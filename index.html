<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VibeHub — Where Your Vibe Lives</title>
<link rel="icon" href="https://i.ibb.co/Fqnj3JKp/1000001392.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script>
(function() {
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
  s.onload = function() { window.supabaseReady = true; console.log('Supabase loaded'); };
  s.onerror = function() { console.log('Supabase failed - using localStorage'); };
  document.head.appendChild(s);
})();
</script>
<script>
  window.VIBEHUB_SUPABASE_URL = 'https://osfqlabtuqpynqcdmwff.supabase.co';
  window.VIBEHUB_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zZnFsYWJ0dXFweW5xY2Rtd2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODQ3OTEsImV4cCI6MjA4NzU2MDc5MX0.LXZ-lbLiarXHSSlu8NXi0c_uvIVFxh8mw6amXGJAwtA';
</script>
<style>
:root {
  --bg: #08080f;
  --bg2: #0f0f1a;
  --bg3: #151525;
  --card: #12121e;
  --card2: #1a1a2e;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --purple: #8b5cf6;
  --purple2: #7c3aed;
  --pink: #ec4899;
  --gold: #f59e0b;
  --cyan: #06b6d4;
  --green: #10b981;
  --red: #ef4444;
  --text: #f1f0ff;
  --text2: #a0a0c0;
  --text3: #60607a;
  --glow: 0 0 30px rgba(139,92,246,0.3);
  --glow2: 0 0 60px rgba(139,92,246,0.15);
  --radius: 16px;
  --radius2: 12px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--purple2); border-radius: 4px; }

/* ── UTILITIES ── */
.hidden { display: none !important; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }
.gap-4 { gap: 16px; }
.w-full { width: 100%; }
.text-center { text-align: center; }
.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ── BUTTONS ── */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 10px 20px; border-radius: 50px; border: none;
  font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 14px;
  cursor: pointer; transition: all .2s; text-decoration: none;
  white-space: nowrap;
}
.btn-primary {
  background: linear-gradient(135deg, var(--purple), var(--pink));
  color: #fff; box-shadow: 0 4px 20px rgba(139,92,246,0.4);
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(139,92,246,0.5); }
.btn-outline {
  background: transparent; color: var(--text);
  border: 1px solid var(--border2);
}
.btn-outline:hover { background: var(--card2); border-color: var(--purple); }
.btn-ghost {
  background: transparent; color: var(--text2);
  border: none; padding: 8px 14px; border-radius: var(--radius2);
}
.btn-ghost:hover { background: var(--card2); color: var(--text); }
.btn-sm { padding: 7px 14px; font-size: 12px; }
.btn-danger { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
.btn-danger:hover { background: rgba(239,68,68,0.25); }

/* ── INPUTS ── */
input, textarea, select {
  background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text); font-family: 'DM Sans', sans-serif;
  font-size: 14px; border-radius: var(--radius2);
  padding: 10px 14px; width: 100%;
  transition: border-color .2s, box-shadow .2s;
}
input:focus, textarea:focus, select:focus {
  outline: none; border-color: var(--purple);
  box-shadow: 0 0 0 3px rgba(139,92,246,0.15);
}
textarea { resize: vertical; min-height: 80px; }
label { display: block; font-size: 13px; color: var(--text2); margin-bottom: 6px; font-weight: 500; }
.form-group { margin-bottom: 16px; }

/* ── CARDS ── */
.card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden;
}
.card-body { padding: 20px; }

/* ── AVATAR ── */
.avatar {
  border-radius: 50%; object-fit: cover; flex-shrink: 0;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif; font-weight: 700; color: #fff;
  overflow: hidden;
}
.avatar-sm { width: 36px; height: 36px; font-size: 14px; }
.avatar-md { width: 48px; height: 48px; font-size: 18px; }
.avatar-lg { width: 80px; height: 80px; font-size: 28px; }
.avatar-xl { width: 120px; height: 120px; font-size: 40px; }

/* ── BADGE ── */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 50px; font-size: 11px; font-weight: 600;
}
.badge-purple { background: rgba(139,92,246,0.2); color: var(--purple); border: 1px solid rgba(139,92,246,0.3); }
.badge-gold { background: rgba(245,158,11,0.2); color: var(--gold); border: 1px solid rgba(245,158,11,0.3); }
.badge-green { background: rgba(16,185,129,0.2); color: var(--green); border: 1px solid rgba(16,185,129,0.3); }
.badge-pink { background: rgba(236,72,153,0.2); color: var(--pink); border: 1px solid rgba(236,72,153,0.3); }

/* ── MODAL ── */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.8);
  backdrop-filter: blur(8px); z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.modal {
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 24px; width: 100%; max-width: 480px;
  max-height: 90vh; overflow-y: auto;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6), var(--glow2);
  animation: modalIn .25s ease;
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.modal-header {
  padding: 24px 24px 0;
  display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; }
.modal-body { padding: 20px 24px 24px; }
.close-btn {
  width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border2);
  background: var(--bg3); cursor: pointer; display: flex; align-items: center; justify-content: center;
  color: var(--text2); font-size: 18px; transition: all .2s;
}
.close-btn:hover { background: var(--card2); color: var(--text); }

/* ── TOAST ── */
#toast-container {
  position: fixed; bottom: 24px; right: 24px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: var(--card2); border: 1px solid var(--border2);
  color: var(--text); padding: 12px 18px; border-radius: 12px;
  font-size: 14px; font-weight: 500; box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  animation: toastIn .3s ease; display: flex; align-items: center; gap: 8px;
  max-width: 320px;
}
.toast.success { border-color: rgba(16,185,129,0.4); }
.toast.error { border-color: rgba(239,68,68,0.4); }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* ──────────────────────────────────────────
   LANDING PAGE
────────────────────────────────────────── */
#page-landing {
  min-height: 100vh;
  background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(139,92,246,0.15) 0%, transparent 70%),
              radial-gradient(ellipse 60% 40% at 100% 100%, rgba(236,72,153,0.1) 0%, transparent 60%),
              var(--bg);
}

.landing-nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 40px; max-width: 1200px; margin: 0 auto;
}
.logo {
  font-family: 'Syne', sans-serif; font-weight: 800; font-size: 26px;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-decoration: none;
}
.site-logo { height: 56px; width: auto; cursor: pointer; }
.site-logo-lg { height: 126px; width: auto; cursor: pointer; }
.landing-hero {
  max-width: 900px; margin: 0 auto; padding: 80px 40px 60px;
  text-align: center;
}
.landing-eyebrow {
  display: inline-flex; align-items: center; gap: 8px;
  background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3);
  color: var(--purple); padding: 6px 16px; border-radius: 50px;
  font-size: 13px; font-weight: 600; margin-bottom: 28px;
  animation: fadeUp .5s ease;
}
.landing-title {
  font-family: 'Syne', sans-serif; font-size: clamp(48px, 8vw, 96px);
  font-weight: 800; line-height: 1.05; margin-bottom: 24px;
  animation: fadeUp .5s .1s ease both;
}
.landing-title .grad {
  background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 50%, var(--gold) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.landing-sub {
  font-size: 18px; color: var(--text2); max-width: 600px; margin: 0 auto 40px;
  line-height: 1.7; animation: fadeUp .5s .2s ease both;
}
.landing-ctas {
  display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;
  animation: fadeUp .5s .3s ease both;
}
.landing-features {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px; max-width: 1100px; margin: 60px auto; padding: 0 40px;
}
.feature-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 24px;
  transition: all .2s; animation: fadeUp .5s ease both;
}
.feature-card:hover { border-color: var(--purple); transform: translateY(-4px); box-shadow: var(--glow); }
.feature-icon { font-size: 32px; margin-bottom: 12px; }
.feature-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 6px; }
.feature-desc { font-size: 13px; color: var(--text2); line-height: 1.6; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ──────────────────────────────────────────
   AUTH PAGES
────────────────────────────────────────── */
.auth-page {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: radial-gradient(ellipse 70% 50% at 50% 0%, rgba(139,92,246,0.12) 0%, transparent 60%), var(--bg);
  padding: 20px;
}
.auth-card {
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 24px; padding: 40px; width: 100%; max-width: 440px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.5);
}
.auth-logo { text-align: center; margin-bottom: 8px; }
.auth-subtitle { text-align: center; color: var(--text2); font-size: 14px; margin-bottom: 32px; }
.auth-switch { text-align: center; font-size: 14px; color: var(--text2); margin-top: 20px; }
.auth-switch a { color: var(--purple); text-decoration: none; font-weight: 600; }
.auth-switch a:hover { color: var(--pink); }
.auth-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 28px; text-align: center; margin-bottom: 4px; }

/* ──────────────────────────────────────────
   APP SHELL
────────────────────────────────────────── */
#app-shell {
  display: flex; min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 260px; flex-shrink: 0; background: var(--bg2);
  border-right: 1px solid var(--border); padding: 20px 16px;
  display: flex; flex-direction: column; gap: 4px;
  position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto;
  z-index: 100;
}
.sidebar-logo { padding: 4px 12px 20px; }
.sidebar-section { font-size: 11px; font-weight: 700; color: var(--text3); padding: 16px 12px 6px; letter-spacing: .08em; text-transform: uppercase; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-radius: 12px; cursor: pointer;
  font-size: 14px; font-weight: 500; color: var(--text2);
  transition: all .15s; text-decoration: none; border: none; background: none;
  width: 100%;
}
.nav-item:hover { background: var(--card2); color: var(--text); }
.nav-item.active { background: rgba(139,92,246,0.15); color: var(--purple); font-weight: 600; }
.nav-item .nav-icon { font-size: 18px; width: 24px; text-align: center; }
.nav-item .nav-badge {
  margin-left: auto; background: var(--pink); color: #fff;
  font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 50px;
}

.sidebar-user {
  margin-top: auto; padding: 16px 12px;
  border-top: 1px solid var(--border); display: flex; align-items: center; gap: 10px;
  cursor: pointer; border-radius: 12px; transition: background .15s;
}
.sidebar-user:hover { background: var(--card2); }
.sidebar-user-info { flex: 1; overflow: hidden; }
.sidebar-user-name { font-weight: 600; font-size: 14px; truncate; }
.sidebar-user-handle { font-size: 12px; color: var(--text3); }

/* Main content */
.main-content {
  flex: 1; margin-left: 260px; min-height: 100vh;
}

/* Top bar */
.topbar {
  position: sticky; top: 0; z-index: 50;
  background: rgba(8,8,15,0.85); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 14px 24px; display: flex; align-items: center; gap: 12px;
}
.topbar-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; flex: 1; }
.topbar-search {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 50px; padding: 8px 16px; width: 240px;
}
.topbar-search input {
  background: none; border: none; padding: 0; font-size: 13px;
  box-shadow: none;
}
.topbar-search input:focus { box-shadow: none; }

/* Page views */
.view { padding: 24px; max-width: 680px; margin: 0 auto; }
.view-wide { padding: 24px; max-width: 1100px; margin: 0 auto; }

/* ──────────────────────────────────────────
   FEED
────────────────────────────────────────── */
.post-composer {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
}
.composer-top { display: flex; gap: 12px; }
.composer-input {
  flex: 1; background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 12px; padding: 12px 16px;
  font-size: 14px; color: var(--text); line-height: 1.5; resize: none;
  transition: border-color .2s;
}
.composer-input:focus { outline: none; border-color: var(--purple); }
.composer-actions {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);
}
.composer-tools { display: flex; gap: 4px; }
.composer-tool {
  width: 36px; height: 36px; border-radius: 8px; border: none;
  background: transparent; cursor: pointer; font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text2); transition: all .15s;
}
.composer-tool:hover { background: var(--bg3); color: var(--text); }

/* Post card */
.post-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); margin-bottom: 16px;
  transition: border-color .2s;
  animation: fadeUp .3s ease;
}
.post-card:hover { border-color: var(--border2); }
.post-header {
  display: flex; align-items: center; gap: 12px;
  padding: 16px 20px 12px;
}
.post-user-info { flex: 1; overflow: hidden; }
.post-user-name { font-weight: 600; font-size: 14px; cursor: pointer; }
.post-user-name:hover { color: var(--purple); }
.post-meta { font-size: 12px; color: var(--text3); }
.post-body { padding: 0 20px 4px; font-size: 15px; line-height: 1.6; color: var(--text); }
.post-media {
  margin: 12px 20px; border-radius: 12px; overflow: hidden;
  max-height: 400px; background: var(--bg3);
}
.post-media img { width: 100%; height: 100%; object-fit: cover; }
.post-media video { width: 100%; max-height: 400px; }
.post-tags { padding: 8px 20px; display: flex; flex-wrap: wrap; gap: 6px; }
.post-tag {
  font-size: 12px; color: var(--purple); font-weight: 500; cursor: pointer;
}
.post-tag:hover { color: var(--pink); }

.post-actions {
  display: flex; align-items: center; gap: 4px;
  padding: 8px 12px 16px; border-top: 1px solid var(--border); margin-top: 8px;
}
.post-action {
  display: flex; align-items: center; gap: 6px;
  padding: 7px 14px; border-radius: 50px; cursor: pointer;
  font-size: 13px; font-weight: 600; border: none; background: transparent;
  color: var(--text2); transition: all .15s;
}
.post-action:hover { background: var(--bg3); }
.post-action.liked { color: var(--purple); background: rgba(139,92,246,0.1); }
.post-action.disliked { color: var(--red); background: rgba(239,68,68,0.1); }
.post-action.commented { color: var(--cyan); }
.post-action.cap-react { color: #f97316; background: rgba(249,115,22,0.15); }
.post-action.relate-react { color: #ec4899; background: rgba(236,72,153,0.15); }
.post-action.wild-react { color: #a855f7; background: rgba(168,85,247,0.15); }
.post-action.facts-react { color: #eab308; background: rgba(234,179,8,0.15); }

/* Comments */
.post-comments {
  padding: 12px 20px 16px; border-top: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 10px;
}
.comment {
  display: flex; gap: 10px; align-items: flex-start;
}
.comment-body { flex: 1; }
.comment-author { font-size: 13px; font-weight: 600; display: inline; margin-right: 6px; }
.comment-text { font-size: 13px; color: var(--text2); display: inline; line-height: 1.5; }
.comment-time { font-size: 11px; color: var(--text3); margin-top: 2px; }
.comment-input-row { display: flex; gap: 10px; align-items: center; margin-top: 6px; }
.comment-input-row input { flex: 1; border-radius: 50px; padding: 8px 14px; }
.comment-reaction-btn { background:none;border:none;font-size:12px;cursor:pointer;padding:2px 6px;border-radius:8px;color:var(--text3);transition:all .15s; }
.comment-reaction-btn:hover { background:var(--bg3); }
.comment-reaction-btn.active { color:var(--purple); }
.comment-reply-btn { background:none;border:none;font-size:12px;cursor:pointer;padding:2px 6px;border-radius:8px;color:var(--cyan); }

/* Feed tabs */
.feed-tabs {
  display: flex; gap: 4px; margin-bottom: 20px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; padding: 4px;
}
.feed-tab {
  flex: 1; text-align: center; padding: 8px; border-radius: 8px;
  font-size: 13px; font-weight: 600; cursor: pointer; color: var(--text2);
  border: none; background: transparent; transition: all .15s;
}
.feed-tab.active { background: var(--purple2); color: #fff; }

/* ──────────────────────────────────────────
   PROFILE PAGE
────────────────────────────────────────── */
.profile-page { }

.profile-banner {
  height: 200px; width: 100%; position: relative; overflow: hidden;
  background: linear-gradient(135deg, var(--purple2), var(--pink));
}
.profile-banner img { width: 100%; height: 100%; object-fit: cover; }
.profile-banner-overlay {
  position: absolute; inset: 0;
  background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.6));
}

.profile-info-section {
  padding: 0 24px 24px;
  position: relative;
}
.profile-avatar-wrap {
  margin-top: -50px; margin-bottom: 16px;
  display: flex; align-items: flex-end; gap: 16px;
}
.profile-avatar-wrap .avatar-xl {
  border: 4px solid var(--bg); box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  font-size: 44px;
}
.profile-name { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 28px; }
.profile-handle { color: var(--text2); font-size: 14px; margin-bottom: 8px; }
.profile-bio { color: var(--text2); font-size: 14px; line-height: 1.6; max-width: 500px; margin-bottom: 12px; }
.profile-stats { display: flex; gap: 24px; margin-bottom: 16px; }
.profile-stat { text-align: center; }
.profile-stat-num { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; }
.profile-stat-label { font-size: 12px; color: var(--text3); }
.profile-actions { display: flex; gap: 8px; }

/* Profile grid layout */
.profile-grid {
  display: grid; grid-template-columns: 1fr 300px; gap: 20px;
  padding: 0 24px 24px;
}

/* Music player */
.music-player {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
}
.music-player-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; margin-bottom: 12px; color: var(--text2); display: flex; align-items: center; gap: 6px; }
.music-track { display: flex; align-items: center; gap: 10px; }
.music-thumb {
  width: 48px; height: 48px; border-radius: 8px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--purple2), var(--pink));
  display: flex; align-items: center; justify-content: center; font-size: 20px;
  animation: spin 4s linear infinite paused;
}
.music-thumb.playing { animation-play-state: running; }
@keyframes spin { to { transform: rotate(360deg); } }
.music-info { flex: 1; overflow: hidden; }
.music-track-name { font-weight: 600; font-size: 14px; truncate; }
.music-artist { font-size: 12px; color: var(--text2); }
.music-controls { display: flex; align-items: center; gap: 6px; margin-top: 8px; }
.music-btn {
  width: 32px; height: 32px; border-radius: 50%; border: none;
  background: var(--bg3); cursor: pointer; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text2); transition: all .15s;
}
.music-btn.play { background: var(--purple2); color: #fff; width: 36px; height: 36px; font-size: 16px; }
.music-btn:hover { background: var(--card2); color: var(--text); }
.music-progress {
  flex: 1; height: 3px; background: var(--border);
  border-radius: 3px; overflow: hidden; margin: 0 8px;
}
.music-progress-fill {
  height: 100%; background: linear-gradient(to right, var(--purple), var(--pink));
  width: 35%; transition: width .1s;
}

/* Top 8 */
.top8-widget {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
}
.top8-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; margin-bottom: 12px; color: var(--text2); display: flex; align-items: center; gap: 6px; }
.top8-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.top8-friend {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: pointer;
}
.top8-friend:hover .avatar-sm { box-shadow: 0 0 0 2px var(--purple); }
.top8-name { font-size: 10px; color: var(--text2); text-align: center; truncate; max-width: 60px; }

/* Mood widget */
.mood-widget {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.mood-emoji { font-size: 28px; }
.mood-text { font-size: 13px; color: var(--text2); }
.mood-text strong { color: var(--text); display: block; }

/* Profile customizer */
.customizer {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
}
.customizer-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 16px; }
.color-picker-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
.color-swatch {
  width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
  border: 2px solid transparent; transition: all .15s;
}
.color-swatch.active, .color-swatch:hover { transform: scale(1.2); border-color: #fff; }
.gradient-option {
  height: 36px; border-radius: 8px; cursor: pointer;
  border: 2px solid transparent; transition: all .15s; flex: 1;
}
.gradient-option.active, .gradient-option:hover { border-color: #fff; transform: translateY(-2px); }

/* Profile theme application */
.profile-themed {
  --theme-primary: var(--purple);
  --theme-bg: var(--card);
}

/* ──────────────────────────────────────────
   CHANNELS
────────────────────────────────────────── */
.channels-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
  margin-bottom: 24px;
}
.channel-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden; cursor: pointer;
  transition: all .2s;
}
.channel-card:hover { border-color: var(--purple); transform: translateY(-4px); box-shadow: var(--glow); }
.channel-banner {
  height: 120px; background: linear-gradient(135deg, var(--purple2), var(--pink));
  display: flex; align-items: center; justify-content: center; font-size: 40px;
  position: relative; overflow: hidden;
}
.channel-info { padding: 16px; }
.channel-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 4px; }
.channel-desc { font-size: 13px; color: var(--text2); margin-bottom: 12px; line-height: 1.5; }
.channel-meta { display: flex; align-items: center; justify-content: space-between; }
.channel-subs { font-size: 12px; color: var(--text3); }

/* Video grid */
.video-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;
}
.video-thumb {
  background: var(--bg3); border-radius: 12px; overflow: hidden;
  cursor: pointer; transition: transform .2s;
}
.video-thumb:hover { transform: translateY(-4px); }
.video-preview {
  height: 130px; background: linear-gradient(135deg, #1a1a2e, #0f0f1a);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; position: relative;
}
.video-play-overlay {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.4); opacity: 0; transition: opacity .2s;
  font-size: 40px;
}
.video-thumb:hover .video-play-overlay { opacity: 1; }
.video-info { padding: 10px 12px; }
.video-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.video-meta { font-size: 11px; color: var(--text3); }

/* ──────────────────────────────────────────
   MESSAGES
────────────────────────────────────────── */
.messages-layout {
  display: grid; grid-template-columns: 300px 1fr; gap: 0;
  height: calc(100vh - 61px);
}
.dm-list {
  border-right: 1px solid var(--border); overflow-y: auto;
  padding: 16px;
}
.dm-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px; border-radius: 12px; cursor: pointer;
  transition: background .15s;
}
.dm-item:hover, .dm-item.active { background: var(--card2); }
.dm-info { flex: 1; overflow: hidden; }
.dm-name { font-weight: 600; font-size: 14px; }
.dm-preview { font-size: 12px; color: var(--text3); truncate; }
.dm-time { font-size: 11px; color: var(--text3); }
.dm-unread { background: var(--purple2); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 50px; }

.chat-area { display: flex; flex-direction: column; }
.chat-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}
.chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.message-bubble {
  max-width: 70%; display: flex; flex-direction: column; gap: 3px;
}
.message-bubble.sent { align-self: flex-end; align-items: flex-end; }
.message-bubble.recv { align-self: flex-start; align-items: flex-start; }
.bubble {
  padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.5;
  word-break: break-word;
}
.sent .bubble { background: var(--purple2); color: #fff; border-bottom-right-radius: 4px; }
.recv .bubble { background: var(--card2); color: var(--text); border-bottom-left-radius: 4px; }
.bubble-time { font-size: 11px; color: var(--text3); padding: 0 4px; }
.chat-input-bar {
  padding: 16px 20px; border-top: 1px solid var(--border);
  display: flex; gap: 10px; align-items: flex-end;
}
.chat-input {
  flex: 1; max-height: 120px; border-radius: 16px;
}

/* ──────────────────────────────────────────
   EXPLORE / TRENDING
────────────────────────────────────────── */
.explore-section { margin-bottom: 32px; }
.explore-heading {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px;
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}
.trending-tags { display: flex; flex-wrap: wrap; gap: 8px; }
.trend-tag {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 50px; padding: 8px 16px; cursor: pointer;
  font-size: 14px; font-weight: 500; transition: all .15s;
}
.trend-tag:hover { border-color: var(--purple); background: rgba(139,92,246,0.1); color: var(--purple); }
.trend-tag .tag-count { color: var(--text3); font-size: 12px; }

.creator-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
.creator-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px; text-align: center;
  cursor: pointer; transition: all .2s;
}
.creator-card:hover { border-color: var(--purple); transform: translateY(-4px); box-shadow: var(--glow); }
.creator-name { font-weight: 700; font-size: 14px; margin: 8px 0 2px; }
.creator-handle { font-size: 12px; color: var(--text3); }
.creator-subs { font-size: 12px; color: var(--purple); font-weight: 600; margin-top: 6px; }

/* ──────────────────────────────────────────
   ADMIN PANEL
────────────────────────────────────────── */
.admin-layout { display: grid; grid-template-columns: 220px 1fr; gap: 0; min-height: calc(100vh - 61px); }
.admin-sidebar {
  background: rgba(139,92,246,0.05); border-right: 1px solid rgba(139,92,246,0.15);
  padding: 20px 12px;
}
.admin-nav-item {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 12px; border-radius: 10px; cursor: pointer;
  font-size: 13px; font-weight: 500; color: var(--text2);
  transition: all .15s; border: none; background: none; width: 100%;
}
.admin-nav-item:hover { background: var(--card2); color: var(--text); }
.admin-nav-item.active { background: rgba(139,92,246,0.2); color: var(--purple); }
.admin-content { padding: 28px; overflow-y: auto; }
.admin-stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
.admin-stat {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
}
.admin-stat-val { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 32px; }
.admin-stat-label { font-size: 13px; color: var(--text2); margin-top: 4px; }

/* ──────────────────────────────────────────
   PAYMENT MODAL
────────────────────────────────────────── */
.payment-card-visual {
  background: linear-gradient(135deg, var(--purple2), var(--pink));
  border-radius: 16px; padding: 24px; margin: 20px 0; color: #fff;
  font-family: 'Space Mono', monospace;
}
.payment-amount { font-family: 'Syne', sans-serif; font-size: 48px; font-weight: 800; text-align: center; margin-bottom: 4px; }
.payment-desc { text-align: center; opacity: .8; font-size: 14px; margin-bottom: 24px; }
.payment-features { display: flex; flex-direction: column; gap: 8px; }
.payment-feature { display: flex; align-items: center; gap: 8px; font-size: 13px; }
.payment-feature::before { content: "✓"; color: var(--gold); font-weight: 700; }

/* ──────────────────────────────────────────
   ANIMATIONS
────────────────────────────────────────── */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: .5; }
}
.pulse { animation: pulse 2s infinite; }

/* Notification dot */
.notif-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--pink);
  display: inline-block; margin-left: 4px;
}

/* Online indicator */
.online-dot {
  width: 10px; height: 10px; border-radius: 50%; background: var(--green);
  border: 2px solid var(--bg2); position: absolute; bottom: 0; right: 0;
}

/* Empty state */
.empty-state {
  text-align: center; padding: 60px 20px; color: var(--text2);
}
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; margin-bottom: 8px; color: var(--text); }
.empty-desc { font-size: 14px; line-height: 1.6; }

/* Divider */
.divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

/* Section title */
.section-title {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 18px;
  margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;
}

/* Tags/Chips */
.chip {
  display: inline-flex; align-items: center; gap: 4px;
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 50px; padding: 4px 12px; font-size: 12px; font-weight: 500; color: var(--text2);
}

/* Tab panels */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Rich text indicator */
.verified { color: var(--purple); font-size: 14px; margin-left: 2px; }

/* Profile theme overlay */
.profile-custom-bg {
  position: absolute; inset: 0; z-index: 0;
  transition: all .3s;
}
.profile-banner { position: relative; }
.profile-banner > * { position: relative; z-index: 1; }

/* Responsive - Tablet */
@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); transition: transform .3s; }
  .sidebar.open { transform: translateX(0); }
  .main-content { margin-left: 0; }
  .profile-grid { grid-template-columns: 1fr; }
  .admin-layout { grid-template-columns: 1fr; }
  .messages-layout { grid-template-columns: 1fr; }
  .admin-stat-grid { grid-template-columns: repeat(2,1fr); }
  .landing-hero { padding: 40px 20px; }
  .landing-title { font-size: clamp(32px, 8vw, 56px); }
  .landing-features { padding: 0 20px; }
  .auth-card { padding: 24px; margin: 20px; }
}

/* Responsive - Mobile Phone */
@media (max-width: 480px) {
  /* Touch-friendly buttons */
  .btn { min-height: 44px; padding: 12px 20px; font-size: 15px; }
  .btn-sm { min-height: 40px; padding: 10px 16px; font-size: 14px; }
  
  /* Landing page */
  .landing-nav { padding: 12px 16px; }
  .landing-hero { padding: 24px 16px 40px; }
  .landing-title { font-size: clamp(28px, 10vw, 40px); line-height: 1.2; }
  .landing-sub { font-size: 15px; }
  .landing-ctas { flex-direction: column; gap: 10px; }
  .landing-ctas .btn { width: 100%; justify-content: center; }
  .landing-features { padding: 0 12px; gap: 12px; }
  .feature-card { padding: 16px; }
  
  /* Auth forms */
  .auth-card { padding: 20px 16px; margin: 12px; }
  .auth-title { font-size: 24px; }
  
  /* Main content */
  .view { padding: 16px; }
  .topbar { padding: 10px 12px; }
  .topbar-title { font-size: 16px; }
  .topbar-search { width: 140px; }
  
  /* Posts */
  .post-card { margin-bottom: 12px; }
  .post-header { padding: 12px 14px; }
  .post-body { padding: 0 14px 4px; font-size: 14px; }
  .post-tags { padding: 8px 14px; }
  .post-actions { padding: 8px 10px; }
  .post-action { padding: 8px 12px; font-size: 13px; }
  
  /* Composer */
  .post-composer { padding: 14px; }
  .composer-input { padding: 10px 12px; font-size: 14px; }
  
  /* Profile */
  .profile-banner { height: 140px; }
  .profile-avatar-wrap .avatar-xl { width: 80px; height: 80px; font-size: 28px; margin-top: -40px; }
  .profile-name { font-size: 22px; }
  .profile-info-section { padding: 0 16px 16px; }
  .profile-stats { gap: 16px; }
  
  /* Modals */
  .modal { margin: 12px; max-height: 90vh; }
  .modal-header { padding: 16px 16px 0; }
  .modal-body { padding: 16px; }
  .modal-title { font-size: 18px; }
  
  /* Bottom bar */
  .bottom-bar { padding: 10px 16px; }
  .bottom-home-btn, .bottom-admin-btn { padding: 10px 16px; font-size: 13px; }
  
  /* Feed tabs */
  .feed-tabs { margin-bottom: 16px; }
  .feed-tab { padding: 10px 8px; font-size: 12px; }
  
  /* Channels */
  .channels-grid { grid-template-columns: 1fr; gap: 12px; }
  .channel-card { }
  
  /* Top 8 */
  .top8-grid { grid-template-columns: repeat(4, 1fr); gap: 4px; }
  .top8-name { font-size: 9px; max-width: 50px; }
  
  /* Video grid */
  .video-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .video-info { padding: 8px; }
  .video-title { font-size: 12px; }
}

/* Very small phones */
@media (max-width: 360px) {
  .landing-title { font-size: 24px; }
  .feature-card { padding: 12px; }
  .feature-title { font-size: 14px; }
  .feature-desc { font-size: 12px; }
  .profile-banner { height: 100px; }
  .profile-avatar-wrap .avatar-xl { width: 60px; height: 60px; font-size: 22px; margin-top: -30px; }
}

/* Theme colors for profiles */
.theme-purple .profile-banner { background: linear-gradient(135deg, #6d28d9, #8b5cf6); }
.theme-pink .profile-banner { background: linear-gradient(135deg, #be185d, #ec4899); }
.theme-cyan .profile-banner { background: linear-gradient(135deg, #0e7490, #06b6d4); }
.theme-gold .profile-banner { background: linear-gradient(135deg, #b45309, #f59e0b); }
.theme-green .profile-banner { background: linear-gradient(135deg, #065f46, #10b981); }
.theme-red .profile-banner { background: linear-gradient(135deg, #991b1b, #ef4444); }

/* Glitch text effect for landing */
.glitch-text { position: relative; }

/* ── BOTTOM FLOATING BAR ── */
.bottom-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 500;
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 24px;
  background: rgba(8,8,15,0.92); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border2);
  pointer-events: none;
}
.bottom-bar > * { pointer-events: all; }

.bottom-home-btn {
  display: flex; align-items: center; gap: 8px;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  color: #fff; border: none; border-radius: 50px;
  padding: 10px 22px; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 700; cursor: pointer;
  box-shadow: 0 4px 20px rgba(139,92,246,0.5);
  transition: all .2s;
}
.bottom-home-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(139,92,246,0.6); }

.bottom-admin-btn {
  display: flex; align-items: center; gap: 8px;
  background: rgba(245,158,11,0.12); border: 1px solid rgba(245,158,11,0.35);
  color: var(--gold); border-radius: 50px;
  padding: 9px 20px; font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 700; cursor: pointer;
  transition: all .2s; backdrop-filter: blur(8px);
}
.bottom-admin-btn:hover { background: rgba(245,158,11,0.22); transform: translateY(-3px); box-shadow: 0 8px 24px rgba(245,158,11,0.3); }

/* ── BACK BUTTON ── */
.back-btn {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text2); font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s; flex-shrink: 0;
}
.back-btn:hover { background: var(--card2); color: var(--text); transform: translateX(-2px); }
.back-btn.invisible { opacity: 0; pointer-events: none; }

/* ── BETA BADGE ── */
.beta-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(6,182,212,0.2));
  border: 1px solid rgba(16,185,129,0.4);
  color: var(--green); padding: 6px 14px; border-radius: 50px;
  font-size: 12px; font-weight: 700; margin-bottom: 12px;
}
.beta-slots { color: var(--cyan); font-weight: 800; }

/* ── FIREBASE SETUP NOTICE ── */
.firebase-notice {
  background: rgba(6,182,212,0.08); border: 1px solid rgba(6,182,212,0.2);
  border-radius: 12px; padding: 14px 16px; margin-bottom: 20px;
  font-size: 13px; color: var(--text2); line-height: 1.6;
}
.firebase-notice strong { color: var(--cyan); }

/* add padding so content not hidden behind bottom bar */
.main-content { padding-bottom: 68px; }
#page-landing { padding-bottom: 80px; }

/* ── MARKETPLACE ── */
.marketplace-item { transition: all .2s; }
.marketplace-item:hover { transform: translateY(-4px); box-shadow: var(--glow); }

/* ── REACTION POPUP ── */
.reaction-popup {
  position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
  background: var(--card2); border: 1px solid var(--border2);
  border-radius: 50px; padding: 6px 10px; display: flex; gap: 4px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 100;
  animation: fadeUp .2s ease;
}
.reaction-popup button {
  background: none; border: none; font-size: 18px; cursor: pointer;
  padding: 4px; border-radius: 50%; transition: all .15s;
}
.reaction-popup button:hover { transform: scale(1.2); }

/* ── WAVE BUTTON ── */
.post-action.waved { color: var(--cyan); background: rgba(6,182,212,0.1); }

/* ── BADGES ── */
.badge-gold { background: rgba(245,158,11,0.2); color: var(--gold); border: 1px solid rgba(245,158,11,0.3); }
.badge-purple { background: rgba(139,92,246,0.2); color: var(--purple); border: 1px solid rgba(139,92,246,0.3); }
.badge-pink { background: rgba(236,72,153,0.2); color: var(--pink); border: 1px solid rgba(236,72,153,0.3); }
.badge-green { background: rgba(16,185,129,0.2); color: var(--green); border: 1px solid rgba(16,185,129,0.3); }

/* ── VIBE LIKE BUTTON ── */
.vibe-like-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border2);
  background: transparent; color: var(--text2); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .2s;
}
.vibe-like-btn:hover { border-color: var(--pink); color: var(--pink); background: rgba(236,72,153,0.1); }
.vibe-like-btn.liked { border-color: var(--pink); color: var(--pink); background: rgba(236,72,153,0.15); }

/* ── FRIEND REQUEST BUTTONS ── */
.friend-req-btns { display: flex; gap: 8px; margin-top: 8px; }
.friend-req-btns button { flex: 1; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all .15s; }
.friend-req-btns .accept { background: var(--green); color: #fff; border: none; }
.friend-req-btns .accept:hover { background: #0d9668; }
.friend-req-btns .reject { background: transparent; color: var(--text2); border: 1px solid var(--border2); }
.friend-req-btns .reject:hover { border-color: var(--red); color: var(--red); }

/* ── AUDIO COMMENT ── */
.audio-comment-btn { background: none; border: none; font-size: 16px; cursor: pointer; padding: 4px; }
.audio-comment-btn:hover { transform: scale(1.1); }
audio { width: 100%; margin-top: 8px; border-radius: 8px; }

/* ── POST EXPIRED ── */
.post-expired { opacity: 0.5; position: relative; }
.post-expired::after {
  content: '⏰ This post has expired'; position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%); background: var(--bg); padding: 8px 16px;
  border-radius: 8px; font-size: 14px; font-weight: 600;
}

/* ── COMMENT REACTIONS ── */
.comment-reaction { font-size: 12px; margin-right: 8px; cursor: pointer; opacity: 0.6; transition: all .15s; }
.comment-reaction:hover, .comment-reaction.active { opacity: 1; transform: scale(1.1); }

/* ── CHANNELS GRID ── */
.channels_grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }

/* ── SETTINGS ── */
.settings-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.settings-item:last-child { border-bottom: none; }
.toggle {
  width: 44px;
  height: 24px;
  background: var(--bg3);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background .2s;
}
.toggle::after {
  content: '';
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform .2s;
}
.toggle.active { background: var(--purple); }
.toggle.active::after { transform: translateX(20px); }

/* ── SYNC SPACES ── */
.sync-space-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 16px;
  transition: all .2s;
}
.sync-space-card:hover { border-color: var(--purple); }
.sync-space-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 18px; }
.sync-space-meta { font-size: 12px; color: var(--text3); margin: 8px 0; }
.sync-space-timer { font-size: 12px; color: var(--cyan); font-weight: 600; }
.sync-space-glow { animation: syncGlow 2s ease-in-out infinite; }
@keyframes syncGlow {
  0%, 100% { box-shadow: 0 0 10px rgba(139,92,246,0.3); }
  50% { box-shadow: 0 0 20px rgba(139,92,246,0.6); }
}
</style>

<!-- ══════════════════════════════════════
     FIREBASE SDK
══════════════════════════════════════ -->
<script type="module">
/* ─────────────────────────────────────────────
   FIREBASE SETUP — replace these values with
   your actual Firebase project config from:
   https://console.firebase.google.com
   Project Settings → Your apps → Config

   After adding your config:
   1. Enable Email/Password auth in Firebase Console
   2. Create a Firestore database
   3. Set Firestore rules to allow authenticated users
   4. The app will auto-sync to Firebase instead of localStorage
──────────────────────────────────────────────── */
const FIREBASE_CONFIG = {
  apiKey:            "YOUR_API_KEY",
  authDomain:        "YOUR_PROJECT.firebaseapp.com",
  projectId:         "YOUR_PROJECT_ID",
  storageBucket:     "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId:             "YOUR_APP_ID"
};

// Detect if Firebase is configured
window.FIREBASE_READY = FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY";

if (window.FIREBASE_READY) {
  // Dynamic import only if configured
  import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js').then(({ initializeApp }) => {
    import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js').then(({ getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }) => {
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').then(({ getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp }) => {
        const app = initializeApp(FIREBASE_CONFIG);
        window.fbAuth = getAuth(app);
        window.fbDB  = getFirestore(app);

        // Override localStorage auth with Firebase
        window.fbRegister = async (email, password, userData) => {
          const cred = await createUserWithEmailAndPassword(window.fbAuth, email, password);
          await setDoc(doc(window.fbDB, 'users', cred.user.uid), { ...userData, uid: cred.user.uid });
          return cred.user;
        };

        window.fbLogin = async (email, password) => {
          const cred = await signInWithEmailAndPassword(window.fbAuth, email, password);
          const snap = await getDoc(doc(window.fbDB, 'users', cred.user.uid));
          return snap.data();
        };

        window.fbLogout = () => signOut(window.fbAuth);

        window.fbSavePost = async (post) => {
          await setDoc(doc(window.fbDB, 'posts', post.id), { ...post, createdAt: serverTimestamp() });
        };

        window.fbGetPosts = async () => {
          const snap = await getDocs(query(collection(window.fbDB, 'posts'), orderBy('time', 'desc')));
          return snap.docs.map(d => d.data());
        };

        console.log('✅ Firebase connected! VibeHub is now cloud-powered.');
        window.dispatchEvent(new Event('firebase-ready'));
      });
    });
  });
} else {
  console.log('ℹ️  Firebase not configured — running in localStorage mode. Add your Firebase config to go live!');
}
</script>

</head>
<body>

<div id="toast-container"></div>

<!-- ══════════════════════════════════════
     GLOBAL BOTTOM BAR
══════════════════════════════════════ -->
<div class="bottom-bar" id="global-bottom-bar">
  <button class="bottom-home-btn" onclick="bottomHomeClick()">🏠 Home</button>
  <button class="bottom-admin-btn" onclick="bottomAdminClick()" id="bottom-admin-btn" title="Owner Admin Panel">🛡️ Admin</button>
</div>

<!-- ══════════════════════════════════════
     LANDING PAGE
══════════════════════════════════════ -->
<div id="page-landing">
<nav class="landing-nav">
    <img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo-lg" onclick="showPage('landing')" alt="VibeHub">
    <div class="flex gap-2">
      <button class="btn btn-outline btn-sm" onclick="showPage('login')" id="nav-login-btn">Log In</button>
      <button class="btn btn-primary btn-sm" onclick="showPage('register')" id="landing-join-btn">Create Free Beta Account</button>
    </div>
  </nav>

  <div class="landing-hero">
    <div class="landing-eyebrow">✨ The social platform for real ones</div>
    <h1 class="landing-title">Your <span class="grad">Vibe.</span><br>Your Space.<br>Your <span class="grad">Community.</span></h1>
    <p class="landing-sub">VibeHub blends the best of TikTok, YouTube, and old-school MySpace. Customize your page, share your world, and find your people.</p>
    <div id="landing-beta-status" style="margin-bottom:16px;"></div>
    <div class="landing-ctas">
      <button class="btn btn-primary" onclick="showPage('register')" id="hero-join-btn" style="padding:14px 32px;font-size:16px;">Create Free Beta Account 🚀</button>
      <button class="btn btn-outline" onclick="showPage('login')" id="hero-login-btn" style="padding:14px 32px;font-size:16px;">Already a member</button>
    </div>
  </div>

  <div class="landing-features">
    <div class="feature-card" style="animation-delay:.1s">
      <div class="feature-icon">🎨</div>
      <div class="feature-title">Fully Customize Your Page</div>
      <div class="feature-desc">Pick your colors, add a profile song, arrange your layout. Make it YOU like it's 2005 but way cooler.</div>
    </div>
    <div class="feature-card" style="animation-delay:.2s">
      <div class="feature-icon">🔥</div>
      <div class="feature-title">Short Videos & Full Channels</div>
      <div class="feature-desc">Post TikTok-style clips or build a full YouTube-style channel. Your content, your rules.</div>
    </div>
    <div class="feature-card" style="animation-delay:.3s">
      <div class="feature-icon">👍 👎</div>
      <div class="feature-title">Real Reactions</div>
      <div class="feature-desc">Like AND dislike. Because honest feedback is good vibes. Plus emoji reactions for everything.</div>
    </div>
    <div class="feature-card" style="animation-delay:.4s">
      <div class="feature-icon">🎵</div>
      <div class="feature-title">Profile Music Player</div>
      <div class="feature-desc">The MySpace feature everyone misses is back. Set your song and let visitors feel your energy the second they land.</div>
    </div>
    <div class="feature-card" style="animation-delay:.5s">
      <div class="feature-icon">👥</div>
      <div class="feature-title">Top 8 Vibes</div>
      <div class="feature-desc">Show your ride-or-dies. The iconic Top 8 is back, baby. No algorithm — you decide who matters.</div>
    </div>
    <div class="feature-card" style="animation-delay:.6s">
      <div class="feature-icon">✌️</div>
      <div class="feature-title">Unity First</div>
      <div class="feature-desc">One-time $1 entry keeps bots out. No ads. No algorithm manipulation. Just humans being human.</div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     LOGIN PAGE
══════════════════════════════════════ -->
<div id="page-login" class="hidden auth-page">
  <div class="auth-card">
    <div class="auth-logo"><img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo-lg" onclick="showPage('landing')" alt="VibeHub"></div>
    <div class="auth-title">Welcome back ✌️</div>
    <div class="auth-subtitle">Good to see you again.</div>
    <div class="form-group">
      <label>Username or Email</label>
      <input type="text" id="login-user" placeholder="yourname or email">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="••••••••" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="stay-logged-in" style="width:auto;">
        <span>Stay Logged In</span>
      </label>
    </div>
    <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="doLogin()">Log In</button>
    <div class="auth-switch">Don't have an account? <a href="#" onclick="showPage('register')">Join VibeHub</a></div>
    <div class="auth-switch" style="margin-top:6px;"><a href="#" onclick="showPage('landing')" style="color:var(--text3);font-size:13px;">← Back to Home</a></div>
  </div>
</div>

<!-- ══════════════════════════════════════
     REGISTER PAGE
══════════════════════════════════════ -->
<div id="page-register" class="hidden auth-page">
  <div class="auth-card">
    <div class="auth-logo"><img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo-lg" onclick="showPage('landing')" alt="VibeHub"></div>
    <div class="auth-title">Join the vibe ✨</div>
    <div id="reg-beta-info" style="text-align:center;margin-bottom:16px;"></div>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="reg-user" placeholder="your_handle">
    </div>
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="reg-name" placeholder="Your Name">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="reg-email" placeholder="you@email.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="reg-pass" placeholder="Min 6 characters">
    </div>
    <div class="form-group">
      <label>Bio (optional)</label>
      <textarea id="reg-bio" placeholder="A lil something about you..." style="min-height:60px;"></textarea>
    </div>
    <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" id="reg-submit-btn" onclick="handleRegisterSubmit()">Create Free Beta Account 🚀</button>
    <div class="auth-switch">Already a member? <a href="#" onclick="showPage('login')">Log In</a></div>
    <div class="auth-switch" style="margin-top:6px;"><a href="#" onclick="showPage('landing')" style="color:var(--text3);font-size:13px;">← Back</a></div>
  </div>
</div>

<!-- ══════════════════════════════════════
     APP SHELL
══════════════════════════════════════ -->
<div id="app-shell" class="hidden">

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo" onclick="navigate('home')" alt="VibeHub">
    </div>

    <div class="sidebar-section">Menu</div>
    <button class="nav-item" onclick="navigate('home')" id="nav-home"><span class="nav-icon">🏠</span> Home Feed</button>
    <button class="nav-item" onclick="navigate('explore')" id="nav-explore"><span class="nav-icon">🔍</span> Explore</button>
    <button class="nav-item" onclick="navigate('channels')" id="nav-channels"><span class="nav-icon">📺</span> Channels</button>
    <button class="nav-item" onclick="navigate('sync-spaces')" id="nav-sync-spaces"><span class="nav-icon">💬</span> Sync Spaces</button>
    <button class="nav-item" onclick="navigate('messages')" id="nav-messages"><span class="nav-icon">💬</span> Messages <span class="nav-badge" id="msg-badge" style="display:none;">2</span></button>
    <button class="nav-item" onclick="navigate('notifications')" id="nav-notifications"><span class="nav-icon">🔔</span> Notifications</button>

    <div class="sidebar-section">You</div>
    <button class="nav-item" onclick="navigate('profile', getCurrentUser()?.username)" id="nav-profile"><span class="nav-icon">👤</span> My Profile</button>
    <button class="nav-item" onclick="navigate('edit-profile')" id="nav-edit-profile"><span class="nav-icon">🎨</span> Customize Page</button>
    <button class="nav-item" onclick="navigate('my-channel')" id="nav-my-channel"><span class="nav-icon">📡</span> My Channel</button>
    <button class="nav-item" onclick="navigate('marketplace')" id="nav-marketplace"><span class="nav-icon">🛍️</span> Marketplace</button>
    <button class="nav-item" onclick="navigate('settings')" id="nav-settings"><span class="nav-icon">⚙️</span> Settings</button>
    <button class="nav-item" onclick="navigate('status-channels')" id="nav-status-channels"><span class="nav-icon">⏰</span> Status Channels</button>
    <button class="nav-item" onclick="navigate('disclaimer')" id="nav-disclaimer"><span class="nav-icon">📜</span> Disclaimer</button>

    <div class="sidebar-section" id="admin-section" style="display:none;">Owner</div>
    <button class="nav-item hidden" onclick="navigate('admin')" id="nav-admin"><span class="nav-icon">🛡️</span> Admin Panel</button>

    <div class="sidebar-user" onclick="navigate('profile', getCurrentUser()?.username)">
      <div class="avatar avatar-sm" id="sidebar-avatar">?</div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sidebar-name">Loading...</div>
        <div class="sidebar-user-handle" id="sidebar-handle">@...</div>
      </div>
      <button class="btn-ghost btn btn-sm" onclick="event.stopPropagation();doLogout();" style="padding:4px 8px;font-size:16px;">↪</button>
    </div>
  </aside>

  <!-- Main -->
  <div class="main-content">

    <!-- Topbar -->
    <div class="topbar">
      <button class="back-btn" id="back-btn" onclick="navBack()" title="Go back">←</button>
      <div class="topbar-title" id="topbar-title">Home Feed</div>
      <div class="topbar-search">
        <span>🔍</span>
        <input type="text" placeholder="Search VibeHub..." id="search-input" oninput="handleSearch(this.value)">
      </div>
      <button class="btn btn-primary btn-sm" onclick="document.getElementById('post-composer-input')?.focus()">+ Post</button>
    </div>

    <!-- HOME VIEW -->
    <div id="view-home" class="view hidden">
      <div class="feed-tabs">
        <button class="feed-tab active" onclick="switchFeedTab('all', this)">✨ All Vibes</button>
        <button class="feed-tab" onclick="switchFeedTab('friends', this)">👥 Friends</button>
        <button class="feed-tab" onclick="switchFeedTab('trending', this)">🔥 Trending</button>
      </div>

      <div class="post-composer card">
        <div class="card-body" style="padding:16px;">
          <div class="composer-top">
            <div class="avatar avatar-sm" id="composer-avatar">?</div>
            <textarea class="composer-input" id="post-composer-input" placeholder="What's your vibe today?..." rows="2"></textarea>
          </div>
          <div class="composer-actions">
            <div class="composer-tools">
              <label class="composer-tool" title="Add Photo" style="cursor:pointer;">📷<input type="file" accept="image/*" style="display:none" onchange="handlePostImage(this)"></label>
              <label class="composer-tool" title="Add Video" style="cursor:pointer;">🎬<input type="file" accept="video/*" style="display:none" onchange="handlePostVideo(this)"></label>
              <button class="composer-tool" title="Add Tag" onclick="addTagToComposer()">🏷️</button>
              <button class="composer-tool" title="Mood" onclick="addMoodToComposer()">😊</button>
            </div>
            <button class="btn btn-primary btn-sm" onclick="createPost()">Post Vibe ✌️</button>
          </div>
          <div id="composer-preview" style="margin-top:8px;"></div>
        </div>
      </div>

      <div id="feed-posts">
        <!-- Posts render here -->
      </div>
      
      <div style="text-align:center;padding:20px;margin-top:16px;border-top:1px solid var(--border);">
        <a href="#" onclick="navigate('disclaimer');return false;" style="font-size:11px;color:var(--text3);text-decoration:none;">📜 Disclaimer</a>
      </div>
    </div>

    <!-- EXPLORE VIEW -->
    <div id="view-explore" class="view-wide hidden">
      <div class="view">
        <div class="explore-section">
          <div class="explore-heading">🔥 Trending Tags</div>
          <div class="trending-tags" id="trending-tags"></div>
        </div>
        <div class="explore-section">
          <div class="explore-heading">⭐ Featured Creators</div>
          <div class="creator-grid" id="creator-grid"></div>
        </div>
        <div class="explore-section">
          <div class="explore-heading">✨ Discover Posts</div>
          <div id="explore-posts"></div>
        </div>
      </div>
    </div>

    <!-- CHANNELS VIEW -->
    <div id="view-channels" class="view-wide hidden">
      <div style="padding:24px;">
        <div class="section-title">
          📺 Channels
          <button class="btn btn-primary btn-sm" onclick="openCreateChannelModal()">+ Create Channel</button>
        </div>
        <div class="channels-grid" id="channels-grid"></div>
      </div>
    </div>

    <!-- SYNC SPACES VIEW -->
    <div id="view-sync-spaces" class="view-wide hidden">
      <div style="padding:24px;">
        <div class="section-title">
          💬 Sync Spaces
          <button class="btn btn-primary btn-sm" onclick="openCreateSyncSpaceModal()">+ Create Room</button>
        </div>
        <p style="color:var(--text2);margin-bottom:20px;font-size:14px;">Live chat rooms. 125 users max. 24 hours. Text only. Room admins can remove users.</p>
        <div class="channels-grid" id="sync-spaces-grid"></div>
      </div>
    </div>

    <!-- CHANNEL DETAIL VIEW -->
    <div id="view-channel-detail" class="hidden" style="padding:24px;">
      <button class="btn btn-ghost btn-sm" onclick="navigate('channels')" style="margin-bottom:16px;">← Back to Channels</button>
      <div id="channel-detail-content"></div>
    </div>

    <!-- MESSAGES VIEW -->
    <div id="view-messages" class="hidden">
      <div class="messages-layout">
        <div class="dm-list">
          <div class="section-title" style="margin-bottom:12px;font-size:16px;">Messages</div>
          <div id="dm-list-items"></div>
        </div>
        <div class="chat-area" id="chat-area">
          <div class="empty-state">
            <div class="empty-icon">💬</div>
            <div class="empty-title">Pick a conversation</div>
            <div class="empty-desc">Select someone from the left to start chatting</div>
          </div>
        </div>
      </div>
    </div>

    <!-- NOTIFICATIONS VIEW -->
    <div id="view-notifications" class="view hidden">
      <div class="section-title">🔔 Notifications</div>
      <div id="notifs-list"></div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="hidden">
      <div id="profile-content"></div>
    </div>

    <!-- EDIT PROFILE VIEW -->
    <div id="view-edit-profile" class="view hidden">
      <div class="section-title">🎨 Customize Your Page</div>
      <div class="customizer">
        <div class="customizer-title">Profile Theme Color</div>
        <div class="color-picker-row" id="theme-color-picker"></div>
        <hr class="divider">
        <div class="customizer-title">Banner Gradient</div>
        <div class="color-picker-row" id="banner-picker"></div>
        <hr class="divider">
        <div class="customizer-title">🖼️ Profile Background Image</div>
        <div class="form-group">
          <label>Background Image URL</label>
          <input type="text" id="edit-profile-background" placeholder="https://example.com/image.jpg">
          <div style="font-size:11px;color:var(--text3);margin-top:4px;">Paste an image URL to use as your profile background</div>
        </div>
        <hr class="divider">
        <div class="customizer-title">📷 Profile Picture</div>
        <div class="form-group">
          <label>Upload Image (auto-compressed)</label>
          <input type="file" accept="image/*" onchange="handleProfileImageUpload(this)" id="profile-image-input">
          <div id="profile-image-preview" style="margin-top:8px;"></div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;">Recommended: Square image. Will be auto-compressed.</div>
        </div>
        <hr class="divider">
        <div class="form-group">
          <label>🎵 Profile Song (YouTube embed URL)</label>
          <input type="text" id="edit-song-url" placeholder="https://www.youtube.com/embed/...">
        </div>
        <div class="form-group">
          <label>🎵 Song Name</label>
          <input type="text" id="edit-song-name" placeholder="Song Title">
        </div>
        <div class="form-group">
          <label>🎤 Artist Name</label>
          <input type="text" id="edit-song-artist" placeholder="Artist Name">
        </div>
        <hr class="divider">
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="edit-display-name">
        </div>
        <div class="form-group">
          <label>Bio</label>
          <textarea id="edit-bio" style="min-height:80px;"></textarea>
        </div>
        <div class="form-group">
          <label>😊 Mood Status</label>
          <div class="flex gap-2" style="flex-wrap:wrap;">
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('☀️','Living my best life')" data-mood="sunny">☀️ Sunny</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('🎵','Vibing to music')" data-mood="music">🎵 Vibing</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('😴','Need coffee')" data-mood="tired">😴 Tired</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('🔥','On fire today')" data-mood="fire">🔥 On Fire</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('✌️','Peace and love')" data-mood="peace">✌️ Peaceful</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('💫','Lost in thought')" data-mood="lost">💫 Dreaming</button>
          </div>
        </div>
        <hr class="divider">
        <div class="customizer-title">🔗 Social Links</div>
        <div class="form-group">
          <label>📸 Instagram</label>
          <input type="text" id="edit-social-instagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>🐦 Twitter/X</label>
          <input type="text" id="edit-social-twitter" placeholder="@username">
        </div>
        <div class="form-group">
          <label>📺 YouTube</label>
          <input type="text" id="edit-social-youtube" placeholder="Channel URL">
        </div>
        <div class="form-group">
          <label>🎵 TikTok</label>
          <input type="text" id="edit-social-tiktok" placeholder="@username">
        </div>
        <div class="form-group">
          <label>🎮 Twitch</label>
          <input type="text" id="edit-social-twitch" placeholder="Channel URL">
        </div>
        <div class="form-group">
          <label>💬 Discord</label>
          <input type="text" id="edit-social-discord" placeholder="Server or username">
        </div>
        <div class="form-group">
          <label>🌐 Website</label>
          <input type="text" id="edit-social-website" placeholder="https://...">
        </div>
        <hr class="divider">
        <div class="customizer-title">Top 8 Vibes</div>
        <div id="top8-editor" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;"></div>
        <hr class="divider">
        <button class="btn btn-primary" onclick="saveProfile()" style="width:100%;justify-content:center;">Save My Vibe ✨</button>
      </div>
    </div>

    <!-- MY CHANNEL VIEW -->
    <div id="view-my-channel" class="view hidden">
      <div class="section-title">📡 My Channel <button class="btn btn-primary btn-sm" onclick="openUploadVideoModal()">+ Upload</button></div>
      <div id="my-channel-content"></div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="view-admin" class="hidden">
      <div class="admin-layout">
        <div class="admin-sidebar">
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:15px;padding:8px 12px 16px;color:var(--purple);">🛡️ Owner Panel</div>
          <button class="admin-nav-item active" onclick="adminTab('dashboard',this)">📊 Dashboard</button>
          <button class="admin-nav-item" onclick="adminTab('users',this)">👥 Users</button>
          <button class="admin-nav-item" onclick="adminTab('posts',this)">📝 Posts</button>
          <button class="admin-nav-item" onclick="adminTab('channels',this)">📺 Channels</button>
          <button class="admin-nav-item" onclick="adminTab('settings',this)">⚙️ Settings</button>
        </div>
        <div class="admin-content">
          <div id="admin-tab-dashboard">
            <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:24px;margin-bottom:24px;">
              Welcome back, Owner 👑
            </div>
            <div class="admin-stat-grid" id="admin-stats"></div>
            <div class="section-title">Recent Activity</div>
            <div id="admin-activity"></div>
          </div>
          <div id="admin-tab-users" style="display:none;">
            <div class="section-title">All Users</div>
            <div id="admin-users-list"></div>
          </div>
          <div id="admin-tab-posts" style="display:none;">
            <div class="section-title">All Posts</div>
            <div id="admin-posts-list"></div>
          </div>
          <div id="admin-tab-channels" style="display:none;">
            <div class="section-title">All Channels</div>
            <div id="admin-channels-list"></div>
          </div>
          <div id="admin-tab-settings" style="display:none;">
            <div class="section-title">Platform Settings</div>
            <div class="card"><div class="card-body">
              <div class="form-group"><label>Platform Name</label><input type="text" value="VibeHub"></div>
              <div class="form-group"><label>Signup Fee ($)</label><input type="number" value="1" step="0.01"></div>
              <div class="form-group"><label>Maintenance Mode</label>
                <select><option>Off</option><option>On</option></select></div>
              <button class="btn btn-primary" onclick="toast('Settings saved!','success')">Save Settings</button>
            </div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SEARCH RESULTS VIEW -->
    <div id="view-search" class="view hidden">
      <div class="section-title">Search Results</div>
      <div id="search-results"></div>
    </div>

    <!-- MARKETPLACE VIEW -->
    <div id="view-marketplace" class="view-wide hidden">
      <div class="flex justify-between items-center" style="margin-bottom:24px;">
        <div class="section-title" style="margin-bottom:0;">🛍️ Marketplace</div>
        <button class="btn btn-primary btn-sm" onclick="showCreateProductModal()">+ List Item</button>
      </div>
      
      <div class="feed-tabs" style="margin-bottom:20px;">
        <button class="feed-tab active" onclick="switchMarketplaceTab('all', this)">✨ All</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('electronics', this)">📱 Electronics</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('clothing', this)">👕 Clothing</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('art', this)">🎨 Art</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('other', this)">📦 Other</button>
      </div>
      
      <div id="marketplace-grid" class="channels_grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;"></div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="view-settings" class="view hidden">
      <div class="section-title">⚙️ Settings</div>
      
      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="settings-display-name" onchange="updateSettingsFromForm()">
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea id="settings-bio" rows="3" onchange="updateSettingsFromForm()"></textarea>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="settings-email" onchange="updateSettingsFromForm()">
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;">🔒 Privacy</h3>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;">Profile Visibility</div>
              <div style="font-size:12px;color:var(--text3);">Allow everyone to view your profile</div>
            </div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;">Show Online Status</div>
              <div style="font-size:12px;color:var(--text3);">Let others see when you're online</div>
            </div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;">Show Vibe Score</div>
              <div style="font-size:12px;color:var(--text3);">Display your reputation score on profile</div>
            </div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;">🔔 Notifications</h3>
          <div class="settings-item">
            <div><div style="font-weight:600;">Likes</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div><div style="font-weight:600;">Comments</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div><div style="font-weight:600;">Follows</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div><div style="font-weight:600;">Messages</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;">🎨 Appearance</h3>
          <div class="settings-item">
            <div><div style="font-weight:600;">Dark Mode</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
      </div>

      <div class="card" style="border-color:rgba(239,68,68,0.3);">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;color:var(--red);">⚠️ Danger Zone</h3>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;color:var(--red);">Delete Account</div>
              <div style="font-size:12px;color:var(--text3);">Permanently delete your account and all data</div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="confirmDeleteAccount()">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DISCLAIMER VIEW -->
    <div id="view-disclaimer" class="view hidden">
      <div class="card">
        <div class="card-body" style="padding:32px;">
          <h2 style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;margin-bottom:24px;">📜 Disclaimer & Terms</h2>
          
          <div style="color:var(--text2);line-height:1.8;font-size:14px;">
            <p style="margin-bottom:16px;"><strong style="color:var(--text);">Last Updated:</strong> February 2026</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">1. User Content</h3>
            <p style="margin-bottom:12px;">All content posted by users is the responsibility of the respective user. VibeHub does not endorse or guarantee the accuracy, completeness, or quality of any user-generated content.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">2. Marketplace Transactions</h3>
            <p style="margin-bottom:12px;">VibeHub provides a platform for users to list and sell items. However, all transactions are between users directly. We are not responsible for any disputes, fraud, or issues arising from marketplace transactions.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">3. Account Security</h3>
            <p style="margin-bottom:12px;">Users are responsible for maintaining the security of their account credentials. Do not share your password with anyone.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">4. Prohibited Content</h3>
            <p style="margin-bottom:12px;">The following is prohibited: illegal content, harassment, hate speech, explicit content, spam, and malicious software. Violations may result in account termination.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">5. Modifications to Service</h3>
            <p style="margin-bottom:12px;">VibeHub reserves the right to modify or discontinue any part of the service at any time without notice.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">6. Contact</h3>
            <p style="margin-bottom:12px;">For questions about these terms, contact: support@vibehub.app</p>
            
            <div style="margin-top:32px;padding:16px;background:var(--bg3);border-radius:12px;">
              <p style="margin:0;font-size:13px;">By using VibeHub, you agree to these terms. Enjoy your time on the platform! ✌️</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STATUS CHANNELS VIEW -->
    <div id="view-status-channels" class="view-wide hidden">
      <div class="flex justify-between items-center" style="margin-bottom:24px;">
        <div class="section-title" style="margin-bottom:0;">⏰ Status Channels</div>
        <button class="btn btn-primary btn-sm" onclick="createStatusChannel()">+ New Status</button>
      </div>
      <div id="status-channels-list" class="channels_grid"></div>
    </div>

  </div><!-- end main-content -->
</div><!-- end app-shell -->

<!-- ══════════════════════════════════════
     MODALS
══════════════════════════════════════ -->

<!-- Payment Modal -->
<div id="modal-payment" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Complete Signup</div>
      <button class="close-btn" onclick="closeModal('modal-payment')">✕</button>
    </div>
    <div class="modal-body">
      <div class="payment-card-visual">
        <div class="payment-amount">$1.00</div>
        <div class="payment-desc">One-time access fee — never charged again</div>
        <div class="payment-features">
          <div class="payment-feature">Lifetime access to VibeHub</div>
          <div class="payment-feature">Full profile customization</div>
          <div class="payment-feature">Unlimited posts & channels</div>
          <div class="payment-feature">No ads. Ever.</div>
          <div class="payment-feature">Profile music player + Top 8</div>
        </div>
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:14px;" onclick="processPayment()">Pay $1 & Join VibeHub 🚀</button>
      <div style="text-align:center;margin-top:12px;font-size:12px;color:var(--text3);">You'll be redirected to complete secure payment</div>
      <div style="text-align:center;margin-top:8px;">
        <button type="button" onclick="completeRegistration()" style="background:none;border:none;color:var(--purple);cursor:pointer;font-size:13px;text-decoration:underline;">I've already paid — Complete Registration</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Channel Modal -->
<div id="modal-create-channel" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Create a Channel 📺</div>
      <button class="close-btn" onclick="closeModal('modal-create-channel')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Channel Name</label>
        <input type="text" id="channel-name-input" placeholder="e.g. Cooking with Vibes">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="channel-desc-input" placeholder="What's your channel about?"></textarea>
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="channel-category-input">
          <option>🎵 Music</option><option>🎮 Gaming</option><option>🍳 Food</option>
          <option>💄 Beauty</option><option>🏋️ Fitness</option><option>🎨 Art</option>
          <option>💻 Tech</option><option>🌍 Travel</option><option>😂 Comedy</option><option>🎭 Lifestyle</option>
        </select>
      </div>
      <div class="form-group">
        <label>Banner Emoji</label>
        <input type="text" id="channel-emoji-input" placeholder="🎵" maxlength="4" value="🎬">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="createChannel()">Create Channel ✨</button>
    </div>
  </div>
</div>

<!-- Create Product Modal -->
<div id="modal-create-product" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">List Item for Sale 🛍️</div>
      <button class="close-btn" onclick="closeModal('modal-create-product')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Item Title</label>
        <input type="text" id="product-title-input" placeholder="e.g. Vintage Jacket">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="product-desc-input" placeholder="Describe your item..."></textarea>
      </div>
      <div class="flex gap-3">
        <div class="form-group" style="flex:1;">
          <label>Price ($)</label>
          <input type="number" id="product-price-input" placeholder="25" min="1">
        </div>
        <div class="form-group" style="flex:1;">
          <label>Category</label>
          <select id="product-category-input">
            <option value="electronics">📱 Electronics</option>
            <option value="clothing">👕 Clothing</option>
            <option value="art">🎨 Art</option>
            <option value="other">📦 Other</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Image URL (optional)</label>
        <input type="text" id="product-image-input" placeholder="https://...">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="createProduct()">List Item ✨</button>
    </div>
  </div>
</div>

<!-- Audio Comment Modal -->
<div id="modal-audio-comment" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Voice Comment 🎤</div>
      <button class="close-btn" onclick="closeModal('modal-audio-comment')">✕</button>
    </div>
    <div class="modal-body" style="text-align:center;">
      <div style="background:var(--bg3);border-radius:16px;padding:32px;margin-bottom:20px;">
        <div style="font-size:48px;margin-bottom:16px;">🎤</div>
        <div id="audio-recorder-status" style="color:var(--text2);margin-bottom:16px;">🎤 Click to start recording (60s max)</div>
        <div id="audio-timer" style="font-size:24px;font-weight:700;color:var(--purple);margin-bottom:12px;">0:00</div>
        <button class="btn btn-primary" id="record-audio-btn" onclick="toggleAudioRecording()">🎤 Record</button>
      </div>
      <audio id="audio-preview" controls style="width:100%;margin-bottom:16px;display:none;"></audio>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="submitAudioComment()">Post Audio Comment ✨</button>
    </div>
  </div>
</div>

<!-- Report User Modal -->
<div id="modal-report" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">🚩 Report User</div>
      <button class="close-btn" onclick="closeModal('modal-report')">✕</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px;color:var(--text2);">Why are you reporting this user?</p>
      <div class="form-group">
        <select id="report-reason">
          <option value="">Select a reason...</option>
          <option value="harassment">Harassment or bullying</option>
          <option value="spam">Spam or fake account</option>
          <option value="inappropriate">Inappropriate content</option>
          <option value="hate">Hate speech</option>
          <option value="scam">Scam or fraud</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Additional details (optional)</label>
        <textarea id="report-details" rows="3" placeholder="Provide more context..."></textarea>
      </div>
      <button class="btn btn-danger w-full" style="justify-content:center;padding:13px;" onclick="submitReport()">Submit Report 🚩</button>
    </div>
  </div>
</div>

<!-- Collab Post Modal -->
<div id="modal-collab-post" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Request Collab 🤝</div>
      <button class="close-btn" onclick="closeModal('modal-collab-post')">✕</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px;color:var(--text2);">Invite another user to collaborate on this post!</p>
      <div class="form-group">
        <label>Username to collab with</label>
        <input type="text" id="collab-user-input" placeholder="their_handle">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="sendCollabRequest()">Send Request 🤝</button>
    </div>
  </div>
</div>

<!-- Upload Video Modal -->
<div id="modal-upload-video" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Upload to Channel 🎬</div>
      <button class="close-btn" onclick="closeModal('modal-upload-video')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Video Title</label>
        <input type="text" id="video-title-input" placeholder="Give your video a great title">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="video-desc-input" placeholder="Tell viewers what this is about..."></textarea>
      </div>
      <div class="form-group">
        <label>Thumbnail Emoji</label>
        <input type="text" id="video-emoji-input" placeholder="🎬" maxlength="4" value="🎬">
      </div>
      <div class="form-group">
        <label>Tags (comma separated)</label>
        <input type="text" id="video-tags-input" placeholder="music, chill, vibes">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="uploadVideo()">Upload Video ✨</button>
    </div>
  </div>
</div>

<!-- Top 8 Picker Modal -->
<div id="modal-top8" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Pick Top 8 Friend</div>
      <button class="close-btn" onclick="closeModal('modal-top8')">✕</button>
    </div>
    <div class="modal-body">
      <div id="top8-user-picker" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>
</div>

<!-- Admin First Setup Modal -->
<div id="modal-admin-setup" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">🛡️ Owner Setup</div>
      <button class="btn-ghost" style="position:absolute;right:16px;top:16px;font-size:20px;" onclick="dismissOwnerSetup()">×</button>
    </div>
    <div class="modal-body">
      <div style="background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text2);">
        This is the one-time owner account creation. Keep this URL private.
      </div>
      <div class="form-group">
        <label>Owner Username</label>
        <input type="text" id="setup-username" placeholder="owner_username">
      </div>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="setup-name" placeholder="Your Name">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="setup-email" placeholder="owner@vibehub.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="setup-pass" placeholder="Strong password">
      </div>
      <div class="form-group">
        <label>Recovery Phrase</label>
        <input type="text" id="setup-recovery" placeholder="3-4 words you'll remember">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="createOwnerAccount()">Create Owner Account 👑</button>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="modal-admin-login" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">🛡️ Owner Login</div>
    </div>
    <div class="modal-body">
      <div style="background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.2);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text2);">
        Enter your owner credentials to access the admin panel.
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="admin-login-user" placeholder="owner_username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="admin-login-pass" placeholder="Your password">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="doAdminLogin()">Login as Owner 🔐</button>
      <div style="text-align:center;margin-top:12px;">
        <a href="#" onclick="showPage('landing');closeModal('modal-admin-login');" style="color:var(--text3);font-size:13px;">← Back to Home</a>
      </div>
    </div>
  </div>
</div>

<!-- Comment Modal -->
<div id="modal-comments" class="modal-overlay hidden">
  <div class="modal" style="max-width:560px;">
    <div class="modal-header">
      <div class="modal-title">Comments</div>
      <button class="close-btn" onclick="closeModal('modal-comments')">✕</button>
    </div>
    <div class="modal-body" id="modal-comments-body"></div>
  </div>
</div>

<script>
// ══════════════════════════════════════
// CONSTANTS & CONFIG
// ══════════════════════════════════════
// All data stored in Supabase - no localStorage fallback
const ADMIN_SLUG = 'vibe-control-7x9kq2m';
const MAX_BETA_USERS = 10; // First 10 users get in FREE

// Square Payment Links (Production)
const SQUARE_SIGNUP_LINK = 'https://square.link/u/ROZgfUxo';
const SQUARE_MARKETPLACE_LINK = 'https://square.link/u/82tj2UXK';

// ══════════════════════════════════════
// SUPABASE CONFIG (SHARED CLIENT)
// ══════════════════════════════════════
// This file now uses simple Supabase background sync
// See initSupabaseClient() below

// ══════════════════════════════════════
// SIMPLE SUPABASE SYNC (Background)
// ══════════════════════════════════════

let supabaseClient = null;

// Initialize Supabase client
function initSupabaseClient() {
  if (supabaseClient) return supabaseClient;
  
  function tryInit() {
    if (window.supabase && window.VIBEHUB_SUPABASE_URL) {
      supabaseClient = window.supabase.createClient(
        window.VIBEHUB_SUPABASE_URL,
        window.VIBEHUB_SUPABASE_ANON_KEY
      );
      console.log('Supabase client ready');
    } else if (!window.supabaseReady) {
      setTimeout(tryInit, 100);
    }
  }
  
  if (window.supabaseReady) {
    tryInit();
  } else {
    setTimeout(tryInit, 100);
  }
  
  return supabaseClient;
}

function getSupabase() {
  if (!supabaseClient && window.supabaseReady && window.VIBEHUB_SUPABASE_URL) {
    supabaseClient = window.supabase.createClient(
      window.VIBEHUB_SUPABASE_URL,
      window.VIBEHUB_SUPABASE_ANON_KEY
    );
  }
  return supabaseClient;
}

// Run on page load
initSupabaseClient();

// PAGE ROUTING - defined early so buttons work
function showPage(page) {
  document.getElementById('page-landing').classList.add('hidden');
  document.getElementById('page-login').classList.add('hidden');
  document.getElementById('page-register').classList.add('hidden');
  document.getElementById('app-shell').classList.add('hidden');

  if (page === 'landing') { document.getElementById('page-landing').classList.remove('hidden'); if(typeof updateBetaUI==='function')updateBetaUI(); }
  else if (page === 'login') document.getElementById('page-login').classList.remove('hidden');
  else if (page === 'register') { document.getElementById('page-register').classList.remove('hidden'); if(typeof updateBetaUI==='function')updateBetaUI(); }
  else if (page === 'admin-setup') {
    if (typeof getOwnerSetup !== 'undefined' && getOwnerSetup()) { if(typeof toast==='function')toast('Owner account already created.', 'error'); showPage('login'); return; }
    document.getElementById('modal-admin-setup').classList.remove('hidden');
    document.getElementById('page-landing').classList.remove('hidden');
  }
}

// ══════════════════════════════════════
// DATA STORE (localStorage + Supabase Background Sync)
// ══════════════════════════════════════
function getDB(key, def) {
  try { return JSON.parse(localStorage.getItem('vh_' + key)) ?? def; }
  catch { return def; }
}
function setDB(key, val) {
  localStorage.setItem('vh_' + key, JSON.stringify(val));
}

function getUsers() { return getDB('users', []); }
function setUsers(users) { 
  setDB('users', users); 
  const sb = getSupabase();
  if (sb) {
    sb.from('users').upsert(users.slice(0, 50).map(u => ({
      uuid: u.id || 'u_' + Date.now() + Math.random().toString(36).substr(2, 9),
      username: u.username,
      email: u.email,
      name: u.name,
      bio: u.bio || '',
      avatar_url: u.avatar || '',
      theme: u.theme || 'purple',
      banner_url: u.banner || 'purple',
      role: u.role || 'user',
      recovery: u.recovery || '',
      paid: u.paid || false,
      isBeta: u.isBeta || false,
      owner_setup: u.owner_setup || false,
      created_at: u.joined ? new Date(u.joined).toISOString() : new Date().toISOString()
    })), { onConflict: 'uuid' }).then(() => {
      console.log('Users synced to Supabase');
    }).catch(() => {});
  }
}

function getPosts() { return getDB('posts', []); }
function setPosts(posts) { 
  setDB('posts', posts); 
  // Supabase sync disabled - tables not set up yet
  // const sb = getSupabase();
  // if (sb) { ... }
}

// Channel functions - localStorage only for now
function getChannels() { return getDB('channels', []); }
function setChannels(channels) { 
  setDB('channels', channels); 
  // Supabase sync disabled - tables not set up yet
}

// Message functions
function getMessages() { return getDB('messages', {}); }
function setMessages(messages) { 
  setDB('messages', messages); 
}

// Notification functions
function getNotifs() { return getDB('notifs', []); }
function setNotifs(notifs) { 
  setDB('notifs', notifs); 
  // Supabase sync disabled - tables not set up yet
}

// Owner setup status
function getOwnerSetup() { return getDB('owner_setup', false); }
function setOwnerSetup(v) { setDB('owner_setup', v); }
function dismissOwnerSetup() {
  setDB('owner_setup_dismissed', true);
  closeModal('modal-admin-setup');
}

// Beta users = real users (non-seed) who joined free
function getBetaCount() {
  const users = getUsers();
  return users.filter(u => u.isBeta || u.role === 'owner').length;
}
function getRealUserCount() {
  return getUsers().filter(u => u.registered).length;
}
function getBetaSlotsLeft() {
  return Math.max(0, MAX_BETA_USERS - getRealUserCount());
}
function isBetaOpen() {
  return getRealUserCount() < MAX_BETA_USERS;
}

// Session
let currentSession = getDB('session', null);

function getCurrentUser() {
  if (!currentSession) return null;
  return getUsers().find(u => u.username === currentSession);
}

function setSession(username) {
  currentSession = username;
  setDB('session', username);
}

function clearSession() {
  currentSession = null;
  setDB('session', null);
}

// Navigation history for back button
let navHistory = [];
let currentView = null;
function seedData() {
  // Check if already seeded FIRST - before clearing anything
  if (getDB('seeded', false)) return;

  // FOR DEMO: Reset posts and activity but keep users
  localStorage.removeItem('vh_posts');
  localStorage.removeItem('vh_notifs');
  localStorage.removeItem('vh_messages');
  localStorage.removeItem('vh_vibeLikes');
  localStorage.removeItem('vh_userWaves');
  localStorage.removeItem('vh_friends');
  localStorage.removeItem('vh_friendRequests');
  localStorage.removeItem('vh_products');
  localStorage.removeItem('vh_statusChannels');
  localStorage.removeItem('vh_collabPosts');
  localStorage.removeItem('vh_reputationCache');
  localStorage.removeItem('vh_momentumData');

  const users = [
    { username:'skyvibes', name:'Sky Williams', email:'sky@vibe.com', password:'pass123', bio:'Just living. 🌈 Music lover. Creator.', theme:'purple', banner:'purple', song:{url:'',name:'Blinding Lights',artist:'The Weeknd'}, mood:{emoji:'☀️',text:'Living my best life'}, top8:['neoncat','djbeatrix','cosmicray','petalrose','hackernova','the_sage','wanderlust','sunsetkim'], role:'user', joined: Date.now()-86400000*30, avatar:'🌈' },
    { username:'neoncat', name:'Neon Cat', email:'neo@vibe.com', password:'pass123', bio:'🎮 Gamer. 🐱 Cat person. 💻 Developer.', theme:'cyan', banner:'cyan', song:{url:'',name:'Levitating',artist:'Dua Lipa'}, mood:{emoji:'🎵','text':'Vibing to music'}, top8:['skyvibes','djbeatrix','hackernova','cosmicray','petalrose','the_sage','wanderlust','sunsetkim'], role:'user', joined: Date.now()-86400000*20, avatar:'🐱' },
    { username:'djbeatrix', name:'DJ Beatrix', email:'bea@vibe.com', password:'pass123', bio:'🎵 DJ. Producer. Music is life.', theme:'pink', banner:'pink', song:{url:'',name:'Stay',artist:'Kid Laroi'}, mood:{emoji:'🔥','text':'On fire today'}, top8:['skyvibes','neoncat','cosmicray','hackernova','petalrose','the_sage','wanderlust','sunsetkim'], role:'user', joined: Date.now()-86400000*15, avatar:'🎵' },
    { username:'cosmicray', name:'Cosmic Ray', email:'ray@vibe.com', password:'pass123', bio:'✨ Space nerd. Artist. Always curious.', theme:'gold', banner:'gold', song:{url:'',name:'Space Song',artist:'Beach House'}, mood:{emoji:'💫','text':'Lost in thought'}, top8:['skyvibes','neoncat','djbeatrix','hackernova','petalrose','the_sage','wanderlust','sunsetkim'], role:'user', joined: Date.now()-86400000*10, avatar:'✨' },
    { username:'petalrose', name:'Petal Rose', email:'rose@vibe.com', password:'pass123', bio:'🌹 Fashion. Beauty. Self love.', theme:'pink', banner:'pink', song:{url:'',name:'Flowers',artist:'Miley Cyrus'}, mood:{emoji:'✌️','text':'Peace and love'}, top8:['skyvibes','neoncat','djbeatrix','cosmicray','hackernova','the_sage','wanderlust','sunsetkim'], role:'user', joined: Date.now()-86400000*8, avatar:'🌹' },
    { username:'hackernova', name:'HackerNova', email:'hack@vibe.com', password:'pass123', bio:'💻 Code. Build. Ship. Repeat.', theme:'green', banner:'green', song:{url:'',name:'Unstoppable',artist:'Sia'}, mood:{emoji:'🔥','text':'On fire today'}, top8:['skyvibes','neoncat','djbeatrix','cosmicray','petalrose','the_sage','wanderlust','sunsetkim'], role:'user', joined: Date.now()-86400000*5, avatar:'💻' },
    { username:'the_sage', name:'The Sage', email:'sage@vibe.com', password:'pass123', bio:'🧠 Philosophy. Deep thoughts. Tea.', theme:'purple', banner:'purple', song:{url:'',name:'Teardrop',artist:'Massive Attack'}, mood:{emoji:'😴','text':'Need coffee'}, top8:['skyvibes','neoncat','djbeatrix','cosmicray','petalrose','hackernova','wanderlust','sunsetkim'], role:'user', joined: Date.now()-86400000*3, avatar:'🧠' },
    { username:'wanderlust', name:'Wanderlust', email:'wander@vibe.com', password:'pass123', bio:'✈️ Traveler. Storyteller. World citizen.', theme:'cyan', banner:'cyan', song:{url:'',name:'Adventure of a Lifetime',artist:'Coldplay'}, mood:{emoji:'✌️','text':'Peace and love'}, top8:['skyvibes','neoncat','djbeatrix','cosmicray','petalrose','hackernova','the_sage','sunsetkim'], role:'user', joined: Date.now()-86400000*2, avatar:'✈️' },
    { username:'sunsetkim', name:'Sunset Kim', email:'kim@vibe.com', password:'pass123', bio:'🌅 Photographer. Sunset collector.', theme:'gold', banner:'gold', song:{url:'',name:'Golden Hour',artist:'JVKE'}, mood:{emoji:'☀️','text':'Living my best life'}, top8:['skyvibes','neoncat','djbeatrix','cosmicray','petalrose','hackernova','the_sage','wanderlust'], role:'user', joined: Date.now()-86400000*1, avatar:'📸' },
  ];

  const posts = [
    { id:'p1', userId:'skyvibes', text:'Just dropped my new photography collection! Every shot is a vibe. 🌈 What do you think?', tags:['photography','art','vibes'], likes:['neoncat','djbeatrix','cosmicray','petalrose'], dislikes:[], comments:[{userId:'neoncat',text:'These are absolutely stunning!! 😍',time:Date.now()-3600000*2},{userId:'djbeatrix',text:'The colors!! Everything!',time:Date.now()-3600000}], time:Date.now()-86400000, type:'text' },
    { id:'p2', userId:'djbeatrix', text:'Just finished a 3-hour set 🎵 The energy in the room was ELECTRIC. Sometimes music is the only thing that makes sense. ✌️', tags:['music','djlife','unity'], likes:['skyvibes','neoncat','cosmicray','hackernova','the_sage'], dislikes:['wanderlust'], comments:[{userId:'skyvibes',text:'Would have LOVED to be there!!',time:Date.now()-7200000},{userId:'cosmicray',text:'Next time tag me in!! 🙏',time:Date.now()-3600000}], time:Date.now()-86400000*2, type:'text' },
    { id:'p3', userId:'neoncat', text:'Pro tip: debugging at 3am with lo-fi music hits different. Shipped a feature I\'ve been stuck on for weeks. 💻🐱 Flow state is real.', tags:['coding','developer','tech'], likes:['hackernova','skyvibes','the_sage'], dislikes:[], comments:[{userId:'hackernova',text:'Lo-fi + dark mode is literally a cheat code',time:Date.now()-1800000}], time:Date.now()-3600000*5, type:'text' },
    { id:'p4', userId:'cosmicray', text:'Nobody talks about how humbling space is. One look at the James Webb images and suddenly all my problems feel manageable. ✨🌌', tags:['space','astronomy','philosophy'], likes:['skyvibes','neoncat','djbeatrix','petalrose','the_sage','wanderlust'], dislikes:[], comments:[{userId:'the_sage',text:'This is exactly the perspective shift we all need',time:Date.now()-900000},{userId:'petalrose',text:'those webb images literally made me cry 😭',time:Date.now()-600000}], time:Date.now()-3600000*8, type:'text' },
    { id:'p5', userId:'petalrose', text:'Self care is not selfish. Repeat that. 🌹 Taking care of yourself is how you show up for others. Your energy matters.', tags:['selfcare','wellness','mentalhealth'], likes:['skyvibes','djbeatrix','wanderlust','sunsetkim','the_sage'], dislikes:[], comments:[{userId:'wanderlust',text:'Needed to read this today. Thank you 💙',time:Date.now()-1200000}], time:Date.now()-3600000*12, type:'text' },
    { id:'p6', userId:'hackernova', text:'Open source contribution #100 is LIVE! 🎉 Two years ago I was afraid to even open a PR. Consistency is the real flex. #code #OpenSource', tags:['opensource','coding','achievement'], likes:['neoncat','skyvibes','cosmicray'], dislikes:[], comments:[{userId:'neoncat',text:'THIS IS HUGE!!! Congrats!!! 🎉🎉',time:Date.now()-2400000}], time:Date.now()-3600000*3, type:'text' },
    { id:'p7', userId:'wanderlust', text:'Day 3 in Morocco. The medina in Marrakech smells like cumin and rose petals and old stories. Every alley has a secret. ✈️🌍', tags:['travel','morocco','adventure'], likes:['skyvibes','petalrose','sunsetkim','cosmicray','djbeatrix'], dislikes:[], comments:[{userId:'sunsetkim',text:'The golden hour photos from there must be INSANE',time:Date.now()-3000000}], time:Date.now()-3600000*6, type:'text' },
    { id:'p8', userId:'sunsetkim', text:'Golden hour at 6:42pm was perfect today. No filter. Just light doing what light does. 🌅📸', tags:['photography','sunset','goldenhour'], likes:['skyvibes','wanderlust','petalrose','cosmicray','neoncat','djbeatrix'], dislikes:[], comments:[{userId:'petalrose',text:'Frameable!! 😍',time:Date.now()-500000}], time:Date.now()-3600000*2, type:'text' },
    { id:'p9', userId:'the_sage', text:'Socrates said "I know that I know nothing." The more I learn, the more I realize he was right. Intellectual humility is a superpower. 🧠', tags:['philosophy','wisdom','learning'], likes:['cosmicray','skyvibes','hackernova'], dislikes:['neoncat'], comments:[{userId:'cosmicray',text:'The Dunning-Kruger effect in full display in the comments of every platform 😂',time:Date.now()-800000}], time:Date.now()-3600000*9, type:'text' },
  ];

  const channels = [
    { id:'ch1', ownerId:'djbeatrix', name:'Beatrix Beats', desc:'Weekly DJ sets, production tutorials and behind-the-scenes music content.', category:'🎵 Music', emoji:'🎵', subs:['skyvibes','neoncat','cosmicray','hackernova','sunsetkim'], videos:[
      { id:'v1', title:'Summer Mix 2025 🌴 3-Hour Deep House Set', desc:'Recorded live at Sunset Rooftop', emoji:'🎵', views:1243, time:Date.now()-86400000*5, tags:['djset','deephouse','summer'] },
      { id:'v2', title:'How I Make Beats in 30 Minutes (Production Tutorial)', desc:'My full workflow revealed', emoji:'🎬', views:892, time:Date.now()-86400000*12, tags:['tutorial','production','beats'] },
      { id:'v3', title:'Top 10 Tracks of 2025 So Far', desc:'My personal playlist picks', emoji:'🏆', views:654, time:Date.now()-86400000*3, tags:['music','playlist','2025'] },
    ]},
    { id:'ch2', ownerId:'neoncat', name:'NeonCode', desc:'Dev tutorials, coding tips and game dev projects. New video every Tuesday.', category:'💻 Tech', emoji:'💻', subs:['hackernova','skyvibes','cosmicray'], videos:[
      { id:'v4', title:'Build a Social App from Scratch (Full Tutorial)', desc:'No frameworks, pure vanilla JS', emoji:'💻', views:3219, time:Date.now()-86400000*7, tags:['coding','tutorial','javascript'] },
      { id:'v5', title:'10 VS Code Extensions That Changed My Life', desc:'Productivity unlocked', emoji:'⚡', views:1876, time:Date.now()-86400000*14, tags:['vscode','productivity','dev'] },
    ]},
    { id:'ch3', ownerId:'cosmicray', name:'Cosmic Art', desc:'Digital art speedpaints, space art and creative process videos.', category:'🎨 Art', emoji:'🎨', subs:['skyvibes','petalrose','wanderlust','djbeatrix'], videos:[
      { id:'v6', title:'Galaxy Speedpaint — 4 Hours in 20 Minutes', desc:'My most complex piece yet', emoji:'🌌', views:2104, time:Date.now()-86400000*4, tags:['art','speedpaint','galaxy'] },
    ]},
    { id:'ch4', ownerId:'wanderlust', name:'Wandering World', desc:'Travel vlogs, budget travel tips and hidden gems around the globe.', category:'🌍 Travel', emoji:'✈️', subs:['skyvibes','sunsetkim','petalrose','neoncat'], videos:[
      { id:'v7', title:'48 Hours in Marrakech — Budget Travel Guide', desc:'Everything for under $50/day', emoji:'🌍', views:4521, time:Date.now()-86400000*3, tags:['travel','morocco','budget'] },
      { id:'v8', title:'Travel Hacks That Actually Work (2025)', desc:'No clickbait, real tips', emoji:'✈️', views:3102, time:Date.now()-86400000*18, tags:['travel','tips','hacks'] },
    ]},
    { id:'ch5', ownerId:'sunsetkim', name:'Golden Lens', desc:'Photography tutorials, golden hour guides and camera reviews.', category:'📸 Lifestyle', emoji:'📸', subs:['wanderlust','petalrose','skyvibes','cosmicray'], videos:[
      { id:'v9', title:'How to Capture Perfect Golden Hour (Any Camera)', desc:'My complete process', emoji:'🌅', views:5234, time:Date.now()-86400000*6, tags:['photography','goldenhour','tutorial'] },
    ]},
  ];

  const messages = {
    'skyvibes-neoncat': [
      { from:'skyvibes', text:'Hey! Love your latest video 💙', time: Date.now()-86400000 },
      { from:'neoncat', text:'Thanks!! Been working on a new one 🐱', time: Date.now()-86400000+3600000 },
      { from:'skyvibes', text:'Can\'t wait to see it!', time: Date.now()-3600000 },
    ],
    'skyvibes-djbeatrix': [
      { from:'djbeatrix', text:'Are you coming to the show Saturday?', time: Date.now()-7200000 },
      { from:'skyvibes', text:'YES!! Front row energy 🔥', time: Date.now()-3600000 },
    ],
  };

  const notifs = [
    { id:'n1', type:'like', fromUser:'neoncat', text:'liked your post', postId:'p1', time:Date.now()-1800000, read:false },
    { id:'n2', type:'comment', fromUser:'djbeatrix', text:'commented on your post', postId:'p1', time:Date.now()-3600000, read:false },
    { id:'n3', type:'follow', fromUser:'cosmicray', text:'started following you', time:Date.now()-7200000, read:true },
    { id:'n4', type:'like', fromUser:'petalrose', text:'liked your post', postId:'p1', time:Date.now()-86400000, read:true },
  ];

  setUsers(users);
  setPosts(posts);
  setChannels(channels);
  setMessages(messages);
  setNotifs(notifs);
  setDB('seeded', true);
}

// Navigate function
function navigate(view, param) {
  // Push to history
  if (currentView && currentView !== view) {
    navHistory.push({ view: currentView, param: currentView._param });
  }
  currentView = view;
  currentView._param = param;
  updateBackBtn();

  const views = ['home','explore','channels','channel-detail','sync-spaces','messages','notifications','profile','edit-profile','my-channel','admin','search','settings'];
  views.forEach(v => {
    const el = document.getElementById('view-' + v);
    if (el) el.classList.add('hidden');
  });

  const titles = { home:'🏠 Home Feed', explore:'🔍 Explore', channels:'📺 Channels', 'sync-spaces':'💬 Sync Spaces', messages:'💬 Messages', notifications:'🔔 Notifications', profile:'👤 Profile', 'edit-profile':'🎨 Customize My Page', 'my-channel':'📡 My Channel', admin:'🛡️ Admin Panel', search:'🔍 Search', settings:'⚙️ Settings' };
  document.getElementById('topbar-title').textContent = titles[view] || 'VibeHub';

  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById('nav-' + view);
  if (navEl) navEl.classList.add('active');

  const el = document.getElementById('view-' + view);
  if (el) el.classList.remove('hidden');

  // Render logic
  if (view === 'home') renderFeed('all');
  else if (view === 'explore') renderExplore();
  else if (view === 'channels') renderChannels();
  else if (view === 'channel-detail') renderChannelDetail(param);
  else if (view === 'sync-spaces') renderSyncSpaces();
  else if (view === 'messages') renderMessages();
  else if (view === 'notifications') renderNotifications();
  else if (view === 'profile') renderProfile(param || getCurrentUser()?.username);
  else if (view === 'edit-profile') renderEditProfile();
  else if (view === 'my-channel') renderMyChannel();
  else if (view === 'settings') renderSettings();
  else if (view === 'admin') renderAdmin();
}

function navBack() {
  if (navHistory.length === 0) { navigate('home'); return; }
  const prev = navHistory.pop();
  currentView = prev.view;
  updateBackBtn();

  // Re-run navigate without adding to history
  const views = ['home','explore','channels','channel-detail','messages','notifications','profile','edit-profile','my-channel','admin','search'];
  views.forEach(v => { const el = document.getElementById('view-'+v); if (el) el.classList.add('hidden'); });
  const titles = { home:'🏠 Home Feed', explore:'🔍 Explore', channels:'📺 Channels', messages:'💬 Messages', notifications:'🔔 Notifications', profile:'👤 Profile', 'edit-profile':'🎨 Customize My Page', 'my-channel':'📡 My Channel', admin:'🛡️ Admin Panel', search:'🔍 Search' };
  document.getElementById('topbar-title').textContent = titles[prev.view] || 'VibeHub';
  const el = document.getElementById('view-' + prev.view);
  if (el) el.classList.remove('hidden');
  if (prev.view === 'home') renderFeed('all');
  else if (prev.view === 'explore') renderExplore();
  else if (prev.view === 'channels') renderChannels();
  else if (prev.view === 'profile') renderProfile(prev.param || getCurrentUser()?.username);
  else if (prev.view === 'messages') renderMessages();
  else if (prev.view === 'notifications') renderNotifications();
}

function updateBackBtn() {
  const btn = document.getElementById('back-btn');
  if (!btn) return;
  if (navHistory.length === 0 || currentView === 'home') {
    btn.classList.add('invisible');
  } else {
    btn.classList.remove('invisible');
  }
}

function bottomHomeClick() {
  const appShell = document.getElementById('app-shell');
  if (!appShell.classList.contains('hidden')) {
    navigate('home');
  } else {
    showPage('landing');
  }
}

function bottomAdminClick() {
  const appShell = document.getElementById('app-shell');
  const me = getCurrentUser();
  if (!appShell.classList.contains('hidden') && me?.role === 'owner') {
    navigate('admin');
  } else if (!appShell.classList.contains('hidden')) {
    toast('Owner access only 🛡️', 'error');
  } else {
    // On landing/auth pages — show admin setup (unless dismissed)
    if (getOwnerSetup()) {
      showPage('login');
      setTimeout(() => {
        document.getElementById('login-user').focus();
        toast('Log in with your owner account 👑', 'info');
      }, 100);
    } else if (!getDB('owner_setup_dismissed', false)) {
      document.getElementById('modal-admin-setup').classList.remove('hidden');
    }
  }
}

function updateBetaUI() {
  const slotsLeft = getBetaSlotsLeft();
  const betaOpen = slotsLeft > 0;

  // Landing nav button
  const landingBtn = document.getElementById('landing-join-btn');
  if (landingBtn) {
    landingBtn.textContent = betaOpen ? 'Create Free Beta Account' : 'Join VibeHub ($1)';
  }

  // Hero join button
  const heroBtn = document.getElementById('hero-join-btn');
  if (heroBtn) {
    heroBtn.textContent = betaOpen ? `Create Free Beta Account 🚀` : `Join VibeHub ($1) 🚀`;
  }

  // Landing beta status
  const statusEl = document.getElementById('landing-beta-status');
  if (statusEl) {
    if (betaOpen) {
      statusEl.innerHTML = `<div class="beta-badge">🎉 Beta is LIVE — <span class="beta-slots">${slotsLeft} free spot${slotsLeft !== 1 ? 's' : ''}</span> remaining!</div>`;
    } else {
      statusEl.innerHTML = `<div class="beta-badge" style="border-color:rgba(245,158,11,0.4);color:var(--gold);background:rgba(245,158,11,0.1);">✨ Beta full — join for just $1 (one time, no ads ever)</div>`;
    }
  }

  // Register page beta info
  const regInfo = document.getElementById('reg-beta-info');
  if (regInfo) {
    if (betaOpen) {
      regInfo.innerHTML = `<div class="beta-badge" style="justify-content:center;">🎉 You're getting in FREE! <span class="beta-slots">${slotsLeft} spot${slotsLeft !== 1 ? 's' : ''} left</span></div>`;
    } else {
      regInfo.innerHTML = `<div style="color:var(--text2);font-size:13px;margin-bottom:4px;">Beta is full — one-time $1 to join</div>`;
    }
  }

  // Register submit button
  const regBtn = document.getElementById('reg-submit-btn');
  if (regBtn) {
    regBtn.textContent = betaOpen ? 'Create Free Beta Account 🚀' : 'Continue to Payment ($1) →';
  }

  // Bottom admin button - show 👑 if owner
  const me = getCurrentUser();
  const adminBtn = document.getElementById('bottom-admin-btn');
  if (adminBtn && me?.role === 'owner') {
    adminBtn.innerHTML = '👑 Admin Panel';
    adminBtn.style.background = 'rgba(245,158,11,0.2)';
  }
}

function handleRegisterSubmit() {
  if (isBetaOpen()) {
    doRegisterFree();
  } else {
    showPaymentModal();
  }
}

async function doRegisterFree() {
  const username = document.getElementById('reg-user').value.trim();
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  const bio = document.getElementById('reg-bio').value.trim();

  if (!username || !name || !email || !pass) { toast('Fill in all fields first', 'error'); return; }
  if (pass.length < 6) { toast('Password must be at least 6 characters', 'error'); return; }

  const users = getUsers();
  if (users.find(u => u.username === username)) { toast('Username already taken', 'error'); return; }
  if (users.find(u => u.email === email)) { toast('Email already registered', 'error'); return; }

  const newUser = {
    username, name, email, password: pass, bio,
    theme: 'purple', banner: 'purple',
    song: { url:'', name:'', artist:'' },
    mood: { emoji:'✌️', text:'Just joined VibeHub!' },
    top8: [],
    role: 'user',
    isBeta: true,
    paid: true,
    registered: true,
    joined: Date.now(),
    avatar: name[0]?.toUpperCase() || '?'
  };

  users.push(newUser);
  setUsers(users);
  setSession(username);
  launchApp();
  toast('🎉 Welcome to the VibeHub Beta, ' + name + '! You got in FREE!', 'success');

  const notifs = getNotifs();
  notifs.unshift({ id: 'n_welcome', type:'system', text:'🎉 Welcome to the VibeHub Beta! You\'re one of the first. Customize your page and start vibing! ✌️', time: Date.now(), read: false });
  setNotifs(notifs);
}

function handleSearch(val) {
  if (!val.trim()) return;
  navigate('search');
  renderSearch(val.trim());
}

// ══════════════════════════════════════
// AUTH
// ══════════════════════════════════════
function doLogin() {
  const userVal = document.getElementById('login-user').value.trim();
  const pass = document.getElementById('login-pass').value;
  const stayLoggedIn = document.getElementById('stay-logged-in')?.checked;

  if (!userVal || !pass) { toast('Fill in all fields', 'error'); return; }

  const users = getUsers();
  const user = users.find(u => (u.username === userVal || u.email === userVal) && u.password === pass);

  if (!user) { toast('Wrong username or password', 'error'); return; }

  // Handle stay logged in
  if (stayLoggedIn) {
    localStorage.setItem('vh_stay_logged_in', 'true');
  } else {
    localStorage.removeItem('vh_stay_logged_in');
  }

  setSession(user.username);
  launchApp();
  toast('Welcome back, ' + user.name + '! ✌️', 'success');
}

function showPaymentModal() {
  const username = document.getElementById('reg-user').value.trim();
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;

  if (!username || !name || !email || !pass) { toast('Fill in all fields first', 'error'); return; }
  if (pass.length < 6) { toast('Password must be at least 6 characters', 'error'); return; }

  const users = getUsers();
  if (users.find(u => u.username === username)) { toast('Username already taken', 'error'); return; }
  if (users.find(u => u.email === email)) { toast('Email already registered', 'error'); return; }

  document.getElementById('modal-payment').classList.remove('hidden');
}

function processPayment() {
  // Open Square payment link in new tab
  window.open(SQUARE_SIGNUP_LINK, '_blank');
  toast('Please complete payment in the new window, then return and click "I\'ve already paid"', 'info');
}

async function completeRegistration() {
  const username = document.getElementById('reg-user').value.trim();
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  const bio = document.getElementById('reg-bio').value.trim();

  const newUser = {
    username, name, email, password: pass, bio,
    theme: 'purple', banner: 'purple',
    song: { url:'', name:'', artist:'' },
    mood: { emoji:'✌️', text:'Just joined VibeHub!' },
    top8: [],
    role: 'user',
    registered: true,
    paid: true,
    isBeta: false,
    joined: Date.now(),
    avatar: name[0]?.toUpperCase() || '?'
  };

  const users = getUsers();
  users.push(newUser);
  setUsers(users);

  setSession(username);
  launchApp();
  toast('Welcome to VibeHub, ' + name + '! 🎉', 'success');

  // Add welcome notification
  const notifs = getNotifs();
  notifs.unshift({ id: 'n_welcome', type:'system', text:'Welcome to VibeHub! Customize your page and start vibing. ✌️', time: Date.now(), read: false });
  setNotifs(notifs);
}

function createOwnerAccount() {
  const username = document.getElementById('setup-username').value.trim();
  const name = document.getElementById('setup-name').value.trim();
  const email = document.getElementById('setup-email').value.trim();
  const pass = document.getElementById('setup-pass').value;
  const recovery = document.getElementById('setup-recovery').value.trim();

  if (!username || !name || !email || !pass || !recovery) { toast('Fill all fields', 'error'); return; }

  const users = getUsers();
  if (users.find(u => u.username === username)) { toast('Username taken', 'error'); return; }

  const owner = {
    id: 'owner_' + Date.now(),
    username, name, email, password: pass, bio: 'Platform owner 👑',
    theme: 'gold', banner: 'gold',
    song: { url:'', name:'', artist:'' },
    mood: { emoji:'👑', text:'Running the show' },
    top8: [],
    role: 'owner',
    recovery,
    joined: Date.now(),
    avatar: '👑',
    owner_setup: true
  };

  users.push(owner);
  setUsers(users);
  
  // Save directly to Supabase immediately
  const sb = getSupabase();
  if (sb) {
    sb.from('users').upsert({
      uuid: owner.id,
      username: owner.username,
      email: owner.email,
      name: owner.name,
      bio: owner.bio,
      avatar_url: owner.avatar,
      theme: owner.theme,
      banner_url: owner.banner,
      role: owner.role,
      recovery: owner.recovery,
      paid: true,
      isBeta: true,
      owner_setup: true,
      created_at: new Date().toISOString()
    }, { onConflict: 'uuid' }).then(() => {
      console.log('Owner saved to Supabase');
    }).catch((err) => {
      console.error('Failed to save owner to Supabase:', err);
    });
  }
  
  setOwnerSetup(true);

  closeModal('modal-admin-setup');
  setSession(username);
  launchApp();
  toast('Owner account created! Welcome, ' + name + ' 👑', 'success');
}

function doAdminLogin() {
  const username = document.getElementById('admin-login-user').value.trim();
  const pass = document.getElementById('admin-login-pass').value;

  if (!username || !pass) { toast('Enter username and password', 'error'); return; }

  // Query Supabase for user
  const sb = getSupabase();
  if (sb) {
    sb.from('users').select('*').then(({ data, error }) => {
      if (error) {
        console.error('Error fetching from Supabase:', error);
        // Fallback to localStorage
        checkLocalUsers();
        return;
      }
      // Check using recovery phrase (password not stored in Supabase)
      const user = data?.find(u => u.username === username && u.recovery === pass);
      if (!user) { toast('Invalid credentials', 'error'); return; }
      if (user.role !== 'owner') { toast('Only owner can login here', 'error'); return; }
      
      // Success - login
      closeModal('modal-admin-login');
      setSession(username);
      // Also save to localStorage
      const localUsers = getUsers();
      if (!localUsers.find(u => u.username === username)) {
        localUsers.push({...user, password: pass});
        setUsers(localUsers);
      }
      launchApp();
      navigate('admin');
      toast('Welcome back, ' + user.name + ' 👑', 'success');
    });
  } else {
    // Supabase not ready, check local
    checkLocalUsers();
  }
  
  function checkLocalUsers() {
    const users = getUsers();
    const user = users.find(u => u.username === username && u.password === pass);
    if (!user) { toast('Invalid credentials', 'error'); return; }
    if (user.role !== 'owner') { toast('Only owner can login here', 'error'); return; }
    closeModal('modal-admin-login');
    setSession(username);
    launchApp();
    navigate('admin');
    toast('Welcome back, ' + user.name + ' 👑', 'success');
  }
}

function doLogout() {
  localStorage.removeItem('vh_stay_logged_in');
  clearSession();

  // Also sign out from Clerk so auth state is cleared across devices
  if (window.vhAuth && typeof window.vhAuth.signOut === 'function') {
    window.vhAuth.signOut();
  }

  // Clear any demo session if running in demo mode
  if (window.vhAuth && typeof window.vhAuth.clearDemoSession === 'function') {
    window.vhAuth.clearDemoSession();
  }

  showPage('landing');
}

function launchApp() {
  showPage('_');
  document.getElementById('app-shell').classList.remove('hidden');
  updateSidebarUser();
  updateBetaUI();
  navHistory = [];
  document.getElementById('msg-badge').style.display = 'flex';
  navigate('home');
}

function updateSidebarUser() {
  const user = getCurrentUser();
  if (!user) return;
  const av = document.getElementById('sidebar-avatar');
  av.textContent = user.avatar || user.name[0];
  document.getElementById('sidebar-name').textContent = user.name;
  document.getElementById('sidebar-handle').textContent = '@' + user.username;

  if (user.role === 'owner') {
    document.getElementById('admin-section').style.display = '';
    document.getElementById('nav-admin').classList.remove('hidden');
  }
}

// ══════════════════════════════════════
// FEED RENDERING
// ══════════════════════════════════════
function switchFeedTab(tab, btn) {
  document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderFeed(tab);
}

let postImageData = null;
let postVideoData = null;

function handlePostImage(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    postImageData = e.target.result;
    postVideoData = null;
    document.getElementById('composer-preview').innerHTML = `<img src="${e.target.result}" style="max-height:200px;border-radius:8px;margin-top:4px;">`;
  };
  reader.readAsDataURL(file);
}

function handlePostVideo(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    postVideoData = e.target.result;
    postImageData = null;
    document.getElementById('composer-preview').innerHTML = `<video src="${e.target.result}" controls style="max-height:200px;border-radius:8px;margin-top:4px;width:100%;"></video>`;
  };
  reader.readAsDataURL(file);
}

function addTagToComposer() {
  const tag = prompt('Add a tag (without #):');
  if (tag) {
    const input = document.getElementById('post-composer-input');
    input.value += ' #' + tag.replace(/\s/g,'').toLowerCase();
  }
}

function addMoodToComposer() {
  const moods = ['☀️','🔥','✌️','💫','😴','🎵','💻','🌍','📸','🎨'];
  const mood = moods[Math.floor(Math.random() * moods.length)];
  const input = document.getElementById('post-composer-input');
  input.value += ' ' + mood;
}

async function createPost() {
  const text = document.getElementById('post-composer-input').value.trim();
  if (!text && !postImageData && !postVideoData) { toast('Write something first!', 'error'); return; }

  const user = getCurrentUser();
  const tags = (text.match(/#(\w+)/g) || []).map(t => t.slice(1));

  const post = {
    id: 'p_' + Date.now(),
    userId: user.username,
    text,
    tags,
    likes: [],
    dislikes: [],
    comments: [],
    time: Date.now(),
    type: postVideoData ? 'video' : postImageData ? 'image' : 'text',
    imageData: postImageData,
    videoData: postVideoData
  };

  const posts = getPosts();
  posts.unshift(post);
  setPosts(posts);

  document.getElementById('post-composer-input').value = '';
  document.getElementById('composer-preview').innerHTML = '';
  postImageData = null;
  postVideoData = null;

  renderFeed('all');
  toast('Vibe posted! ✌️', 'success');
}

function renderFeed(tab) {
  const container = document.getElementById('feed-posts');
  let posts = getPosts();
  const user = getCurrentUser();

  // Update composer avatar
  const av = document.getElementById('composer-avatar');
  if (av && user) av.textContent = user.avatar || user.name[0];

  if (tab === 'friends') {
    posts = posts.filter(p => user.top8?.includes(p.userId) || p.userId === user.username);
  } else if (tab === 'trending') {
    posts = [...posts].sort((a,b) => {
      const calcScore = (p) => {
        const reactions = p.reactions || {};
        const capCount = reactions.cap?.length || 0;
        const relateCount = reactions.relate?.length || 0;
        const wildCount = reactions.wild?.length || 0;
        const factsCount = reactions.facts?.length || 0;
        const commentReactions = p.comments?.reduce((sum, c) => {
          return sum + (c.reactions?.like?.length || 0) + (c.reactions?.relate?.length || 0);
        }, 0) || 0;
        
        return (p.likes.length * 2) + (p.dislikes.length * 1) + 
               (p.comments.length * 5) + (capCount * 3) + 
               (relateCount * 4) + (wildCount * 3) + 
               (factsCount * 3) + commentReactions +
               (getVibeLikeCount(p.userId) * 2) + 
               (getTop8VibesCount(p.userId) * 3);
      };
      return calcScore(b) - calcScore(a);
    });
  }

  if (posts.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">✨</div><div class="empty-title">No vibes yet</div><div class="empty-desc">Be the first to post!</div></div>`;
    return;
  }

  container.innerHTML = posts.map(p => renderPostCard(p)).join('');
}

function renderPostCard(post, isFeatured = false) {
  const users = getUsers();
  const user = users.find(u => u.username === post.userId);
  const me = getCurrentUser();
  if (!user) return '';

  const liked = post.likes.includes(me?.username);
  const disliked = post.dislikes.includes(me?.username);
  const capped = post.reactions?.cap?.includes(me?.username);
  const related = post.reactions?.relate?.includes(me?.username);
  const wilded = post.reactions?.wild?.includes(me?.username);
  const factsed = post.reactions?.facts?.includes(me?.username);
  const timeAgo = getTimeAgo(post.time);

  const isMyPost = me?.username === post.userId;
  const isPinned = isMyPost && (me.featuredPosts || []).includes(post.id);
  const canPin = isMyPost && (!me.featuredPosts || me.featuredPosts.length < 3);

  const mediaHtml = post.type === 'image' && post.imageData
    ? `<div class="post-media"><img src="${post.imageData}" alt="post image" loading="lazy"></div>`
    : post.type === 'video' && post.videoData
    ? `<div class="post-media"><video src="${post.videoData}" controls></video></div>`
    : '';

  const tagsHtml = post.tags?.length
    ? `<div class="post-tags">${post.tags.map(t => `<span class="post-tag" onclick="handleSearch('${t}')">#${t}</span>`).join('')}</div>`
    : '';

  const topComment = post.comments[post.comments.length - 1];
  const topCommentUser = topComment ? users.find(u => u.username === topComment.userId) : null;

  const commentPreview = topComment && topCommentUser ? `
    <div class="post-comments" style="padding-top:8px;">
      <div class="comment">
        <div class="avatar avatar-sm" style="font-size:12px;">${topCommentUser.avatar || topCommentUser.name[0]}</div>
        <div class="comment-body">
          <span class="comment-author" onclick="navigate('profile','${topCommentUser.username}')" style="cursor:pointer;">${topCommentUser.name}</span>
          <span class="comment-text">${escHtml(topComment.text)}</span>
        </div>
      </div>
      ${post.comments.length > 1 ? `<div style="font-size:12px;color:var(--text3);padding-left:46px;cursor:pointer;" onclick="openComments('${post.id}')">View all ${post.comments.length} comments</div>` : ''}
    </div>
  ` : '';

  return `
    <div class="post-card" id="post-${post.id}">
      <div class="post-header">
        <div class="avatar avatar-sm" onclick="navigate('profile','${user.username}')" style="cursor:pointer;">${user.avatar || user.name[0]}</div>
        <div class="post-user-info">
          <div class="post-user-name" onclick="navigate('profile','${user.username}')">${user.name} ${user.role === 'owner' ? '<span class="verified" title="Platform Owner">👑</span>' : ''}${isPinned ? ' <span style="color:var(--gold);" title="Featured">⭐</span>' : ''}</div>
          <div class="post-meta">@${user.username} · ${timeAgo}</div>
        </div>
        <div style="display:flex;gap:4px;">
          ${canPin ? `<button class="btn btn-ghost btn-sm" onclick="togglePinPost('${post.id}')" style="color:var(--text3);" title="Pin to profile">📌</button>` : ''}
          ${isPinned ? `<button class="btn btn-ghost btn-sm" onclick="togglePinPost('${post.id}')" style="color:var(--gold);" title="Unpin">⭐</button>` : ''}
          ${me?.username === post.userId || me?.role === 'owner'
            ? `<button class="btn btn-ghost btn-sm" onclick="deletePost('${post.id}')" style="color:var(--text3);">✕</button>` : ''}
        </div>
      </div>
      ${post.text ? `<div class="post-body">${escHtml(post.text).replace(/#(\w+)/g, '<span class="post-tag" onclick="handleSearch(\'$1\')">#$1</span>')}</div>` : ''}
      ${mediaHtml}
      ${tagsHtml}
      <div class="post-actions">
        <button class="post-action ${liked ? 'liked' : ''}" onclick="toggleReaction('${post.id}','like')">
          👍 <span>${post.likes.length}</span>
        </button>
        <button class="post-action ${disliked ? 'disliked' : ''}" onclick="toggleReaction('${post.id}','dislike')">
          👎 <span>${post.dislikes.length}</span>
        </button>
        <button class="post-action ${capped ? 'cap-react' : ''}" onclick="toggleReaction('${post.id}','cap')">
          🤥 <span>${post.reactions?.cap?.length || 0}</span>
        </button>
        <button class="post-action ${related ? 'relate-react' : ''}" onclick="toggleReaction('${post.id}','relate')">
          🙌 <span>${post.reactions?.relate?.length || 0}</span>
        </button>
        <button class="post-action ${wilded ? 'wild-react' : ''}" onclick="toggleReaction('${post.id}','wild')">
          🦄 <span>${post.reactions?.wild?.length || 0}</span>
        </button>
        <button class="post-action ${factsed ? 'facts-react' : ''}" onclick="toggleReaction('${post.id}','facts')">
          📢 <span>${post.reactions?.facts?.length || 0}</span>
        </button>
        <button class="post-action commented" onclick="openComments('${post.id}')">
          💬 <span>${post.comments.length}</span>
        </button>
        <button class="post-action" onclick="sharePost('${post.id}')">🔗 Share</button>
      </div>
      ${commentPreview}
    </div>
  `;
}

function toggleReaction(postId, type) {
  const me = getCurrentUser();
  if (!me) return;
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  const liked = post.likes.includes(me.username);
  const disliked = post.dislikes.includes(me.username);

  if (type === 'like') {
    if (liked) { post.likes = post.likes.filter(u => u !== me.username); }
    else {
      post.likes.push(me.username);
      post.dislikes = post.dislikes.filter(u => u !== me.username);
      if (post.userId !== me.username) addNotif(post.userId, 'like', me.username, 'liked your post', postId);
    }
  } else if (type === 'dislike') {
    if (disliked) { post.dislikes = post.dislikes.filter(u => u !== me.username); }
    else {
      post.dislikes.push(me.username);
      post.likes = post.likes.filter(u => u !== me.username);
    }
  } else {
    // New reactions: cap, relate, wild, facts
    if (!post.reactions) post.reactions = {};
    if (!post.reactions[type]) post.reactions[type] = [];
    
    const arr = post.reactions[type];
    const idx = arr.indexOf(me.username);
    
    if (idx > -1) {
      arr.splice(idx, 1);
    } else {
      arr.push(me.username);
      if (post.userId !== me.username) {
        const notifText = { cap: 'called cap on', relate: 'related to', wild: 'said was wild about', facts: 'dropped facts on' };
        addNotif(post.userId, type, me.username, notifText[type] + ' your post', postId);
      }
    }
  }

  setPosts(posts);
  const el = document.getElementById('post-' + postId);
  if (el) el.outerHTML = renderPostCard(post);
}

function deletePost(postId) {
  if (!confirm('Delete this post?')) return;
  const posts = getPosts().filter(p => p.id !== postId);
  setPosts(posts);
  const el = document.getElementById('post-' + postId);
  if (el) el.remove();
  toast('Post deleted', 'success');
}

function togglePinPost(postId) {
  const me = getCurrentUser();
  if (!me) return;
  
  const users = getUsers();
  const idx = users.findIndex(u => u.username === me.username);
  if (idx === -1) return;
  
  let featured = users[idx].featuredPosts || [];
  const isPinned = featured.includes(postId);
  
  if (isPinned) {
    featured = featured.filter(id => id !== postId);
    users[idx].featuredPosts = featured;
    setUsers(users);
    setSession(me.username);
    toast('Post unpinned', 'success');
  } else {
    if (featured.length >= 3) {
      toast('Maximum 3 featured posts. Unpin one first.', 'error');
      return;
    }
    featured.push(postId);
    users[idx].featuredPosts = featured;
    setUsers(users);
    setSession(me.username);
    toast('Post pinned to profile! ⭐', 'success');
  }
  
  renderProfile(me.username);
}

function sharePost(postId) {
  navigator.clipboard?.writeText(window.location.href + '?post=' + postId)
    .then(() => toast('Link copied!', 'success'))
    .catch(() => toast('Post #' + postId + ' — share link ready!', 'success'));
  toast('Share link copied to clipboard!', 'success');
}

function openComments(postId) {
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  const users = getUsers();
  const me = getCurrentUser();
  if (!post) return;

  function renderComment(c, depth = 0, parentIndex = null) {
    const cu = users.find(u => u.username === c.userId);
    const cLiked = c.reactions?.like?.includes(me?.username);
    const cRelated = c.reactions?.relate?.includes(me?.username);
    const cLikeCount = c.reactions?.like?.length || 0;
    const cRelateCount = c.reactions?.relate?.length || 0;
    const maxDepth = 2;
    
    let repliesHtml = '';
    if (c.replies && c.replies.length > 0 && depth < maxDepth) {
      repliesHtml = c.replies.map(r => renderComment(r, depth + 1)).join('');
    }
    
    return `
      <div class="comment" style="padding:8px 0;border-bottom:1px solid var(--border);${depth > 0 ? 'margin-left:24px;border-left:2px solid var(--purple);padding-left:12px;' : ''}">
        <div class="avatar avatar-sm" style="font-size:12px;cursor:pointer;" onclick="navigate('profile','${c.userId}')">${cu?.avatar || cu?.name[0] || '?'}</div>
        <div class="comment-body">
          <span class="comment-author" style="cursor:pointer;" onclick="navigate('profile','${c.userId}')">${cu?.name || c.userId}</span>
          ${c.audio ? `<audio controls src="${c.audio}" style="width:100%;height:32px;margin:4px 0;"></audio>` : ''}
          <span class="comment-text">${escHtml(c.text)}</span>
          <div class="comment-reactions" style="margin-top:4px;display:flex;gap:8px;align-items:center;">
            <button class="comment-reaction-btn ${cLiked ? 'active' : ''}" onclick="toggleCommentReaction('${postId}','${c.userId}',${c.time},'like')">
              ❤️ ${cLikeCount}
            </button>
            <button class="comment-reaction-btn ${cRelated ? 'active' : ''}" onclick="toggleCommentReaction('${postId}','${c.userId}',${c.time},'relate')">
              🙌 ${cRelateCount}
            </button>
            ${depth < maxDepth ? `<button class="comment-reply-btn" onclick="showReplyInput('${postId}','${c.userId}',${c.time})">💬 Reply</button>` : ''}
            ${c.audio ? '<span style="font-size:10px;background:var(--purple2);color:#fff;padding:2px 6px;border-radius:4px;">🎤</span>' : ''}
            <span class="comment-time">${getTimeAgo(c.time)}</span>
          </div>
          <div class="reply-input-area" id="reply-input-${postId}-${c.userId}-${c.time}" style="display:none;margin-top:8px;">
            <input type="text" id="reply-text-${postId}-${c.userId}-${c.time}" placeholder="Write a reply..." style="border-radius:20px;padding:8px 12px;font-size:13px;">
            <button class="btn btn-primary btn-sm" onclick="submitReply('${postId}','${c.userId}',${c.time})">Reply</button>
            <button class="btn btn-ghost btn-sm" onclick="showReplyInput('${postId}','${c.userId}',${c.time})">Cancel</button>
          </div>
        </div>
      </div>
      ${repliesHtml}
    `;
  }

  const commentsHtml = post.comments.length
    ? post.comments.map((c, idx) => renderComment(c, 0)).join('')
    : '<div class="empty-state" style="padding:24px;"><div class="empty-icon">💬</div><div class="empty-desc">No comments yet. Be first!</div></div>';

  document.getElementById('modal-comments-body').innerHTML = `
    <div style="max-height:300px;overflow-y:auto;margin-bottom:16px;">${commentsHtml}</div>
    <div class="comment-input-row">
      <div class="avatar avatar-sm" style="font-size:12px;">${me?.avatar || me?.name[0]}</div>
      <input type="text" id="comment-input-${postId}" placeholder="Add a comment..." style="border-radius:50px;">
      <button class="btn btn-primary btn-sm" onclick="submitComment('${postId}')">Post</button>
      <button class="btn btn-outline btn-sm" onclick="showAudioCommentModal('${postId}')" title="Voice comment">🎤</button>
    </div>
  `;
  document.getElementById('modal-comments').classList.remove('hidden');
}

function showReplyInput(postId, userId, timestamp) {
  const el = document.getElementById(`reply-input-${postId}-${userId}-${timestamp}`);
  if (el) {
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
    if (el.style.display === 'block') {
      const input = document.getElementById(`reply-text-${postId}-${userId}-${timestamp}`);
      if (input) input.focus();
    }
  }
}

function submitReply(postId, userId, timestamp) {
  const text = document.getElementById(`reply-text-${postId}-${userId}-${timestamp}`)?.value.trim();
  if (!text) return;
  
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;
  
  const parentComment = post.comments.find(c => c.userId === userId && c.time === timestamp);
  if (!parentComment) return;
  
  if (!parentComment.replies) parentComment.replies = [];
  parentComment.replies.push({ userId: me.username, text, time: Date.now() });
  
  setPosts(posts);
  openComments(postId);
  toast('Reply posted!', 'success');
}

function submitComment(postId) {
  const text = document.getElementById('comment-input-' + postId)?.value.trim();
  if (!text) return;
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  post.comments.unshift({ userId: me.username, text, time: Date.now(), replies: [] });
  setPosts(posts);
  if (post.userId !== me.username) addNotif(post.userId, 'comment', me.username, 'commented on your post', postId);

  openComments(postId);
  toast('Comment posted!', 'success');
}

function toggleCommentReaction(postId, userId, timestamp, type) {
  if (!currentSession) { toast('Log in to react', 'error'); return; }
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;
  
  const comment = post.comments.find(c => c.userId === userId && c.time === timestamp);
  if (!comment) {
    // Check replies
    for (const c of post.comments) {
      if (c.replies) {
        const reply = c.replies.find(r => r.userId === userId && r.time === timestamp);
        if (reply) {
          if (!reply.reactions) reply.reactions = {};
          if (!reply.reactions[type]) reply.reactions[type] = [];
          const arr = reply.reactions[type];
          const idx = arr.indexOf(me.username);
          if (idx > -1) arr.splice(idx, 1);
          else arr.push(me.username);
          setPosts(posts);
          openComments(postId);
          return;
        }
      }
    }
    return;
  }
  
  if (!comment.reactions) comment.reactions = {};
  if (!comment.reactions[type]) comment.reactions[type] = [];
  
  const arr = comment.reactions[type];
  const idx = arr.indexOf(me.username);
  if (idx > -1) arr.splice(idx, 1);
  else arr.push(me.username);
  
  setPosts(posts);
  openComments(postId);
}

// ══════════════════════════════════════
// EXPLORE
// ══════════════════════════════════════
function renderExplore() {
  const posts = getPosts();
  const users = getUsers();

  // Trending tags
  const tagCounts = {};
  posts.forEach(p => p.tags?.forEach(t => { tagCounts[t] = (tagCounts[t] || 0) + 1; }));
  const sorted = Object.entries(tagCounts).sort((a,b) => b[1]-a[1]).slice(0,16);
  document.getElementById('trending-tags').innerHTML = sorted.map(([tag, count]) =>
    `<div class="trend-tag" onclick="handleSearch('${tag}')">#${tag} <span class="tag-count">${count} posts</span></div>`
  ).join('');

  // Creators
  const creators = [...users].sort((a,b) => {
    const aP = posts.filter(p => p.userId === a.username).length;
    const bP = posts.filter(p => p.userId === b.username).length;
    return bP - aP;
  }).slice(0, 8);

  document.getElementById('creator-grid').innerHTML = creators.map(u => `
    <div class="creator-card" onclick="navigate('profile','${u.username}')">
      <div class="avatar avatar-md" style="margin:0 auto;">${u.avatar || u.name[0]}</div>
      <div class="creator-name">${u.name}</div>
      <div class="creator-handle">@${u.username}</div>
      <div class="creator-subs">${posts.filter(p => p.userId === u.username).length} posts</div>
    </div>
  `).join('');

  // Explore posts
  const explorePosts = [...posts].sort((a,b) => (b.likes.length + b.comments.length) - (a.likes.length + a.comments.length)).slice(0, 10);
  document.getElementById('explore-posts').innerHTML = explorePosts.map(p => renderPostCard(p)).join('');
}

// ══════════════════════════════════════
// CHANNELS
// ══════════════════════════════════════
function renderChannels() {
  const channels = getChannels();
  const users = getUsers();
  const me = getCurrentUser();

  document.getElementById('channels-grid').innerHTML = channels.map(ch => {
    const owner = users.find(u => u.username === ch.ownerId);
    const subbed = ch.subs.includes(me?.username);
    return `
      <div class="channel-card" onclick="navigate('channel-detail','${ch.id}')">
        <div class="channel-banner theme-${owner?.banner || 'purple'}" style="display:flex;align-items:center;justify-content:center;font-size:48px;height:120px;">
          ${ch.emoji}
        </div>
        <div class="channel-info">
          <div class="channel-name">${ch.name}</div>
          <div class="channel-desc">${ch.desc}</div>
          <div class="channel-meta">
            <div class="channel-subs">👥 ${ch.subs.length} subscribers · ${ch.videos?.length || 0} videos</div>
            <button class="btn btn-sm ${subbed ? 'btn-outline' : 'btn-primary'}" onclick="event.stopPropagation();toggleSubscribe('${ch.id}')">
              ${subbed ? 'Subscribed ✓' : 'Subscribe'}
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('') + (channels.length === 0 ? '<div class="empty-state"><div class="empty-icon">📺</div><div class="empty-title">No channels yet</div><div class="empty-desc">Be the first to create one!</div></div>' : '');
}

function renderChannelDetail(channelId) {
  const channels = getChannels();
  const ch = channels.find(c => c.id === channelId);
  if (!ch) { navigate('channels'); return; }

  const users = getUsers();
  const owner = users.find(u => u.username === ch.ownerId);
  const me = getCurrentUser();
  const subbed = ch.subs.includes(me?.username);

  document.getElementById('topbar-title').textContent = ch.name;

  document.getElementById('channel-detail-content').innerHTML = `
    <div class="profile-banner theme-${owner?.banner || 'purple'}" style="display:flex;align-items:flex-end;padding:24px;gap:16px;">
      <div style="font-size:64px;">${ch.emoji}</div>
      <div>
        <h1 style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;">${ch.name}</h1>
        <div style="color:var(--text2);font-size:14px;">${ch.category} · ${ch.subs.length} subscribers · ${ch.videos?.length || 0} videos</div>
      </div>
    </div>
    <div style="padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="avatar avatar-sm">${owner?.avatar || owner?.name[0]}</div>
        <div>
          <div style="font-weight:600;">${owner?.name}</div>
          <div style="font-size:12px;color:var(--text3);">@${owner?.username}</div>
        </div>
      </div>
      <button class="btn ${subbed ? 'btn-outline' : 'btn-primary'}" onclick="toggleSubscribe('${ch.id}');renderChannelDetail('${ch.id}')">
        ${subbed ? '✓ Subscribed' : 'Subscribe'}
      </button>
    </div>
    <div style="font-size:14px;color:var(--text2);margin-bottom:20px;">${ch.desc}</div>
    <div class="section-title">Videos</div>
    <div class="video-grid">
      ${(ch.videos || []).map(v => `
        <div class="video-thumb" onclick="toast('Video player coming soon! 🎬','success')">
          <div class="video-preview">
            <span style="font-size:40px;">${v.emoji}</span>
            <div class="video-play-overlay">▶</div>
          </div>
          <div class="video-info">
            <div class="video-title">${v.title}</div>
            <div class="video-meta">${v.views.toLocaleString()} views · ${getTimeAgo(v.time)}</div>
          </div>
        </div>
      `).join('')}
    </div>
    ${!ch.videos?.length ? '<div class="empty-state"><div class="empty-icon">🎬</div><div class="empty-title">No videos yet</div></div>' : ''}
  `;
}

function toggleSubscribe(channelId) {
  const channels = getChannels();
  const ch = channels.find(c => c.id === channelId);
  const me = getCurrentUser();
  if (!ch || !me) return;

  const idx = ch.subs.indexOf(me.username);
  if (idx === -1) {
    ch.subs.push(me.username);
    toast('Subscribed to ' + ch.name + '!', 'success');
  } else {
    ch.subs.splice(idx, 1);
    toast('Unsubscribed from ' + ch.name, 'success');
  }
  setChannels(channels);
  renderChannels();
}

function openCreateChannelModal() {
  document.getElementById('modal-create-channel').classList.remove('hidden');
}

function createChannel() {
  const name = document.getElementById('channel-name-input').value.trim();
  const desc = document.getElementById('channel-desc-input').value.trim();
  const category = document.getElementById('channel-category-input').value;
  const emoji = document.getElementById('channel-emoji-input').value.trim() || '🎬';

  if (!name) { toast('Give your channel a name!', 'error'); return; }

  const me = getCurrentUser();
  const ch = {
    id: 'ch_' + Date.now(),
    ownerId: me.username,
    name, desc, category, emoji,
    subs: [me.username],
    videos: [],
    created: Date.now()
  };

  const channels = getChannels();
  channels.unshift(ch);
  setChannels(channels);
  closeModal('modal-create-channel');
  renderChannels();
  toast('Channel created! 📺', 'success');
}

// ══════════════════════════════════════
// SYNC SPACES
// ══════════════════════════════════════
let syncSpacesData = [
  { id: 's1', name: 'Late Night Vibes', creator: 'neoncat', users: ['neoncat', 'skyvibes'], messages: 45, expiresAt: Date.now() + 3600000 * 12 },
  { id: 's2', name: 'Music Talk', creator: 'djbeatrix', users: ['djbeatrix'], messages: 12, expiresAt: Date.now() + 3600000 * 18 },
  { id: 's3', name: 'Dev Chat', creator: 'neoncat', users: [], messages: 0, expiresAt: Date.now() + 3600000 * 6 },
];

function getSyncSpaces() {
  return JSON.parse(localStorage.getItem('vibehub_sync_spaces') || '[]');
}

function setSyncSpaces(spaces) {
  localStorage.setItem('vibehub_sync_spaces', JSON.stringify(spaces));
}

function renderSyncSpaces() {
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  const me = getCurrentUser();
  
  // Filter out expired spaces
  spaces = spaces.filter(s => s.expiresAt > Date.now());
  
  document.getElementById('sync-spaces-grid').innerHTML = spaces.map(room => {
    const isInRoom = room.users.includes(me?.username);
    const hoursLeft = Math.floor((room.expiresAt - Date.now()) / 3600000);
    const isActive = room.users.length > 0;
    return `
      <div class="sync-space-card ${isActive ? 'sync-space-glow' : ''}">
        <div class="sync-space-name">${room.name}</div>
        <div class="sync-space-meta">by @${room.creator} · ${room.users.length}/125 users</div>
        <div class="sync-space-timer">${hoursLeft}h remaining</div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          ${isInRoom 
            ? `<button class="btn btn-outline btn-sm" onclick="leaveSyncSpace('${room.id}')">Leave</button>`
            : room.users.length < 125 
              ? `<button class="btn btn-primary btn-sm" onclick="joinSyncSpace('${room.id}')">Join Room</button>`
              : `<button class="btn btn-outline btn-sm" disabled>Full</button>`
          }
          ${me?.username === room.creator ? `<button class="btn btn-danger btn-sm" onclick="deleteSyncSpace('${room.id}')">Delete</button>` : ''}
        </div>
      </div>
    `;
  }).join('') || '<div class="empty-state"><div class="empty-icon">💬</div><div class="empty-title">No active rooms</div><div class="empty-desc">Create a room to start chatting!</div></div>';
}

function openCreateSyncSpaceModal() {
  const name = prompt('Room name:');
  if (!name) return;
  
  const me = getCurrentUser();
  const newRoom = {
    id: 's_' + Date.now(),
    name: name,
    creator: me.username,
    users: [me.username],
    messages: [],
    expiresAt: Date.now() + 3600000 * 24
  };
  
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  spaces.unshift(newRoom);
  setSyncSpaces(spaces);
  renderSyncSpaces();
  toast('Room created! 💬', 'success');
}

function joinSyncSpace(roomId) {
  const me = getCurrentUser();
  if (!me) { toast('Please log in first', 'error'); return; }
  
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  const room = spaces.find(s => s.id === roomId);
  if (!room) return;
  
  if (!room.users.includes(me.username)) {
    room.users.push(me.username);
    setSyncSpaces(spaces);
    renderSyncSpaces();
    toast('Joined the room! 💬', 'success');
  }
}

function leaveSyncSpace(roomId) {
  const me = getCurrentUser();
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  const room = spaces.find(s => s.id === roomId);
  if (!room) return;
  
  room.users = room.users.filter(u => u !== me.username);
  setSyncSpaces(spaces);
  renderSyncSpaces();
  toast('Left the room', 'success');
}

function deleteSyncSpace(roomId) {
  if (!confirm('Delete this room?')) return;
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  spaces = spaces.filter(s => s.id !== roomId);
  setSyncSpaces(spaces);
  renderSyncSpaces();
  toast('Room deleted', 'success');
}

function renderMyChannel() {
  const me = getCurrentUser();
  const channels = getChannels();
  const myChannels = channels.filter(c => c.ownerId === me.username);
  const el = document.getElementById('my-channel-content');

  if (!myChannels.length) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📡</div>
        <div class="empty-title">You don't have a channel yet</div>
        <div class="empty-desc">Create your first channel and start sharing your content with the world.</div>
        <button class="btn btn-primary" style="margin-top:16px;" onclick="openCreateChannelModal()">Create Channel 📺</button>
      </div>
    `;
    return;
  }

  el.innerHTML = myChannels.map(ch => `
    <div class="card" style="margin-bottom:16px;">
      <div class="card-body">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">${ch.emoji} ${ch.name}</div>
            <div style="font-size:13px;color:var(--text2);">${ch.subs.length} subscribers · ${ch.videos?.length || 0} videos</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="openUploadVideoModal('${ch.id}')">+ Upload</button>
        </div>
        <div class="video-grid">
          ${(ch.videos || []).map(v => `
            <div class="video-thumb">
              <div class="video-preview"><span style="font-size:32px;">${v.emoji}</span><div class="video-play-overlay">▶</div></div>
              <div class="video-info">
                <div class="video-title">${v.title}</div>
                <div class="video-meta">${v.views.toLocaleString()} views · ${getTimeAgo(v.time)}</div>
              </div>
            </div>
          `).join('')}
        </div>
        ${!ch.videos?.length ? '<div style="text-align:center;padding:24px;color:var(--text3);font-size:14px;">Upload your first video 🎬</div>' : ''}
      </div>
    </div>
  `).join('');
}

let uploadTargetChannelId = null;

function openUploadVideoModal(channelId) {
  const me = getCurrentUser();
  const channels = getChannels();
  const myChannels = channels.filter(c => c.ownerId === me.username);

  if (!myChannels.length) { toast('Create a channel first!', 'error'); openCreateChannelModal(); return; }

  uploadTargetChannelId = channelId || myChannels[0].id;
  document.getElementById('modal-upload-video').classList.remove('hidden');
}

function uploadVideo() {
  const title = document.getElementById('video-title-input').value.trim();
  const desc = document.getElementById('video-desc-input').value.trim();
  const emoji = document.getElementById('video-emoji-input').value.trim() || '🎬';
  const tags = document.getElementById('video-tags-input').value.split(',').map(t => t.trim()).filter(Boolean);

  if (!title) { toast('Give your video a title!', 'error'); return; }

  const channels = getChannels();
  const ch = channels.find(c => c.id === uploadTargetChannelId);
  if (!ch) { toast('Channel not found', 'error'); return; }

  ch.videos = ch.videos || [];
  ch.videos.unshift({ id: 'v_' + Date.now(), title, desc, emoji, tags, views: 0, time: Date.now() });
  setChannels(channels);

  closeModal('modal-upload-video');
  renderMyChannel();
  toast('Video uploaded! 🎬', 'success');
}

// ══════════════════════════════════════
// MESSAGES
// ══════════════════════════════════════
function renderMessages() {
  const me = getCurrentUser();
  const allMessages = getMessages();
  const users = getUsers();
  const otherUsers = users.filter(u => u.username !== me?.username).slice(0, 8);

  document.getElementById('dm-list-items').innerHTML = otherUsers.map(u => {
    const key = [me.username, u.username].sort().join('-');
    const msgs = allMessages[key] || [];
    const lastMsg = msgs[msgs.length - 1];
    const hasUnread = msgs.some(m => m.from !== me.username && !m.read);
    return `
      <div class="dm-item" onclick="openDM('${u.username}')">
        <div style="position:relative;">
          <div class="avatar avatar-sm">${u.avatar || u.name[0]}</div>
          <div class="online-dot"></div>
        </div>
        <div class="dm-info">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="dm-name">${u.name}</div>
            ${hasUnread ? '<span class="dm-unread">New</span>' : ''}
          </div>
          <div class="dm-preview">${lastMsg ? escHtml(lastMsg.text).substring(0, 35) + '...' : 'Say hello!'}</div>
        </div>
      </div>
    `;
  }).join('');
}

function openDM(username) {
  const me = getCurrentUser();
  const users = getUsers();
  const other = users.find(u => u.username === username);
  const allMessages = getMessages();
  const key = [me.username, username].sort().join('-');
  const msgs = allMessages[key] || [];

  document.getElementById('chat-area').innerHTML = `
    <div class="chat-header">
      <div class="avatar avatar-sm">${other?.avatar || other?.name[0]}</div>
      <div>
        <div style="font-weight:600;">${other?.name}</div>
        <div style="font-size:12px;color:var(--green);">● Online</div>
      </div>
    </div>
    <div class="chat-messages" id="chat-msgs-${username}">
      ${msgs.length ? msgs.map(m => `
        <div class="message-bubble ${m.from === me.username ? 'sent' : 'recv'}">
          <div class="bubble">${escHtml(m.text)}</div>
          <div class="bubble-time">${getTimeAgo(m.time)}</div>
        </div>
      `).join('') : '<div class="empty-state" style="padding:24px;"><div class="empty-icon">👋</div><div class="empty-desc">Say hello to ' + other?.name + '!</div></div>'}
    </div>
    <div class="chat-input-bar">
      <textarea class="chat-input" id="chat-input-${username}" placeholder="Message ${other?.name}..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendDM('${username}')}"></textarea>
      <button class="btn btn-primary" onclick="sendDM('${username}')">Send</button>
    </div>
  `;

  // Scroll to bottom
  setTimeout(() => {
    const msgs = document.getElementById('chat-msgs-' + username);
    if (msgs) msgs.scrollTop = msgs.scrollHeight;
  }, 50);
}

function sendDM(username) {
  const me = getCurrentUser();
  const text = document.getElementById('chat-input-' + username)?.value.trim();
  if (!text) return;

  const allMessages = getMessages();
  const key = [me.username, username].sort().join('-');
  if (!allMessages[key]) allMessages[key] = [];
  allMessages[key].push({ from: me.username, text, time: Date.now(), read: false });
  setMessages(allMessages);

  document.getElementById('chat-input-' + username).value = '';
  openDM(username);
}

// ══════════════════════════════════════
// NOTIFICATIONS
// ══════════════════════════════════════
function renderNotifications() {
  const notifs = getNotifs();
  const users = getUsers();

  // Mark all read
  notifs.forEach(n => n.read = true);
  setNotifs(notifs);

  const el = document.getElementById('notifs-list');
  if (!notifs.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">🔔</div><div class="empty-title">No notifications</div></div>';
    return;
  }

  const icons = { like:'👍', comment:'💬', follow:'👤', system:'✨' };
  el.innerHTML = notifs.map(n => {
    const fromUser = users.find(u => u.username === n.fromUser);
    return `
      <div class="card" style="margin-bottom:10px;padding:16px;display:flex;align-items:center;gap:12px;${!n.read?'border-color:var(--purple);':''}" >
        <div style="font-size:24px;">${icons[n.type] || '✨'}</div>
        <div style="flex:1;">
          ${fromUser ? `<strong>${fromUser.name}</strong> ` : ''}${n.text}
          <div style="font-size:12px;color:var(--text3);margin-top:2px;">${getTimeAgo(n.time)}</div>
        </div>
        ${!n.read ? '<div class="notif-dot"></div>' : ''}
      </div>
    `;
  }).join('');
}

function addNotif(toUser, type, fromUser, text, postId) {
  const notifs = getNotifs();
  notifs.unshift({ id: 'n_' + Date.now(), type, fromUser, text, postId, time: Date.now(), read: false });
  setNotifs(notifs.slice(0, 50));
}

// ══════════════════════════════════════
// PROFILE
// ══════════════════════════════════════
function renderProfile(username) {
  const users = getUsers();
  const user = users.find(u => u.username === username);
  const me = getCurrentUser();
  if (!user) { navigate('home'); return; }

  const posts = getPosts().filter(p => p.userId === username);
  const channels = getChannels().filter(c => c.ownerId === username);
  const isMe = me?.username === username;

  document.getElementById('topbar-title').textContent = user.name + '\'s Profile';

  document.getElementById('profile-content').innerHTML = `
    <div class="profile-page">
      <div class="profile-banner theme-${user.banner || 'purple'}" ${user.profileBackground ? `style="background:url('${user.profileBackground}') center/cover;"` : ''}></div>
      <div class="profile-info-section">
        <div class="profile-avatar-wrap">
          <div class="avatar avatar-xl" ${user.avatarImage ? `style="background:url('${user.avatarImage}') center/cover;"` : ''}>${user.avatarImage ? '' : (user.avatar || user.name[0])}</div>
          <div style="padding-bottom:8px;">
            ${user.role === 'owner' ? '<span class="badge badge-gold">👑 Owner</span>' : ''}
          </div>
        </div>
        <div class="profile-name">${user.name} ${user.role === 'owner' ? '👑' : ''}</div>
        <div class="profile-handle">@${user.username} ${(function() { const r = getUserRank(username); return r.total > 1 ? '<span style="color:var(--gold);font-size:12px;margin-left:8px;">#' + r.rank + ' of ' + r.total + '</span>' : ''; })()}</div>
        ${(function() { const badges = calculateUserBadges(username); return badges.length ? '<div style="display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;">' + badges.map(b => '<span style="background:' + b.color + '22;border:1px solid ' + b.color + '55;color:' + b.color + ';padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;">' + b.icon + ' ' + b.label + '</span>').join('') + '</div>' : ''; })()}
        <div class="profile-bio">${user.bio || 'No bio yet.'}</div>
        ${(function() {
          const links = user.socialLinks || {};
          const icons = {
            instagram: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>',
            twitter: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4l11.733 16h4.267l-11.733 -16z"></path><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"></path></svg>',
            youtube: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>',
            tiktok: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"></path></svg>',
            twitch: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
            discord: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="2"></circle></svg>',
            website: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>'
          };
          const urls = {
            instagram: links.instagram ? `https://instagram.com/${links.instagram.replace('@','')}` : '',
            twitter: links.twitter ? `https://x.com/${links.twitter.replace('@','')}` : '',
            youtube: links.youtube,
            tiktok: links.tiktok ? `https://tiktok.com/@${links.tiktok.replace('@','')}` : '',
            twitch: links.twitch ? `https://twitch.tv/${links.twitch}` : '',
            discord: links.discord,
            website: links.website
          };
          const hasLinks = Object.values(links).some(v => v);
          if (!hasLinks) return '';
          return '<div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;">' +
            (links.instagram ? `<a href="${urls.instagram}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.instagram}</a>` : '') +
            (links.twitter ? `<a href="${urls.twitter}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.twitter}</a>` : '') +
            (links.youtube ? `<a href="${urls.youtube}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.youtube}</a>` : '') +
            (links.tiktok ? `<a href="${urls.tiktok}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.tiktok}</a>` : '') +
            (links.twitch ? `<a href="${urls.twitch}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.twitch}</a>` : '') +
            (links.discord ? `<span style="color:var(--text2);cursor:pointer;" title="Discord: ${links.discord}" onclick="navigator.clipboard.writeText('${links.discord}');toast('Discord copied!','success')">${icons.discord}</span>` : '') +
            (links.website ? `<a href="${urls.website.startsWith('http') ? urls.website : 'https://' + urls.website}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.website}</a>` : '') +
          '</div>';
        })()}
        <div class="profile-stats">
          <div class="profile-stat"><div class="profile-stat-num">${posts.length}</div><div class="profile-stat-label">Posts</div></div>
          <div class="profile-stat"><div class="profile-stat-num">${getVibeLikeCount(username)}</div><div class="profile-stat-label">Vibes</div></div>
          <div class="profile-stat"><div class="profile-stat-num">${getTop8VibesCount(username)}</div><div class="profile-stat-label">Top 8 Vibes</div></div>
        </div>
        <div class="profile-actions">
          ${isMe
            ? `<button class="btn btn-primary" onclick="navigate('edit-profile')">🎨 Customize Page</button>`
            : `<button class="btn btn-primary" onclick="openDM_goto('${username}')">💬 Message</button>
               <button class="btn btn-outline" onclick="waveUser('${username}')">👋 Wave</button>
               <button class="vibe-like-btn" id="vibe-like-btn-${username}" onclick="likeUserVibe('${username}')">💜 I Like Your Vibe</button>
               <button class="btn btn-outline btn-sm" onclick="openReportModal('${username}')">🚩 Report</button>`
          }
        </div>
      </div>

      <div class="profile-grid">
        <div>
          <!-- Mood widget -->
          ${user.mood ? `
            <div class="mood-widget">
              <div class="mood-emoji">${user.mood.emoji}</div>
              <div class="mood-text"><strong>${user.mood.text}</strong>How ${user.name.split(' ')[0]} is feeling</div>
            </div>
          ` : ''}

          <!-- Featured Posts -->
          ${(function() {
            const featured = (user.featuredPosts || []).map(id => posts.find(p => p.id === id)).filter(Boolean);
            if (!featured.length) return '';
            return '<div class="section-title">⭐ Featured</div><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">' + 
              featured.map(p => renderPostCard(p, true)).join('') + '</div>';
          })()}

          <!-- Posts -->
          <div class="section-title">Posts</div>
          ${(function() {
            const featured = user.featuredPosts || [];
            const regularPosts = posts.filter(p => !featured.includes(p.id));
            return regularPosts.length
              ? regularPosts.map(p => renderPostCard(p)).join('')
              : '<div class="empty-state" style="padding:32px;"><div class="empty-icon">✨</div><div class="empty-title">No posts yet</div></div>';
          })()}
        </div>

        <div>
          <!-- Music Player -->
          <div class="music-player">
            <div class="music-player-title">🎵 Now Playing</div>
            <div class="music-track">
              <div class="music-thumb" id="profile-music-thumb-${username}">🎵</div>
              <div class="music-info">
                <div class="music-track-name">${user.song?.name || 'No song set'}</div>
                <div class="music-artist">${user.song?.artist || 'Unknown artist'}</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:4px;margin-top:10px;">
              <button class="music-btn">⏮</button>
              <button class="music-btn play" onclick="toggleProfileMusic('${username}')">▶</button>
              <button class="music-btn">⏭</button>
              <div class="music-progress"><div class="music-progress-fill" id="music-prog-${username}"></div></div>
            </div>
          </div>

          <!-- Top 8 -->
          <div class="top8-widget">
            <div class="top8-title">⭐ Top 8 Vibes</div>
            <div class="top8-grid">
              ${(user.top8 || []).slice(0, 8).map(friendUsername => {
                const friend = users.find(u => u.username === friendUsername);
                return friend ? `
                  <div class="top8-friend" onclick="navigate('profile','${friend.username}')">
                    <div class="avatar avatar-sm" style="font-size:14px;">${friend.avatar || friend.name[0]}</div>
                    <div class="top8-name">${friend.name.split(' ')[0]}</div>
                  </div>
                ` : '';
              }).join('')}
              ${(user.top8 || []).length < 8
                ? Array(Math.max(0, 8 - (user.top8||[]).length)).fill(0).map(() =>
                    `<div class="top8-friend"><div class="avatar avatar-sm" style="background:var(--bg3);color:var(--text3);font-size:16px;">+</div><div class="top8-name">Open</div></div>`
                  ).join('')
                : ''}
            </div>
          </div>

          <!-- Channels -->
          ${channels.length ? `
            <div class="top8-widget">
              <div class="top8-title">📺 Channels</div>
              ${channels.map(ch => `
                <div onclick="navigate('channel-detail','${ch.id}')" style="display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;border-bottom:1px solid var(--border);">
                  <span style="font-size:20px;">${ch.emoji}</span>
                  <div>
                    <div style="font-weight:600;font-size:13px;">${ch.name}</div>
                    <div style="font-size:12px;color:var(--text3);">${ch.subs.length} subs</div>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  // Start music progress animation if playing
  if (user.song?.playing) {
    const thumb = document.getElementById('profile-music-thumb-' + username);
    if (thumb) thumb.classList.add('playing');
  }
}

let musicIntervals = {};

function toggleProfileMusic(username) {
  const thumb = document.getElementById('profile-music-thumb-' + username);
  const prog = document.getElementById('music-prog-' + username);
  if (!thumb) return;

  const isPlaying = thumb.classList.contains('playing');
  if (isPlaying) {
    thumb.classList.remove('playing');
    clearInterval(musicIntervals[username]);
  } else {
    thumb.classList.add('playing');
    let pct = 35;
    musicIntervals[username] = setInterval(() => {
      pct = (pct + 0.3) % 100;
      if (prog) prog.style.width = pct + '%';
    }, 100);
  }
}

function openDM_goto(username) {
  navigate('messages');
  setTimeout(() => openDM(username), 100);
}

// ══════════════════════════════════════
// EDIT PROFILE / CUSTOMIZER
// ══════════════════════════════════════
const THEME_COLORS = ['purple','pink','cyan','gold','green','red'];
const COLOR_HEX = { purple:'#8b5cf6', pink:'#ec4899', cyan:'#06b6d4', gold:'#f59e0b', green:'#10b981', red:'#ef4444' };

function renderEditProfile() {
  const me = getCurrentUser();

  // Theme color picker
  document.getElementById('theme-color-picker').innerHTML = THEME_COLORS.map(c =>
    `<div class="color-swatch ${me.theme === c ? 'active' : ''}" style="background:${COLOR_HEX[c]};" onclick="selectTheme('${c}',this)" title="${c}"></div>`
  ).join('');

  // Banner picker
  document.getElementById('banner-picker').innerHTML = THEME_COLORS.map(c =>
    `<div class="gradient-option ${me.banner === c ? 'active' : ''}" style="background:linear-gradient(135deg,${COLOR_HEX[c]},${COLOR_HEX[c]}88);" onclick="selectBanner('${c}',this)" title="${c}"></div>`
  ).join('');

  // Song
  document.getElementById('edit-song-url').value = me.song?.url || '';
  document.getElementById('edit-song-name').value = me.song?.name || '';
  document.getElementById('edit-song-artist').value = me.song?.artist || '';

  // Bio + name
  document.getElementById('edit-display-name').value = me.name;
  document.getElementById('edit-bio').value = me.bio || '';

  // Social Links
  document.getElementById('edit-social-instagram').value = me.socialLinks?.instagram || '';
  document.getElementById('edit-social-twitter').value = me.socialLinks?.twitter || '';
  document.getElementById('edit-social-youtube').value = me.socialLinks?.youtube || '';
  document.getElementById('edit-social-tiktok').value = me.socialLinks?.tiktok || '';
  document.getElementById('edit-social-twitch').value = me.socialLinks?.twitch || '';
  document.getElementById('edit-social-discord').value = me.socialLinks?.discord || '';
  document.getElementById('edit-social-website').value = me.socialLinks?.website || '';

  // Profile Background
  document.getElementById('edit-profile-background').value = me.profileBackground || '';

  // Profile Image Preview
  if (me.avatarImage) {
    document.getElementById('profile-image-preview').innerHTML = `<img src="${me.avatarImage}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">`;
  } else {
    document.getElementById('profile-image-preview').innerHTML = '';
  }

  // Top 8 editor
  renderTop8Editor();
}

let editTheme = null;
let editBanner = null;
let editMood = null;
let editTop8 = null;
let editAvatarImage = null;

function selectTheme(color, el) {
  editTheme = color;
  document.querySelectorAll('#theme-color-picker .color-swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
}

function selectBanner(color, el) {
  editBanner = color;
  document.querySelectorAll('#banner-picker .gradient-option').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
}

function setMood(emoji, text) {
  editMood = { emoji, text };
  toast('Mood set to ' + emoji + ' ' + text, 'success');
}

function renderTop8Editor() {
  const me = getCurrentUser();
  const users = getUsers();
  const top8 = me.top8 || [];
  const el = document.getElementById('top8-editor');

  el.innerHTML = Array(8).fill(0).map((_, i) => {
    const friendUsername = top8[i];
    const friend = friendUsername ? users.find(u => u.username === friendUsername) : null;
    return `
      <div style="text-align:center;cursor:pointer;" onclick="openTop8Picker(${i})">
        <div class="avatar avatar-sm" style="margin:0 auto 4px;font-size:14px;${friend ? '' : 'background:var(--bg3);'}">${friend ? (friend.avatar || friend.name[0]) : '+'}</div>
        <div style="font-size:10px;color:var(--text2);">${friend ? friend.name.split(' ')[0] : 'Add'}</div>
      </div>
    `;
  }).join('');
}

let top8SlotIndex = null;

function openTop8Picker(slotIndex) {
  const me = getCurrentUser();
  editTop8 = editTop8 || [...(me.top8 || [])];
  top8SlotIndex = slotIndex;
  const users = getUsers().filter(u => u.username !== me.username);

  document.getElementById('top8-user-picker').innerHTML = users.map(u => `
    <div class="dm-item" onclick="pickTop8User('${u.username}')">
      <div class="avatar avatar-sm">${u.avatar || u.name[0]}</div>
      <div>
        <div style="font-weight:600;font-size:14px;">${u.name}</div>
        <div style="font-size:12px;color:var(--text3);">@${u.username}</div>
      </div>
    </div>
  `).join('');
  document.getElementById('modal-top8').classList.remove('hidden');
}

function pickTop8User(username) {
  if (!editTop8) editTop8 = [...(getCurrentUser().top8 || [])];
  if (editTop8.length <= top8SlotIndex) {
    while (editTop8.length <= top8SlotIndex) editTop8.push('');
  }
  editTop8[top8SlotIndex] = username;
  closeModal('modal-top8');
  renderTop8Editor_preview();
}

function renderTop8Editor_preview() {
  const users = getUsers();
  const el = document.getElementById('top8-editor');
  const t8 = editTop8 || [];

  el.innerHTML = Array(8).fill(0).map((_, i) => {
    const friendUsername = t8[i];
    const friend = friendUsername ? users.find(u => u.username === friendUsername) : null;
    return `
      <div style="text-align:center;cursor:pointer;" onclick="openTop8Picker(${i})">
        <div class="avatar avatar-sm" style="margin:0 auto 4px;font-size:14px;${friend ? '' : 'background:var(--bg3);'}">${friend ? (friend.avatar || friend.name[0]) : '+'}</div>
        <div style="font-size:10px;color:var(--text2);">${friend ? friend.name.split(' ')[0] : 'Add'}</div>
      </div>
    `;
  }).join('');
}

function saveProfile() {
  const me = getCurrentUser();
  const users = getUsers();
  const idx = users.findIndex(u => u.username === me.username);
  if (idx === -1) return;

  users[idx].name = document.getElementById('edit-display-name').value.trim() || me.name;
  users[idx].bio = document.getElementById('edit-bio').value.trim();
  users[idx].song = {
    url: document.getElementById('edit-song-url').value.trim(),
    name: document.getElementById('edit-song-name').value.trim(),
    artist: document.getElementById('edit-song-artist').value.trim(),
  };
  
  // Social Links
  users[idx].socialLinks = {
    instagram: document.getElementById('edit-social-instagram').value.trim(),
    twitter: document.getElementById('edit-social-twitter').value.trim(),
    youtube: document.getElementById('edit-social-youtube').value.trim(),
    tiktok: document.getElementById('edit-social-tiktok').value.trim(),
    twitch: document.getElementById('edit-social-twitch').value.trim(),
    discord: document.getElementById('edit-social-discord').value.trim(),
    website: document.getElementById('edit-social-website').value.trim(),
  };
  
  // Profile Background
  users[idx].profileBackground = document.getElementById('edit-profile-background').value.trim();
  
  // Profile Image (handled by compressImage function)
  if (editAvatarImage) {
    users[idx].avatarImage = editAvatarImage;
    users[idx].avatar = editAvatarImage;
  }
  
  if (editTheme) users[idx].theme = editTheme;
  if (editBanner) users[idx].banner = editBanner;
  if (editMood) users[idx].mood = editMood;
  if (editTop8) users[idx].top8 = editTop8.filter(Boolean);

  setUsers(users);
  editTheme = null; editBanner = null; editMood = null; editTop8 = null; editAvatarImage = null;
  updateSidebarUser();
  toast('Profile saved! Looking fresh ✨', 'success');
  navigate('profile', me.username);
}

// ══════════════════════════════════════
// IMAGE COMPRESSION
// ══════════════════════════════════════
function compressImage(file, maxSizeKB = 200, maxWidth = 400) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        let quality = 0.9;
        let dataUrl = canvas.toDataURL('image/jpeg', quality);
        
        while (dataUrl.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) {
          quality -= 0.1;
          dataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        
        resolve(dataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function handleProfileImageUpload(input) {
  const file = input.files[0];
  if (!file) return;
  
  compressImage(file).then(dataUrl => {
    editAvatarImage = dataUrl;
    document.getElementById('profile-image-preview').innerHTML = 
      `<img src="${dataUrl}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">`;
    toast('Image compressed and ready!', 'success');
  });
}

// ══════════════════════════════════════
// SETTINGS
// ══════════════════════════════════════
function renderSettings() {
  const me = getCurrentUser();
  if (!me) { navigate('home'); return; }
  
  document.getElementById('settings-display-name').value = me.name || '';
  document.getElementById('settings-bio').value = me.bio || '';
  document.getElementById('settings-email').value = me.email || '';
}

function updateSettingsFromForm() {
  const me = getCurrentUser();
  if (!me) return;
  
  me.name = document.getElementById('settings-display-name').value;
  me.bio = document.getElementById('settings-bio').value;
  me.email = document.getElementById('settings-email').value;
  
  const users = getUsers();
  const idx = users.findIndex(u => u.username === me.username);
  if (idx !== -1) {
    users[idx] = me;
    setUsers(users);
    setSession(me.username);
  }
  
  toast('Settings saved!', 'success');
}

function confirmDeleteAccount() {
  if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
  if (!confirm('This will permanently delete all your data. Continue?')) return;
  
  const me = getCurrentUser();
  let users = getUsers();
  users = users.filter(u => u.username !== me.username);
  setUsers(users);
  clearSession();
  toast('Account deleted. Sorry to see you go!', 'success');
  setTimeout(() => window.location.reload(), 1500);
}

// ══════════════════════════════════════
// ADMIN PANEL
// ══════════════════════════════════════
function renderAdmin() {
  const me = getCurrentUser();
  if (me?.role !== 'owner') { navigate('home'); toast('Access denied', 'error'); return; }

  const users = getUsers();
  const posts = getPosts();
  const channels = getChannels();

  // Stats
  document.getElementById('admin-stats').innerHTML = [
    { val: users.length, label:'Total Users', color:'purple' },
    { val: posts.length, label:'Total Posts', color:'pink' },
    { val: channels.length, label:'Channels', color:'cyan' },
    { val: '$' + users.length, label:'Revenue', color:'gold' },
  ].map(s => `
    <div class="admin-stat" style="border-color:var(--${s.color},var(--border));">
      <div class="admin-stat-val" style="color:var(--${s.color})">${s.val}</div>
      <div class="admin-stat-label">${s.label}</div>
    </div>
  `).join('');

  // Activity
  document.getElementById('admin-activity').innerHTML = posts.slice(0,5).map(p => {
    const u = users.find(u => u.username === p.userId);
    return `
      <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
        <span style="font-size:18px;">📝</span>
        <div style="flex:1;">
          <strong>${u?.name}</strong> posted: "${p.text?.substring(0,60)}..."
          <div style="font-size:12px;color:var(--text3);">${getTimeAgo(p.time)}</div>
        </div>
      </div>
    `;
  }).join('');

  // Users tab
  document.getElementById('admin-users-list').innerHTML = users.map(u => `
    <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
      <div class="avatar avatar-sm">${u.avatar || u.name[0]}</div>
      <div style="flex:1;">
        <div style="font-weight:600;">${u.name} <span class="badge ${u.role === 'owner' ? 'badge-gold' : 'badge-purple'}">${u.role}</span></div>
        <div style="font-size:12px;color:var(--text3);">@${u.username} · ${u.email} · Joined ${getTimeAgo(u.joined)}</div>
      </div>
      ${u.role !== 'owner' ? `<button class="btn btn-danger btn-sm" onclick="adminDeleteUser('${u.username}')">Remove</button>` : ''}
    </div>
  `).join('');

  // Posts tab
  document.getElementById('admin-posts-list').innerHTML = posts.map(p => {
    const u = users.find(u => u.username === p.userId);
    return `
      <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
        <div class="avatar avatar-sm" style="font-size:12px;">${u?.avatar || u?.name[0]}</div>
        <div style="flex:1;">
          <div style="font-size:14px;">${p.text?.substring(0,80) || '(media post)'}...</div>
          <div style="font-size:12px;color:var(--text3);">by @${p.userId} · 👍${p.likes.length} 👎${p.dislikes.length} · ${getTimeAgo(p.time)}</div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="adminDeletePost('${p.id}')">Delete</button>
      </div>
    `;
  }).join('');

  // Channels tab
  document.getElementById('admin-channels-list').innerHTML = channels.map(ch => `
    <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
      <span style="font-size:24px;">${ch.emoji}</span>
      <div style="flex:1;">
        <div style="font-weight:600;">${ch.name}</div>
        <div style="font-size:12px;color:var(--text3);">by @${ch.ownerId} · ${ch.subs.length} subs · ${ch.videos?.length || 0} videos</div>
      </div>
    </div>
  `).join('');
}

function adminTab(tab, btn) {
  document.querySelectorAll('.admin-nav-item').forEach(n => n.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('[id^="admin-tab-"]').forEach(el => el.style.display = 'none');
  document.getElementById('admin-tab-' + tab).style.display = '';
}

function adminDeleteUser(username) {
  if (!confirm('Remove user @' + username + '?')) return;
  setUsers(getUsers().filter(u => u.username !== username));
  setPosts(getPosts().filter(p => p.userId !== username));
  renderAdmin();
  toast('User removed', 'success');
}

function adminDeletePost(postId) {
  if (!confirm('Delete this post?')) return;
  setPosts(getPosts().filter(p => p.id !== postId));
  renderAdmin();
  toast('Post deleted', 'success');
}

// ══════════════════════════════════════
// SEARCH
// ══════════════════════════════════════
function renderSearch(query) {
  document.getElementById('topbar-title').textContent = 'Search: "' + query + '"';
  const q = query.toLowerCase();
  const users = getUsers().filter(u => u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q));
  const posts = getPosts().filter(p => p.text?.toLowerCase().includes(q) || p.tags?.some(t => t.includes(q)));

  document.getElementById('search-results').innerHTML = `
    ${users.length ? `
      <div class="section-title">People</div>
      <div class="creator-grid" style="margin-bottom:24px;">
        ${users.map(u => `
          <div class="creator-card" onclick="navigate('profile','${u.username}')">
            <div class="avatar avatar-md" style="margin:0 auto;">${u.avatar || u.name[0]}</div>
            <div class="creator-name">${u.name}</div>
            <div class="creator-handle">@${u.username}</div>
          </div>
        `).join('')}
      </div>
    ` : ''}
    ${posts.length ? `
      <div class="section-title">Posts</div>
      ${posts.map(p => renderPostCard(p)).join('')}
    ` : ''}
    ${!users.length && !posts.length ? `
      <div class="empty-state">
        <div class="empty-icon">🔍</div>
        <div class="empty-title">No results for "${query}"</div>
        <div class="empty-desc">Try a different search term</div>
      </div>
    ` : ''}
  `;
}

// ══════════════════════════════════════
// MODALS
// ══════════════════════════════════════
function closeModal(id) {
  document.getElementById(id)?.classList.add('hidden');
  // Reset payment button
  if (id === 'modal-payment') {
    const btn = document.querySelector('#modal-payment .btn-primary');
    if (btn) { btn.textContent = 'Pay $1 & Join VibeHub 🚀'; btn.disabled = false; }
  }
}

// ══════════════════════════════════════
// TOAST
// ══════════════════════════════════════
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  const icons = { success:'✅', error:'❌', info:'ℹ️' };
  el.className = 'toast ' + type;
  el.innerHTML = `<span>${icons[type] || '✨'}</span> ${msg}`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ══════════════════════════════════════
// UTILS
// ══════════════════════════════════════
function getTimeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatCard(input) {
  let val = input.value.replace(/\D/g,'').substring(0,16);
  input.value = val.replace(/(.{4})/g,'$1 ').trim();
}

// ══════════════════════════════════════
// MARKETPLACE
// ══════════════════════════════════════
function getProducts() { return getDB('products', []); }
function setProducts(v) { setDB('products', v); }

function showCreateProductModal() {
  if (!currentSession) { toast('Log in to list items', 'error'); return; }
  document.getElementById('modal-create-product').classList.remove('hidden');
}

function createProduct() {
  const title = document.getElementById('product-title-input').value.trim();
  const desc = document.getElementById('product-desc-input').value.trim();
  const price = parseFloat(document.getElementById('product-price-input').value) || 0;
  const category = document.getElementById('product-category-input').value;
  const image = document.getElementById('product-image-input').value.trim();
  
  if (!title || !price) { toast('Title and price required', 'error'); return; }
  
  const me = getCurrentUser();
  const products = getProducts();
  products.unshift({
    id: 'prod_' + Date.now(),
    seller: me.username,
    sellerName: me.name,
    title, desc, price, category, image,
    createdAt: Date.now()
  });
  setProducts(products);
  closeModal('modal-create-product');
  navigate('marketplace');
  toast('Item listed!', 'success');
  
  document.getElementById('product-title-input').value = '';
  document.getElementById('product-desc-input').value = '';
  document.getElementById('product-price-input').value = '';
  document.getElementById('product-image-input').value = '';
}

function renderMarketplace(tab = 'all') {
  let products = getProducts();
  if (tab !== 'all') {
    products = products.filter(p => p.category === tab);
  }
  
  const grid = document.getElementById('marketplace-grid');
  if (!products.length) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">🛍️</div><div class="empty-title">No items yet</div><div class="empty-desc">Be the first to list something!</div></div>';
    return;
  }
  
  grid.innerHTML = products.map(p => `
    <div class="card" style="overflow:hidden;cursor:pointer;" onclick="viewProduct('${p.id}')">
      <div style="height:160px;background:${p.image ? 'url('+p.image+') center/cover' : 'linear-gradient(135deg,var(--purple2),var(--pink))'};display:flex;align-items:center;justify-content:center;">
        ${!p.image ? '<span style="font-size:48px;">📦</span>' : ''}
      </div>
      <div style="padding:16px;">
        <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${escHtml(p.title)}</div>
        <div style="color:var(--purple);font-weight:700;font-size:18px;margin-bottom:8px;">$${p.price}</div>
        <div style="font-size:12px;color:var(--text3);">by @${p.seller}</div>
      </div>
    </div>
  `).join('');
}

function switchMarketplaceTab(tab, btn) {
  document.querySelectorAll('#view-marketplace .feed-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderMarketplace(tab);
}

function renderStatusChannels() {
  const channels = getStatusChannels().filter(c => c.expiresAt > Date.now());
  const container = document.getElementById('status-channels-list');
  if (!container) return;
  
  if (!channels.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">⏰</div><div class="empty-title">No active status channels</div><div class="empty-desc">Create one to start vibing!</div></div>';
    return;
  }
  
  container.innerHTML = channels.map(c => `
    <div class="channel-card" onclick="joinStatusChannel('${c.id}')">
      <div class="channel-banner">${c.name[0]}</div>
      <div class="channel-info">
        <div class="channel-name">${escHtml(c.name)}</div>
        <div class="channel-meta">
          <span class="channel-subs">by @${c.creator}</span>
          <span style="color:var(--cyan);font-size:11px;">⏰ ${Math.round((c.expiresAt - Date.now()) / 3600000)}h left</span>
        </div>
      </div>
    </div>
  `).join('');
}

function viewProduct(productId) {
  const products = getProducts();
  const p = products.find(prod => prod.id === productId);
  if (!p) return;
  
  const me = getCurrentUser();
  if (p.seller === me?.username) {
    toast('This is your listing', 'info');
    return;
  }
  
  const msg = prompt('Message to @' + p.seller + ':');
  if (msg) {
    const messages = getMessages();
    const key = [me.username, p.seller].sort().join('_');
    if (!messages[key]) messages[key] = [];
    messages[key].unshift({ from: me.username, to: p.seller, text: msg, time: Date.now() });
    setMessages(messages);
    toast('Message sent!', 'success');
  }
}

// ══════════════════════════════════════
// REPUTATION & BADGES
// ══════════════════════════════════════
function getEngagementScore(username) {
  const users = getUsers();
  const posts = getPosts();
  const user = users.find(u => u.username === username);
  if (!user) return 0;
  
  const userPosts = posts.filter(p => p.userId === username);
  let score = 0;
  
  score += userPosts.length * 10;
  
  userPosts.forEach(p => {
    score += (p.likes?.length || 0) * 2;
    score += (p.dislikes?.length || 0) * 1;
    score += (p.comments?.length || 0) * 3;
    score += (p.waves?.length || 0) * 2;
    if (p.reactions) {
      Object.values(p.reactions).forEach(arr => {
        score += (arr?.length || 0) * 2;
      });
    }
  });
  
  const friends = getFriends()[username] || [];
  score += friends.length * 5;
  
  return score;
}

function getUserBadge(username) {
  const score = getEngagementScore(username);
  if (score >= 1000) return { icon: '👑', label: 'Legend', color: 'gold' };
  if (score >= 500) return { icon: '⭐', label: 'Superstar', color: 'purple' };
  if (score >= 200) return { icon: '🔥', label: 'Rising', color: 'pink' };
  if (score >= 50) return { icon: '🌱', label: 'Newbie', color: 'green' };
  return null;
}

function renderBadge(username) {
  const badge = getUserBadge(username);
  if (!badge) return '';
  return `<span class="badge badge-${badge.color}" style="margin-left:6px;">${badge.icon} ${badge.label}</span>`;
}

// ══════════════════════════════════════
// "I LIKE YOUR VIBE" BUTTON
// ══════════════════════════════════════
function getVibeLikes() { return getDB('vibeLikes', {}); }
function setVibeLikes(v) { setDB('vibeLikes', v); }

function likeUserVibe(username) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const me = getCurrentUser();
  if (me.username === username) { toast("Can't vibe yourself 😅", 'error'); return; }
  
  const likes = getVibeLikes();
  if (!likes[username]) likes[username] = [];
  
  if (likes[username].includes(me.username)) {
    toast('You already liked their vibe!', 'info');
    return;
  }
  
  likes[username].push(me.username);
  setVibeLikes(likes);
  toast('You like their vibe! ✨', 'success');
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'vibeLike', from: me.username, to: username, time: Date.now() });
  setNotifs(notifs);
}

function getVibeLikeCount(username) {
  const likes = getVibeLikes();
  return likes[username]?.length || 0;
}

// ══════════════════════════════════════
// REPORT SYSTEM
// ══════════════════════════════════════
let reportTargetUser = '';

function openReportModal(username) {
  reportTargetUser = username;
  document.getElementById('report-reason').value = '';
  document.getElementById('report-details').value = '';
  document.getElementById('modal-report').classList.remove('hidden');
}

function submitReport() {
  const reason = document.getElementById('report-reason').value;
  const details = document.getElementById('report-details').value;
  
  if (!reason) {
    toast('Please select a reason', 'error');
    return;
  }
  
  const me = getCurrentUser();
  const reports = getDB('reports', []);
  reports.unshift({
    id: 'r_' + Date.now(),
    reporter: me?.username || 'anonymous',
    reportedUser: reportTargetUser,
    reason: reason,
    details: details,
    time: Date.now(),
    status: 'pending'
  });
  setDB('reports', reports);
  
  closeModal('modal-report');
  toast('Report submitted. We\'ll review it soon. 🚩', 'success');
  reportTargetUser = '';
}

function getTop8VibesCount(username) {
  const users = getUsers();
  let count = 0;
  users.forEach(u => {
    if ((u.top8 || []).includes(username)) count++;
  });
  return count;
}

function calculateUserBadges(username) {
  const posts = getPosts().filter(p => p.userId === username);
  const users = getUsers();
  const user = users.find(u => u.username === username);
  if (!user) return [];
  
  const badges = [];
  const allReactions = { likes: 0, cap: 0, relate: 0, wild: 0, facts: 0 };
  
  posts.forEach(p => {
    allReactions.likes += p.likes.length;
    if (p.reactions) {
      allReactions.cap += p.reactions.cap?.length || 0;
      allReactions.relate += p.reactions.relate?.length || 0;
      allReactions.wild += p.reactions.wild?.length || 0;
      allReactions.facts += p.reactions.facts?.length || 0;
    }
    p.comments?.forEach(c => {
      allReactions.likes += c.reactions?.like?.length || 0;
      allReactions.relate += c.reactions?.relate?.length || 0;
    });
  });
  
  const total = allReactions.likes + allReactions.cap + allReactions.relate + allReactions.wild + allReactions.facts;
  
  if (total > 0) {
    if (allReactions.likes / total >= 0.6) badges.push({ icon: '❤️', label: 'Loved', color: '#ec4899' });
    if (allReactions.relate / total >= 0.4) badges.push({ icon: '🙌', label: 'Relatable', color: '#8b5cf6' });
    if (allReactions.wild / total >= 0.3) badges.push({ icon: '🦄', label: 'Wild Card', color: '#a855f7' });
    if (allReactions.facts / total >= 0.3) badges.push({ icon: '📢', label: 'Facts Only', color: '#eab308' });
    if (allReactions.cap / total >= 0.2) badges.push({ icon: '🤥', label: 'Cap Detector', color: '#f97316' });
  }
  
  const commentCount = posts.reduce((sum, p) => sum + (p.comments?.length || 0), 0);
  if (commentCount >= 10) badges.push({ icon: '💬', label: 'Conversationalist', color: '#06b6d4' });
  
  const totalReactions = total + (getVibeLikeCount(username));
  if (totalReactions >= 20) badges.push({ icon: '🔥', label: 'On Fire', color: '#ef4444' });
  if (getVibeLikeCount(username) >= 10) badges.push({ icon: '❤️', label: 'Vibe King', color: '#ec4899' });
  if (getTop8VibesCount(username) >= 5) badges.push({ icon: '⭐', label: 'Popular', color: '#f59e0b' });
  
  return badges;
}

function getUserRank(username) {
  const users = getUsers();
  const posts = getPosts();
  
  const userScores = users.map(u => {
    const userPosts = posts.filter(p => p.userId === u.username);
    let score = 0;
    
    score += getTop8VibesCount(u.username) * 10;
    score += getVibeLikeCount(u.username) * 5;
    
    userPosts.forEach(p => {
      score += p.likes.length * 2;
      score += p.dislikes.length * 1;
      score += p.comments.length * 3;
      score += (p.reactions?.cap?.length || 0) * 3;
      score += (p.reactions?.relate?.length || 0) * 4;
      score += (p.reactions?.wild?.length || 0) * 3;
      score += (p.reactions?.facts?.length || 0) * 3;
    });
    
    return { username: u.username, score };
  });
  
  userScores.sort((a, b) => b.score - a.score);
  
  const rank = userScores.findIndex(u => u.username === username) + 1;
  const total = users.length;
  
  return { rank, total };
}

function waveUser(username) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const me = getCurrentUser();
  if (me.username === username) { toast("Can't wave at yourself 😅", 'error'); return; }
  
  const waves = getWaves();
  if (!waves[username]) waves[username] = [];
  
  if (waves[username].includes(me.username)) {
    toast('You already waved at them! 👋', 'info');
    return;
  }
  
  waves[username].push(me.username);
  setWaves(waves);
  toast('You waved at @' + username + '! 👋', 'success');
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'wave', from: me.username, to: username, time: Date.now() });
  setNotifs(notifs);
  renderProfile(username);
}

function getWaves() { return getDB('userWaves', {}); }
function setWaves(v) { setDB('userWaves', v); }

// ══════════════════════════════════════
// FRIENDS SYSTEM
// ══════════════════════════════════════
function getFriends() { return getDB('friends', {}); }
function setFriends(v) { setDB('friends', v); }
function getFriendRequests() { return getDB('friendRequests', []); }
function setFriendRequests(v) { setDB('friendRequests', v); }

function sendFriendRequest(toUsername) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const me = getCurrentUser();
  if (me.username === toUsername) { toast("Can't friend yourself", 'error'); return; }
  
  const requests = getFriendRequests();
  if (requests.find(r => r.from === me.username && r.to === toUsername && r.status === 'pending')) {
    toast('Request already sent', 'info');
    return;
  }
  
  const friends = getFriends();
  if (friends[me.username]?.includes(toUsername)) {
    toast('Already friends!', 'info');
    return;
  }
  
  requests.push({ from: me.username, to: toUsername, time: Date.now(), status: 'pending' });
  setFriendRequests(requests);
  toast('Friend request sent!', 'success');
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'friendRequest', from: me.username, to: toUsername, time: Date.now() });
  setNotifs(notifs);
}

function acceptFriendRequest(fromUsername) {
  if (!currentSession) return;
  const me = getCurrentUser();
  const requests = getFriendRequests();
  const idx = requests.findIndex(r => r.from === fromUsername && r.to === me.username && r.status === 'pending');
  if (idx === -1) return;
  
  requests[idx].status = 'accepted';
  setFriendRequests(requests);
  
  const friends = getFriends();
  if (!friends[me.username]) friends[me.username] = [];
  if (!friends[fromUsername]) friends[fromUsername] = [];
  friends[me.username].push(fromUsername);
  friends[fromUsername].push(me.username);
  setFriends(friends);
  
  toast('You are now friends! 🎉', 'success');
  renderNotifications();
}

function rejectFriendRequest(fromUsername) {
  if (!currentSession) return;
  const me = getCurrentUser();
  const requests = getFriendRequests();
  const idx = requests.findIndex(r => r.from === fromUsername && r.to === me.username && r.status === 'pending');
  if (idx === -1) return;
  
  requests[idx].status = 'rejected';
  setFriendRequests(requests);
  renderNotifications();
}

function isFriends(user1, user2) {
  const friends = getFriends();
  return friends[user1]?.includes(user2) || false;
}

// ══════════════════════════════════════
// WAVES (SUPER LIKE)
// ══════════════════════════════════════
function wavePost(postId) {
  if (!currentSession) { toast('Log in to wave', 'error'); return; }
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;
  
  if (!post.waves) post.waves = [];
  if (post.waves.includes(me.username)) {
    toast('Already waved at this!', 'info');
    return;
  }
  
  post.waves.push(me.username);
  setPosts(posts);
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'wave', from: me.username, to: post.userId, postId, time: Date.now() });
  setNotifs(notifs);
  
  renderFeed(document.querySelector('#view-home .feed-tab.active')?.textContent?.toLowerCase().includes('friends') ? 'friends' : 'all');
  toast('You waved at this! 🌊', 'success');
}

// ══════════════════════════════════════
// COMMENT REACTIONS
// ══════════════════════════════════════
function toggleCommentReaction(postId, commentIndex, type) {
  if (!currentSession) { toast('Log in to react', 'error'); return; }
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post || !post.comments || !post.comments[commentIndex]) return;
  
  const comment = post.comments[commentIndex];
  if (!comment.reactions) comment.reactions = {};
  if (!comment.reactions[type]) comment.reactions[type] = [];
  
  const arr = comment.reactions[type];
  const idx = arr.indexOf(me.username);
  
  if (idx > -1) {
    arr.splice(idx, 1);
  } else {
    arr.push(me.username);
  }
  
  setPosts(posts);
  renderFeed('all');
}

function getCommentReactionCount(comment, type) {
  return comment.reactions?.[type]?.length || 0;
}

function hasCommentReacted(comment, type) {
  if (!currentSession) return false;
  const me = getCurrentUser();
  return comment.reactions?.[type]?.includes(me.username) || false;
}

// ══════════════════════════════════════
// AUDIO COMMENTS (60 second limit)
// ══════════════════════════════════════
function showAudioCommentModal(postId) {
  if (!currentSession) { toast('Log in to record', 'error'); return; }
  document.getElementById('modal-audio-comment').classList.remove('hidden');
  window.currentAudioCommentPost = postId;
  window.currentAudioReplyTo = null;
  initAudioRecorder();
}

function initAudioRecorder() {
  const recorderEl = document.getElementById('audio-recorder-status');
  const btn = document.getElementById('record-audio-btn');
  const timer = document.getElementById('audio-timer');
  if (recorderEl) recorderEl.textContent = '🎤 Click to start recording (60s max)';
  if (btn) btn.textContent = '🎤 Record';
  if (timer) timer.textContent = '0:00';
  window.audioRecording = false;
  window.audioBlob = null;
  if (window.audioTimerInterval) clearInterval(window.audioTimerInterval);
}

async function toggleAudioRecording() {
  const btn = document.getElementById('record-audio-btn');
  const status = document.getElementById('audio-recorder-status');
  const timer = document.getElementById('audio-timer');
  
  if (!window.audioRecording) {
    try {
      window.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      window.audioMediaRecorder = new MediaRecorder(window.audioStream);
      const chunks = [];
      
      window.audioMediaRecorder.ondataavailable = e => chunks.push(e.data);
      window.audioMediaRecorder.onstop = () => {
        window.audioBlob = new Blob(chunks, { type: 'audio/webm' });
        if (status) status.textContent = '✅ Recording done! Click to re-record';
        if (window.audioTimerInterval) clearInterval(window.audioTimerInterval);
      };
      
      window.audioMediaRecorder.start();
      window.audioRecording = true;
      window.audioStartTime = Date.now();
      if (btn) btn.textContent = '⏹️ Stop';
      if (status) status.textContent = '🔴 Recording...';
      
      window.audioTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - window.audioStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        if (timer) timer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        if (elapsed >= 60) {
          stopAudioRecording();
        }
      }, 1000);
      
    } catch (e) {
      toast('Mic access denied', 'error');
    }
  } else {
    stopAudioRecording();
  }
}

function stopAudioRecording() {
  if (window.audioMediaRecorder && window.audioRecording) {
    window.audioMediaRecorder.stop();
    if (window.audioStream) {
      window.audioStream.getTracks().forEach(t => t.stop());
    }
    window.audioRecording = false;
    const btn = document.getElementById('record-audio-btn');
    if (btn) btn.textContent = '🎤 Re-record';
    if (window.audioTimerInterval) clearInterval(window.audioTimerInterval);
  }
}

function submitAudioComment() {
  if (!window.audioBlob) { toast('Record audio first', 'error'); return; }
  
  const reader = new FileReader();
  reader.onload = () => {
    const posts = getPosts();
    const post = posts.find(p => p.id === window.currentAudioCommentPost);
    if (!post) return;
    
    if (!post.comments) post.comments = [];
    const me = getCurrentUser();
    
    post.comments.unshift({
      userId: me.username,
      authorName: me.name,
      audio: reader.result,
      time: Date.now(),
      replies: [],
      reactions: {}
    });
    
    setPosts(posts);
    closeModal('modal-audio-comment');
    openComments(window.currentAudioCommentPost);
    toast('Audio comment added! 🎤', 'success');
  };
  reader.readAsDataURL(window.audioBlob);
}

// ══════════════════════════════════════
// POST EXPIRATION (2 DAYS FOR TIMELINE)
// ══════════════════════════════════════
function isPostExpired(post) {
  if (post.pinned) return false;
  const TWO_DAYS = 2 * 24 * 60 * 60 * 1000;
  return Date.now() - post.time > TWO_DAYS;
}

function cleanupExpiredPosts() {
  const posts = getPosts();
  const initialCount = posts.length;
  const validPosts = posts.filter(p => !isPostExpired(p) || p.userId === getCurrentUser()?.username);
  
  if (validPosts.length !== initialCount) {
    setPosts(validPosts);
  }
}

// ══════════════════════════════════════
// ENHANCED REACTIONS WITH POPUPS
// ══════════════════════════════════════
function showReactionPopup(postId, btn) {
  const popup = document.getElementById('reaction-popup-' + postId);
  if (popup) {
    popup.classList.toggle('hidden');
  }
}

function toggleReactionWithPopup(postId, type) {
  toggleReaction(postId, type);
  const popup = document.getElementById('reaction-popup-' + postId);
  if (popup) popup.classList.add('hidden');
}

// ══════════════════════════════════════
// NAVIGATION - ADD MARKETPLACE & DISCLAIMER
// ══════════════════════════════════════
const originalNavigate = navigate;
navigate = function(view, param) {
  const views = ['home','explore','channels','channel-detail','messages','notifications','profile','edit-profile','my-channel','admin','search','marketplace','disclaimer','status-channels'];
  views.forEach(v => {
    const el = document.getElementById('view-' + v);
    if (el) el.classList.add('hidden');
  });
  
  const titles = { home:'🏠 Home Feed', explore:'🔍 Explore', channels:'📺 Channels', messages:'💬 Messages', notifications:'🔔 Notifications', profile:'👤 Profile', 'edit-profile':'🎨 Customize My Page', 'my-channel':'📡 My Channel', admin:'🛡️ Admin Panel', search:'🔍 Search', marketplace:'🛍️ Marketplace', disclaimer:'📜 Disclaimer', 'status-channels':'⏰ Status Channels' };
  document.getElementById('topbar-title').textContent = titles[view] || 'VibeHub';
  
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById('nav-' + view);
  if (navEl) navEl.classList.add('active');
  
  const el = document.getElementById('view-' + view);
  if (el) el.classList.remove('hidden');
  
  if (view === 'home') { cleanupExpiredPosts(); renderFeed('all'); }
  else if (view === 'explore') renderExplore();
  else if (view === 'channels') renderChannels();
  else if (view === 'channel-detail') renderChannelDetail(param);
  else if (view === 'messages') renderMessages();
  else if (view === 'notifications') renderNotifications();
  else if (view === 'profile') renderProfile(param || getCurrentUser()?.username);
  else if (view === 'edit-profile') renderEditProfile();
  else if (view === 'my-channel') renderMyChannel();
  else if (view === 'admin') renderAdmin();
  else if (view === 'marketplace') renderMarketplace();
  else if (view === 'status-channels') renderStatusChannels();
  else if (view === 'search') {} // handled by handleSearch
};

// Add nav items for marketplace and disclaimer
function addNavItems() {
  const sidebar = document.getElementById('sidebar');
  if (sidebar && !document.getElementById('nav-marketplace')) {
    const marketplaceNav = document.createElement('button');
    marketplaceNav.className = 'nav-item';
    marketplaceNav.id = 'nav-marketplace';
    marketplaceNav.onclick = () => navigate('marketplace');
    marketplaceNav.innerHTML = '<span class="nav-icon">🛍️</span> Marketplace';
    
    const disclaimerNav = document.createElement('button');
    disclaimerNav.className = 'nav-item';
    disclaimerNav.id = 'nav-disclaimer';
    disclaimerNav.onclick = () => navigate('disclaimer');
    disclaimerNav.innerHTML = '<span class="nav-icon">📜</span> Disclaimer';
    
    const editProfileNav = document.getElementById('nav-edit-profile');
    if (editProfileNav && editProfileNav.nextSibling) {
      sidebar.insertBefore(marketplaceNav, editProfileNav.nextSibling);
      sidebar.insertBefore(disclaimerNav, marketplaceNav.nextSibling);
    }
  }
}

// ══════════════════════════════════════
// REPUTATION ENGINE
// ══════════════════════════════════════
const ReputationEngine = {
  TIERS: {
    RISING_VOICE: { id: 'rising_voice', name: 'Rising Voice', emoji: '🌱', minScore: 0, color: '#10B981' },
    VIBE_CATALYST: { id: 'vibe_catalyst', name: 'Vibe Catalyst', emoji: '⚡', minScore: 100, color: '#F59E0B' },
    TREND_STARTER: { id: 'trend_starter', name: 'Trend Starter', emoji: '🔥', minScore: 500, color: '#EF4444' },
    DEBATE_MASTER: { id: 'debate_master', name: 'Debate Master', emoji: '🎯', minScore: 1000, color: '#8B5CF6' },
    COMMUNITY_BUILDER: { id: 'community_builder', name: 'Community Builder', emoji: '🏛️', minScore: 2500, color: '#06B6D4' },
    TRUSTED_SELLER: { id: 'trusted_seller', name: 'Trusted Seller', emoji: '💎', minScore: 5000, color: '#F97316' }
  },
  calculateReputation(username) {
    const posts = getPosts().filter(p => p.userId === username);
    let score = posts.length * 10;
    posts.forEach(p => {
      score += (p.likes?.length || 0) * 2;
      score += (p.dislikes?.length || 0) * 1;
      score += (p.comments?.length || 0) * 3;
      score += (p.waves?.length || 0) * 2;
    });
    const friends = getFriends()[username] || [];
    score += friends.length * 5;
    
    const tier = Object.values(this.TIERS).reverse().find(t => score >= t.minScore) || this.TIERS.RISING_VOICE;
    return { score, tier };
  },
  getScore(username) {
    return this.calculateReputation(username).score;
  },
  getTier(username) {
    return this.calculateReputation(username).tier;
  }
};
window.ReputationEngine = ReputationEngine;

// ══════════════════════════════════════
// MOMENTUM ENGINE
// ══════════════════════════════════════
const MomentumEngine = {
  DECAY_RATE: 0.985,
  LEVELS: {
    LOW: { min: 0, max: 100, name: 'Building', class: 'low' },
    MEDIUM: { min: 100, max: 300, name: 'Rising', class: 'medium' },
    HIGH: { min: 300, max: 600, name: 'Hot', class: 'high' },
    ELITE: { min: 600, max: Infinity, name: 'Legendary', class: 'elite' }
  },
  calculateMomentum(username) {
    const posts = getPosts().filter(p => p.userId === username);
    const now = Date.now();
    const dayMs = 24 * 60 * 60 * 1000;
    
    let momentum = 0;
    let streak = 0;
    
    posts.forEach(p => {
      const age = (now - p.time) / dayMs;
      const decay = Math.pow(this.DECAY_RATE, age);
      const engagement = (p.likes?.length || 0) + (p.dislikes?.length || 0) + (p.comments?.length || 0) * 2;
      momentum += engagement * decay;
    });
    
    const sorted = [...posts].sort((a, b) => b.time - a.time);
    if (sorted.length > 0) {
      let currentDate = new Date(sorted[0].time);
      currentDate.setHours(0, 0, 0, 0);
      streak = 1;
      for (let i = 1; i < Math.min(sorted.length, 30); i++) {
        const postDate = new Date(sorted[i].time);
        postDate.setHours(0, 0, 0, 0);
        const dayDiff = Math.floor((currentDate - postDate) / dayMs);
        if (dayDiff === 1) { streak++; currentDate = postDate; }
        else if (dayDiff > 1) break;
      }
    }
    
    momentum += streak * 20;
    momentum = Math.min(momentum, 1000);
    
    let level = this.LEVELS.LOW;
    if (momentum >= this.LEVELS.ELITE.min) level = this.LEVELS.ELITE;
    else if (momentum >= this.LEVELS.HIGH.min) level = this.LEVELS.HIGH;
    else if (momentum >= this.LEVELS.MEDIUM.min) level = this.LEVELS.MEDIUM;
    
    return { score: Math.floor(momentum), streak, level };
  },
  getScore(username) {
    return this.calculateMomentum(username).score;
  }
};
window.MomentumEngine = MomentumEngine;

// ══════════════════════════════════════
// STATUS CHANNELS (24-HOUR TEMPORARY)
// ══════════════════════════════════════
function getStatusChannels() { return getDB('statusChannels', []); }
function setStatusChannels(v) { setDB('statusChannels', v); }

function createStatusChannel() {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const name = prompt('Status channel name:');
  if (!name) return;
  
  const me = getCurrentUser();
  const channels = getStatusChannels();
  channels.unshift({
    id: 'status_' + Date.now(),
    name: name,
    creator: me.username,
    createdAt: Date.now(),
    expiresAt: Date.now() + (24 * 60 * 60 * 1000)
  });
  setStatusChannels(channels);
  toast('Status channel created! Expires in 24h ⏰', 'success');
  renderStatusChannels();
}

function renderStatusChannels() {
  const channels = getStatusChannels().filter(c => c.expiresAt > Date.now());
  const container = document.getElementById('status-channels-list');
  if (!container) return;
  
  if (!channels.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">⏰</div><div class="empty-title">No active status channels</div><div class="empty-desc">Create one to start vibing!</div></div>';
    return;
  }
  
  container.innerHTML = channels.map(c => `
    <div class="channel-card" onclick="joinStatusChannel('${c.id}')">
      <div class="channel-banner">${c.name[0]}</div>
      <div class="channel-info">
        <div class="channel-name">${escHtml(c.name)}</div>
        <div class="channel-meta">
          <span class="channel-subs">by @${c.creator}</span>
          <span style="color:var(--cyan);font-size:11px;">⏰ ${Math.round((c.expiresAt - Date.now()) / 3600000)}h left</span>
        </div>
      </div>
    </div>
  `).join('');
}

function joinStatusChannel(channelId) {
  const channel = getStatusChannels().find(c => c.id === channelId);
  if (!channel) { toast('Channel expired', 'error'); return; }
  toast(`Joined #${channel.name}! 🎉`, 'success');
}

// ══════════════════════════════════════
// COLLABORATIVE POSTS
// ══════════════════════════════════════
function getCollabPosts() { return getDB('collabPosts', []); }
function setCollabPosts(v) { setDB('collabPosts', v); }

function showCollabModal(postId) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  document.getElementById('modal-collab-post').classList.remove('hidden');
  window.currentCollabPost = postId;
}

function sendCollabRequest() {
  const username = document.getElementById('collab-user-input').value.trim();
  if (!username) { toast('Enter username', 'error'); return; }
  
  const collabs = getCollabPosts();
  collabs.unshift({
    id: 'collab_' + Date.now(),
    postId: window.currentCollabPost,
    from: getCurrentUser().username,
    to: username,
    status: 'pending',
    createdAt: Date.now()
  });
  setCollabPosts(collabs);
  closeModal('modal-collab-post');
  toast('Collab request sent! 🤝', 'success');
}

function acceptCollab(collabId) {
  const collabs = getCollabPosts();
  const collab = collabs.find(c => c.id === collabId);
  if (!collab) return;
  
  collab.status = 'accepted';
  setCollabPosts(collabs);
  
  const posts = getPosts();
  const post = posts.find(p => p.id === collab.postId);
  if (post) {
    if (!post.collabs) post.collabs = [];
    post.collabs.push(collab.from);
    setPosts(posts);
  }
  
  toast('Collab accepted! 🤝', 'success');
  renderNotifications();
}

// ══════════════════════════════════════
// VIBE SYNC (ROOM ENERGY DETECTION)
// ══════════════════════════════════════
const VibeSyncEngine = {
  detectRoomEnergy(posts) {
    if (!posts || posts.length === 0) return { energy: 'calm', emoji: '😌', color: '#06B6D4' };
    
    const now = Date.now();
    const recentPosts = posts.filter(p => now - p.time < 3600000);
    
    let totalEngagement = 0;
    let waveCount = 0;
    let reactionCount = 0;
    
    recentPosts.forEach(p => {
      totalEngagement += (p.likes?.length || 0) + (p.dislikes?.length || 0);
      waveCount += p.waves?.length || 0;
      if (p.reactions) {
        Object.values(p.reactions).forEach(arr => {
          reactionCount += arr?.length || 0;
        });
      }
    });
    
    const score = totalEngagement + (waveCount * 2) + (reactionCount * 1.5);
    
    if (score > 100) return { energy: 'lit', emoji: '🔥', color: '#EF4444' };
    if (score > 50) return { energy: 'vibing', emoji: '🎵', color: '#8B5CF6' };
    if (score > 20) return { energy: 'chill', emoji: '☕', color: '#10B981' };
    return { energy: 'calm', emoji: '😌', color: '#06B6D4' };
  },
  
  getRoomPulse() {
    const posts = getPosts();
    return this.detectRoomEnergy(posts);
  }
};
window.VibeSyncEngine = VibeSyncEngine;

// ══════════════════════════════════════
// INIT
// ══════════════════════════════════════
function init() {
  // Attach button listeners
  addNavItems();
  
  // Check for admin setup URL - show setup even if owner exists (for recovery)
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('vibe-control-7x9kq2m')) {
    // Admin URL - allow re-setup if needed
    showPage('admin-setup');
    document.getElementById('modal-admin-setup').classList.remove('hidden');
  }
  
  // Initialize Supabase client
  initSupabaseClient();
  
  // Seed demo data if needed
  seedData();
  
  // Check for existing session
  const session = getDB('session', null);
  if (session) {
    const user = getCurrentUser();
    if (user) {
      launchApp();
      return;
    }
  }
  
  // Show landing page
  showPage('landing');
  if (typeof updateBetaUI === 'function') updateBetaUI();
}

// Simple init - handled by init() at bottom of file

function continueInit() {
  var navLoginBtn = document.getElementById('nav-login-btn');
  var landingJoinBtn = document.getElementById('landing-join-btn');
  var heroJoinBtn = document.getElementById('hero-join-btn');
  var heroLoginBtn = document.getElementById('hero-login-btn');
  
  if (landingJoinBtn) landingJoinBtn.onclick = function() { showPage('register'); };
  if (navLoginBtn) navLoginBtn.onclick = function() { showPage('login'); };
  if (heroJoinBtn) heroJoinBtn.onclick = function() { showPage('register'); };
  if (heroLoginBtn) heroLoginBtn.onclick = function() { showPage('login'); };
}



// Simple init - handled by init() at bottom of file

function continueInit() {
  // Just show landing if no session
  const session = getDB('session', null);
  if (session && getCurrentUser()) {
    launchApp();
  } else {
    showPage('landing');
  }
}

// Click outside modal to close
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-overlay')) {
    e.target.classList.add('hidden');
    const payBtn = document.querySelector('#modal-payment .btn-primary');
    if (payBtn) { payBtn.textContent = 'Pay $1 & Join VibeHub 🚀'; payBtn.disabled = false; }
  }
});

// Attach button listeners immediately - before anything else
(function attachButtonsNow() {
  var btnIds = ['nav-login-btn', 'landing-join-btn', 'hero-join-btn', 'hero-login-btn'];
  btnIds.forEach(function(id) {
    var btn = document.getElementById(id);
    if (btn && !btn._hasListener) {
      btn._hasListener = true;
      if (id === 'nav-login-btn' || id === 'hero-login-btn') {
        btn.onclick = function() { showPage('login'); };
      } else {
        btn.onclick = function() { showPage('register'); };
      }
    }
  });
})();

try {
  initSupabaseClient();
  init();
} catch(e) {
  console.error('Init error:', e);
  // Fallback: show landing page anyway
  document.getElementById('page-landing').classList.remove('hidden');
}
</script>
</body>
</html>
