<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#8b5cf6">
<meta name="description" content="VibeHub - Social media for the vibe generation">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="VibeHub">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✌️</text></svg>">
<link rel="manifest" href="manifest.json">
<title>VibeHub — Where Your Vibe Lives</title>
<link rel="icon" href="https://i.ibb.co/Fqnj3JKp/1000001392.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script>
(function() {
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
  s.onload = function() { window.supabaseReady = true; console.log('Supabase loaded'); };
  s.onerror = function() { console.log('Supabase failed to load'); };
  document.head.appendChild(s);
})();
</script>
<script>
  window.VIBEHUB_SUPABASE_URL = 'https://osfqlabtuqpynqcdmwff.supabase.co';
  window.VIBEHUB_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zZnFsYWJ0dXFweW5xY2Rtd2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODQ3OTEsImV4cCI6MjA4NzU2MDc5MX0.LXZ-lbLiarXHSSlu8NXi0c_uvIVFxh8mw6amXGJAwtA';
</script>

<!-- Splash Screen -->
<div id="splash-screen" style="display:none;">
  <div class="splash-particles">
    <div class="particle purple" style="--x:10%;--y:20%;--d:3s;--s:20px;"></div>
    <div class="particle purple" style="--x:80%;--y:15%;--d:4s;--s:15px;"></div>
    <div class="particle purple" style="--x:30%;--y:70%;--d:5s;--s:25px;"></div>
    <div class="particle purple" style="--x:70%;--y:60%;--d:3.5s;--s:18px;"></div>
    <div class="particle orange" style="--x:20%;--y:40%;--d:4s;--s:22px;"></div>
    <div class="particle orange" style="--x:60%;--y:30%;--d:3s;--s:16px;"></div>
    <div class="particle orange" style="--x:40%;--y:80%;--d:5s;--s:20px;"></div>
    <div class="particle orange" style="--x:90%;--y:70%;--d:4s;--s:18px;"></div>
  </div>
  <div class="splash-glow"></div>
  <img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="splash-logo" alt="VibeHub">
  <div class="splash-spinner"></div>
</div>

<style>
/* Splash Screen */
#splash-screen {
  position: fixed;
  inset: 0;
  background: #08080f;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.splash-glow {
  position: absolute;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(139,92,246,0.4) 0%, transparent 70%);
  animation: glowPulse 2s ease-in-out infinite;
}

.splash-logo {
  height: 120px;
  animation: logoFloat 2s ease-in-out infinite;
  z-index: 1;
}

.splash-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(139,92,246,0.3);
  border-top-color: #8b5cf6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-top: 30px;
}

.splash-particles {
  position: absolute;
  inset: 0;
  overflow: hidden;
}

.particle {
  position: absolute;
  border-radius: 50%;
  animation: float var(--d) ease-in-out infinite;
  left: var(--x);
  top: var(--y);
  width: var(--s);
  height: var(--s);
}

.particle.purple {
  background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
  box-shadow: 0 0 20px #8b5cf6;
}

.particle.orange {
  background: radial-gradient(circle, #f59e0b 0%, transparent 70%);
  box-shadow: 0 0 20px #f59e0b;
}

@keyframes glowPulse {
  0%, 100% { transform: scale(1); opacity: 0.6; }
  50% { transform: scale(1.2); opacity: 1; }
}

@keyframes logoFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes float {
  0%, 100% { transform: translateY(0) scale(1); opacity: 0.8; }
  50% { transform: translateY(-30px) scale(1.2); opacity: 1; }
}

/* Native App Feel - Smooth Transitions */
html {
  scroll-behavior: smooth;
}

* {
  -webkit-tap-highlight-color: transparent;
}

.btn, .nav-item, .feed-tab, .post-action, .comment-reaction-btn {
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn:active {
  transform: scale(0.96);
}

.nav-item:active {
  transform: scale(0.98);
}

.feed-tab:active {
  transform: scale(0.95);
}

/* Smooth view transitions */
.view {
  animation: viewFadeIn 0.25s ease;
}

@keyframes viewFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Card hover effects */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Post card smooth render */
.post-card {
  animation: postFadeIn 0.3s ease;
}

@keyframes postFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Global responsive fixes - REPLACE existing */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  max-width: 100vw;
  min-height: 100dvh;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
}

img, video {
  max-width: 100%;
  height: auto;
}

/* Force full width on all containers */
.container, .wrapper, .content, main, section, article {
  width: 100%;
  max-width: 100%;
}

/* Prevent horizontal overflow everywhere */
div, span, p, ul, ol, li, form, table, tr, td, th, header, footer, nav, aside {
  max-width: 100%;
  overflow-x: hidden;
}

/* Ensure no horizontal scroll on any element */
* {
  max-width: 100vw;
  overflow-x: hidden;
}

:root {
  --bg: #08080f;
  --bg2: #0f0f1a;
  --bg3: #151525;
  --card: #12121e;
  --card2: #1a1a2e;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --purple: #8b5cf6;
  --purple2: #7c3aed;
  --pink: #ec4899;
  --gold: #f59e0b;
  --cyan: #06b6d4;
  --green: #10b981;
  --red: #ef4444;
  --text: #f1f0ff;
  --text2: #a0a0c0;
  --text3: #60607a;
  --glow: 0 0 30px rgba(139,92,246,0.3);
  --glow2: 0 0 60px rgba(139,92,246,0.15);
  --radius: 16px;
  --radius2: 12px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--purple2); border-radius: 4px; }

/* ── UTILITIES ── */
.hidden { display: none !important; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }
.gap-4 { gap: 16px; }
.w-full { width: 100%; }
.text-center { text-align: center; }
.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ── BUTTONS ── */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 10px 20px; border-radius: 50px; border: none;
  font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 14px;
  cursor: pointer; transition: all .2s; text-decoration: none;
  white-space: nowrap;
}
.btn-primary {
  background: linear-gradient(135deg, var(--purple), var(--pink));
  color: #fff; box-shadow: 0 4px 20px rgba(139,92,246,0.4);
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(139,92,246,0.5); }
.btn-outline {
  background: transparent; color: var(--text);
  border: 1px solid var(--border2);
}
.btn-outline:hover { background: var(--card2); border-color: var(--purple); }
.btn-ghost {
  background: transparent; color: var(--text2);
  border: none; padding: 8px 14px; border-radius: var(--radius2);
}
.btn-ghost:hover { background: var(--card2); color: var(--text); }
.btn-sm { padding: 7px 14px; font-size: 12px; }
.btn-danger { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
.btn-danger:hover { background: rgba(239,68,68,0.25); }

/* ── INPUTS ── */
input, textarea, select {
  background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text); font-family: 'DM Sans', sans-serif;
  font-size: 14px; border-radius: var(--radius2);
  padding: 10px 14px; width: 100%;
  transition: border-color .2s, box-shadow .2s;
}
input:focus, textarea:focus, select:focus {
  outline: none; border-color: var(--purple);
  box-shadow: 0 0 0 3px rgba(139,92,246,0.15);
}
textarea { resize: vertical; min-height: 80px; }
label { display: block; font-size: 13px; color: var(--text2); margin-bottom: 6px; font-weight: 500; }
.form-group { margin-bottom: 16px; }

/* ── CARDS ── */
.card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden;
}
.card-body { padding: 20px; }

/* ── AVATAR ── */
.avatar {
  border-radius: 50%; object-fit: cover; flex-shrink: 0;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif; font-weight: 700; color: #fff;
  overflow: hidden;
}
.avatar-sm { width: 36px; height: 36px; font-size: 14px; }
.avatar-md { width: 48px; height: 48px; font-size: 18px; }
.avatar-lg { width: 80px; height: 80px; font-size: 28px; }
.avatar-xl { width: 120px; height: 120px; font-size: 40px; }

/* ── BADGE ── */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 50px; font-size: 11px; font-weight: 600;
}
.badge-purple { background: rgba(139,92,246,0.2); color: var(--purple); border: 1px solid rgba(139,92,246,0.3); }
.badge-gold { background: rgba(245,158,11,0.2); color: var(--gold); border: 1px solid rgba(245,158,11,0.3); }
.badge-green { background: rgba(16,185,129,0.2); color: var(--green); border: 1px solid rgba(16,185,129,0.3); }
.badge-pink { background: rgba(236,72,153,0.2); color: var(--pink); border: 1px solid rgba(236,72,153,0.3); }

/* ── MODAL ── */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.8);
  backdrop-filter: blur(8px); z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
/* Hide admin modals by default */
#modal-admin-login.hidden, #modal-admin-setup.hidden {
  display: none !important;
}
.modal {
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 24px; width: 100%; max-width: 480px;
  max-height: 90vh; overflow-y: auto;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6), var(--glow2);
  animation: modalIn .25s ease;
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.modal-header {
  padding: 24px 24px 0;
  display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; }
.modal-body { padding: 20px 24px 24px; }
.close-btn {
  width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border2);
  background: var(--bg3); cursor: pointer; display: flex; align-items: center; justify-content: center;
  color: var(--text2); font-size: 18px; transition: all .2s;
}
.close-btn:hover { background: var(--card2); color: var(--text); }

/* ── TOAST ── */
#toast-container {
  position: fixed; bottom: 24px; right: 24px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: var(--card2); border: 1px solid var(--border2);
  color: var(--text); padding: 12px 18px; border-radius: 12px;
  font-size: 14px; font-weight: 500; box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  animation: toastIn .3s ease; display: flex; align-items: center; gap: 8px;
  max-width: 320px;
}
.toast.success { border-color: rgba(16,185,129,0.4); }
.toast.error { border-color: rgba(239,68,68,0.4); }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* ──────────────────────────────────────────
   LANDING PAGE
────────────────────────────────────────── */
#page-landing {
  min-height: 100vh;
  background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(139,92,246,0.15) 0%, transparent 70%),
              radial-gradient(ellipse 60% 40% at 100% 100%, rgba(236,72,153,0.1) 0%, transparent 60%),
              var(--bg);
}

.landing-nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 40px; max-width: 1200px; margin: 0 auto;
}
.logo {
  font-family: 'Syne', sans-serif; font-weight: 800; font-size: 26px;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-decoration: none;
}
.site-logo { height: 56px; width: auto; cursor: pointer; }
.site-logo-lg { height: 126px; width: auto; cursor: pointer; }
.landing-hero {
  max-width: 900px; margin: 0 auto; padding: 80px 40px 60px;
  text-align: center;
}
.landing-eyebrow {
  display: inline-flex; align-items: center; gap: 8px;
  background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3);
  color: var(--purple); padding: 6px 16px; border-radius: 50px;
  font-size: 13px; font-weight: 600; margin-bottom: 28px;
  animation: fadeUp .5s ease;
}
.landing-title {
  font-family: 'Syne', sans-serif; font-size: clamp(48px, 8vw, 96px);
  font-weight: 800; line-height: 1.05; margin-bottom: 24px;
  animation: fadeUp .5s .1s ease both;
}
.landing-title .grad {
  background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 50%, var(--gold) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.landing-sub {
  font-size: 18px; color: var(--text2); max-width: 600px; margin: 0 auto 40px;
  line-height: 1.7; animation: fadeUp .5s .2s ease both;
}
.landing-ctas {
  display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;
  animation: fadeUp .5s .3s ease both;
}
.landing-features {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px; max-width: 1100px; margin: 60px auto; padding: 0 40px;
}
.feature-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 24px;
  transition: all .2s; animation: fadeUp .5s ease both;
}
.feature-card:hover { border-color: var(--purple); transform: translateY(-4px); box-shadow: var(--glow); }
.feature-icon { font-size: 32px; margin-bottom: 12px; }
.feature-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 6px; }
.feature-desc { font-size: 13px; color: var(--text2); line-height: 1.6; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ──────────────────────────────────────────
   AUTH PAGES
────────────────────────────────────────── */
.auth-page {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: radial-gradient(ellipse 70% 50% at 50% 0%, rgba(139,92,246,0.12) 0%, transparent 60%), var(--bg);
  padding: 20px;
}
.auth-card {
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 24px; padding: 40px; width: 100%; max-width: 440px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.5);
}
.auth-logo { text-align: center; margin-bottom: 8px; }
.auth-subtitle { text-align: center; color: var(--text2); font-size: 14px; margin-bottom: 32px; }
.auth-switch { text-align: center; font-size: 14px; color: var(--text2); margin-top: 20px; }
.auth-switch a { color: var(--purple); text-decoration: none; font-weight: 600; }
.auth-switch a:hover { color: var(--pink); }
.auth-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 28px; text-align: center; margin-bottom: 4px; }

/* ──────────────────────────────────────────
   APP SHELL
────────────────────────────────────────── */
#app-shell {
  display: flex; min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 260px; flex-shrink: 0; background: var(--bg2);
  border-right: 1px solid var(--border); padding: 20px 16px;
  display: flex; flex-direction: column; gap: 4px;
  position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto;
  z-index: 100;
}
.sidebar-logo { padding: 4px 12px 20px; }
.sidebar-section { font-size: 11px; font-weight: 700; color: var(--text3); padding: 16px 12px 6px; letter-spacing: .08em; text-transform: uppercase; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-radius: 12px; cursor: pointer;
  font-size: 14px; font-weight: 500; color: var(--text2);
  transition: all .15s; text-decoration: none; border: none; background: none;
  width: 100%;
}
.nav-item:hover { background: var(--card2); color: var(--text); }
.nav-item.active { background: rgba(139,92,246,0.15); color: var(--purple); font-weight: 600; }
.nav-item .nav-icon { font-size: 18px; width: 24px; text-align: center; }
.nav-item .nav-badge {
  margin-left: auto; background: var(--pink); color: #fff;
  font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 50px;
}

.sidebar-user {
  margin-top: auto; padding: 16px 12px;
  border-top: 1px solid var(--border); display: flex; align-items: center; gap: 10px;
  cursor: pointer; border-radius: 12px; transition: background .15s;
}
.sidebar-user:hover { background: var(--card2); }
.sidebar-user-info { flex: 1; overflow: hidden; }
.sidebar-user-name { font-weight: 600; font-size: 14px; truncate; }
.sidebar-user-handle { font-size: 12px; color: var(--text3); }

/* Main content */
.main-content {
  flex: 1; margin-left: 260px; min-height: 100vh;
}

/* Top bar */
.topbar {
  position: sticky; top: 0; z-index: 50;
  background: rgba(8,8,15,0.85); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 14px 24px; display: flex; align-items: center; gap: 12px;
}
.topbar-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; flex: 1; }
.topbar-search {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 50px; padding: 8px 16px; width: 240px;
}
.topbar-search input {
  background: none; border: none; padding: 0; font-size: 13px;
  box-shadow: none;
}
.topbar-search input:focus { box-shadow: none; }

/* Mobile Navigation Dropdown */
.mobile-nav-container {
  display: none;
  padding: 10px 16px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
}

.mobile-nav-dropdown {
  width: 100%;
  padding: 12px 16px;
  font-size: 15px;
  font-family: 'DM Sans', sans-serif;
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border2);
  border-radius: 12px;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23ffffff' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

.mobile-nav-dropdown:focus {
  outline: none;
  border-color: var(--purple);
}

.mobile-nav-dropdown option {
  background: var(--bg3);
  color: var(--text);
  padding: 12px;
}

/* Show mobile nav only on small screens */
@media (max-width: 768px) {
  .mobile-nav-container {
    display: block;
  }
  
  .sidebar {
    display: none;
  }
  
  .app-layout {
    padding-left: 0;
  }
}

/* Page views */
.view { padding: 24px; max-width: 680px; margin: 0 auto; }
.view-wide { padding: 24px; max-width: 1100px; margin: 0 auto; }

/* ──────────────────────────────────────────
   FEED
────────────────────────────────────────── */
.post-composer {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
}
.composer-top { display: flex; gap: 12px; }
.composer-input {
  flex: 1; background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 12px; padding: 12px 16px;
  font-size: 14px; color: var(--text); line-height: 1.5; resize: none;
  transition: border-color .2s;
}
.composer-input:focus { outline: none; border-color: var(--purple); }
.composer-actions {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);
}
.composer-tools { display: flex; gap: 4px; }
.composer-tool {
  width: 36px; height: 36px; border-radius: 8px; border: none;
  background: transparent; cursor: pointer; font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text2); transition: all .15s;
}
.composer-tool:hover { background: var(--bg3); color: var(--text); }

/* Post card */
.post-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); margin-bottom: 16px;
  transition: border-color .2s;
  animation: fadeUp .3s ease;
}
.post-card:hover { border-color: var(--border2); }
.post-header {
  display: flex; align-items: center; gap: 12px;
  padding: 16px 20px 12px;
}
.post-user-info { flex: 1; overflow: hidden; }
.post-user-name { font-weight: 600; font-size: 14px; cursor: pointer; }
.post-user-name:hover { color: var(--purple); }
.post-meta { font-size: 12px; color: var(--text3); }
.post-body { padding: 0 20px 4px; font-size: 15px; line-height: 1.6; color: var(--text); }
.post-media {
  margin: 12px 20px; border-radius: 12px; overflow: hidden;
  max-height: 400px; background: var(--bg3);
}
.post-media img { width: 100%; height: 100%; object-fit: cover; }
.post-media video { width: 100%; max-height: 400px; }
.post-tags { padding: 8px 20px; display: flex; flex-wrap: wrap; gap: 6px; }
.post-tag {
  font-size: 12px; color: var(--purple); font-weight: 500; cursor: pointer;
}
.post-tag:hover { color: var(--pink); }

.post-actions {
  display: flex; align-items: center; gap: 4px;
  padding: 8px 12px 16px; border-top: 1px solid var(--border); margin-top: 8px;
}
.post-action {
  display: flex; align-items: center; gap: 6px;
  padding: 7px 14px; border-radius: 50px; cursor: pointer;
  font-size: 13px; font-weight: 600; border: none; background: transparent;
  color: var(--text2); transition: all .15s;
}
.post-action:hover { background: var(--bg3); }
.post-action.liked { color: var(--purple); background: rgba(139,92,246,0.1); }
.post-action.disliked { color: var(--red); background: rgba(239,68,68,0.1); }
.post-action.commented { color: var(--cyan); }
.post-action.cap-react { color: #f97316; background: rgba(249,115,22,0.15); }
.post-action.relate-react { color: #ec4899; background: rgba(236,72,153,0.15); }
.post-action.wild-react { color: #a855f7; background: rgba(168,85,247,0.15); }
.post-action.facts-react { color: #eab308; background: rgba(234,179,8,0.15); }

/* Comments */
.post-comments {
  padding: 12px 20px 16px; border-top: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 10px;
}
.comment {
  display: flex; gap: 10px; align-items: flex-start;
}
.comment-body { flex: 1; }
.comment-author { font-size: 13px; font-weight: 600; display: inline; margin-right: 6px; }
.comment-text { font-size: 13px; color: var(--text2); display: inline; line-height: 1.5; }
.comment-time { font-size: 11px; color: var(--text3); margin-top: 2px; }
.comment-input-row { display: flex; gap: 10px; align-items: center; margin-top: 6px; }
.comment-input-row input { flex: 1; border-radius: 50px; padding: 8px 14px; }
.comment-reaction-btn { background:none;border:none;font-size:12px;cursor:pointer;padding:2px 6px;border-radius:8px;color:var(--text3);transition:all .15s; }
.comment-reaction-btn:hover { background:var(--bg3); }
.comment-reaction-btn.active { color:var(--purple); }
.comment-reply-btn { background:none;border:none;font-size:12px;cursor:pointer;padding:2px 6px;border-radius:8px;color:var(--cyan); }

/* Feed tabs */
.feed-tabs {
  display: flex; gap: 4px; margin-bottom: 20px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; padding: 4px;
}
.feed-tab {
  flex: 1; text-align: center; padding: 8px; border-radius: 8px;
  font-size: 13px; font-weight: 600; cursor: pointer; color: var(--text2);
  border: none; background: transparent; transition: all .15s;
}
.feed-tab.active { background: var(--purple2); color: #fff; }

/* ──────────────────────────────────────────
   PROFILE PAGE
────────────────────────────────────────── */
.profile-page { }

.profile-banner {
  height: 200px; width: 100%; position: relative; overflow: hidden;
  background: linear-gradient(135deg, var(--purple2), var(--pink));
}
.profile-banner img { width: 100%; height: 100%; object-fit: cover; }
.profile-banner-overlay {
  position: absolute; inset: 0;
  background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.6));
}

.profile-info-section {
  padding: 0 24px 24px;
  position: relative;
}
.profile-avatar-wrap {
  margin-top: -50px; margin-bottom: 16px;
  display: flex; align-items: flex-end; gap: 16px;
}
.profile-avatar-wrap .avatar-xl {
  border: 4px solid var(--bg); box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  font-size: 44px;
}
.profile-name { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 28px; }
.profile-handle { color: var(--text2); font-size: 14px; margin-bottom: 8px; }
.profile-bio { color: var(--text2); font-size: 14px; line-height: 1.6; max-width: 500px; margin-bottom: 12px; }
.profile-stats { display: flex; gap: 24px; margin-bottom: 16px; }
.profile-stat { text-align: center; }
.profile-stat-num { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; }
.profile-stat-label { font-size: 12px; color: var(--text3); }
.profile-actions { display: flex; gap: 8px; }

/* Profile grid layout */
.profile-grid {
  display: grid; grid-template-columns: 1fr 300px; gap: 20px;
  padding: 0 24px 24px;
}

/* Music player */
.music-player {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
}
.music-player-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; margin-bottom: 12px; color: var(--text2); display: flex; align-items: center; gap: 6px; }
.music-track { display: flex; align-items: center; gap: 10px; }
.music-thumb {
  width: 48px; height: 48px; border-radius: 8px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--purple2), var(--pink));
  display: flex; align-items: center; justify-content: center; font-size: 20px;
  animation: spin 4s linear infinite paused;
}
.music-thumb.playing { animation-play-state: running; }
@keyframes spin { to { transform: rotate(360deg); } }
.music-info { flex: 1; overflow: hidden; }
.music-track-name { font-weight: 600; font-size: 14px; truncate; }
.music-artist { font-size: 12px; color: var(--text2); }
.music-controls { display: flex; align-items: center; gap: 6px; margin-top: 8px; }
.music-btn {
  width: 32px; height: 32px; border-radius: 50%; border: none;
  background: var(--bg3); cursor: pointer; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text2); transition: all .15s;
}
.music-btn.play { background: var(--purple2); color: #fff; width: 36px; height: 36px; font-size: 16px; }
.music-btn:hover { background: var(--card2); color: var(--text); }
.music-progress {
  flex: 1; height: 3px; background: var(--border);
  border-radius: 3px; overflow: hidden; margin: 0 8px;
}
.music-progress-fill {
  height: 100%; background: linear-gradient(to right, var(--purple), var(--pink));
  width: 35%; transition: width .1s;
}

/* Top 8 */
.top8-widget {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
}
.top8-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; margin-bottom: 12px; color: var(--text2); display: flex; align-items: center; gap: 6px; }
.top8-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.top8-friend {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: pointer;
}
.top8-friend:hover .avatar-sm { box-shadow: 0 0 0 2px var(--purple); }
.top8-name { font-size: 10px; color: var(--text2); text-align: center; truncate; max-width: 60px; }

/* Mood widget */
.mood-widget {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.mood-emoji { font-size: 28px; }
.mood-text { font-size: 13px; color: var(--text2); }
.mood-text strong { color: var(--text); display: block; }

/* Profile customizer */
.customizer {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
}
.customizer-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 16px; }
.color-picker-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
.color-swatch {
  width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
  border: 2px solid transparent; transition: all .15s;
}
.color-swatch.active, .color-swatch:hover { transform: scale(1.2); border-color: #fff; }
.gradient-option {
  height: 36px; border-radius: 8px; cursor: pointer;
  border: 2px solid transparent; transition: all .15s; flex: 1;
}
.gradient-option.active, .gradient-option:hover { border-color: #fff; transform: translateY(-2px); }

/* Profile theme application */
.profile-themed {
  --theme-primary: var(--purple);
  --theme-bg: var(--card);
}

/* ──────────────────────────────────────────
   CHANNELS
────────────────────────────────────────── */
.channels-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
  margin-bottom: 24px;
}
.channel-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden; cursor: pointer;
  transition: all .2s;
}
.channel-card:hover { border-color: var(--purple); transform: translateY(-4px); box-shadow: var(--glow); }
.channel-banner {
  height: 120px; background: linear-gradient(135deg, var(--purple2), var(--pink));
  display: flex; align-items: center; justify-content: center; font-size: 40px;
  position: relative; overflow: hidden;
}
.channel-info { padding: 16px; }
.channel-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 4px; }
.channel-desc { font-size: 13px; color: var(--text2); margin-bottom: 12px; line-height: 1.5; }
.channel-meta { display: flex; align-items: center; justify-content: space-between; }
.channel-subs { font-size: 12px; color: var(--text3); }

/* Video grid */
.video-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;
}
.video-thumb {
  background: var(--bg3); border-radius: 12px; overflow: hidden;
  cursor: pointer; transition: transform .2s;
}
.video-thumb:hover { transform: translateY(-4px); }
.video-preview {
  height: 130px; background: linear-gradient(135deg, #1a1a2e, #0f0f1a);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; position: relative;
}
.video-play-overlay {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.4); opacity: 0; transition: opacity .2s;
  font-size: 40px;
}
.video-thumb:hover .video-play-overlay { opacity: 1; }
.video-info { padding: 10px 12px; }
.video-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.video-meta { font-size: 11px; color: var(--text3); }

/* ──────────────────────────────────────────
   MESSAGES
────────────────────────────────────────── */
.messages-layout {
  display: grid; grid-template-columns: 300px 1fr; gap: 0;
  height: calc(100vh - 61px);
}
.dm-list {
  border-right: 1px solid var(--border); overflow-y: auto;
  padding: 16px;
}
.dm-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px; border-radius: 12px; cursor: pointer;
  transition: background .15s;
}
.dm-item:hover, .dm-item.active { background: var(--card2); }
.dm-info { flex: 1; overflow: hidden; }
.dm-name { font-weight: 600; font-size: 14px; }
.dm-preview { font-size: 12px; color: var(--text3); truncate; }
.dm-time { font-size: 11px; color: var(--text3); }
.dm-unread { background: var(--purple2); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 50px; }

.chat-area { display: flex; flex-direction: column; }
.chat-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}
.chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.message-bubble {
  max-width: 70%; display: flex; flex-direction: column; gap: 3px;
}
.message-bubble.sent { align-self: flex-end; align-items: flex-end; }
.message-bubble.recv { align-self: flex-start; align-items: flex-start; }
.bubble {
  padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.5;
  word-break: break-word;
}
.sent .bubble { background: var(--purple2); color: #fff; border-bottom-right-radius: 4px; }
.recv .bubble { background: var(--card2); color: var(--text); border-bottom-left-radius: 4px; }
.bubble-time { font-size: 11px; color: var(--text3); padding: 0 4px; }
.chat-input-bar {
  padding: 16px 20px; border-top: 1px solid var(--border);
  display: flex; gap: 10px; align-items: flex-end;
}
.chat-input {
  flex: 1; max-height: 120px; border-radius: 16px;
}

/* ──────────────────────────────────────────
   EXPLORE / TRENDING
────────────────────────────────────────── */
.explore-section { margin-bottom: 32px; }
.explore-heading {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px;
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}
.trending-tags { display: flex; flex-wrap: wrap; gap: 8px; }
.trend-tag {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 50px; padding: 8px 16px; cursor: pointer;
  font-size: 14px; font-weight: 500; transition: all .15s;
}
.trend-tag:hover { border-color: var(--purple); background: rgba(139,92,246,0.1); color: var(--purple); }
.trend-tag .tag-count { color: var(--text3); font-size: 12px; }

.creator-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
.creator-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px; text-align: center;
  cursor: pointer; transition: all .2s;
}
.creator-card:hover { border-color: var(--purple); transform: translateY(-4px); box-shadow: var(--glow); }
.creator-name { font-weight: 700; font-size: 14px; margin: 8px 0 2px; }
.creator-handle { font-size: 12px; color: var(--text3); }
.creator-subs { font-size: 12px; color: var(--purple); font-weight: 600; margin-top: 6px; }

/* ──────────────────────────────────────────
   ADMIN PANEL
────────────────────────────────────────── */
.admin-layout { display: grid; grid-template-columns: 220px 1fr; gap: 0; min-height: calc(100vh - 61px); }
.admin-sidebar {
  background: rgba(139,92,246,0.05); border-right: 1px solid rgba(139,92,246,0.15);
  padding: 20px 12px;
}
.admin-nav-item {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 12px; border-radius: 10px; cursor: pointer;
  font-size: 13px; font-weight: 500; color: var(--text2);
  transition: all .15s; border: none; background: none; width: 100%;
}
.admin-nav-item:hover { background: var(--card2); color: var(--text); }
.admin-nav-item.active { background: rgba(139,92,246,0.2); color: var(--purple); }
.admin-content { padding: 28px; overflow-y: auto; }
.admin-stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
.admin-stat {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
}
.admin-stat-val { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 32px; }
.admin-stat-label { font-size: 13px; color: var(--text2); margin-top: 4px; }

/* ──────────────────────────────────────────
   PAYMENT MODAL
────────────────────────────────────────── */
.payment-card-visual {
  background: linear-gradient(135deg, var(--purple2), var(--pink));
  border-radius: 16px; padding: 24px; margin: 20px 0; color: #fff;
  font-family: 'Space Mono', monospace;
}
.payment-amount { font-family: 'Syne', sans-serif; font-size: 48px; font-weight: 800; text-align: center; margin-bottom: 4px; }
.payment-desc { text-align: center; opacity: .8; font-size: 14px; margin-bottom: 24px; }
.payment-features { display: flex; flex-direction: column; gap: 8px; }
.payment-feature { display: flex; align-items: center; gap: 8px; font-size: 13px; }
.payment-feature::before { content: "✓"; color: var(--gold); font-weight: 700; }

/* ──────────────────────────────────────────
   ANIMATIONS
────────────────────────────────────────── */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: .5; }
}
.pulse { animation: pulse 2s infinite; }

/* Notification dot */
.notif-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--pink);
  display: inline-block; margin-left: 4px;
}

/* Online indicator */
.online-dot {
  width: 10px; height: 10px; border-radius: 50%; background: var(--green);
  border: 2px solid var(--bg2); position: absolute; bottom: 0; right: 0;
}

/* Empty state */
.empty-state {
  text-align: center; padding: 60px 20px; color: var(--text2);
}
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; margin-bottom: 8px; color: var(--text); }
.empty-desc { font-size: 14px; line-height: 1.6; }

/* Divider */
.divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

/* Section title */
.section-title {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 18px;
  margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;
}

/* Tags/Chips */
.chip {
  display: inline-flex; align-items: center; gap: 4px;
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 50px; padding: 4px 12px; font-size: 12px; font-weight: 500; color: var(--text2);
}

/* Tab panels */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Rich text indicator */
.verified { color: var(--purple); font-size: 14px; margin-left: 2px; }

/* Profile theme overlay */
.profile-custom-bg {
  position: absolute; inset: 0; z-index: 0;
  transition: all .3s;
}
.profile-banner { position: relative; }
.profile-banner > * { position: relative; z-index: 1; }

/* Responsive - Tablet */
@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); transition: transform .3s; }
  .sidebar.open { transform: translateX(0); }
  .main-content { margin-left: 0; width: 100%; max-width: 100%; overflow-x: hidden; }
  .profile-grid { grid-template-columns: 1fr; }
  .admin-layout { grid-template-columns: 1fr; }
  .messages-layout { grid-template-columns: 1fr; }
  .admin-stat-grid { grid-template-columns: repeat(2,1fr); }
  .landing-hero { padding: 40px 20px; }
  .landing-title { font-size: clamp(32px, 8vw, 56px); }
  .landing-features { padding: 0 20px; }
  .auth-card { padding: 24px; margin: 20px; }
}

/* Responsive - Mobile Phone */
@media (max-width: 480px) {
  /* Touch-friendly buttons */
  .btn { min-height: 44px; padding: 12px 20px; font-size: 15px; }
  .btn-sm { min-height: 40px; padding: 10px 16px; font-size: 14px; }
  
  /* Landing page */
  .landing-nav { padding: 12px 16px; }
  .landing-hero { padding: 24px 16px 40px; }
  .landing-title { font-size: clamp(28px, 10vw, 40px); line-height: 1.2; }
  .landing-sub { font-size: 15px; }
  .landing-ctas { flex-direction: column; gap: 10px; }
  .landing-ctas .btn { width: 100%; justify-content: center; }
  .landing-features { padding: 0 12px; gap: 12px; }
  .feature-card { padding: 16px; }
  
  /* Auth forms */
  .auth-card { padding: 20px 16px; margin: 12px; }
  .auth-title { font-size: 24px; }
  
/* Main content */
  .view { padding: 12px !important; max-width: 100% !important; width: 100% !important; }
  .topbar { padding: 10px 12px !important; }
  .topbar-title { font-size: 16px !important; }
  .topbar .btn { padding: 6px 10px; font-size: 12px; }
  .topbar-search { display: none !important; }
  
  /* Posts */
  .post-card { margin-bottom: 12px; }
  .post-header { padding: 12px 14px; }
  .post-body { padding: 0 14px 4px; font-size: 14px; }
  .post-tags { padding: 8px 14px; }
  .post-actions { padding: 8px 10px; }
  .post-action { padding: 8px 12px; font-size: 13px; }
  
/* Composer */
  .post-composer { padding: 10px !important; margin: 0 0 12px 0 !important; border-radius: 0 !important; border-left: none !important; border-right: none !important; }
  .composer-input { padding: 10px 12px; font-size: 16px !important; }
  .composer-actions { flex-wrap: wrap; gap: 6px; }
  
  /* Profile */
  .profile-banner { height: 140px; }
  .profile-avatar-wrap .avatar-xl { width: 80px; height: 80px; font-size: 28px; margin-top: -40px; }
  .profile-name { font-size: 22px; }
  .profile-info-section { padding: 0 16px 16px; }
  .profile-stats { gap: 16px; }
  
  /* Modals */
  .modal { margin: 12px; max-height: 90vh; }
  .modal-header { padding: 16px 16px 0; }
  .modal-body { padding: 16px; }
  .modal-title { font-size: 18px; }
  
  /* Bottom bar */
  .bottom-bar { padding: 10px 16px; }
  .bottom-home-btn, .bottom-admin-btn { padding: 10px 16px; font-size: 13px; }
  
/* Feed tabs - mobile icons only */
  .feed-tabs { 
    margin-bottom: 16px; 
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .feed-tabs::-webkit-scrollbar { display: none; }
  .feed-tab { 
    padding: 10px 6px; 
    font-size: 11px; 
    white-space: nowrap;
    min-width: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .feed-tab[data-icon]::before {
    content: attr(data-icon);
    font-size: 18px;
    margin-bottom: 2px;
  }
  .feed-tab span {
    display: none;
  }
  
  /* Channels */
  .channels-grid { grid-template-columns: 1fr; gap: 12px; }
  .channel-card { }
  
  /* Top 8 */
  .top8-grid { grid-template-columns: repeat(4, 1fr); gap: 4px; }
  .top8-name { font-size: 9px; max-width: 50px; }
  
  /* Video grid */
  .video-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .video-info { padding: 8px; }
  .video-title { font-size: 12px; }
}

/* Very small phones */
@media (max-width: 360px) {
  .landing-title { font-size: 24px; }
  .feature-card { padding: 12px; }
  .feature-title { font-size: 14px; }
  .feature-desc { font-size: 12px; }
  .profile-banner { height: 100px; }
  .profile-avatar-wrap .avatar-xl { width: 60px; height: 60px; font-size: 22px; margin-top: -30px; }
}

/* Theme colors for profiles */
.theme-purple .profile-banner { background: linear-gradient(135deg, #6d28d9, #8b5cf6); }
.theme-pink .profile-banner { background: linear-gradient(135deg, #be185d, #ec4899); }
.theme-cyan .profile-banner { background: linear-gradient(135deg, #0e7490, #06b6d4); }
.theme-gold .profile-banner { background: linear-gradient(135deg, #b45309, #f59e0b); }
.theme-green .profile-banner { background: linear-gradient(135deg, #065f46, #10b981); }
.theme-red .profile-banner { background: linear-gradient(135deg, #991b1b, #ef4444); }

/* Glitch text effect for landing */
.glitch-text { position: relative; }

/* ── BOTTOM FLOATING BAR ── */
.bottom-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 500;
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 24px;
  background: rgba(8,8,15,0.92); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border2);
  pointer-events: none;
}
.bottom-bar > * { pointer-events: all; }

.bottom-home-btn {
  display: flex; align-items: center; gap: 8px;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  color: #fff; border: none; border-radius: 50px;
  padding: 10px 22px; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 700; cursor: pointer;
  box-shadow: 0 4px 20px rgba(139,92,246,0.5);
  transition: all .2s;
}
.bottom-home-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(139,92,246,0.6); }

.bottom-admin-btn {
  display: none !important;
}

.bottom-admin-btn.admin-visible {
  display: flex !important;
  align-items: center; gap: 8px;
  background: rgba(245,158,11,0.12); border: 1px solid rgba(245,158,11,0.35);
  color: var(--gold); border-radius: 50px;
  padding: 9px 20px; font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 700; cursor: pointer;
  transition: all .2s; backdrop-filter: blur(8px);
}
.bottom-admin-btn.admin-visible:hover { background: rgba(245,158,11,0.22); transform: translateY(-3px); box-shadow: 0 8px 24px rgba(245,158,11,0.3); }

/* ── BACK BUTTON ── */
.back-btn {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text2); font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s; flex-shrink: 0;
}
.back-btn:hover { background: var(--card2); color: var(--text); transform: translateX(-2px); }
.back-btn.invisible { opacity: 0; pointer-events: none; }

/* ── BETA BADGE ── */
.beta-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(6,182,212,0.2));
  border: 1px solid rgba(16,185,129,0.4);
  color: var(--green); padding: 6px 14px; border-radius: 50px;
  font-size: 12px; font-weight: 700; margin-bottom: 12px;
}
.beta-slots { color: var(--cyan); font-weight: 800; }

/* ── FIREBASE SETUP NOTICE ── */
.firebase-notice {
  background: rgba(6,182,212,0.08); border: 1px solid rgba(6,182,212,0.2);
  border-radius: 12px; padding: 14px 16px; margin-bottom: 20px;
  font-size: 13px; color: var(--text2); line-height: 1.6;
}
.firebase-notice strong { color: var(--cyan); }

/* add padding so content not hidden behind bottom bar */
.main-content { padding-bottom: 68px; }
#page-landing { padding-bottom: 80px; }

/* ── MARKETPLACE ── */
.marketplace-item { transition: all .2s; }
.marketplace-item:hover { transform: translateY(-4px); box-shadow: var(--glow); }

/* ── REACTION POPUP ── */
.reaction-popup {
  position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
  background: var(--card2); border: 1px solid var(--border2);
  border-radius: 50px; padding: 6px 10px; display: flex; gap: 4px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 100;
  animation: fadeUp .2s ease;
}
.reaction-popup button {
  background: none; border: none; font-size: 18px; cursor: pointer;
  padding: 4px; border-radius: 50%; transition: all .15s;
}
.reaction-popup button:hover { transform: scale(1.2); }

/* ── REACTION FEEDBACK OVERLAY ── */
.reaction-feedback-overlay {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: reactionPop 900ms ease-out forwards;
}
.reaction-feedback-emoji { font-size: 48px; }
.reaction-feedback-text { 
  font-size: 14px; font-weight: 600; 
  margin-top: 8px; color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}
@keyframes reactionPop {
  0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
  20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
  40% { transform: translate(-50%, -50%) scale(1); }
  100% { opacity: 0; transform: translate(-50%, -60%); }
}

/* ── WAVE BUTTON ── */
.post-action.waved { color: var(--cyan); background: rgba(6,182,212,0.1); }

/* ── BADGES ── */
.badge-gold { background: rgba(245,158,11,0.2); color: var(--gold); border: 1px solid rgba(245,158,11,0.3); }
.badge-purple { background: rgba(139,92,246,0.2); color: var(--purple); border: 1px solid rgba(139,92,246,0.3); }
.badge-pink { background: rgba(236,72,153,0.2); color: var(--pink); border: 1px solid rgba(236,72,153,0.3); }
.badge-green { background: rgba(16,185,129,0.2); color: var(--green); border: 1px solid rgba(16,185,129,0.3); }

/* ── VIBE LIKE BUTTON ── */
.vibe-like-btn {
  background: transparent;
  border: 1px solid var(--border2);
  color: var(--text2);
  padding: 8px 16px;
  border-radius: 50px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all .15s;
}
.vibe-like-btn:hover { border-color: var(--pink); color: var(--pink); background: rgba(236,72,153,0.1); }
.vibe-like-btn.liked { border-color: var(--pink); color: var(--pink); background: rgba(236,72,153,0.15); }

/* We Vibin Tab */
.feed-tab[data-wevibin] { background: linear-gradient(135deg, var(--purple), var(--pink)); }
.feed-tab[data-wevibin].active { box-shadow: 0 0 20px rgba(139,92,246,0.4); }

/* Content Tags */
.content-tags-selector { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.content-tag-option {
  padding: 4px 10px; border-radius: 20px; font-size: 11px;
  background: var(--bg3); color: var(--text2); cursor: pointer;
  border: 1px solid var(--border2); transition: all .15s;
}
.content-tag-option:hover { border-color: var(--purple); color: var(--purple); }
.content-tag-option.selected { background: var(--purple); color: #fff; border-color: var(--purple); }

/* Top 8 Supabase Indicator */
.top8-sync-status { font-size: 10px; color: var(--text3); margin-top: 4px; }
.top8-sync-status.synced { color: var(--green); }

/* ── FRIEND REQUEST BUTTONS ── */
.friend-req-btns { display: flex; gap: 8px; margin-top: 8px; }
.friend-req-btns button { flex: 1; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all .15s; }
.friend-req-btns .accept { background: var(--green); color: #fff; border: none; }
.friend-req-btns .accept:hover { background: #0d9668; }
.friend-req-btns .reject { background: transparent; color: var(--text2); border: 1px solid var(--border2); }
.friend-req-btns .reject:hover { border-color: var(--red); color: var(--red); }

/* ── AUDIO COMMENT ── */
.audio-comment-btn { background: none; border: none; font-size: 16px; cursor: pointer; padding: 4px; }
.audio-comment-btn:hover { transform: scale(1.1); }
audio { width: 100%; margin-top: 8px; border-radius: 8px; }

/* ── POST EXPIRED ── */
.post-expired { opacity: 0.5; position: relative; }
.post-expired::after {
  content: '⏰ This post has expired'; position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%); background: var(--bg); padding: 8px 16px;
  border-radius: 8px; font-size: 14px; font-weight: 600;
}

/* ── COMMENT REACTIONS ── */
.comment-reaction { font-size: 12px; margin-right: 8px; cursor: pointer; opacity: 0.6; transition: all .15s; }
.comment-reaction:hover, .comment-reaction.active { opacity: 1; transform: scale(1.1); }

/* ── CHANNELS GRID ── */
.channels_grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }

/* ── SETTINGS ── */
.settings-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.settings-item:last-child { border-bottom: none; }
.toggle {
  width: 44px;
  height: 24px;
  background: var(--bg3);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background .2s;
}
.toggle::after {
  content: '';
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform .2s;
}
.toggle.active { background: var(--purple); }
.toggle.active::after { transform: translateX(20px); }

/* ── SYNC SPACES ── */
.sync-space-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 16px;
  transition: all .2s;
}
.sync-space-card:hover { border-color: var(--purple); }
.sync-space-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 18px; }
.sync-space-meta { font-size: 12px; color: var(--text3); margin: 8px 0; }
.sync-space-timer { font-size: 12px; color: var(--cyan); font-weight: 600; }
.sync-space-glow { animation: syncGlow 2s ease-in-out infinite; }
@keyframes syncGlow {
  0%, 100% { box-shadow: 0 0 10px rgba(139,92,246,0.3); }
  50% { box-shadow: 0 0 20px rgba(139,92,246,0.6); }
}

@keyframes flyUp {
  0% { 
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  100% { 
    opacity: 0;
    transform: translateY(-100px) scale(1.5);
  }
}
</style>

</head>
<body>

<div id="toast-container"></div>

<!-- ══════════════════════════════════════
     GLOBAL BOTTOM BAR
══════════════════════════════════════ -->
<div class="bottom-bar" id="global-bottom-bar">
  <button class="bottom-home-btn" onclick="bottomHomeClick()">🏠 Home</button>
  <button class="bottom-admin-btn" onclick="bottomAdminClick()" id="bottom-admin-btn" title="Owner Admin Panel">🛡️ Admin</button>
</div>

<!-- ══════════════════════════════════════
     LANDING PAGE
══════════════════════════════════════ -->
<div id="page-landing">
<nav class="landing-nav">
    <img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo-lg" onclick="showPage('landing')" alt="VibeHub">
    <div class="flex gap-2">
      <button class="btn btn-outline btn-sm" onclick="showPage('login')" id="nav-login-btn">Log In</button>
      <button class="btn btn-primary btn-sm" onclick="showPage('register')" id="landing-join-btn">Create Free Beta Account</button>
    </div>
  </nav>

  <div class="landing-hero">
    <div class="landing-eyebrow">✨ The social platform for real ones</div>
    <h1 class="landing-title">Your <span class="grad">Vibe.</span><br>Your Space.<br>Your <span class="grad">Community.</span></h1>
    <p class="landing-sub">VibeHub blends the best of TikTok, YouTube, and old-school MySpace. Customize your page, share your world, and find your people.</p>
    <div id="landing-beta-status" style="margin-bottom:16px;"></div>
    <div class="landing-ctas">
      <button class="btn btn-primary" onclick="showPage('register')" id="hero-join-btn" style="padding:14px 32px;font-size:16px;">Create Free Beta Account 🚀</button>
      <button class="btn btn-outline" onclick="showPage('login')" id="hero-login-btn" style="padding:14px 32px;font-size:16px;">Already a member</button>
    </div>
  </div>

  <div class="landing-features">
    <div class="feature-card" style="animation-delay:.1s">
      <div class="feature-icon">🎨</div>
      <div class="feature-title">Fully Customize Your Page</div>
      <div class="feature-desc">Pick your colors, add a profile song, arrange your layout. Make it YOU like it's 2005 but way cooler.</div>
    </div>
    <div class="feature-card" style="animation-delay:.2s">
      <div class="feature-icon">🔥</div>
      <div class="feature-title">Short Videos & Full Channels</div>
      <div class="feature-desc">Post TikTok-style clips or build a full YouTube-style channel. Your content, your rules.</div>
    </div>
    <div class="feature-card" style="animation-delay:.3s">
      <div class="feature-icon">👍 👎</div>
      <div class="feature-title">Real Reactions</div>
      <div class="feature-desc">Like AND dislike. Because honest feedback is good vibes. Plus emoji reactions for everything.</div>
    </div>
    <div class="feature-card" style="animation-delay:.4s">
      <div class="feature-icon">🎵</div>
      <div class="feature-title">Profile Music Player</div>
      <div class="feature-desc">The MySpace feature everyone misses is back. Set your song and let visitors feel your energy the second they land.</div>
    </div>
    <div class="feature-card" style="animation-delay:.5s">
      <div class="feature-icon">👥</div>
      <div class="feature-title">Top 8 Vibes</div>
      <div class="feature-desc">Show your ride-or-dies. The iconic Top 8 is back, baby. No algorithm — you decide who matters.</div>
    </div>
    <div class="feature-card" style="animation-delay:.6s">
      <div class="feature-icon">✌️</div>
      <div class="feature-title">Unity First</div>
      <div class="feature-desc">One-time $1 entry keeps bots out. No ads. No algorithm manipulation. Just humans being human.</div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     LOGIN PAGE
══════════════════════════════════════ -->
<div id="page-login" class="hidden auth-page">
  <div class="auth-card">
    <div class="auth-logo"><img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo-lg" onclick="showPage('landing')" alt="VibeHub"></div>
    <div class="auth-title">Welcome back ✌️</div>
    <div class="auth-subtitle">Good to see you again.</div>
    <div class="form-group">
      <label>Username or Email</label>
      <input type="text" id="login-user" placeholder="yourname or email">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="••••••••" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="stay-logged-in" style="width:auto;">
        <span>Stay Logged In</span>
      </label>
    </div>
    <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="doLogin()">Log In</button>
    <div class="auth-switch">Don't have an account? <a href="#" onclick="showPage('register')">Join VibeHub</a></div>
    <div class="auth-switch" style="margin-top:6px;"><a href="#" onclick="showPage('landing')" style="color:var(--text3);font-size:13px;">← Back to Home</a></div>
  </div>
</div>

<!-- ══════════════════════════════════════
     REGISTER PAGE
══════════════════════════════════════ -->
<div id="page-register" class="hidden auth-page">
  <div class="auth-card">
    <div class="auth-logo"><img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo-lg" onclick="showPage('landing')" alt="VibeHub"></div>
    <div class="auth-title">Join the vibe ✨</div>
    <div id="reg-beta-info" style="text-align:center;margin-bottom:16px;"></div>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="reg-user" placeholder="your_handle">
    </div>
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="reg-name" placeholder="Your Name">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="reg-email" placeholder="you@email.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="reg-pass" placeholder="Min 6 characters">
    </div>
    <div class="form-group">
      <label>Bio (optional)</label>
      <textarea id="reg-bio" placeholder="A lil something about you..." style="min-height:60px;"></textarea>
    </div>
    <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" id="reg-submit-btn" onclick="handleRegisterSubmit()">Create Free Beta Account 🚀</button>
    <div class="auth-switch">Already a member? <a href="#" onclick="showPage('login')">Log In</a></div>
    <div class="auth-switch" style="margin-top:6px;"><a href="#" onclick="showPage('landing')" style="color:var(--text3);font-size:13px;">← Back</a></div>
  </div>
</div>

<!-- ══════════════════════════════════════
     APP SHELL
══════════════════════════════════════ -->
<div id="app-shell" class="hidden">

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <img src="https://i.ibb.co/Fqnj3JKp/1000001392.png" class="site-logo" onclick="navigate('home')" alt="VibeHub">
    </div>

    <div class="sidebar-section">Menu</div>
    <button class="nav-item" onclick="navigate('home')" id="nav-home"><span class="nav-icon">🏠</span> Home Feed</button>
    <button class="nav-item" onclick="navigate('explore')" id="nav-explore"><span class="nav-icon">🔍</span> Explore</button>
    <button class="nav-item" onclick="navigate('channels')" id="nav-channels"><span class="nav-icon">📺</span> Channels</button>
    <button class="nav-item" onclick="navigate('sync-spaces')" id="nav-sync-spaces"><span class="nav-icon">💬</span> Sync Spaces</button>
    <button class="nav-item" onclick="navigate('messages')" id="nav-messages"><span class="nav-icon">💬</span> Messages <span class="nav-badge" id="msg-badge" style="display:none;">2</span></button>
    <button class="nav-item" onclick="navigate('notifications')" id="nav-notifications"><span class="nav-icon">🔔</span> Notifications <span class="nav-badge" id="notif-badge" style="display:none;">0</span></button>

    <div class="sidebar-section">You</div>
    <button class="nav-item" onclick="navigate('profile', getCurrentUser()?.username)" id="nav-profile"><span class="nav-icon">👤</span> My Profile</button>
    <button class="nav-item" onclick="navigate('edit-profile')" id="nav-edit-profile"><span class="nav-icon">🎨</span> Customize Page</button>
    <button class="nav-item" onclick="navigate('my-channel')" id="nav-my-channel"><span class="nav-icon">📡</span> My Channel</button>
    <button class="nav-item" onclick="navigate('marketplace')" id="nav-marketplace"><span class="nav-icon">🛍️</span> Marketplace</button>
    <button class="nav-item" onclick="navigate('settings')" id="nav-settings"><span class="nav-icon">⚙️</span> Settings</button>
    <button class="nav-item" onclick="navigate('status-channels')" id="nav-status-channels"><span class="nav-icon">⏰</span> Status Channels</button>
    <button class="nav-item" onclick="navigate('disclaimer')" id="nav-disclaimer"><span class="nav-icon">📜</span> Disclaimer</button>

    <div class="sidebar-section" id="admin-section" style="display:none;">Owner</div>
    <button class="nav-item hidden" onclick="navigate('admin')" id="nav-admin"><span class="nav-icon">🛡️</span> Admin Panel</button>

<div class="sidebar-user" onclick="navigate('profile', getCurrentUser()?.username)">
      <div class="avatar avatar-sm" id="sidebar-avatar">?</div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sidebar-name">Loading...</div>
        <div class="sidebar-user-handle" id="sidebar-handle">@...</div>
      </div>
      <button class="btn-ghost" onclick="event.stopPropagation();doLogout();" title="Sign Out" style="display:flex;align-items:center;gap:4px;padding:6px 10px;font-size:13px;color:var(--text2);background:var(--bg3);border:1px solid var(--border2);border-radius:8px;">
        <span>↪</span><span style="font-weight:500;">Sign Out</span>
      </button>
    </div>
  </aside>

  <!-- Main -->
  <div class="main-content">

    <!-- Topbar -->
    <div class="topbar">
      <button class="back-btn" id="back-btn" onclick="navBack()" title="Go back">←</button>
      <div class="topbar-title" id="topbar-title">Home Feed</div>
      <div class="topbar-search">
        <span>🔍</span>
        <input type="text" placeholder="Search VibeHub..." id="search-input" oninput="handleSearch(this.value)">
      </div>
      <button class="btn btn-primary btn-sm" onclick="document.getElementById('post-composer-input')?.focus()">+ Post</button>
    </div>
    
    <!-- Mobile Navigation Dropdown -->
    <div class="mobile-nav-container">
      <select id="mobile-nav" class="mobile-nav-dropdown" onchange="handleMobileNav(this.value)">
        <option value="">☰ Menu</option>
        <option value="home">🏠 Home</option>
        <option value="explore">🔍 Explore</option>
        <option value="channels">📺 Channels</option>
        <option value="sync-spaces">💬 Sync Spaces</option>
        <option value="messages">💬 Messages</option>
        <option value="notifications">🔔 Notifications</option>
        <option value="profile">👤 Profile</option>
        <option value="settings">⚙️ Settings</option>
        <option value="admin" id="mobile-admin-option" style="display:none;">🛡️ Admin</option>
      </select>
    </div>

    <!-- HOME VIEW -->
    <div id="view-home" class="view hidden">
<div class="feed-tabs">
        <button class="feed-tab active" data-icon="👁️" onclick="switchFeedTab('all', this)"><span>✨ All Vibes</span></button>
        <button class="feed-tab" data-icon="👥" onclick="switchFeedTab('friends', this)"><span>👥 Friends</span></button>
        <button class="feed-tab" data-icon="🔥" onclick="switchFeedTab('trending', this)"><span>🔥 Trending</span></button>
        <button class="feed-tab" data-icon="✨" onclick="switchFeedTab('wevibin', this)" data-wevibin><span>✨ We Vibin</span></button>
      </div>

      <div class="post-composer card">
        <div class="card-body" style="padding:16px;">
          <div class="composer-top">
            <div class="avatar avatar-sm" id="composer-avatar">?</div>
            <textarea class="composer-input" id="post-composer-input" placeholder="What's your vibe today?..." rows="2"></textarea>
          </div>
          <div class="composer-actions">
            <div class="composer-tools">
              <label class="composer-tool" title="Add Photo" style="cursor:pointer;">📷<input type="file" accept="image/*" style="display:none" onchange="handlePostImage(this)"></label>
              <label class="composer-tool" title="Add Video" style="cursor:pointer;">🎬<input type="file" accept="video/*" style="display:none" onchange="handlePostVideo(this)"></label>
              <button class="composer-tool" title="Add Tag" onclick="addTagToComposer()">🏷️</button>
              <button class="composer-tool" title="Mood" onclick="addMoodToComposer()">😊</button>
            </div>
            <button class="btn btn-primary btn-sm" onclick="createPost()">Post Vibe ✌️</button>
          </div>
          <div id="composer-preview" style="margin-top:8px;"></div>
        </div>
      </div>

      <div id="feed-posts">
        <!-- Posts render here -->
      </div>
      
      <div style="text-align:center;padding:20px;margin-top:16px;border-top:1px solid var(--border);">
        <a href="#" onclick="navigate('disclaimer');return false;" style="font-size:11px;color:var(--text3);text-decoration:none;">📜 Disclaimer</a>
      </div>
    </div>

    <!-- EXPLORE VIEW -->
    <div id="view-explore" class="view-wide hidden">
      <div class="view">
        <div class="explore-section">
          <div class="explore-heading">🔥 Trending Tags</div>
          <div class="trending-tags" id="trending-tags"></div>
        </div>
        <div class="explore-section">
          <div class="explore-heading">⭐ Featured Creators</div>
          <div class="creator-grid" id="creator-grid"></div>
        </div>
        <div class="explore-section">
          <div class="explore-heading">✨ Discover Posts</div>
          <div id="explore-posts"></div>
        </div>
      </div>
    </div>

    <!-- CHANNELS VIEW -->
    <div id="view-channels" class="view-wide hidden">
      <div style="padding:24px;">
        <div class="section-title">
          📺 Channels
          <button class="btn btn-primary btn-sm" onclick="openCreateChannelModal()">+ Create Channel</button>
        </div>
        <div class="channels-grid" id="channels-grid"></div>
      </div>
    </div>

    <!-- SYNC SPACES VIEW -->
    <div id="view-sync-spaces" class="view-wide hidden">
      <div style="padding:24px;">
        <div class="section-title">
          💬 Sync Spaces
          <button class="btn btn-primary btn-sm" onclick="openCreateSyncSpaceModal()">+ Create Room</button>
        </div>
        <p style="color:var(--text2);margin-bottom:20px;font-size:14px;">Live chat rooms. 125 users max. 24 hours. Text only. Room admins can remove users.</p>
        <div class="channels-grid" id="sync-spaces-grid"></div>
      </div>
    </div>

    <!-- CHANNEL DETAIL VIEW -->
    <div id="view-channel-detail" class="hidden" style="padding:24px;">
      <button class="btn btn-ghost btn-sm" onclick="navigate('channels')" style="margin-bottom:16px;">← Back to Channels</button>
      <div id="channel-detail-content"></div>
    </div>

    <!-- MESSAGES VIEW -->
    <div id="view-messages" class="hidden">
      <div class="messages-layout">
        <div class="dm-list">
          <div class="section-title" style="margin-bottom:12px;font-size:16px;">Messages</div>
          <div id="dm-list-items"></div>
        </div>
        <div class="chat-area" id="chat-area">
          <div class="empty-state">
            <div class="empty-icon">💬</div>
            <div class="empty-title">Pick a conversation</div>
            <div class="empty-desc">Select someone from the left to start chatting</div>
          </div>
        </div>
      </div>
    </div>

    <!-- NOTIFICATIONS VIEW -->
    <div id="view-notifications" class="view hidden">
      <div class="section-title">🔔 Notifications</div>
      <div id="notifs-list"></div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="hidden">
      <div id="profile-content"></div>
    </div>

    <!-- EDIT PROFILE VIEW -->
    <div id="view-edit-profile" class="view hidden">
      <div class="section-title">🎨 Customize Your Page</div>
      <div class="customizer">
        <div class="customizer-title">Profile Theme Color</div>
        <div class="color-picker-row" id="theme-color-picker"></div>
        <hr class="divider">
        <div class="customizer-title">Banner Gradient</div>
        <div class="color-picker-row" id="banner-picker"></div>
        <hr class="divider">
        <div class="customizer-title">🖼️ Profile Background Image</div>
        <div class="form-group">
          <label>Background Image URL</label>
          <input type="text" id="edit-profile-background" placeholder="https://example.com/image.jpg">
          <div style="font-size:11px;color:var(--text3);margin-top:4px;">Paste an image URL to use as your profile background</div>
        </div>
        <hr class="divider">
        <div class="customizer-title">📷 Profile Picture</div>
        <div class="form-group">
          <label>Upload Image (auto-compressed)</label>
          <input type="file" accept="image/*" onchange="handleProfileImageUpload(this)" id="profile-image-input">
          <div id="profile-image-preview" style="margin-top:8px;"></div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;">Recommended: Square image. Will be auto-compressed.</div>
        </div>
        <hr class="divider">
        <div class="form-group">
          <label>🎵 Profile Song (YouTube embed URL)</label>
          <input type="text" id="edit-song-url" placeholder="https://www.youtube.com/embed/...">
        </div>
        <div class="form-group">
          <label>🎵 Song Name</label>
          <input type="text" id="edit-song-name" placeholder="Song Title">
        </div>
        <div class="form-group">
          <label>🎤 Artist Name</label>
          <input type="text" id="edit-song-artist" placeholder="Artist Name">
        </div>
        <hr class="divider">
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="edit-display-name">
        </div>
        <div class="form-group">
          <label>Bio</label>
          <textarea id="edit-bio" style="min-height:80px;"></textarea>
        </div>
        <div class="form-group">
          <label>😊 Mood Status</label>
          <div class="flex gap-2" style="flex-wrap:wrap;">
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('☀️','Living my best life')" data-mood="sunny">☀️ Sunny</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('🎵','Vibing to music')" data-mood="music">🎵 Vibing</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('😴','Need coffee')" data-mood="tired">😴 Tired</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('🔥','On fire today')" data-mood="fire">🔥 On Fire</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('✌️','Peace and love')" data-mood="peace">✌️ Peaceful</button>
            <button class="btn btn-outline btn-sm mood-pick" onclick="setMood('💫','Lost in thought')" data-mood="lost">💫 Dreaming</button>
          </div>
        </div>
        <hr class="divider">
        <div class="customizer-title">🔗 Social Links</div>
        <div class="form-group">
          <label>📸 Instagram</label>
          <input type="text" id="edit-social-instagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>🐦 Twitter/X</label>
          <input type="text" id="edit-social-twitter" placeholder="@username">
        </div>
        <div class="form-group">
          <label>📺 YouTube</label>
          <input type="text" id="edit-social-youtube" placeholder="Channel URL">
        </div>
        <div class="form-group">
          <label>🎵 TikTok</label>
          <input type="text" id="edit-social-tiktok" placeholder="@username">
        </div>
        <div class="form-group">
          <label>🎮 Twitch</label>
          <input type="text" id="edit-social-twitch" placeholder="Channel URL">
        </div>
        <div class="form-group">
          <label>💬 Discord</label>
          <input type="text" id="edit-social-discord" placeholder="Server or username">
        </div>
        <div class="form-group">
          <label>🌐 Website</label>
          <input type="text" id="edit-social-website" placeholder="https://...">
        </div>
        <hr class="divider">
        <div class="customizer-title">Top 8 Vibes</div>
        <div id="top8-editor" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;"></div>
        <hr class="divider">
        <button class="btn btn-primary" onclick="saveProfile()" style="width:100%;justify-content:center;">Save My Vibe ✨</button>
      </div>
    </div>

    <!-- MY CHANNEL VIEW -->
    <div id="view-my-channel" class="view hidden">
      <div class="section-title">📡 My Channel <button class="btn btn-primary btn-sm" onclick="openUploadVideoModal()">+ Upload</button></div>
      <div id="my-channel-content"></div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="view-admin" class="hidden">
      <div class="admin-layout">
        <div class="admin-sidebar">
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:15px;padding:8px 12px 16px;color:var(--purple);">🛡️ Owner Panel</div>
          <button class="admin-nav-item active" onclick="adminTab('dashboard',this)">📊 Dashboard</button>
          <button class="admin-nav-item" onclick="adminTab('users',this)">👥 Users</button>
          <button class="admin-nav-item" onclick="adminTab('posts',this)">📝 Posts</button>
          <button class="admin-nav-item" onclick="adminTab('channels',this)">📺 Channels</button>
          <button class="admin-nav-item" onclick="adminTab('settings',this)">⚙️ Settings</button>
        </div>
        <div class="admin-content">
          <div id="admin-tab-dashboard">
            <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:24px;margin-bottom:24px;">
              Welcome back, Owner 👑
            </div>
            <div class="admin-stat-grid" id="admin-stats"></div>
            <div class="section-title">Recent Activity</div>
            <div id="admin-activity"></div>
          </div>
          <div id="admin-tab-users" style="display:none;">
            <div class="section-title">All Users</div>
            <div id="admin-users-list"></div>
          </div>
          <div id="admin-tab-posts" style="display:none;">
            <div class="section-title">All Posts</div>
            <div id="admin-posts-list"></div>
          </div>
          <div id="admin-tab-channels" style="display:none;">
            <div class="section-title">All Channels</div>
            <div id="admin-channels-list"></div>
          </div>
          <div id="admin-tab-settings" style="display:none;">
            <div class="section-title">Platform Settings</div>
            <div class="card"><div class="card-body">
              <div class="form-group"><label>Platform Name</label><input type="text" value="VibeHub"></div>
              <div class="form-group"><label>Signup Fee ($)</label><input type="number" value="1" step="0.01"></div>
              <div class="form-group"><label>Maintenance Mode</label>
                <select><option>Off</option><option>On</option></select></div>
              <button class="btn btn-primary" onclick="toast('Settings saved!','success')">Save Settings</button>
            </div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SEARCH RESULTS VIEW -->
    <div id="view-search" class="view hidden">
      <div class="section-title">Search Results</div>
      <div id="search-results"></div>
    </div>

    <!-- MARKETPLACE VIEW -->
    <div id="view-marketplace" class="view-wide hidden">
      <div class="flex justify-between items-center" style="margin-bottom:24px;">
        <div class="section-title" style="margin-bottom:0;">🛍️ Marketplace</div>
        <button class="btn btn-primary btn-sm" onclick="showCreateProductModal()">+ List Item</button>
      </div>
      
      <div class="feed-tabs" style="margin-bottom:20px;">
        <button class="feed-tab active" onclick="switchMarketplaceTab('all', this)">✨ All</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('electronics', this)">📱 Electronics</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('clothing', this)">👕 Clothing</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('art', this)">🎨 Art</button>
        <button class="feed-tab" onclick="switchMarketplaceTab('other', this)">📦 Other</button>
      </div>
      
      <div id="marketplace-grid" class="channels_grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;"></div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="view-settings" class="view hidden">
      <div class="section-title">⚙️ Settings</div>
      
      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="settings-display-name" onchange="updateSettingsFromForm()">
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea id="settings-bio" rows="3" onchange="updateSettingsFromForm()"></textarea>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="settings-email" onchange="updateSettingsFromForm()">
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;">🔒 Privacy</h3>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;">Profile Visibility</div>
              <div style="font-size:12px;color:var(--text3);">Allow everyone to view your profile</div>
            </div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;">Show Online Status</div>
              <div style="font-size:12px;color:var(--text3);">Let others see when you're online</div>
            </div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;">Show Vibe Score</div>
              <div style="font-size:12px;color:var(--text3);">Display your reputation score on profile</div>
            </div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;">🔔 Notifications</h3>
          <div class="settings-item">
            <div><div style="font-weight:600;">Likes</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div><div style="font-weight:600;">Comments</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div><div style="font-weight:600;">Follows</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
          <div class="settings-item">
            <div><div style="font-weight:600;">Messages</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;">🎨 Appearance</h3>
          <div class="settings-item">
            <div><div style="font-weight:600;">Dark Mode</div></div>
            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
      </div>

      <div class="card" style="border-color:rgba(239,68,68,0.3);">
        <div class="card-body">
          <h3 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;color:var(--red);">⚠️ Danger Zone</h3>
          <div class="settings-item">
            <div>
              <div style="font-weight:600;color:var(--red);">Delete Account</div>
              <div style="font-size:12px;color:var(--text3);">Permanently delete your account and all data</div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="confirmDeleteAccount()">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DISCLAIMER VIEW -->
    <div id="view-disclaimer" class="view hidden">
      <div class="card">
        <div class="card-body" style="padding:32px;">
          <h2 style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;margin-bottom:24px;">📜 Disclaimer & Terms</h2>
          
          <div style="color:var(--text2);line-height:1.8;font-size:14px;">
            <p style="margin-bottom:16px;"><strong style="color:var(--text);">Last Updated:</strong> February 2026</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">1. User Content</h3>
            <p style="margin-bottom:12px;">All content posted by users is the responsibility of the respective user. VibeHub does not endorse or guarantee the accuracy, completeness, or quality of any user-generated content.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">2. Marketplace Transactions</h3>
            <p style="margin-bottom:12px;">VibeHub provides a platform for users to list and sell items. However, all transactions are between users directly. We are not responsible for any disputes, fraud, or issues arising from marketplace transactions.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">3. Account Security</h3>
            <p style="margin-bottom:12px;">Users are responsible for maintaining the security of their account credentials. Do not share your password with anyone.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">4. Prohibited Content</h3>
            <p style="margin-bottom:12px;">The following is prohibited: illegal content, harassment, hate speech, explicit content, spam, and malicious software. Violations may result in account termination.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">5. Modifications to Service</h3>
            <p style="margin-bottom:12px;">VibeHub reserves the right to modify or discontinue any part of the service at any time without notice.</p>
            
            <h3 style="color:var(--text);font-size:16px;margin:24px 0 12px;">6. Contact</h3>
            <p style="margin-bottom:12px;">For questions about these terms, contact: support@vibehub.app</p>
            
            <div style="margin-top:32px;padding:16px;background:var(--bg3);border-radius:12px;">
              <p style="margin:0;font-size:13px;">By using VibeHub, you agree to these terms. Enjoy your time on the platform! ✌️</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STATUS CHANNELS VIEW -->
    <div id="view-status-channels" class="view-wide hidden">
      <div class="flex justify-between items-center" style="margin-bottom:24px;">
        <div class="section-title" style="margin-bottom:0;">⏰ Status Channels</div>
        <button class="btn btn-primary btn-sm" onclick="createStatusChannel()">+ New Status</button>
      </div>
      <div id="status-channels-list" class="channels_grid"></div>
    </div>

  </div><!-- end main-content -->
</div><!-- end app-shell -->

<!-- ══════════════════════════════════════
     MODALS
══════════════════════════════════════ -->

<!-- Payment Modal -->
<div id="modal-payment" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Complete Signup</div>
      <button class="close-btn" onclick="closeModal('modal-payment')">✕</button>
    </div>
    <div class="modal-body">
      <div class="payment-card-visual">
        <div class="payment-amount">$1.00</div>
        <div class="payment-desc">One-time access fee — never charged again</div>
        <div class="payment-features">
          <div class="payment-feature">Lifetime access to VibeHub</div>
          <div class="payment-feature">Full profile customization</div>
          <div class="payment-feature">Unlimited posts & channels</div>
          <div class="payment-feature">No ads. Ever.</div>
          <div class="payment-feature">Profile music player + Top 8</div>
        </div>
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:14px;" onclick="processPayment()">Pay $1 & Join VibeHub 🚀</button>
      <div style="text-align:center;margin-top:12px;font-size:12px;color:var(--text3);">You'll be redirected to complete secure payment</div>
      <div style="text-align:center;margin-top:8px;">
        <button type="button" onclick="completeRegistration()" style="background:none;border:none;color:var(--purple);cursor:pointer;font-size:13px;text-decoration:underline;">I've already paid — Complete Registration</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Channel Modal -->
<div id="modal-create-channel" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Create a Channel 📺</div>
      <button class="close-btn" onclick="closeModal('modal-create-channel')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Channel Name</label>
        <input type="text" id="channel-name-input" placeholder="e.g. Cooking with Vibes">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="channel-desc-input" placeholder="What's your channel about?"></textarea>
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="channel-category-input">
          <option>🎵 Music</option><option>🎮 Gaming</option><option>🍳 Food</option>
          <option>💄 Beauty</option><option>🏋️ Fitness</option><option>🎨 Art</option>
          <option>💻 Tech</option><option>🌍 Travel</option><option>😂 Comedy</option><option>🎭 Lifestyle</option>
        </select>
      </div>
      <div class="form-group">
        <label>Banner Emoji</label>
        <input type="text" id="channel-emoji-input" placeholder="🎵" maxlength="4" value="🎬">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="createChannel()">Create Channel ✨</button>
    </div>
  </div>
</div>

<!-- Create Product Modal -->
<div id="modal-create-product" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">List Item for Sale 🛍️</div>
      <button class="close-btn" onclick="closeModal('modal-create-product')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Item Title</label>
        <input type="text" id="product-title-input" placeholder="e.g. Vintage Jacket">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="product-desc-input" placeholder="Describe your item..."></textarea>
      </div>
      <div class="flex gap-3">
        <div class="form-group" style="flex:1;">
          <label>Price ($)</label>
          <input type="number" id="product-price-input" placeholder="25" min="1">
        </div>
        <div class="form-group" style="flex:1;">
          <label>Category</label>
          <select id="product-category-input">
            <option value="electronics">📱 Electronics</option>
            <option value="clothing">👕 Clothing</option>
            <option value="art">🎨 Art</option>
            <option value="other">📦 Other</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Image URL (optional)</label>
        <input type="text" id="product-image-input" placeholder="https://...">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="createProduct()">List Item ✨</button>
    </div>
  </div>
</div>

<!-- Audio Comment Modal -->
<div id="modal-audio-comment" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Voice Comment 🎤</div>
      <button class="close-btn" onclick="closeModal('modal-audio-comment')">✕</button>
    </div>
    <div class="modal-body" style="text-align:center;">
      <div style="background:var(--bg3);border-radius:16px;padding:32px;margin-bottom:20px;">
        <div style="font-size:48px;margin-bottom:16px;">🎤</div>
        <div id="audio-recorder-status" style="color:var(--text2);margin-bottom:16px;">🎤 Click to start recording (60s max)</div>
        <div id="audio-timer" style="font-size:24px;font-weight:700;color:var(--purple);margin-bottom:12px;">0:00</div>
        <button class="btn btn-primary" id="record-audio-btn" onclick="toggleAudioRecording()">🎤 Record</button>
      </div>
      <audio id="audio-preview" controls style="width:100%;margin-bottom:16px;display:none;"></audio>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="submitAudioComment()">Post Audio Comment ✨</button>
    </div>
  </div>
</div>

<!-- Report User Modal -->
<div id="modal-report" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">🚩 Report User</div>
      <button class="close-btn" onclick="closeModal('modal-report')">✕</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px;color:var(--text2);">Why are you reporting this user?</p>
      <div class="form-group">
        <select id="report-reason">
          <option value="">Select a reason...</option>
          <option value="harassment">Harassment or bullying</option>
          <option value="spam">Spam or fake account</option>
          <option value="inappropriate">Inappropriate content</option>
          <option value="hate">Hate speech</option>
          <option value="scam">Scam or fraud</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Additional details (optional)</label>
        <textarea id="report-details" rows="3" placeholder="Provide more context..."></textarea>
      </div>
      <button class="btn btn-danger w-full" style="justify-content:center;padding:13px;" onclick="submitReport()">Submit Report 🚩</button>
    </div>
  </div>
</div>

<!-- Collab Post Modal -->
<div id="modal-collab-post" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Request Collab 🤝</div>
      <button class="close-btn" onclick="closeModal('modal-collab-post')">✕</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px;color:var(--text2);">Invite another user to collaborate on this post!</p>
      <div class="form-group">
        <label>Username to collab with</label>
        <input type="text" id="collab-user-input" placeholder="their_handle">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="sendCollabRequest()">Send Request 🤝</button>
    </div>
  </div>
</div>

<!-- Upload Video Modal -->
<div id="modal-upload-video" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Upload to Channel 🎬</div>
      <button class="close-btn" onclick="closeModal('modal-upload-video')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Video Title</label>
        <input type="text" id="video-title-input" placeholder="Give your video a great title">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="video-desc-input" placeholder="Tell viewers what this is about..."></textarea>
      </div>
      <div class="form-group">
        <label>Thumbnail Emoji</label>
        <input type="text" id="video-emoji-input" placeholder="🎬" maxlength="4" value="🎬">
      </div>
      <div class="form-group">
        <label>Tags (comma separated)</label>
        <input type="text" id="video-tags-input" placeholder="music, chill, vibes">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="uploadVideo()">Upload Video ✨</button>
    </div>
  </div>
</div>

<!-- Top 8 Picker Modal -->
<div id="modal-top8" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Pick Top 8 Friend</div>
      <button class="close-btn" onclick="closeModal('modal-top8')">✕</button>
    </div>
    <div class="modal-body">
      <div id="top8-user-picker" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>
</div>

<!-- Admin First Setup Modal -->
<div id="modal-admin-setup" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">🛡️ Owner Setup</div>
      <button class="btn-ghost" style="position:absolute;right:16px;top:16px;font-size:20px;" onclick="dismissOwnerSetup()">×</button>
    </div>
    <div class="modal-body">
      <div style="background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text2);">
        This is the one-time owner account creation. Keep this URL private.
      </div>
      <div class="form-group">
        <label>Owner Username</label>
        <input type="text" id="setup-username" placeholder="owner_username">
      </div>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="setup-name" placeholder="Your Name">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="setup-email" placeholder="owner@vibehub.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="setup-pass" placeholder="Strong password">
      </div>
      <div class="form-group">
        <label>Recovery Phrase</label>
        <input type="text" id="setup-recovery" placeholder="3-4 words you'll remember">
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="createOwnerAccount()">Create Owner Account 👑</button>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="modal-admin-login" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">🛡️ Owner Login</div>
    </div>
    <div class="modal-body">
      <div style="background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.2);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text2);">
        Enter your owner credentials to access the admin panel.
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="admin-login-user" placeholder="owner_username">
      </div>
<div class="form-group">
        <label>Password</label>
        <input type="password" id="admin-login-pass" placeholder="Your password">
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:12px;margin:16px 0;">
        <input type="checkbox" id="admin-remember" checked style="width:22px;height:22px;accent-color:#8b5cf6;cursor:pointer;">
        <label for="admin-remember" style="font-size:15px;cursor:pointer;">Stay logged in</label>
      </div>
      <button class="btn btn-primary w-full" style="justify-content:center;padding:13px;" onclick="doAdminLogin()">Login as Owner 🔐</button>
      <div style="text-align:center;margin-top:12px;">
        <a href="#" onclick="showPage('landing');closeModal('modal-admin-login');" style="color:var(--text3);font-size:13px;">← Back to Home</a>
      </div>
    </div>
  </div>
</div>

<!-- Comment Modal -->
<div id="modal-comments" class="modal-overlay hidden">
  <div class="modal" style="max-width:560px;">
    <div class="modal-header">
      <div class="modal-title">Comments</div>
      <button class="close-btn" onclick="closeModal('modal-comments')">✕</button>
    </div>
    <div class="modal-body" id="modal-comments-body"></div>
  </div>
</div>

<script>
// ══════════════════════════════════════
// CONSTANTS & CONFIG
// ══════════════════════════════════════
// All data stored in Supabase - no localStorage
const ADMIN_SLUG = 'vibe-control-7x9kq2m';
const MAX_BETA_USERS = 10; // First 10 users get in FREE

// Square Payment Links (Production)
const SQUARE_SIGNUP_LINK = 'https://square.link/u/ROZgfUxo';
const SQUARE_MARKETPLACE_LINK = 'https://square.link/u/82tj2UXK';

// ══════════════════════════════════════
// SUPABASE CONFIG (SHARED CLIENT)
// ══════════════════════════════════════
// This file now uses simple Supabase background sync
// See initSupabaseClient() below

// ══════════════════════════════════════
// SIMPLE SUPABASE SYNC (Background)
// ══════════════════════════════════════

let supabaseClient = null;

// Initialize Supabase client
function initSupabaseClient() {
  if (supabaseClient) return supabaseClient;
  
  function tryInit() {
    if (window.supabase && window.VIBEHUB_SUPABASE_URL) {
      supabaseClient = window.supabase.createClient(
        window.VIBEHUB_SUPABASE_URL,
        window.VIBEHUB_SUPABASE_ANON_KEY
      );
      console.log('Supabase client ready');
    } else if (!window.supabaseReady) {
      setTimeout(tryInit, 100);
    }
  }
  
  if (window.supabaseReady) {
    tryInit();
  } else {
    setTimeout(tryInit, 100);
  }
  
  return supabaseClient;
}

function getSupabase() {
  // Return existing client if already created
  if (supabaseClient) return supabaseClient;
  
  // Create client if Supabase is ready
  if (window.supabaseReady && window.VIBEHUB_SUPABASE_URL && window.VIBEHUB_SUPABASE_ANON_KEY) {
    supabaseClient = window.supabase.createClient(
      window.VIBEHUB_SUPABASE_URL,
      window.VIBEHUB_SUPABASE_ANON_KEY
    );
  }
  return supabaseClient;
}

// Upload file to Supabase Storage
async function uploadMedia(file, bucket) {
  const sb = getSupabase();
  if (!sb) { console.error('Supabase not ready'); return null; }
  
  try {
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
    
    const { data, error } = await sb.storage
      .from(bucket)
      .upload(fileName, file, { cacheControl: '3600', upsert: false });
    
    if (error) {
      console.error('Upload error:', error);
      return null;
    }
    
    // Get public URL
    const { data: urlData } = sb.storage.from(bucket).getPublicUrl(fileName);
    return urlData.publicUrl;
  } catch (err) {
    console.error('Upload failed:', err);
    return null;
  }
}

// Real-time subscriptions
let _postsSubscription = null;
let _channelsSubscription = null;
let _notifsSubscription = null;
let _dmSubscription = null;
let _presenceChannel = null;
let _onlineUsers = {};

function initRealtimeSubscriptions() {
  const sb = getSupabase();
  if (!sb) return;
  
  // Subscribe to new posts
  if (!_postsSubscription) {
    _postsSubscription = sb.channel('realtime-posts')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, (payload) => {
        const newPost = payload.new;
        const posts = getPosts();
        const exists = posts.find(p => p.id === newPost.id);
        if (!exists) {
          posts.unshift({
            ...newPost,
            userId: newPost.user_id,
            time: new Date(newPost.created_at).getTime()
          });
          _postsCache = posts;
          if (document.getElementById('feed-posts')) {
            renderFeed('all');
          }
        }
      })
      .subscribe();
  }
  
  // Subscribe to new channel videos
  if (!_channelsSubscription) {
    _channelsSubscription = sb.channel('realtime-channels')
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'channels' }, (payload) => {
        const updatedChannel = payload.new;
        const channels = getChannels();
        const idx = channels.findIndex(c => c.id === updatedChannel.id);
        if (idx !== -1) {
          channels[idx] = {
            ...channels[idx],
            ...updatedChannel,
            ownerId: updatedChannel.owner_id,
            desc: updatedChannel.description,
            emoji: updatedChannel.emoji_banner,
            subs: updatedChannel.subscribers,
            videos: updatedChannel.videos || []
          };
          _channelsCache = channels;
        }
      })
      .subscribe();
  }
  
  // Subscribe to new notifications
  if (!_notifsSubscription) {
    _notifsSubscription = sb.channel('realtime-notifs')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, (payload) => {
        const newNotif = payload.new;
        const me = getCurrentUser();
        if (newNotif.user_id === me?.username) {
          const notifs = getNotifs();
          notifs.unshift({
            id: newNotif.id,
            type: newNotif.type,
            fromUser: newNotif.clerk_id,
            toUser: newNotif.user_id,
            text: newNotif.message,
            time: new Date(newNotif.created_at).getTime(),
            read: false
          });
          _notifsCache = notifs;
          // Update notification badge
          const badge = document.getElementById('notif-badge');
          if (badge) {
            badge.textContent = notifs.filter(n => !n.read).length;
            badge.style.display = notifs.filter(n => !n.read).length > 0 ? 'block' : 'none';
          }
        }
      })
      .subscribe();
  }
  
  // Subscribe to new DM messages
  subscribeToDMs();
  
  // Subscribe to online users presence
  subscribeToPresence();
  
  // Subscribe to Top 8 Vibes changes
  subscribeToTopVibes();
  
  // Subscribe to Vibe Likes
  subscribeToVibeLikes();
  
  console.log('Realtime subscriptions initialized');
}

// Subscribe to Top 8 Vibes changes
function subscribeToTopVibes() {
  const sb = getSupabase();
  const user = getCurrentUser();
  if (!sb || !user?.id) return;
  
  sb.channel('top_vibes_changes')
    .on('postgres_changes', { 
      event: '*', 
      schema: 'public', 
      table: 'top_vibes',
      filter: `user_id=eq.${user.id}`
    }, async (payload) => {
      console.log('Top vibes changed:', payload);
      await loadTopVibesToUser();
      renderProfile(user.username);
    })
    .subscribe();
}

// Subscribe to Vibe Likes
function subscribeToVibeLikes() {
  const sb = getSupabase();
  const user = getCurrentUser();
  if (!sb || !user?.id) return;
  
  sb.channel('vibe_likes_changes')
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'vibe_likes',
      filter: `receiver_id=eq.${user.id}`
    }, (payload) => {
      console.log('New vibe like received:', payload);
      addNotif(payload.new.sender_id, 'vibe_like', payload.new.from_username || 'Someone', 'liked your vibe!', null);
    })
    .subscribe();
}

// Subscribe to DM messages
function subscribeToDMs() {
  const sb = getSupabase();
  const user = getCurrentUser();
  if (!sb || !user) return;
  
  // Unsubscribe from previous if any
  if (_dmSubscription) {
    _dmSubscription.unsubscribe();
  }
  
  _dmSubscription = sb.channel('dm-messages')
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'messages',
      filter: `receiver_id=eq.${user.username}`
    }, (payload) => {
      const newMsg = payload.new;
      console.log('New DM received:', newMsg);
      
      // Add to messages cache
      const allMessages = getMessages();
      const key = [newMsg.sender_id, newMsg.receiver_id].sort().join('-');
      if (!allMessages[key]) allMessages[key] = [];
      
      // Check if message already exists
      const exists = allMessages[key].find(m => m.id === newMsg.id);
      if (!exists) {
        allMessages[key].push({
          id: newMsg.id,
          from: newMsg.sender_id,
          to: newMsg.receiver_id,
          text: newMsg.message,
          time: new Date(newMsg.created_at).getTime(),
          read: false
        });
        _messagesCache = allMessages;
        
        // Show notification if in different conversation
        const currentChat = document.getElementById('chat-area');
        if (currentChat && !currentChat.classList.contains('hidden')) {
          // Currently in chat - refresh
          if (typeof openDM === 'function') {
            const otherUser = Object.keys(allMessages).find(k => k.includes(user.username) && k !== key);
            if (otherUser) openDM(otherUser.split('-').find(u => u !== user.username));
          }
        } else {
          // Show toast notification
          toast(`New message from ${newMsg.sender_id}`, 'info');
        }
      }
    })
    .subscribe();
  
  console.log('Subscribed to DM messages for:', user.username);
}

// Subscribe to online users presence
function subscribeToPresence() {
  const sb = getSupabase();
  const user = getCurrentUser();
  if (!sb || !user) return;
  
  // Unsubscribe from previous if any
  if (_presenceChannel) {
    _presenceChannel.unsubscribe();
  }
  
  _presenceChannel = sb.channel('online-users')
    .on('presence', { event: 'sync' }, () => {
      const state = _presenceChannel.presenceState();
      _onlineUsers = {};
      Object.values(state).forEach(userList => {
        userList.forEach(u => {
          _onlineUsers[u.user] = u;
        });
      });
      console.log('Online users:', Object.keys(_onlineUsers));
      
      // Update UI if online indicator exists
      updateOnlineIndicators();
    })
    .on('presence', { event: 'join' }, ({ key, newPresences }) => {
      console.log('User joined:', key, newPresences);
    })
    .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
      console.log('User left:', key, leftPresences);
    })
    .subscribe(async (status) => {
      if (status === 'SUBSCRIBED') {
        await _presenceChannel.track({ user: user.username, online_at: Date.now() });
        console.log('Presence tracking started for:', user.username);
      }
    });
}

// Update online indicators in UI
function updateOnlineIndicators() {
  // This can be called to update any UI element showing online status
  const onlineCount = Object.keys(_onlineUsers).length;
  console.log('Total online:', onlineCount);
}

// Check if user is online
function isUserOnline(username) {
  return !!_onlineUsers[username];
}

// Send live reaction to a post (Broadcast - ephemeral)
function sendLiveReaction(postId, emoji) {
  const sb = getSupabase();
  const user = getCurrentUser();
  if (!sb || !user) return;
  
  const channel = sb.channel('reactions:' + postId);
  channel.send({
    type: 'broadcast',
    event: 'new_reaction',
    payload: { emoji: emoji, user: user.username, postId: postId }
  });
}

// Subscribe to live reactions for a post
function subscribeToReactions(postId) {
  const sb = getSupabase();
  if (!sb) return;
  
  sb.channel('reactions:' + postId)
    .on('broadcast', { event: 'new_reaction' }, (payload) => {
      const { emoji, user, postId: reactionPostId } = payload.payload;
      if (reactionPostId === postId) {
        showFlyingEmoji(postId, emoji, user);
      }
    })
    .subscribe();
}

// Show flying emoji animation
function showFlyingEmoji(postId, emoji, fromUser) {
  const postEl = document.getElementById('post-' + postId);
  if (!postEl) return;
  
  // Create flying emoji element
  const flyingEmoji = document.createElement('div');
  flyingEmoji.textContent = emoji;
  flyingEmoji.style.cssText = `
    position: absolute;
    font-size: 24px;
    pointer-events: none;
    animation: flyUp 1s ease-out forwards;
    z-index: 1000;
  `;
  
  // Random starting position
  const randomX = Math.random() * 80 + 10;
  flyingEmoji.style.left = randomX + '%';
  flyingEmoji.style.top = '50%';
  
  postEl.style.position = 'relative';
  postEl.appendChild(flyingEmoji);
  
  // Remove after animation
  setTimeout(() => {
    flyingEmoji.remove();
  }, 1000);
}

function cleanupRealtimeSubscriptions() {
  if (_postsSubscription) {
    _postsSubscription.unsubscribe();
    _postsSubscription = null;
  }
  if (_channelsSubscription) {
    _channelsSubscription.unsubscribe();
    _channelsSubscription = null;
  }
  if (_notifsSubscription) {
    _notifsSubscription.unsubscribe();
    _notifsSubscription = null;
  }
  if (_dmSubscription) {
    _dmSubscription.unsubscribe();
    _dmSubscription = null;
  }
  if (_presenceChannel) {
    _presenceChannel.unsubscribe();
    _presenceChannel = null;
  }
}

// Run on page load
initSupabaseClient();

// PAGE ROUTING - defined early so buttons work

// Mobile Navigation Handler
function handleMobileNav(value) {
  if (!value) return;
  
  // Check if logged in
  const session = getSession();
  if (!session) {
    showPage('landing');
    return;
  }
  
  // Navigate to selected page
  navigate(value);
  
  // Reset dropdown to default
  document.getElementById('mobile-nav').value = '';
}

// Update mobile admin option visibility
function updateMobileAdminOption() {
  const isAdminURL = window.location.search.includes('vibe-control-7x9kq2m');
  const adminOption = document.getElementById('mobile-admin-option');
  
  if (adminOption) {
    adminOption.style.display = isAdminURL ? 'block' : 'none';
  }
}

function showPage(page) {
  document.getElementById('page-landing').classList.add('hidden');
  document.getElementById('page-login').classList.add('hidden');
  document.getElementById('page-register').classList.add('hidden');
  document.getElementById('app-shell').classList.add('hidden');

  if (page === 'landing') { document.getElementById('page-landing').classList.remove('hidden'); if(typeof updateBetaUI==='function')updateBetaUI(); }
  else if (page === 'login') document.getElementById('page-login').classList.remove('hidden');
  else if (page === 'register') { document.getElementById('page-register').classList.remove('hidden'); if(typeof updateBetaUI==='function')updateBetaUI(); }
  else if (page === 'admin-setup') {
    if (typeof getOwnerSetup !== 'undefined' && getOwnerSetup()) { if(typeof toast==='function')toast('Owner account already created.', 'error'); showPage('login'); return; }
    document.getElementById('modal-admin-setup').classList.remove('hidden');
    document.getElementById('page-landing').classList.remove('hidden');
  }
}

// ══════════════════════════════════════
// DATA STORE (Supabase Only)
// ══════════════════════════════════════

// In-memory cache for data
let _usersCache = [];
let _postsCache = [];
let _channelsCache = [];
let _notifsCache = [];
let _messagesCache = {};
let _initialized = false;

// Initialize data from Supabase
async function initDataStore() {
  if (_initialized) return;
  const sb = getSupabase();
  if (!sb) return;
  
  try {
    // Load users first - this is critical
    const usersRes = await sb.from('users').select('*');
    console.log('Users response:', usersRes);
    _usersCache = (usersRes.data || []).map(u => ({
      ...u,
      id: u.id,
      username: u.username,
      name: u.name || u.username,
      email: u.email,
      bio: u.bio || '',
      avatar: u.avatar_url || u.avatar || '',
      avatar_url: u.avatar_url || '',
      avatarImage: u.avatar_url || '',
      banner: u.banner_url || u.banner || 'purple',
      banner_url: u.banner_url || '',
      profileBackground: u.profileBackground || '',
      theme: u.theme || 'purple',
      role: u.role || 'user',
      isBeta: u.is_beta || false,
      joined: u.created_at ? new Date(u.created_at).getTime() : Date.now()
    }));
    console.log('Users loaded from Supabase:', _usersCache.length);
    console.log('First user sample:', _usersCache[0]);
    
    // Try to load other data but don't fail if they don't exist
    try {
      console.log('Loading posts from Supabase...');
      const postsRes = await sb.from('posts').select('*').order('created_at', { ascending: false });
      if (postsRes.error) {
        console.error('Posts load error:', postsRes.error);
      } else {
        console.log('Posts loaded:', postsRes.data?.length || 0);
      }
      _postsCache = (postsRes.data || []).map(p => ({
        id: p.id,
        userId: p.user_id,
        username: p.username || p.user_id,
        text: p.text || '',
        tags: p.tags || [],
        likes: p.likes || [],
        dislikes: p.dislikes || [],
        reactions: p.reactions || {},
        comments: p.comments || [],
        type: p.media_type || 'text',
        imageData: p.media_type === 'image' ? p.media_url : null,
        videoData: p.media_type === 'video' ? p.media_url : null,
        time: p.created_at ? new Date(p.created_at).getTime() : Date.now()
      }));
      console.log('Posts in cache:', _postsCache.length);
      console.log('Sample post:', _postsCache[0]);
    } catch (e) { console.log('Posts table not available:', e); }
    
    try {
      const channelsRes = await sb.from('channels').select('*');
      _channelsCache = (channelsRes.data || []).map(c => ({
        ...c,
        ownerId: c.owner_id,
        desc: c.description,
        emoji: c.emoji_banner,
        subs: c.subscribers,
        videos: c.videos || []
      }));
    } catch (e) { console.log('Channels table not available'); }
    
    try {
      const notifsRes = await sb.from('notifications').select('*');
      const allNotifs = notifsRes.data || [];
      _notifsCache = allNotifs.map(n => ({
        ...n,
        toUser: n.user_id,
        fromUser: n.clerk_id,
        text: n.message,
        time: new Date(n.created_at).getTime()
      }));
    } catch (e) { console.log('Notifications table not available'); }
    
    try {
      const msgsRes = await sb.from('messages').select('*').order('created_at', { ascending: true });
      const allMsgs = msgsRes.data || [];
      const msgsByConvo = {};
      allMsgs.forEach(m => {
        const key = [m.sender_id, m.receiver_id].sort().join('-');
        if (!msgsByConvo[key]) msgsByConvo[key] = [];
        msgsByConvo[key].push({
          id: m.id,
          from: m.sender_id,
          to: m.receiver_id,
          text: m.message,
          time: new Date(m.created_at).getTime(),
          read: true
        });
      });
      _messagesCache = msgsByConvo;
    } catch (e) { console.log('Messages table not available'); }
    
    try {
      const spacesRes = await sb.from('sync_spaces').select('*');
      if (spacesRes.data && spacesRes.data.length > 0) {
        _syncSpacesCache = spacesRes.data.map(s => ({
          id: s.id,
          name: s.name,
          creator: s.creator,
          users: s.users || [],
          expiresAt: new Date(s.expires_at).getTime()
        }));
      }
    } catch (e) { console.log('Sync spaces table not available'); }
    
    try {
      const roomMsgsRes = await sb.from('sync_space_messages').select('*').order('created_at', { ascending: true });
      if (roomMsgsRes.data) {
        roomMsgsRes.data.forEach(m => {
          if (!_roomMessagesCache[m.room_id]) _roomMessagesCache[m.room_id] = [];
          _roomMessagesCache[m.room_id].push({
            id: m.id,
            roomId: m.room_id,
            senderId: m.sender_id,
            senderName: m.sender_name,
            text: m.message,
            reactions: m.reactions || {},
            time: new Date(m.created_at).getTime()
          });
        });
      }
    } catch (e) { console.log('Sync space messages table not available'); }
    
    // Load Top 8 Vibes from Supabase for current user
    const me = getCurrentUser();
    if (me?.id) {
      await loadTopVibesToUser();
    }
    
    _initialized = true;
    console.log('Data loaded from Supabase');
  } catch (err) {
    console.error('Failed to load data:', err);
  }
}

// User functions - Supabase only
function getUsers() { return _usersCache; }

async function setUsers(users) { 
  _usersCache = users;
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('users').upsert(users.slice(0, 50).map(u => ({
        id: u.id || 'u_' + Date.now() + Math.random().toString(36).substr(2, 9),
        username: u.username,
        email: u.email,
        name: u.name,
        bio: u.bio || '',
        avatar_url: u.avatar || u.avatar_url || '',
        theme: u.theme || 'purple',
        banner_url: u.banner || u.banner_url || 'purple',
        role: u.role || 'user',
        recovery: u.recovery || '',
        password: u.password || '',
        is_beta: u.isBeta || u.is_beta || false,
        owner_setup: u.owner_setup || false,
        paid: u.paid || false,
        created_at: u.joined ? new Date(u.joined).toISOString() : new Date().toISOString()
      })), { onConflict: 'id' });
      console.log('Users saved to Supabase');
    } catch (err) {
      console.error('Failed to save users:', err);
    }
  }
}

// Post functions - Supabase only
function getPosts() { return _postsCache; }

async function setPosts(posts) { 
  // Sort by time (newest first) before saving
  posts = posts.sort((a, b) => (b.time || 0) - (a.time || 0));
  
  _postsCache = posts;
  const sb = getSupabase();
  if (sb) {
    try {
      console.log('Saving posts to Supabase, count:', posts.length);
      const postsToSave = posts.slice(0, 50).map(p => {
        let mediaUrl = '';
        let mediaType = 'text';
        
        if (p.imageData) {
          mediaUrl = p.imageData;
          mediaType = 'image';
        } else if (p.videoData) {
          mediaUrl = p.videoData;
          mediaType = 'video';
        }
        
        return {
          id: p.id,
          user_id: p.userId,
          username: p.username || p.userId,
          text: p.text || '',
          tags: p.tags || [],
          likes: p.likes || [],
          dislikes: p.dislikes || [],
          reactions: p.reactions || { cap: [], relate: [], wild: [], facts: [] },
          comments: p.comments || [],
          media_type: mediaType,
          media_url: mediaUrl,
          created_at: p.time ? new Date(p.time).toISOString() : new Date().toISOString()
        };
      });
      console.log('Posts to save:', postsToSave);
      
      const { data, error } = await sb.from('posts').upsert(postsToSave, { onConflict: 'id' });
      if (error) {
        console.error('Posts save error:', error);
      } else {
        console.log('Posts saved to Supabase successfully');
      }
    } catch (err) {
      console.error('Failed to save posts:', err);
    }
  } else {
    console.log('Supabase not available, posts not saved');
  }
}

// Debug function to diagnose posts issues
function diagnosePosts() {
  console.log('=== POSTS DIAGNOSTIC ===');
  console.log('Posts in cache:', _postsCache.length);
  console.log('Posts:', JSON.stringify(_postsCache, null, 2));
  console.log('Current user:', getCurrentUser());
  console.log('Users in cache:', _usersCache.length);
  console.log('Users:', _usersCache.map(u => u.username));
  
  // Check if posts have required fields
  _postsCache.forEach((p, i) => {
    console.log(`Post ${i}: id=${p.id}, userId=${p.userId}, text=${p.text?.substring(0, 30)}..., time=${p.time}`);
  });
  
  // Check if renderFeed would work
  const container = document.getElementById('feed-posts');
  console.log('Feed container exists:', !!container);
}

// Channel functions - Supabase only
function getChannels() { return _channelsCache; }

async function setChannels(channels) { 
  _channelsCache = channels;
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('channels').upsert(channels.slice(0, 50).map(c => ({
        id: c.id,
        owner_id: c.ownerId,
        name: c.name,
        description: c.desc || '',
        category: c.category || '🎵 Music',
        emoji_banner: c.emoji || '🎬',
        subscribers: c.subs || [],
        videos: c.videos || []
      })), { onConflict: 'id' });
    } catch (err) {
      console.error('Failed to save channels:', err);
    }
  }
}

// Notify channel subscribers when new video is uploaded
function notifyChannelSubscribers(channelId, videoTitle) {
  const channels = getChannels();
  const channel = channels.find(c => c.id === channelId);
  if (!channel || !channel.subs) return;
  
  const me = getCurrentUser();
  channel.subs.forEach(sub => {
    if (sub !== me.username) {
      addNotif(sub, 'video', me.username, `uploaded "${videoTitle}" to ${channel.name}`, channelId);
    }
  });
}

// Message functions - Supabase only
function getMessages() { return _messagesCache; }

async function setMessages(messages) { 
  _messagesCache = messages;
  const sb = getSupabase();
  if (sb) {
    try {
      const msgsToSave = [];
      Object.values(messages).forEach(convo => {
        convo.forEach(m => {
          msgsToSave.push({
            id: m.id || 'm_' + Date.now() + Math.random().toString(36).substr(2, 9),
            sender_id: m.from,
            receiver_id: m.to,
            message: m.text,
            created_at: m.time ? new Date(m.time).toISOString() : new Date().toISOString()
          });
        });
      });
      await sb.from('messages').upsert(msgsToSave.slice(0, 100), { onConflict: 'id' });
    } catch (err) {
      console.error('Failed to save messages:', err);
    }
  }
}

// Notification functions - Supabase only
function getNotifs() { return _notifsCache; }

async function setNotifs(notifs) { 
  _notifsCache = notifs;
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('notifications').upsert(notifs.slice(0, 50).map(n => ({
        id: n.id,
        user_id: n.toUser,
        clerk_id: n.fromUser,
        type: n.type,
        message: n.text,
        read: n.read || false,
        created_at: n.time ? new Date(n.time).toISOString() : new Date().toISOString()
      })), { onConflict: 'id' });
    } catch (err) {
      console.error('Failed to save notifications:', err);
    }
  }
}

// Owner setup status - query Supabase
async function checkOwnerExists() {
  const sb = getSupabase();
  if (!sb) return false;
  try {
    const { data } = await sb.from('users').select('id').eq('role', 'owner').limit(1);
    return data && data.length > 0;
  } catch (err) {
    return false;
  }
}

function getOwnerSetup() {
  // Check if owner exists in the cache
  if (_usersCache && _usersCache.length > 0) {
    const owner = _usersCache.find(u => u.role === 'owner');
    if (owner) return true;
  }
  // If we have a session, assume owner (user logged in before)
  const session = getSession();
  if (session) return true;
  // Check URL - if admin URL, we want to show login since owner exists in Supabase
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('vibe-control-7x9kq2m')) {
    // Admin URL - owner was created in Supabase, show login
    return true;
  }
  // Default to showing setup
  return false;
}

function setOwnerSetup(v) {
  // Owner setup is determined by existence in Supabase now
  // This function kept for compatibility but does nothing
}

function dismissOwnerSetup() {
  closeModal('modal-admin-setup');
}

// Beta users = real users (non-seed) who joined free
function getBetaCount() {
  return _usersCache.filter(u => u.isBeta || u.role === 'owner').length;
}
function getRealUserCount() {
  return _usersCache.filter(u => u.registered).length;
}
function getBetaSlotsLeft() {
  return Math.max(0, MAX_BETA_USERS - getRealUserCount());
}
function isBetaOpen() {
  // Check Supabase users first
  const betaCount = _usersCache.filter(u => u.is_beta).length;
  return betaCount < MAX_BETA_USERS;
}

// Session
// Session management - cookie based
let currentSession = null;

function getSession() {
  if (currentSession) return currentSession;
  const match = document.cookie.match(/vibe_session=([^;]+)/);
  return match ? decodeURIComponent(match[1]) : null;
}

function getCurrentUser() {
  const session = getSession();
  if (!session) return null;
  return _usersCache.find(u => u.username === session);
}

function setSession(username) {
  currentSession = username;
  document.cookie = 'vibe_session=' + encodeURIComponent(username) + ';path=/;max-age=2592000';
}

function clearSession() {
  currentSession = null;
  document.cookie = 'vibe_session=;path=/;expires=Thu, 01 Jan 1970 00:00:00';
}

// Navigation history for back button
let navHistory = [];
let currentView = null;

// Cleanup function for native SPA behavior
function cleanupCurrentView() {
  // Reset scroll position to top
  window.scrollTo(0, 0);
  
  // Clean up any floating elements or overlays from previous view
  const overlays = document.querySelectorAll('.modal-overlay:not(.hidden)');
  // Don't close modals, just clean up any temp elements
  
  // Clear any pending timeouts related to current view
  // This prevents memory leaks
}

// Navigate function
function navigate(view, param) {
  // Clean up previous view
  cleanupCurrentView();
  
  // Push to history
  if (currentView && currentView !== view) {
    navHistory.push({ view: currentView, param: currentView._param });
  }
  currentView = view;
  currentView._param = param;
  updateBackBtn();

  const views = ['home','explore','channels','channel-detail','sync-spaces','messages','notifications','profile','edit-profile','my-channel','admin','search','settings'];
  views.forEach(v => {
    const el = document.getElementById('view-' + v);
    if (el) el.classList.add('hidden');
  });

  const titles = { home:'🏠 Home Feed', explore:'🔍 Explore', channels:'📺 Channels', 'sync-spaces':'💬 Sync Spaces', messages:'💬 Messages', notifications:'🔔 Notifications', profile:'👤 Profile', 'edit-profile':'🎨 Customize My Page', 'my-channel':'📡 My Channel', admin:'🛡️ Admin Panel', search:'🔍 Search', settings:'⚙️ Settings' };
  document.getElementById('topbar-title').textContent = titles[view] || 'VibeHub';

  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById('nav-' + view);
  if (navEl) navEl.classList.add('active');

  const el = document.getElementById('view-' + view);
  if (el) el.classList.remove('hidden');

  // Render logic
  if (view === 'home') renderFeed('all');
  else if (view === 'explore') renderExplore();
  else if (view === 'channels') renderChannels();
  else if (view === 'channel-detail') renderChannelDetail(param);
  else if (view === 'sync-spaces') renderSyncSpaces();
  else if (view === 'messages') renderMessages();
  else if (view === 'notifications') renderNotifications();
  else if (view === 'profile') renderProfile(param || getCurrentUser()?.username);
  else if (view === 'edit-profile') renderEditProfile();
  else if (view === 'my-channel') renderMyChannel();
  else if (view === 'settings') renderSettings();
  else if (view === 'admin') renderAdmin();
}

function navBack() {
  if (navHistory.length === 0) { navigate('home'); return; }
  const prev = navHistory.pop();
  currentView = prev.view;
  updateBackBtn();

  // Re-run navigate without adding to history
  const views = ['home','explore','channels','channel-detail','messages','notifications','profile','edit-profile','my-channel','admin','search'];
  views.forEach(v => { const el = document.getElementById('view-'+v); if (el) el.classList.add('hidden'); });
  const titles = { home:'🏠 Home Feed', explore:'🔍 Explore', channels:'📺 Channels', messages:'💬 Messages', notifications:'🔔 Notifications', profile:'👤 Profile', 'edit-profile':'🎨 Customize My Page', 'my-channel':'📡 My Channel', admin:'🛡️ Admin Panel', search:'🔍 Search' };
  document.getElementById('topbar-title').textContent = titles[prev.view] || 'VibeHub';
  const el = document.getElementById('view-' + prev.view);
  if (el) el.classList.remove('hidden');
  if (prev.view === 'home') renderFeed('all');
  else if (prev.view === 'explore') renderExplore();
  else if (prev.view === 'channels') renderChannels();
  else if (prev.view === 'profile') renderProfile(prev.param || getCurrentUser()?.username);
  else if (prev.view === 'messages') renderMessages();
  else if (prev.view === 'notifications') renderNotifications();
}

function updateBackBtn() {
  const btn = document.getElementById('back-btn');
  if (!btn) return;
  if (navHistory.length === 0 || currentView === 'home') {
    btn.classList.add('invisible');
  } else {
    btn.classList.remove('invisible');
  }
}

function bottomHomeClick() {
  const appShell = document.getElementById('app-shell');
  if (!appShell.classList.contains('hidden')) {
    navigate('home');
  } else {
    showPage('landing');
  }
}

function bottomAdminClick() {
  // Only work on admin URL
  const isAdminURL = window.location.search.includes('vibe-control-7x9kq2m');
  if (!isAdminURL) return;
  
  // Show admin login modal
  showPage('landing');
  document.getElementById('modal-admin-login').classList.remove('hidden');
  setTimeout(() => {
    document.getElementById('admin-login-user').focus();
  }, 100);
}

function updateBetaUI() {
  const slotsLeft = getBetaSlotsLeft();
  const betaOpen = slotsLeft > 0;

  // Landing nav button
  const landingBtn = document.getElementById('landing-join-btn');
  if (landingBtn) {
    landingBtn.textContent = betaOpen ? 'Create Free Beta Account' : 'Join VibeHub ($1)';
  }

  // Hero join button
  const heroBtn = document.getElementById('hero-join-btn');
  if (heroBtn) {
    heroBtn.textContent = betaOpen ? `Create Free Beta Account 🚀` : `Join VibeHub ($1) 🚀`;
  }

  // Landing beta status
  const statusEl = document.getElementById('landing-beta-status');
  if (statusEl) {
    if (betaOpen) {
      statusEl.innerHTML = `<div class="beta-badge">🎉 Beta is LIVE — <span class="beta-slots">${slotsLeft} free spot${slotsLeft !== 1 ? 's' : ''}</span> remaining!</div>`;
    } else {
      statusEl.innerHTML = `<div class="beta-badge" style="border-color:rgba(245,158,11,0.4);color:var(--gold);background:rgba(245,158,11,0.1);">✨ Beta full — join for just $1 (one time, no ads ever)</div>`;
    }
  }

  // Register page beta info
  const regInfo = document.getElementById('reg-beta-info');
  if (regInfo) {
    if (betaOpen) {
      regInfo.innerHTML = `<div class="beta-badge" style="justify-content:center;">🎉 You're getting in FREE! <span class="beta-slots">${slotsLeft} spot${slotsLeft !== 1 ? 's' : ''} left</span></div>`;
    } else {
      regInfo.innerHTML = `<div style="color:var(--text2);font-size:13px;margin-bottom:4px;">Beta is full — one-time $1 to join</div>`;
    }
  }

  // Register submit button
  const regBtn = document.getElementById('reg-submit-btn');
  if (regBtn) {
    regBtn.textContent = betaOpen ? 'Create Free Beta Account 🚀' : 'Continue to Payment ($1) →';
  }

  // Bottom admin button - show 👑 if owner
  const me = getCurrentUser();
  const adminBtn = document.getElementById('bottom-admin-btn');
  if (adminBtn && me?.role === 'owner') {
    adminBtn.innerHTML = '👑 Admin Panel';
    adminBtn.style.background = 'rgba(245,158,11,0.2)';
  }
}

function handleRegisterSubmit() {
  if (isBetaOpen()) {
    doRegisterFree();
  } else {
    showPaymentModal();
  }
}

async function doRegisterFree() {
  const username = document.getElementById('reg-user').value.trim();
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  const bio = document.getElementById('reg-bio').value.trim();

  if (!username || !name || !email || !pass) { toast('Fill in all fields first', 'error'); return; }
  if (pass.length < 6) { toast('Password must be at least 6 characters', 'error'); return; }

  const users = getUsers();
  if (users.find(u => u.username === username)) { toast('Username already taken', 'error'); return; }
  if (users.find(u => u.email === email)) { toast('Email already registered', 'error'); return; }

  // Check beta count - first 10 users are free, then $1
  const betaCount = _usersCache.filter(u => u.is_beta).length;
  const isFree = betaCount < 10;
  
  if (!isFree) {
    showPaymentModal();
    return;
  }

  const newUser = {
    username, name, email, password: pass, bio,
    theme: 'purple', banner: 'purple',
    song: { url:'', name:'', artist:'' },
    mood: { emoji:'✌️', text:'Just joined VibeHub!' },
    top8: [],
    role: 'user',
    isBeta: true,
    paid: true,
    registered: true,
    joined: Date.now(),
    avatar: name[0]?.toUpperCase() || '?'
  };

  // Save to Supabase
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('users').insert({
        username: username,
        name: name,
        email: email,
        bio: bio || '',
        theme: 'purple',
        banner_gradient: 'purple',
        role: 'user',
        is_beta: true,
        paid: true
      });
      console.log('User saved to Supabase');
    } catch (e) {
      console.error('Failed to save to Supabase:', e);
    }
  }

  users.push(newUser);
  setUsers(users);
  setSession(username);
  launchApp();
  toast('🎉 Welcome to the VibeHub Beta, ' + name + '! You got in FREE!', 'success');

  const notifs = getNotifs();
  notifs.unshift({ id: 'n_welcome', type:'system', text:'🎉 Welcome to the VibeHub Beta! You\'re one of the first. Customize your page and start vibing! ✌️', time: Date.now(), read: false });
  setNotifs(notifs);
}

function handleSearch(val) {
  if (!val.trim()) return;
  navigate('search');
  renderSearch(val.trim());
}

// ══════════════════════════════════════
// AUTH
// ══════════════════════════════════════
function doLogin() {
  const userVal = document.getElementById('login-user').value.trim();
  const pass = document.getElementById('login-pass').value;

  if (!userVal || !pass) { toast('Fill in all fields', 'error'); return; }

  const sb = getSupabase();
  if (sb) {
    sb.from('users').select('*').eq('username', userVal).then(({ data, error }) => {
      if (error) {
        console.error('Error fetching from Supabase:', error);
        toast('Server error: ' + error.message, 'error');
        return;
      }
      
      if (!data || data.length === 0) {
        toast('Wrong username or password', 'error');
        return;
      }
      
      const user = data[0];
      
      if (user.password !== pass) {
        toast('Wrong username or password', 'error');
        return;
      }
      
      setSession(user.username);
      if (!_usersCache.find(u => u.username === user.username)) {
        _usersCache.push({...user, password: pass});
      }
      launchApp();
      initRealtimeSubscriptions();
      toast('Welcome back, ' + user.name + '! ✌️', 'success');
    });
  } else {
    toast('Please wait, connecting to server...', 'info');
  }
}

function showPaymentModal() {
  const username = document.getElementById('reg-user').value.trim();
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;

  if (!username || !name || !email || !pass) { toast('Fill in all fields first', 'error'); return; }
  if (pass.length < 6) { toast('Password must be at least 6 characters', 'error'); return; }

  const users = getUsers();
  if (users.find(u => u.username === username)) { toast('Username already taken', 'error'); return; }
  if (users.find(u => u.email === email)) { toast('Email already registered', 'error'); return; }

  document.getElementById('modal-payment').classList.remove('hidden');
}

function processPayment() {
  // Open Square payment link in new tab
  window.open(SQUARE_SIGNUP_LINK, '_blank');
  toast('Please complete payment in the new window, then return and click "I\'ve already paid"', 'info');
}

async function completeRegistration() {
  const username = document.getElementById('reg-user').value.trim();
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  const bio = document.getElementById('reg-bio').value.trim();

  console.log('Creating new user:', username, name);
  
  const newUser = {
    username, name, email, password: pass, bio,
    theme: 'purple', banner: 'purple',
    song: { url:'', name:'', artist:'' },
    mood: { emoji:'✌️', text:'Just joined VibeHub!' },
    top8: [],
    role: 'user',
    registered: true,
    paid: true,
    isBeta: false,
    joined: Date.now(),
    avatar: name[0]?.toUpperCase() || '?'
  };

  const users = getUsers();
  console.log('Current users before:', users.length);
  users.push(newUser);
  console.log('Users after push:', users.length);
  
  try {
    await setUsers(users);
    console.log('User saved to Supabase');
  } catch (err) {
    console.error('Failed to save user:', err);
    toast('Failed to save account. Please try again.', 'error');
    return;
  }

  setSession(username);
  launchApp();
  toast('Welcome to VibeHub, ' + name + '! 🎉', 'success');

  // Add welcome notification
  const notifs = getNotifs();
  notifs.unshift({ id: 'n_welcome', type:'system', text:'Welcome to VibeHub! Customize your page and start vibing. ✌️', time: Date.now(), read: false });
  setNotifs(notifs);
}

function createOwnerAccount() {
  const username = document.getElementById('setup-username').value.trim();
  const name = document.getElementById('setup-name').value.trim();
  const email = document.getElementById('setup-email').value.trim();
  const pass = document.getElementById('setup-pass').value;
  const recovery = document.getElementById('setup-recovery').value.trim();

  if (!username || !name || !email || !pass || !recovery) { toast('Fill all fields', 'error'); return; }

  const users = getUsers();
  if (users.find(u => u.username === username)) { toast('Username taken', 'error'); return; }

  const owner = {
    id: 'owner_' + Date.now(),
    username, name, email, password: pass, bio: 'Platform owner 👑',
    theme: 'gold', banner: 'gold',
    song: { url:'', name:'', artist:'' },
    mood: { emoji:'👑', text:'Running the show' },
    top8: [],
    role: 'owner',
    recovery,
    joined: Date.now(),
    avatar: '👑',
    owner_setup: true,
    isBeta: true,
    paid: true
  };

  users.push(owner);
  setUsers(users);
  
  setOwnerSetup(true);

  closeModal('modal-admin-setup');
  setSession(username);
  launchApp();
  toast('Owner account created! Welcome, ' + name + ' 👑', 'success');
}

function doAdminLogin() {
  const username = document.getElementById('admin-login-user').value.trim();
  const pass = document.getElementById('admin-login-pass').value;
  const rememberMe = document.getElementById('admin-remember')?.checked;

  if (!username || !pass) { toast('Enter username and password', 'error'); return; }

  // Query Supabase for user - specifically by username
  const sb = getSupabase();
  if (sb) {
    sb.from('users').select('*').eq('username', username).then(({ data, error }) => {
      if (error) {
        console.error('Error fetching from Supabase:', error);
        toast('Server error: ' + error.message, 'error');
        return;
      }
      
      if (!data || data.length === 0) {
        toast('User not found', 'error');
        return;
      }
      
      const user = data[0];
      
      // Check recovery phrase
      if (user.recovery !== pass) {
        toast('Invalid credentials - check your recovery phrase', 'error');
        return;
      }
      
      // Check role
      if (user.role !== 'owner') {
        toast('Only owner can login here', 'error');
        return;
      }
      
      // Success - login
      closeModal('modal-admin-login');
      
      // Set cookie based on remember me
      if (rememberMe) {
        document.cookie = 'vibe_session=' + encodeURIComponent(username) + ';path=/;max-age=2592000';
      } else {
        document.cookie = 'vibe_session=' + encodeURIComponent(username) + ';path=/';
      }
      
      // Add to local cache if not exists
      if (!_usersCache.find(u => u.username === username)) {
        _usersCache.push({...user, password: pass});
      }
      launchApp();
      initRealtimeSubscriptions();
      navigate('admin');
      toast('Welcome back, ' + user.name + ' 👑', 'success');
    });
  } else {
    // Supabase not ready
    toast('Please wait, connecting to server...', 'info');
  }
}

function doLogout() {
  clearSession();
  
  // Clear last_seen interval
  if (typeof lastSeenInterval !== 'undefined') {
    clearInterval(lastSeenInterval);
    lastSeenInterval = null;
  }

  // Also sign out from Clerk so auth state is cleared across devices
  if (window.vhAuth && typeof window.vhAuth.signOut === 'function') {
    window.vhAuth.signOut();
  }

  // Clear any demo session if running in demo mode
  if (window.vhAuth && typeof window.vhAuth.clearDemoSession === 'function') {
    window.vhAuth.clearDemoSession();
  }

  showPage('landing');
}

function launchApp() {
  showPage('_');
  document.getElementById('app-shell').classList.remove('hidden');
  updateSidebarUser();
  updateBetaUI();
  navHistory = [];
  document.getElementById('msg-badge').style.display = 'flex';
  navigate('home');
  
  // Update last_seen on login
  updateLastSeen();
  
  // Set up periodic last_seen updates
  if (typeof lastSeenInterval !== 'undefined') {
    clearInterval(lastSeenInterval);
  }
  lastSeenInterval = setInterval(updateLastSeen, 60000); // Every minute
}

// Update user's last_seen timestamp
let lastSeenInterval = null;

async function updateLastSeen() {
  const user = getCurrentUser();
  if (!user) return;
  
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('users').update({ 
        last_seen: new Date().toISOString() 
      }).eq('username', user.username);
    } catch (err) {
      // Silent fail - not critical
    }
  }
}

function updateSidebarUser() {
  const user = getCurrentUser();
  if (!user) return;
  const av = document.getElementById('sidebar-avatar');
  av.textContent = user.avatar || user.name[0];
  document.getElementById('sidebar-name').textContent = user.name;
  document.getElementById('sidebar-handle').textContent = '@' + user.username;

  if (user.role === 'owner') {
    document.getElementById('admin-section').style.display = '';
    document.getElementById('nav-admin').classList.remove('hidden');
  }
}

// ══════════════════════════════════════
// FEED RENDERING
// ══════════════════════════════════════
function switchFeedTab(tab, btn) {
  document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderFeed(tab);
}

let postImageData = null;
let postVideoData = null;
let postImageFile = null;
let postVideoFile = null;

function handlePostImage(input) {
  const file = input.files[0];
  if (!file) return;
  
  // Store file for upload
  postImageFile = file;
  postVideoFile = null;
  
  // Show preview using file API
  const reader = new FileReader();
  reader.onload = e => {
    postImageData = e.target.result;
    document.getElementById('composer-preview').innerHTML = `<img src="${e.target.result}" style="max-height:200px;border-radius:8px;margin-top:4px;">`;
  };
  reader.readAsDataURL(file);
}

function handlePostVideo(input) {
  const file = input.files[0];
  if (!file) return;
  
  // Store file for upload
  postVideoFile = file;
  postImageFile = null;
  
  // Show preview using file API
  const reader = new FileReader();
  reader.onload = e => {
    postVideoData = e.target.result;
    document.getElementById('composer-preview').innerHTML = `<video src="${e.target.result}" controls style="max-height:200px;border-radius:8px;margin-top:4px;width:100%;"></video>`;
  };
  reader.readAsDataURL(file);
}

function addTagToComposer() {
  const tag = prompt('Add a tag (without #):');
  if (tag) {
    const input = document.getElementById('post-composer-input');
    input.value += ' #' + tag.replace(/\s/g,'').toLowerCase();
  }
}

function addMoodToComposer() {
  const moods = ['☀️','🔥','✌️','💫','😴','🎵','💻','🌍','📸','🎨'];
  const mood = moods[Math.floor(Math.random() * moods.length)];
  const input = document.getElementById('post-composer-input');
  input.value += ' ' + mood;
}

async function createPost() {
  const text = document.getElementById('post-composer-input').value.trim();
  if (!text && !postImageData && !postVideoData) { toast('Write something first!', 'error'); return; }

  const user = getCurrentUser();
  console.log('Creating post, user:', user);
  const tags = (text.match(/#(\w+)/g) || []).map(t => t.slice(1));

  let mediaUrl = '';
  let mediaType = 'text';
  
  // Upload image or video if present
  if (postImageFile) {
    toast('Uploading image...', 'info');
    console.log('Uploading image file:', postImageFile.name);
    mediaUrl = await uploadMedia(postImageFile, 'posts');
    mediaType = 'image';
    console.log('Image uploaded, URL:', mediaUrl);
  } else if (postVideoFile) {
    toast('Uploading video...', 'info');
    console.log('Uploading video file:', postVideoFile.name);
    mediaUrl = await uploadMedia(postVideoFile, 'posts');
    mediaType = 'video';
    console.log('Video uploaded, URL:', mediaUrl);
  }

  const post = {
    id: 'p_' + Date.now(),
    userId: user.username,
    text,
    tags,
    likes: [],
    dislikes: [],
    comments: [],
    time: Date.now(),
    type: mediaType,
    imageData: mediaType === 'image' ? mediaUrl : null,
    videoData: mediaType === 'video' ? mediaUrl : null
  };
  console.log('Created post object:', post);

  const posts = getPosts();
  console.log('Current posts count before:', posts.length);
  posts.unshift(post);
  console.log('Posts count after unshift:', posts.length);
  
  await setPosts(posts);

  // Update user interests based on post tags (for We Vibin)
  if (tags.length > 0) {
    updateInterestsOnPost(tags);
  }

  document.getElementById('post-composer-input').value = '';
  document.getElementById('composer-preview').innerHTML = '';
  postImageData = null;
  postVideoData = null;
  postImageFile = null;
  postVideoFile = null;

  renderFeed('all');
  toast('Vibe posted! ✌️', 'success');
}

function renderFeed(tab) {
  const container = document.getElementById('feed-posts');
  let posts = getPosts();
  const user = getCurrentUser();
  
  console.log('Rendering feed, tab:', tab, 'posts count:', posts.length);

  // Update composer avatar
  const av = document.getElementById('composer-avatar');
  if (av && user) av.textContent = user.avatar || user.name[0];

  // Sort ALL posts by time (newest first) for 'all' tab
  if (tab === 'all') {
    posts = [...posts].sort((a, b) => (b.time || 0) - (a.time || 0));
  }
  
  if (tab === 'friends') {
    posts = posts.filter(p => user.top8?.includes(p.userId) || p.userId === user.username);
  } else if (tab === 'trending') {
    posts = [...posts].sort((a,b) => {
      const calcScore = (p) => {
        const reactions = p.reactions || {};
        const capCount = reactions.cap?.length || 0;
        const relateCount = reactions.relate?.length || 0;
        const wildCount = reactions.wild?.length || 0;
        const factsCount = reactions.facts?.length || 0;
        const commentReactions = p.comments?.reduce((sum, c) => {
          return sum + (c.reactions?.like?.length || 0) + (c.reactions?.relate?.length || 0);
        }, 0) || 0;
        
        return (p.likes.length * 2) + (p.dislikes.length * 1) + 
               (p.comments.length * 5) + (capCount * 3) + 
               (relateCount * 4) + (wildCount * 3) + 
               (factsCount * 3) + commentReactions +
               (getVibeLikeCount(p.userId) * 2) + 
               (getTop8VibesCount(p.userId) * 3);
      };
      return calcScore(b) - calcScore(a);
    });
  } else if (tab === 'wevibin') {
    loadWeVibinFeed().then(wevibinPosts => {
      if (wevibinPosts.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">✨</div><div class="empty-title">No similar vibes yet</div><div class="empty-desc">Post with tags to find your vibe match!</div></div>`;
      } else {
        container.innerHTML = wevibinPosts.map(p => renderPostCard(p)).join('');
      }
    });
    return;
  }

  if (posts.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">✨</div><div class="empty-title">No vibes yet</div><div class="empty-desc">Be the first to post!</div></div>`;
    return;
  }

  console.log('Rendering', posts.length, 'posts');
  container.innerHTML = posts.map(p => renderPostCard(p)).join('');
}

function renderPostCard(post, isFeatured = false) {
  // Subscribe to live reactions for this post (so we see others' reactions)
  subscribeToReactions(post.id);
  
  const users = getUsers();
  let user = users.find(u => u.username === post.userId);
  // Use fallback user data if user not found - don't hide the post!
  if (!user) {
    user = { 
      username: post.userId, 
      name: post.userId, 
      avatar: post.userId?.[0]?.toUpperCase() || '?',
      avatar_url: '',
      bio: '',
      role: ''
    };
  }
  const me = getCurrentUser();

  const liked = post.likes.includes(me?.username);
  const disliked = post.dislikes.includes(me?.username);
  const capped = post.reactions?.cap?.includes(me?.username);
  const related = post.reactions?.relate?.includes(me?.username);
  const wilded = post.reactions?.wild?.includes(me?.username);
  const factsed = post.reactions?.facts?.includes(me?.username);
  const timeAgo = getTimeAgo(post.time);

  const isMyPost = me?.username === post.userId;
  const isPinned = isMyPost && (me.featuredPosts || []).includes(post.id);
  const canPin = isMyPost && (!me.featuredPosts || me.featuredPosts.length < 3);

  // Handle media from both local (imageData/videoData) and Supabase (media_url)
  const mediaUrl = post.imageData || post.videoData || post.media_url || '';
  const mediaHtml = post.type === 'image' && mediaUrl
    ? `<div class="post-media"><img src="${mediaUrl}" alt="post image" loading="lazy"></div>`
    : post.type === 'video' && mediaUrl
    ? `<div class="post-media"><video src="${mediaUrl}" controls></video></div>`
    : '';

  const tagsHtml = post.tags?.length
    ? `<div class="post-tags">${post.tags.map(t => `<span class="post-tag" onclick="handleSearch('${t}')">#${t}</span>`).join('')}</div>`
    : '';

  const topComment = post.comments[post.comments.length - 1];
  const topCommentUser = topComment ? users.find(u => u.username === topComment.userId) : null;

  const commentPreview = topComment && topCommentUser ? `
    <div class="post-comments" style="padding-top:8px;">
      <div class="comment">
        <div class="avatar avatar-sm" style="font-size:12px;">${topCommentUser.avatar || topCommentUser.name[0]}</div>
        <div class="comment-body">
          <span class="comment-author" onclick="navigate('profile','${topCommentUser.username}')" style="cursor:pointer;">${topCommentUser.name}</span>
          <span class="comment-text">${escHtml(topComment.text)}</span>
        </div>
      </div>
      ${post.comments.length > 1 ? `<div style="font-size:12px;color:var(--text3);padding-left:46px;cursor:pointer;" onclick="openComments('${post.id}')">View all ${post.comments.length} comments</div>` : ''}
    </div>
  ` : '';

  return `
    <div class="post-card" id="post-${post.id}">
      <div class="post-header">
        <div class="avatar avatar-sm" onclick="navigate('profile','${user.username}')" style="cursor:pointer;${user.avatar_url ? 'background:url(' + user.avatar_url + ') center/cover;' : ''}">${user.avatar_url ? '' : (user.avatar || user.name?.[0] || '?')}</div>
        <div class="post-user-info">
          <div class="post-user-name" onclick="navigate('profile','${user.username}')">${user.name} ${user.role === 'owner' ? '<span class="verified" title="Platform Owner">👑</span>' : ''}${isPinned ? ' <span style="color:var(--gold);" title="Featured">⭐</span>' : ''}</div>
          <div class="post-meta">@${user.username} · ${timeAgo}</div>
        </div>
        <div style="display:flex;gap:4px;">
          ${canPin ? `<button class="btn btn-ghost btn-sm" onclick="togglePinPost('${post.id}')" style="color:var(--text3);" title="Pin to profile">📌</button>` : ''}
          ${isPinned ? `<button class="btn btn-ghost btn-sm" onclick="togglePinPost('${post.id}')" style="color:var(--gold);" title="Unpin">⭐</button>` : ''}
          ${me?.username === post.userId || me?.role === 'owner'
            ? `<button class="btn btn-ghost btn-sm" onclick="deletePost('${post.id}')" style="color:var(--text3);">✕</button>` : ''}
        </div>
      </div>
      ${post.text ? `<div class="post-body">${escHtml(post.text).replace(/#(\w+)/g, '<span class="post-tag" onclick="handleSearch(\'$1\')">#$1</span>')}</div>` : ''}
      ${mediaHtml}
      ${tagsHtml}
      <div class="post-actions">
        <button class="post-action ${liked ? 'liked' : ''}" onclick="toggleReaction('${post.id}','like')">
          👍 <span>${post.likes.length}</span>
        </button>
        <button class="post-action ${disliked ? 'disliked' : ''}" onclick="toggleReaction('${post.id}','dislike')">
          👎 <span>${post.dislikes.length}</span>
        </button>
        <button class="post-action ${capped ? 'cap-react' : ''}" onclick="toggleReaction('${post.id}','cap')">
          🤥 <span>${post.reactions?.cap?.length || 0}</span>
        </button>
        <button class="post-action ${related ? 'relate-react' : ''}" onclick="toggleReaction('${post.id}','relate')">
          🙌 <span>${post.reactions?.relate?.length || 0}</span>
        </button>
        <button class="post-action ${wilded ? 'wild-react' : ''}" onclick="toggleReaction('${post.id}','wild')">
          🦄 <span>${post.reactions?.wild?.length || 0}</span>
        </button>
        <button class="post-action ${factsed ? 'facts-react' : ''}" onclick="toggleReaction('${post.id}','facts')">
          📢 <span>${post.reactions?.facts?.length || 0}</span>
        </button>
        <button class="post-action commented" onclick="openComments('${post.id}')">
          💬 <span>${post.comments.length}</span>
        </button>
        <button class="post-action" style="color:var(--red);" onclick="toggleReaction('${post.id}','heart')" title="Heart">❤️</button>
        <button class="post-action" style="color:var(--orange);" onclick="toggleReaction('${post.id}','fire')" title="Fire">🔥</button>
        <button class="post-action" onclick="sharePost('${post.id}')">🔗 Share</button>
      </div>
      ${commentPreview}
    </div>
  `;
}

// Show reaction feedback overlay with emoji and name
function showReactionFeedback(emoji, reactionName) {
  const overlay = document.createElement('div');
  overlay.className = 'reaction-feedback-overlay';
  overlay.innerHTML = `
    <div class="reaction-feedback-emoji">${emoji}</div>
    <div class="reaction-feedback-text">${reactionName}</div>
  `;
  document.body.appendChild(overlay);
  setTimeout(() => overlay.remove(), 900);
}

function toggleReaction(postId, type) {
  const me = getCurrentUser();
  if (!me) return;
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  const liked = post.likes.includes(me.username);
  const disliked = post.dislikes.includes(me.username);

  // Map reaction types to emojis for flying animation and feedback
  const emojiMap = {
    'like': '👍',
    'dislike': '👎',
    'cap': '🤥',
    'relate': '🙌',
    'wild': '🦄',
    'facts': '📢',
    'heart': '❤️',
    'fire': '🔥'
  };
  
  // Reaction names for feedback overlay
  const reactionNames = {
    'like': 'Like',
    'dislike': 'Dislike',
    'cap': 'Cap',
    'relate': 'Relate',
    'wild': 'Wild',
    'facts': 'Facts',
    'heart': 'Heart',
    'fire': 'Fire'
  };

  if (type === 'like') {
    if (liked) { post.likes = post.likes.filter(u => u !== me.username); }
    else {
      post.likes.push(me.username);
      post.dislikes = post.dislikes.filter(u => u !== me.username);
      // Send live reaction animation
      sendLiveReaction(postId, '👍');
      // Show feedback overlay
      showReactionFeedback('👍', 'Like');
      if (post.userId !== me.username) addNotif(post.userId, 'like', me.username, 'liked your post', postId);
    }
  } else if (type === 'dislike') {
    if (disliked) { post.dislikes = post.dislikes.filter(u => u !== me.username); }
    else {
      post.dislikes.push(me.username);
      post.likes = post.likes.filter(u => u !== me.username);
      // Send live reaction animation
      sendLiveReaction(postId, '👎');
      // Show feedback overlay
      showReactionFeedback('👎', 'Dislike');
    }
  } else {
    // New reactions: cap, relate, wild, facts, heart, fire
    if (!post.reactions) post.reactions = {};
    if (!post.reactions[type]) post.reactions[type] = [];
    
    const arr = post.reactions[type];
    const idx = arr.indexOf(me.username);
    
    if (idx > -1) {
      arr.splice(idx, 1);
    } else {
      arr.push(me.username);
      // Send live reaction animation
      if (emojiMap[type]) {
        sendLiveReaction(postId, emojiMap[type]);
        // Show feedback overlay
        const reactionNamesLocal = { cap: 'Cap', relate: 'Relate', wild: 'Wild', facts: 'Facts', heart: 'Heart', fire: 'Fire' };
        showReactionFeedback(emojiMap[type], reactionNamesLocal[type] || type);
      }
      if (post.userId !== me.username) {
        const notifText = { cap: 'called cap on', relate: 'related to', wild: 'said was wild about', facts: 'dropped facts on', heart: 'admired', fire: 'doped' };
        addNotif(post.userId, type, me.username, notifText[type] + ' your post', postId);
      }
    }
  }

  setPosts(posts);
  const el = document.getElementById('post-' + postId);
  if (el) el.outerHTML = renderPostCard(post);
}

function deletePost(postId) {
  if (!confirm('Delete this post?')) return;
  const posts = getPosts().filter(p => p.id !== postId);
  setPosts(posts);
  const el = document.getElementById('post-' + postId);
  if (el) el.remove();
  toast('Post deleted', 'success');
}

// ============================================
// FOLLOW SYSTEM
// ============================================

async function followUser(username) {
  const user = getCurrentUser();
  if (!user || user.username === username) return;
  
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('follows').insert({
        follower_id: user.username,
        following_id: username
      });
      addNotif(username, 'follow', user.username, 'started following you', null);
      toast('Following ' + username, 'success');
      
      // Update local cache if exists
      const users = getUsers();
      const idx = users.findIndex(u => u.username === username);
      if (idx !== -1) {
        if (!users[idx].followers) users[idx].followers = [];
        if (!users[idx].followers.includes(user.username)) {
          users[idx].followers.push(user.username);
          setUsers(users);
        }
      }
    } catch (err) {
      console.error('Follow error:', err);
    }
  }
}

async function unfollowUser(username) {
  const user = getCurrentUser();
  if (!user) return;
  
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('follows').delete()
        .eq('follower_id', user.username)
        .eq('following_id', username);
      toast('Unfollowed ' + username, 'success');
      
      // Update local cache
      const users = getUsers();
      const idx = users.findIndex(u => u.username === username);
      if (idx !== -1 && users[idx].followers) {
        users[idx].followers = users[idx].followers.filter(f => f !== user.username);
        setUsers(users);
      }
    } catch (err) {
      console.error('Unfollow error:', err);
    }
  }
}

function toggleFollow(username) {
  const user = getCurrentUser();
  if (!user || user.username === username) return;
  
  const users = getUsers();
  const profileUser = users.find(u => u.username === username);
  if (!profileUser) return;
  
  const isFollowing = profileUser.followers && profileUser.followers.includes(user.username);
  if (isFollowing) {
    unfollowUser(username);
  } else {
    followUser(username);
  }
}

// ============================================
// FRIENDS SYSTEM
// ============================================

async function sendFriendRequest(username) {
  const user = getCurrentUser();
  if (!user || user.username === username) return;
  
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('friend_requests').insert({
        requester_id: user.username,
        receiver_id: username,
        status: 'pending'
      });
      addNotif(username, 'friend_request', user.username, 'sent you a friend request', null);
      toast('Friend request sent to ' + username, 'success');
    } catch (err) {
      console.error('Friend request error:', err);
      toast('Failed to send friend request', 'error');
    }
  }
}

async function acceptFriendRequest(requestId, requesterUsername) {
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('friend_requests').update({ status: 'accepted' }).eq('id', requestId);
      addNotif(requesterUsername, 'friend_accept', getCurrentUser().username, 'accepted your friend request', null);
      toast('Friend request accepted!', 'success');
      
      // Refresh friends list
      if (typeof renderMessages === 'function') renderMessages();
    } catch (err) {
      console.error('Accept error:', err);
    }
  }
}

async function rejectFriendRequest(requestId) {
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('friend_requests').update({ status: 'rejected' }).eq('id', requestId);
      toast('Friend request rejected', 'success');
    } catch (err) {
      console.error('Reject error:', err);
    }
  }
}

// ============================================
// WAVES SYSTEM
// ============================================

let lastWaveTime = 0;
const WAVE_COOLDOWN = 60000; // 1 minute

async function sendWave(username) {
  const user = getCurrentUser();
  if (!user || user.username === username) return;
  
  const now = Date.now();
  if (now - lastWaveTime < WAVE_COOLDOWN) {
    toast('Wait before sending another wave! 👋', 'error');
    return;
  }
  
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('waves').upsert({
        sender_id: user.username,
        receiver_id: username
      }, { onConflict: 'sender_id,receiver_id' });
      
      addNotif(username, 'wave', user.username, 'waved at you 👋', null);
      lastWaveTime = now;
      toast('Wave sent! 👋', 'success');
    } catch (err) {
      console.error('Wave error:', err);
    }
  }
}

function togglePinPost(postId) {
  const me = getCurrentUser();
  if (!me) return;
  
  const users = getUsers();
  const idx = users.findIndex(u => u.username === me.username);
  if (idx === -1) return;
  
  let featured = users[idx].featuredPosts || [];
  const isPinned = featured.includes(postId);
  
  if (isPinned) {
    featured = featured.filter(id => id !== postId);
    users[idx].featuredPosts = featured;
    setUsers(users);
    setSession(me.username);
    toast('Post unpinned', 'success');
  } else {
    if (featured.length >= 3) {
      toast('Maximum 3 featured posts. Unpin one first.', 'error');
      return;
    }
    featured.push(postId);
    users[idx].featuredPosts = featured;
    setUsers(users);
    setSession(me.username);
    toast('Post pinned to profile! ⭐', 'success');
  }
  
  renderProfile(me.username);
}

function sharePost(postId) {
  navigator.clipboard?.writeText(window.location.href + '?post=' + postId)
    .then(() => toast('Link copied!', 'success'))
    .catch(() => toast('Post #' + postId + ' — share link ready!', 'success'));
  toast('Share link copied to clipboard!', 'success');
}

// ============================================
// TOP 8 VIBES - SUPABASE BACKED
// ============================================

async function fetchTopVibesFromSupabase(userId) {
  const sb = getSupabase();
  if (!sb || !userId) return [];
  
  try {
    const { data, error } = await sb
      .from('top_vibes')
      .select('friend_id, position, users(username, avatar_url)')
      .eq('user_id', userId)
      .order('position');
    
    if (error) { console.error('fetchTopVibes error:', error); return []; }
    return data || [];
  } catch (err) { console.error('fetchTopVibes exception:', err); return []; }
}

async function addToTopVibes(friendUsername) {
  const me = getCurrentUser();
  const sb = getSupabase();
  if (!me || !sb) { toast('Please log in', 'error'); return; }
  
  const friendUser = users.find(u => u.username === friendUsername);
  if (!friendUser?.id) { toast('User not found', 'error'); return; }
  
  try {
    const { count } = await sb
      .from('top_vibes')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', me.id);
    
    if (count >= 8) {
      toast('Top 8 is full! Remove someone first.', 'error');
      return;
    }
    
    const maxPos = await sb
      .from('top_vibes')
      .select('position')
      .eq('user_id', me.id)
      .order('position', { ascending: false })
      .limit(1)
      .single();
    
    const nextPos = (maxPos.data?.position || 0) + 1;
    
    const { error } = await sb
      .from('top_vibes')
      .insert({ user_id: me.id, friend_id: friendUser.id, position: nextPos });
    
    if (error) { toast(error.message, 'error'); return; }
    
    toast('Added to Top 8! ⭐', 'success');
    renderProfile(me.username);
  } catch (err) { console.error('addToTopVibes error:', err); toast('Failed to add', 'error'); }
}

async function removeFromTopVibes(friendUsername) {
  const me = getCurrentUser();
  const sb = getSupabase();
  if (!me || !sb) return;
  
  const friendUser = users.find(u => u.username === friendUsername);
  if (!friendUser?.id) return;
  
  try {
    await sb.from('top_vibes').delete()
      .eq('user_id', me.id)
      .eq('friend_id', friendUser.id);
    
    await reorderTopVibesPositions();
    toast('Removed from Top 8', 'success');
    renderProfile(me.username);
  } catch (err) { console.error('removeFromTopVibes error:', err); }
}

async function reorderTopVibesPositions() {
  const me = getCurrentUser();
  const sb = getSupabase();
  if (!me || !sb) return;
  
  try {
    const { data } = await sb
      .from('top_vibes')
      .select('id')
      .eq('user_id', me.id)
      .order('position');
    
    for (let i = 0; i < (data?.length || 0); i++) {
      await sb.from('top_vibes').update({ position: i + 1 }).eq('id', data[i].id);
    }
  } catch (err) { console.error('reorderTopVibesPositions error:', err); }
}

async function loadTopVibesToUser() {
  const me = getCurrentUser();
  if (!me?.id) return;
  
  const sb = getSupabase();
  if (!sb) return;
  
  try {
    const { data } = await sb
      .from('top_vibes')
      .select('friend_id, position')
      .eq('user_id', me.id)
      .order('position');
    
    if (data?.length) {
      const friendIds = data.map(d => d.friend_id);
      const { data: friends } = await sb
        .from('users')
        .select('id, username, avatar_url')
        .in('id', friendIds);
      
      if (friends?.length) {
        const top8Array = data.map(d => {
          const f = friends.find(friend => friend.id === d.friend_id);
          return f?.username || '';
        }).filter(Boolean);
        
        const usersList = getUsers();
        const idx = usersList.findIndex(u => u.id === me.id);
        if (idx !== -1) {
          usersList[idx].top8 = top8Array;
          setUsers(usersList);
        }
      }
    }
  } catch (err) { console.error('loadTopVibesToUser error:', err); }
}

// ============================================
// WE VIBIN TIMELINE
// ============================================

async function loadWeVibinFeed() {
  const me = getCurrentUser();
  const sb = getSupabase();
  if (!me?.id || !sb) {
    return getPosts().filter(p => p.userId !== me?.username).slice(0, 20);
  }
  
  try {
    const { data, error } = await sb.rpc('get_we_vibin_timeline', {
      current_user_id: me.id,
      limit_count: 20
    });
    
    if (error) { console.error('We Vibin error:', error); }
    
    if (data?.length) {
      return data.map(p => ({
        id: p.id,
        userId: p.username,
        text: p.text,
        tags: p.tags,
        created_at: p.created_at,
        _wevibinScore: p.overlap_score
      }));
    }
    
    return getPosts().filter(p => p.userId !== me.username).slice(0, 20);
  } catch (err) { console.error('loadWeVibinFeed error:', err); }
  return [];
}

async function updateInterestsOnPost(tags) {
  const me = getCurrentUser();
  const sb = getSupabase();
  if (!me?.id || !sb || !tags?.length) return;
  
  for (const tag of tags) {
    try {
      const interest = tag.toLowerCase().trim();
      if (!interest) continue;
      
      const { data: existing } = await sb
        .from('user_interests')
        .select('id, weight')
        .eq('user_id', me.id)
        .eq('interest', interest)
        .single();
      
      if (existing) {
        await sb.from('user_interests')
          .update({ weight: (existing.weight || 0) + 1 })
          .eq('id', existing.id);
      } else {
        await sb.from('user_interests')
          .insert({ user_id: me.id, interest: interest, weight: 1 });
      }
    } catch (err) { console.error('updateInterestsOnPost error:', err); }
  }
}

// ============================================
// I LIKE YOUR VIBE - SUPABASE BACKED
// ============================================

async function likeUserVibeSupabase(username) {
  const me = getCurrentUser();
  const sb = getSupabase();
  if (!me || !sb) { toast('Please log in', 'error'); return; }
  if (me.username === username) { toast("Can't vibe yourself 😅", 'error'); return; }
  
  const profileUser = users.find(u => u.username === username);
  if (!profileUser?.id) { toast('User not found', 'error'); return; }
  
  try {
    const { data: existing } = await sb
      .from('vibe_likes')
      .select('id')
      .eq('sender_id', me.id)
      .eq('receiver_id', profileUser.id)
      .single();
    
    if (existing) {
      await sb.from('vibe_likes').delete().eq('id', existing.id);
      toast('Removed vibe like', 'info');
    } else {
      await sb.from('vibe_likes').insert({
        sender_id: me.id,
        receiver_id: profileUser.id
      });
      
      await sb.from('notifications').insert({
        user_id: profileUser.id,
        clerk_id: me.username,
        type: 'vibe_like',
        from_user_id: me.id,
        from_username: me.username,
        message: 'liked your vibe!'
      });
      
      toast('You like their vibe! 💜', 'success');
    }
    
    renderProfile(username);
  } catch (err) { console.error('likeUserVibeSupabase error:', err); toast('Failed', 'error'); }
}

async function getVibeLikeCountSupabase(username) {
  const sb = getSupabase();
  const profileUser = users.find(u => u.username === username);
  if (!sb || !profileUser?.id) return 0;
  
  try {
    const { count, error } = await sb
      .from('vibe_likes')
      .select('*', { count: 'exact', head: true })
      .eq('receiver_id', profileUser.id);
    
    return count || 0;
  } catch (err) { return 0; }
}

async function checkUserVibed(username) {
  const me = getCurrentUser();
  const sb = getSupabase();
  if (!me?.id || !sb) return false;
  
  const profileUser = users.find(u => u.username === username);
  if (!profileUser?.id) return false;
  
  try {
    const { data } = await sb
      .from('vibe_likes')
      .select('id')
      .eq('sender_id', me.id)
      .eq('receiver_id', profileUser.id)
      .single();
    
    return !!data;
  } catch (err) { return false; }
}

function openComments(postId) {
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  const users = getUsers();
  const me = getCurrentUser();
  if (!post) return;

  function renderComment(c, depth = 0, parentIndex = null) {
    const cu = users.find(u => u.username === c.userId);
    const cLiked = c.reactions?.like?.includes(me?.username);
    const cRelated = c.reactions?.relate?.includes(me?.username);
    const cLikeCount = c.reactions?.like?.length || 0;
    const cRelateCount = c.reactions?.relate?.length || 0;
    const maxDepth = 2;
    
    let repliesHtml = '';
    if (c.replies && c.replies.length > 0 && depth < maxDepth) {
      repliesHtml = c.replies.map(r => renderComment(r, depth + 1)).join('');
    }
    
    return `
      <div class="comment" style="padding:8px 0;border-bottom:1px solid var(--border);${depth > 0 ? 'margin-left:24px;border-left:2px solid var(--purple);padding-left:12px;' : ''}">
        <div class="avatar avatar-sm" style="font-size:12px;cursor:pointer;" onclick="navigate('profile','${c.userId}')">${cu?.avatar || cu?.name[0] || '?'}</div>
        <div class="comment-body">
          <span class="comment-author" style="cursor:pointer;" onclick="navigate('profile','${c.userId}')">${cu?.name || c.userId}</span>
          ${c.audio ? `<audio controls src="${c.audio}" style="width:100%;height:32px;margin:4px 0;"></audio>` : ''}
          <span class="comment-text">${escHtml(c.text)}</span>
          <div class="comment-reactions" style="margin-top:4px;display:flex;gap:8px;align-items:center;">
            <button class="comment-reaction-btn ${cLiked ? 'active' : ''}" onclick="toggleCommentReaction('${postId}','${c.userId}',${c.time},'like')">
              ❤️ ${cLikeCount}
            </button>
            <button class="comment-reaction-btn ${cRelated ? 'active' : ''}" onclick="toggleCommentReaction('${postId}','${c.userId}',${c.time},'relate')">
              🙌 ${cRelateCount}
            </button>
            ${depth < maxDepth ? `<button class="comment-reply-btn" onclick="showReplyInput('${postId}','${c.userId}',${c.time})">💬 Reply</button>` : ''}
            ${c.audio ? '<span style="font-size:10px;background:var(--purple2);color:#fff;padding:2px 6px;border-radius:4px;">🎤</span>' : ''}
            <span class="comment-time">${getTimeAgo(c.time)}</span>
          </div>
          <div class="reply-input-area" id="reply-input-${postId}-${c.userId}-${c.time}" style="display:none;margin-top:8px;">
            <input type="text" id="reply-text-${postId}-${c.userId}-${c.time}" placeholder="Write a reply..." style="border-radius:20px;padding:8px 12px;font-size:13px;">
            <button class="btn btn-primary btn-sm" onclick="submitReply('${postId}','${c.userId}',${c.time})">Reply</button>
            <button class="btn btn-ghost btn-sm" onclick="showReplyInput('${postId}','${c.userId}',${c.time})">Cancel</button>
          </div>
        </div>
      </div>
      ${repliesHtml}
    `;
  }

  const commentsHtml = post.comments.length
    ? post.comments.map((c, idx) => renderComment(c, 0)).join('')
    : '<div class="empty-state" style="padding:24px;"><div class="empty-icon">💬</div><div class="empty-desc">No comments yet. Be first!</div></div>';

  document.getElementById('modal-comments-body').innerHTML = `
    <div style="max-height:300px;overflow-y:auto;margin-bottom:16px;">${commentsHtml}</div>
    <div class="comment-input-row">
      <div class="avatar avatar-sm" style="font-size:12px;">${me?.avatar || me?.name[0]}</div>
      <input type="text" id="comment-input-${postId}" placeholder="Add a comment..." style="border-radius:50px;">
      <button class="btn btn-primary btn-sm" onclick="submitComment('${postId}')">Post</button>
      <button class="btn btn-outline btn-sm" onclick="showAudioCommentModal('${postId}')" title="Voice comment">🎤</button>
    </div>
  `;
  document.getElementById('modal-comments').classList.remove('hidden');
}

function showReplyInput(postId, userId, timestamp) {
  const el = document.getElementById(`reply-input-${postId}-${userId}-${timestamp}`);
  if (el) {
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
    if (el.style.display === 'block') {
      const input = document.getElementById(`reply-text-${postId}-${userId}-${timestamp}`);
      if (input) input.focus();
    }
  }
}

function submitReply(postId, userId, timestamp) {
  const text = document.getElementById(`reply-text-${postId}-${userId}-${timestamp}`)?.value.trim();
  if (!text) return;
  
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;
  
  const parentComment = post.comments.find(c => c.userId === userId && c.time === timestamp);
  if (!parentComment) return;
  
  if (!parentComment.replies) parentComment.replies = [];
  parentComment.replies.push({ userId: me.username, text, time: Date.now() });
  
  setPosts(posts);
  openComments(postId);
  toast('Reply posted!', 'success');
}

function submitComment(postId) {
  const text = document.getElementById('comment-input-' + postId)?.value.trim();
  if (!text) return;
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;

  post.comments.unshift({ userId: me.username, text, time: Date.now(), replies: [] });
  setPosts(posts);
  if (post.userId !== me.username) addNotif(post.userId, 'comment', me.username, 'commented on your post', postId);

  openComments(postId);
  toast('Comment posted!', 'success');
}

function toggleCommentReaction(postId, userId, timestamp, type) {
  if (!currentSession) { toast('Log in to react', 'error'); return; }
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;
  
  const comment = post.comments.find(c => c.userId === userId && c.time === timestamp);
  if (!comment) {
    // Check replies
    for (const c of post.comments) {
      if (c.replies) {
        const reply = c.replies.find(r => r.userId === userId && r.time === timestamp);
        if (reply) {
          if (!reply.reactions) reply.reactions = {};
          if (!reply.reactions[type]) reply.reactions[type] = [];
const arr = reply.reactions[type];
          const idx = arr.indexOf(me.username);
          if (idx > -1) arr.splice(idx, 1);
          else {
            arr.push(me.username);
            // Notify comment author they got a reaction
            if (userId !== me.username) {
              addNotif(userId, 'comment_reaction', me.username, 'reacted to your comment', postId);
            }
          }
          setPosts(posts);
          openComments(postId);
          return;
        }
      }
    }
    return;
  }
  
  if (!comment.reactions) comment.reactions = {};
  if (!comment.reactions[type]) comment.reactions[type] = [];
  
const arr = comment.reactions[type];
  const idx = arr.indexOf(me.username);
  if (idx > -1) arr.splice(idx, 1);
  else {
    arr.push(me.username);
    // Notify comment author they got a reaction
    if (userId !== me.username) {
      addNotif(userId, 'comment_reaction', me.username, 'reacted to your comment', postId);
    }
  }
  
  setPosts(posts);
  openComments(postId);
}

// ══════════════════════════════════════
// EXPLORE
// ══════════════════════════════════════
function renderExplore() {
  const posts = getPosts();
  const users = getUsers();

  // Trending tags
  const tagCounts = {};
  posts.forEach(p => p.tags?.forEach(t => { tagCounts[t] = (tagCounts[t] || 0) + 1; }));
  const sorted = Object.entries(tagCounts).sort((a,b) => b[1]-a[1]).slice(0,16);
  document.getElementById('trending-tags').innerHTML = sorted.map(([tag, count]) =>
    `<div class="trend-tag" onclick="handleSearch('${tag}')">#${tag} <span class="tag-count">${count} posts</span></div>`
  ).join('');

  // Creators
  const creators = [...users].sort((a,b) => {
    const aP = posts.filter(p => p.userId === a.username).length;
    const bP = posts.filter(p => p.userId === b.username).length;
    return bP - aP;
  }).slice(0, 8);

  document.getElementById('creator-grid').innerHTML = creators.map(u => `
    <div class="creator-card" onclick="navigate('profile','${u.username}')">
      <div class="avatar avatar-md" style="margin:0 auto;">${u.avatar || u.name[0]}</div>
      <div class="creator-name">${u.name}</div>
      <div class="creator-handle">@${u.username}</div>
      <div class="creator-subs">${posts.filter(p => p.userId === u.username).length} posts</div>
    </div>
  `).join('');

  // Explore posts
  const explorePosts = [...posts].sort((a,b) => (b.likes.length + b.comments.length) - (a.likes.length + a.comments.length)).slice(0, 10);
  document.getElementById('explore-posts').innerHTML = explorePosts.map(p => renderPostCard(p)).join('');
}

// ══════════════════════════════════════
// CHANNELS
// ══════════════════════════════════════
function renderChannels() {
  const channels = getChannels();
  const users = getUsers();
  const me = getCurrentUser();

  document.getElementById('channels-grid').innerHTML = channels.map(ch => {
    const owner = users.find(u => u.username === ch.ownerId);
    const subbed = ch.subs.includes(me?.username);
    return `
      <div class="channel-card" onclick="navigate('channel-detail','${ch.id}')">
        <div class="channel-banner theme-${owner?.banner || 'purple'}" style="display:flex;align-items:center;justify-content:center;font-size:48px;height:120px;">
          ${ch.emoji}
        </div>
        <div class="channel-info">
          <div class="channel-name">${ch.name}</div>
          <div class="channel-desc">${ch.desc}</div>
          <div class="channel-meta">
            <div class="channel-subs">👥 ${ch.subs.length} subscribers · ${ch.videos?.length || 0} videos</div>
            <button class="btn btn-sm ${subbed ? 'btn-outline' : 'btn-primary'}" onclick="event.stopPropagation();toggleSubscribe('${ch.id}')">
              ${subbed ? 'Subscribed ✓' : 'Subscribe'}
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('') + (channels.length === 0 ? '<div class="empty-state"><div class="empty-icon">📺</div><div class="empty-title">No channels yet</div><div class="empty-desc">Be the first to create one!</div></div>' : '');
}

function renderChannelDetail(channelId) {
  const channels = getChannels();
  const ch = channels.find(c => c.id === channelId);
  if (!ch) { navigate('channels'); return; }

  const users = getUsers();
  const owner = users.find(u => u.username === ch.ownerId);
  const me = getCurrentUser();
  const subbed = ch.subs.includes(me?.username);

  document.getElementById('topbar-title').textContent = ch.name;

  document.getElementById('channel-detail-content').innerHTML = `
    <div class="profile-banner theme-${owner?.banner || 'purple'}" style="display:flex;align-items:flex-end;padding:24px;gap:16px;">
      <div style="font-size:64px;">${ch.emoji}</div>
      <div>
        <h1 style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;">${ch.name}</h1>
        <div style="color:var(--text2);font-size:14px;">${ch.category} · ${ch.subs.length} subscribers · ${ch.videos?.length || 0} videos</div>
      </div>
    </div>
    <div style="padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="avatar avatar-sm">${owner?.avatar || owner?.name[0]}</div>
        <div>
          <div style="font-weight:600;">${owner?.name}</div>
          <div style="font-size:12px;color:var(--text3);">@${owner?.username}</div>
        </div>
      </div>
      <button class="btn ${subbed ? 'btn-outline' : 'btn-primary'}" onclick="toggleSubscribe('${ch.id}');renderChannelDetail('${ch.id}')">
        ${subbed ? '✓ Subscribed' : 'Subscribe'}
      </button>
    </div>
    <div style="font-size:14px;color:var(--text2);margin-bottom:20px;">${ch.desc}</div>
    <div class="section-title">Videos</div>
    <div class="video-grid">
      ${(ch.videos || []).map(v => `
        <div class="video-thumb" onclick="toast('Video player coming soon! 🎬','success')">
          <div class="video-preview">
            <span style="font-size:40px;">${v.emoji}</span>
            <div class="video-play-overlay">▶</div>
          </div>
          <div class="video-info">
            <div class="video-title">${v.title}</div>
            <div class="video-meta">${v.views.toLocaleString()} views · ${getTimeAgo(v.time)}</div>
          </div>
        </div>
      `).join('')}
    </div>
    ${!ch.videos?.length ? '<div class="empty-state"><div class="empty-icon">🎬</div><div class="empty-title">No videos yet</div></div>' : ''}
  `;
}

function toggleSubscribe(channelId) {
  const channels = getChannels();
  const ch = channels.find(c => c.id === channelId);
  const me = getCurrentUser();
  if (!ch || !me) return;

  const idx = ch.subs.indexOf(me.username);
  if (idx === -1) {
    ch.subs.push(me.username);
    toast('Subscribed to ' + ch.name + '!', 'success');
  } else {
    ch.subs.splice(idx, 1);
    toast('Unsubscribed from ' + ch.name, 'success');
  }
  setChannels(channels);
  renderChannels();
}

function openCreateChannelModal() {
  document.getElementById('modal-create-channel').classList.remove('hidden');
}

function createChannel() {
  const name = document.getElementById('channel-name-input').value.trim();
  const desc = document.getElementById('channel-desc-input').value.trim();
  const category = document.getElementById('channel-category-input').value;
  const emoji = document.getElementById('channel-emoji-input').value.trim() || '🎬';

  if (!name) { toast('Give your channel a name!', 'error'); return; }

  const me = getCurrentUser();
  const ch = {
    id: 'ch_' + Date.now(),
    ownerId: me.username,
    name, desc, category, emoji,
    subs: [me.username],
    videos: [],
    created: Date.now()
  };

  const channels = getChannels();
  channels.unshift(ch);
  setChannels(channels);
  closeModal('modal-create-channel');
  renderChannels();
  toast('Channel created! 📺', 'success');
}

// ══════════════════════════════════════
// SYNC SPACES
// ══════════════════════════════════════
let syncSpacesData = [
  { id: 's1', name: 'Late Night Vibes', creator: 'neoncat', users: ['neoncat', 'skyvibes'], messages: 45, expiresAt: Date.now() + 3600000 * 12 },
  { id: 's2', name: 'Music Talk', creator: 'djbeatrix', users: ['djbeatrix'], messages: 12, expiresAt: Date.now() + 3600000 * 18 },
  { id: 's3', name: 'Dev Chat', creator: 'neoncat', users: [], messages: 0, expiresAt: Date.now() + 3600000 * 6 },
];

// In-memory sync spaces
let _syncSpacesCache = [];
let _roomMessagesCache = {};
let _currentRoomId = null;
let _roomSubscription = null;

// Get messages for a specific room
function getRoomMessages(roomId) {
  return _roomMessagesCache[roomId] || [];
}

// Set messages for a room
function setRoomMessages(roomId, messages) {
  _roomMessagesCache[roomId] = messages;
}

// Subscribe to room messages for real-time updates
function subscribeToRoom(roomId) {
  const sb = getSupabase();
  if (!sb) return;
  
  // Unsubscribe from previous room if any
  if (_roomSubscription) {
    _roomSubscription.unsubscribe();
    _roomSubscription = null;
  }
  
  _currentRoomId = roomId;
  
  // Subscribe to new room
  _roomSubscription = sb
    .channel('room-' + roomId)
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'sync_space_messages',
      filter: 'room_id=eq.' + roomId
    }, (payload) => {
      const msg = payload.new;
      if (!_roomMessagesCache[roomId]) _roomMessagesCache[roomId] = [];
      
      // Check if message already exists (avoid duplicates)
      const exists = _roomMessagesCache[roomId].find(m => m.id === msg.id);
      if (!exists) {
        _roomMessagesCache[roomId].push({
          id: msg.id,
          roomId: msg.room_id,
          senderId: msg.sender_id,
          senderName: msg.sender_name,
          text: msg.message,
          reactions: msg.reactions || {},
          time: new Date(msg.created_at).getTime()
        });
        
        // Re-render if we're in this room
        if (_currentRoomId === roomId && document.getElementById('active-room-chat')) {
          renderActiveRoomChat();
        }
      }
    })
    .subscribe();
  
  console.log('Subscribed to room:', roomId);
}

// Unsubscribe from room
function unsubscribeFromRoom() {
  if (_roomSubscription) {
    _roomSubscription.unsubscribe();
    _roomSubscription = null;
  }
  _currentRoomId = null;
}

// Send message to room
async function sendRoomMessage(roomId, text) {
  const me = getCurrentUser();
  if (!me || !text.trim()) return;
  
  const sb = getSupabase();
  const msgId = 'rm_' + Date.now();
  
  const msgObj = {
    id: msgId,
    roomId: roomId,
    senderId: me.username,
    senderName: me.name || me.username,
    text: text.trim(),
    reactions: {},
    time: Date.now()
  };
  
  // Add to local cache immediately
  if (!_roomMessagesCache[roomId]) _roomMessagesCache[roomId] = [];
  _roomMessagesCache[roomId].push(msgObj);
  
  // Save to Supabase
  if (sb) {
    try {
      await sb.from('sync_space_messages').insert({
        id: msgId,
        room_id: roomId,
        sender_id: me.username,
        sender_name: me.name || me.username,
        message: text.trim(),
        reactions: {}
      });
    } catch (err) {
      console.error('Failed to send room message:', err);
    }
  }
  
  // Re-render
  if (_currentRoomId === roomId) {
    renderActiveRoomChat();
  }
}

// React to room message
async function reactToRoomMessage(messageId, emoji) {
  const me = getCurrentUser();
  if (!me || !_currentRoomId) return;
  
  const sb = getSupabase();
  const messages = _roomMessagesCache[_currentRoomId] || [];
  const msg = messages.find(m => m.id === messageId);
  if (!msg) return;
  
  if (!msg.reactions) msg.reactions = {};
  if (!msg.reactions[emoji]) msg.reactions[emoji] = [];
  
  const idx = msg.reactions[emoji].indexOf(me.username);
  if (idx > -1) {
    msg.reactions[emoji].splice(idx, 1);
  } else {
    msg.reactions[emoji].push(me.username);
  }
  
  // Update in Supabase
  if (sb) {
    try {
      await sb.from('sync_space_messages').update({ reactions: msg.reactions }).eq('id', messageId);
    } catch (err) {
      console.error('Failed to react:', err);
    }
  }
  
  renderActiveRoomChat();
}

function getSyncSpaces() {
  return _syncSpacesCache.length ? _syncSpacesCache : syncSpacesData;
}

async function setSyncSpaces(spaces) {
  _syncSpacesCache = spaces;
  const sb = getSupabase();
  if (sb) {
    try {
      await sb.from('sync_spaces').upsert(spaces.slice(0, 50).map(s => ({
        id: s.id,
        name: s.name,
        creator: s.creator,
        users: s.users || [],
        expires_at: new Date(s.expiresAt).toISOString()
      })), { onConflict: 'id' });
    } catch (err) {
      console.error('Failed to save sync spaces:', err);
    }
  }
}

function renderSyncSpaces() {
  // If we're in a room, show the chat instead of the list
  if (_currentRoomId) {
    renderActiveRoomChat();
    return;
  }
  
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  const me = getCurrentUser();
  
  // Filter out expired spaces
  spaces = spaces.filter(s => s.expiresAt > Date.now());
  
  document.getElementById('sync-spaces-grid').innerHTML = spaces.map(room => {
    const isInRoom = room.users.includes(me?.username);
    const hoursLeft = Math.floor((room.expiresAt - Date.now()) / 3600000);
    const isActive = room.users.length > 0;
    return `
      <div class="sync-space-card ${isActive ? 'sync-space-glow' : ''}">
        <div class="sync-space-name">${room.name}</div>
        <div class="sync-space-meta">by @${room.creator} · ${room.users.length}/125 users</div>
        <div class="sync-space-timer">${hoursLeft}h remaining</div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
          ${isInRoom 
            ? `<button class="btn btn-primary btn-sm" onclick="openRoomChat('${room.id}')">💬 Chat</button>
               <button class="btn btn-outline btn-sm" onclick="leaveSyncSpace('${room.id}')">Leave</button>`
            : room.users.length < 125 
              ? `<button class="btn btn-primary btn-sm" onclick="joinSyncSpace('${room.id}')">Join Room</button>`
              : `<button class="btn btn-outline btn-sm" disabled>Full</button>`
          }
          ${me?.username === room.creator ? `<button class="btn btn-danger btn-sm" onclick="deleteSyncSpace('${room.id}')">Delete</button>` : ''}
        </div>
      </div>
    `;
  }).join('') || '<div class="empty-state"><div class="empty-icon">💬</div><div class="empty-title">No active rooms</div><div class="empty-desc">Create a room to start chatting!</div></div>';
}

// Open room chat interface
function openRoomChat(roomId) {
  subscribeToRoom(roomId);
  renderActiveRoomChat();
}

// Go back to room list
function closeRoomChat() {
  unsubscribeFromRoom();
  renderSyncSpaces();
}

// Render the active room chat
function renderActiveRoomChat() {
  const roomId = _currentRoomId;
  if (!roomId) return;
  
  const spaces = getSyncSpaces();
  const room = spaces.find(s => s.id === roomId);
  if (!room) {
    closeRoomChat();
    return;
  }
  
  const messages = getRoomMessages(roomId);
  const me = getCurrentUser();
  
  const container = document.getElementById('sync-spaces-grid');
  if (!container) return;
  
  container.innerHTML = `
    <div style="display:flex;flex-direction:column;height:calc(100vh - 180px);max-width:800px;margin:0 auto;width:100%;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--card);border-radius:12px 12px 0 0;border:1px solid var(--border);border-bottom:none;">
        <div>
          <button class="btn btn-outline btn-sm" onclick="closeRoomChat()">← Back</button>
          <span style="margin-left:12px;font-weight:700;font-size:18px;">${room.name}</span>
        </div>
        <div style="color:var(--text3);font-size:13px;">👥 ${room.users.length}/125</div>
      </div>
      
      <div id="active-room-chat" style="flex:1;overflow-y:auto;padding:16px;background:var(--bg);border-left:1px solid var(--border);border-right:1px solid var(--border);display:flex;flex-direction:column;gap:8px;">
        ${messages.length === 0 
          ? '<div style="text-align:center;color:var(--text3);padding:40px;">No messages yet. Say hi! 👋</div>'
          : messages.map(m => renderRoomMessage(m, me?.username)).join('')
        }
      </div>
      
      <div style="padding:12px;background:var(--card);border-radius:0 0 12px 12px;border:1px solid var(--border);border-top:none;display:flex;gap:8px;">
        <input type="text" id="room-message-input" placeholder="Type a message..." 
          style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);"
          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendRoomMessageFromInput();}">
        <button class="btn btn-primary" onclick="sendRoomMessageFromInput()">Send</button>
      </div>
    </div>
  `;
  
  // Scroll to bottom
  const chatEl = document.getElementById('active-room-chat');
  if (chatEl) chatEl.scrollTop = chatEl.scrollHeight;
}

// Send message from input
function sendRoomMessageFromInput() {
  const input = document.getElementById('room-message-input');
  if (!input || !_currentRoomId) return;
  const text = input.value.trim();
  if (!text) return;
  
  sendRoomMessage(_currentRoomId, text);
  input.value = '';
}

// Render a single room message
function renderRoomMessage(msg, currentUser) {
  const isMe = msg.senderId === currentUser;
  const time = new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  let reactionsHtml = '';
  const reactions = msg.reactions || {};
  const reactionEmojis = ['👍', '❤️', '😂', '😮', '😢', '🔥'];
  
  reactionEmojis.forEach(emoji => {
    const users = reactions[emoji] || [];
    if (users.length > 0) {
      reactionsHtml += `<span style="background:var(--purple2);padding:2px 6px;border-radius:10px;font-size:11px;margin-right:4px;cursor:pointer;" onclick="reactToRoomMessage('${msg.id}', '${emoji}')">${emoji} ${users.length}</span>`;
    } else {
      reactionsHtml += `<span style="color:var(--text3);padding:2px 6px;border-radius:10px;font-size:11px;margin-right:4px;cursor:pointer;opacity:0.5;" onclick="reactToRoomMessage('${msg.id}', '${emoji}')">${emoji}</span>`;
    }
  });
  
  return `
    <div style="display:flex;flex-direction:column;align-items:${isMe ? 'flex-end' : 'flex-start'};">
      <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:2px;">
        <span style="font-weight:600;font-size:13px;color:var(--purple);">@${msg.senderId}</span>
        <span style="font-size:11px;color:var(--text3);">${time}</span>
      </div>
      <div style="max-width:70%;padding:10px 14px;border-radius:16px;background:${isMe ? 'var(--purple)' : 'var(--card)'};color:${isMe ? '#fff' : 'var(--text)'};word-wrap:break-word;">
        ${escapeHtml(msg.text)}
      </div>
      <div style="margin-top:4px;display:flex;gap:2px;flex-wrap:wrap;max-width:70%;">
        ${reactionsHtml}
      </div>
    </div>
  `;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function openCreateSyncSpaceModal() {
  const name = prompt('Room name:');
  if (!name) return;
  
  const me = getCurrentUser();
  const newRoom = {
    id: 's_' + Date.now(),
    name: name,
    creator: me.username,
    users: [me.username],
    messages: [],
    expiresAt: Date.now() + 3600000 * 24
  };
  
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  spaces.unshift(newRoom);
  setSyncSpaces(spaces);
  renderSyncSpaces();
  toast('Room created! 💬', 'success');
}

function joinSyncSpace(roomId) {
  const me = getCurrentUser();
  if (!me) { toast('Please log in first', 'error'); return; }
  
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  const room = spaces.find(s => s.id === roomId);
  if (!room) return;
  
  if (!room.users.includes(me.username)) {
    room.users.push(me.username);
    setSyncSpaces(spaces);
    toast('Joined the room! 💬', 'success');
  }
  
  // Automatically open the chat
  openRoomChat(roomId);
}

function leaveSyncSpace(roomId) {
  const me = getCurrentUser();
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  const room = spaces.find(s => s.id === roomId);
  if (!room) return;
  
  // Close chat if in this room
  if (_currentRoomId === roomId) {
    closeRoomChat();
  }
  
  room.users = room.users.filter(u => u !== me.username);
  setSyncSpaces(spaces);
  renderSyncSpaces();
  toast('Left the room', 'success');
}

function deleteSyncSpace(roomId) {
  if (!confirm('Delete this room?')) return;
  let spaces = getSyncSpaces().length ? getSyncSpaces() : syncSpacesData;
  spaces = spaces.filter(s => s.id !== roomId);
  setSyncSpaces(spaces);
  renderSyncSpaces();
  toast('Room deleted', 'success');
}

function renderMyChannel() {
  const me = getCurrentUser();
  const channels = getChannels();
  const myChannels = channels.filter(c => c.ownerId === me.username);
  const el = document.getElementById('my-channel-content');

  if (!myChannels.length) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📡</div>
        <div class="empty-title">You don't have a channel yet</div>
        <div class="empty-desc">Create your first channel and start sharing your content with the world.</div>
        <button class="btn btn-primary" style="margin-top:16px;" onclick="openCreateChannelModal()">Create Channel 📺</button>
      </div>
    `;
    return;
  }

  el.innerHTML = myChannels.map(ch => `
    <div class="card" style="margin-bottom:16px;">
      <div class="card-body">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">${ch.emoji} ${ch.name}</div>
            <div style="font-size:13px;color:var(--text2);">${ch.subs.length} subscribers · ${ch.videos?.length || 0} videos</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="openUploadVideoModal('${ch.id}')">+ Upload</button>
        </div>
        <div class="video-grid">
          ${(ch.videos || []).map(v => `
            <div class="video-thumb">
              <div class="video-preview"><span style="font-size:32px;">${v.emoji}</span><div class="video-play-overlay">▶</div></div>
              <div class="video-info">
                <div class="video-title">${v.title}</div>
                <div class="video-meta">${v.views.toLocaleString()} views · ${getTimeAgo(v.time)}</div>
              </div>
            </div>
          `).join('')}
        </div>
        ${!ch.videos?.length ? '<div style="text-align:center;padding:24px;color:var(--text3);font-size:14px;">Upload your first video 🎬</div>' : ''}
      </div>
    </div>
  `).join('');
}

let uploadTargetChannelId = null;

function openUploadVideoModal(channelId) {
  const me = getCurrentUser();
  const channels = getChannels();
  const myChannels = channels.filter(c => c.ownerId === me.username);

  if (!myChannels.length) { toast('Create a channel first!', 'error'); openCreateChannelModal(); return; }

  uploadTargetChannelId = channelId || myChannels[0].id;
  document.getElementById('modal-upload-video').classList.remove('hidden');
}

function uploadVideo() {
  const title = document.getElementById('video-title-input').value.trim();
  const desc = document.getElementById('video-desc-input').value.trim();
  const emoji = document.getElementById('video-emoji-input').value.trim() || '🎬';
  const tags = document.getElementById('video-tags-input').value.split(',').map(t => t.trim()).filter(Boolean);

  if (!title) { toast('Give your video a title!', 'error'); return; }

  const channels = getChannels();
  const ch = channels.find(c => c.id === uploadTargetChannelId);
  if (!ch) { toast('Channel not found', 'error'); return; }

  ch.videos = ch.videos || [];
  ch.videos.unshift({ id: 'v_' + Date.now(), title, desc, emoji, tags, views: 0, time: Date.now() });
  setChannels(channels);

  closeModal('modal-upload-video');
  renderMyChannel();
  toast('Video uploaded! 🎬', 'success');
}

// ══════════════════════════════════════
// MESSAGES
// ══════════════════════════════════════
function renderMessages() {
  const me = getCurrentUser();
  const allMessages = getMessages();
  const users = getUsers();
  const otherUsers = users.filter(u => u.username !== me?.username).slice(0, 8);

  document.getElementById('dm-list-items').innerHTML = otherUsers.map(u => {
    const key = [me.username, u.username].sort().join('-');
    const msgs = allMessages[key] || [];
    const lastMsg = msgs[msgs.length - 1];
    const hasUnread = msgs.some(m => m.from !== me.username && !m.read);
    return `
      <div class="dm-item" onclick="openDM('${u.username}')">
        <div style="position:relative;">
          <div class="avatar avatar-sm">${u.avatar || u.name[0]}</div>
          <div class="online-dot"></div>
        </div>
        <div class="dm-info">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="dm-name">${u.name}</div>
            ${hasUnread ? '<span class="dm-unread">New</span>' : ''}
          </div>
          <div class="dm-preview">${lastMsg ? escHtml(lastMsg.text).substring(0, 35) + '...' : 'Say hello!'}</div>
        </div>
      </div>
    `;
  }).join('');
}

function openDM(username) {
  const me = getCurrentUser();
  const users = getUsers();
  const other = users.find(u => u.username === username);
  const allMessages = getMessages();
  const key = [me.username, username].sort().join('-');
  const msgs = allMessages[key] || [];

  document.getElementById('chat-area').innerHTML = `
    <div class="chat-header">
      <div class="avatar avatar-sm">${other?.avatar || other?.name[0]}</div>
      <div>
        <div style="font-weight:600;">${other?.name}</div>
        <div style="font-size:12px;color:var(--green);">● Online</div>
      </div>
    </div>
    <div class="chat-messages" id="chat-msgs-${username}">
      ${msgs.length ? msgs.map(m => `
        <div class="message-bubble ${m.from === me.username ? 'sent' : 'recv'}">
          <div class="bubble">${escHtml(m.text)}</div>
          <div class="bubble-time">${getTimeAgo(m.time)}</div>
        </div>
      `).join('') : '<div class="empty-state" style="padding:24px;"><div class="empty-icon">👋</div><div class="empty-desc">Say hello to ' + other?.name + '!</div></div>'}
    </div>
    <div class="chat-input-bar">
      <textarea class="chat-input" id="chat-input-${username}" placeholder="Message ${other?.name}..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendDM('${username}')}"></textarea>
      <button class="btn btn-primary" onclick="sendDM('${username}')">Send</button>
    </div>
  `;

  // Scroll to bottom
  setTimeout(() => {
    const msgs = document.getElementById('chat-msgs-' + username);
    if (msgs) msgs.scrollTop = msgs.scrollHeight;
  }, 50);
}

function sendDM(username) {
  const me = getCurrentUser();
  const text = document.getElementById('chat-input-' + username)?.value.trim();
  if (!text) return;

  const allMessages = getMessages();
  const key = [me.username, username].sort().join('-');
  if (!allMessages[key]) allMessages[key] = [];
  allMessages[key].push({ id: 'm_' + Date.now(), from: me.username, to: username, text, time: Date.now(), read: false });
  setMessages(allMessages);

  document.getElementById('chat-input-' + username).value = '';
  openDM(username);
}

// ══════════════════════════════════════
// NOTIFICATIONS
// ══════════════════════════════════════
function renderNotifications() {
  const me = getCurrentUser();
  const allNotifs = getNotifs();
  const notifs = allNotifs.filter(n => n.toUser === me?.username);
  const users = getUsers();

  // Mark all read
  notifs.forEach(n => n.read = true);
  setNotifs(notifs);

  const el = document.getElementById('notifs-list');
  if (!notifs.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">🔔</div><div class="empty-title">No notifications</div></div>';
    return;
  }

  const icons = { 
    like:'👍', 
    comment:'💬', 
    follow:'👤', 
    friend_request:'🤝',
    friend_accept:'✅',
    wave:'👋',
    video:'🎬',
    cap:'🤥',
    relate:'🙌',
    wild:'🦄',
    facts:'📢',
    system:'✨' 
  };
  
  el.innerHTML = notifs.map(n => {
    const fromUser = users.find(u => u.username === n.fromUser);
    const icon = icons[n.type] || '✨';
    
    return `
      <div class="card" style="margin-bottom:10px;padding:16px;display:flex;align-items:center;gap:12px;cursor:pointer;${!n.read?'border:2px solid var(--purple);':''}" onclick="handleNotificationClick('${n.type}','${n.postId || ''}','${n.fromUser || ''}')">
        <div style="font-size:24px;">${icon}</div>
        <div style="flex:1;">
          ${fromUser ? `<strong>${fromUser.name}</strong> ` : ''}${n.text}
          <div style="font-size:12px;color:var(--text3);margin-top:2px;">${getTimeAgo(n.time)}</div>
        </div>
        ${!n.read ? '<div style="width:8px;height:8px;border-radius:50%;background:var(--purple);"></div>' : ''}
      </div>
    `;
  }).join('');
  
  // Update badge count in nav
  updateNotificationBadge();
}

function handleNotificationClick(type, postId, fromUser) {
  if (type === 'comment' || type === 'like' || type === 'cap' || type === 'relate' || type === 'wild' || type === 'facts') {
    if (postId) {
      navigate('home');
      // Scroll to post
      setTimeout(() => {
        const postEl = document.getElementById('post-' + postId);
        if (postEl) postEl.scrollIntoView({ behavior: 'smooth' });
      }, 100);
    }
  } else if (type === 'follow' || type === 'friend_request' || type === 'friend_accept') {
    if (fromUser) {
      navigate('profile', fromUser);
    }
  } else if (type === 'wave') {
    if (fromUser) {
      navigate('messages');
    }
  }
}

function updateNotificationBadge() {
  const me = getCurrentUser();
  if (!me) return;
  
  const notifs = getNotifs().filter(n => n.toUser === me.username);
  const unread = notifs.filter(n => !n.read).length;
  
  // Update nav badge
  const badge = document.getElementById('notif-badge');
  if (badge) {
    badge.textContent = unread;
    badge.style.display = unread > 0 ? 'flex' : 'none';
  }
}

function addNotif(toUser, type, fromUser, text, postId) {
  const notifs = getNotifs();
  notifs.unshift({ id: 'n_' + Date.now(), type, fromUser, toUser, text, postId, time: Date.now(), read: false });
  setNotifs(notifs.slice(0, 50));
}

// ══════════════════════════════════════
// PROFILE
// ══════════════════════════════════════
function renderProfile(username) {
  const users = getUsers();
  console.log('Rendering profile for:', username);
  console.log('Available users:', users.map(u => u.username));
  const user = users.find(u => u.username === username);
  const me = getCurrentUser();
  if (!user) { 
    console.log('User not found, navigating home');
    navigate('home'); 
    return; 
  }
  console.log('User found:', user);

  const posts = getPosts().filter(p => p.userId === username);
  const channels = getChannels().filter(c => c.ownerId === username);
  const isMe = me?.username === username;

  // Ensure avatar fields are set
  const avatarUrl = user.avatar_url || user.avatarImage || user.avatar || '';
  
  document.getElementById('topbar-title').textContent = user.name + '\'s Profile';

  document.getElementById('profile-content').innerHTML = `
    <div class="profile-page">
      <div class="profile-banner theme-${user.banner || 'purple'}" ${user.profileBackground || user.banner_url ? `style="background:url('${user.profileBackground || user.banner_url}') center/cover;"` : ''}></div>
      <div class="profile-info-section">
        <div class="profile-avatar-wrap">
          <div class="avatar avatar-xl" ${avatarUrl ? `style="background:url('${avatarUrl}') center/cover;"` : ''}>${avatarUrl ? '' : (user.avatar || user.name?.[0] || '?')}</div>
          <div style="padding-bottom:8px;">
            ${user.role === 'owner' ? '<span class="badge badge-gold">👑 Owner</span>' : ''}
          </div>
        </div>
        <div class="profile-name">${user.name} ${user.role === 'owner' ? '👑' : ''}</div>
        <div class="profile-handle">@${user.username}</div>
        ${(function() { const badges = calculateUserBadges(username); return badges.length ? '<div style="display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;">' + badges.map(b => '<span style="background:' + b.color + '22;border:1px solid ' + b.color + '55;color:' + b.color + ';padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;">' + b.icon + ' ' + b.label + '</span>').join('') + '</div>' : ''; })()}
        <div class="profile-bio">${user.bio || 'No bio yet.'}</div>
        ${(function() {
          const links = user.socialLinks || {};
          const icons = {
            instagram: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>',
            twitter: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4l11.733 16h4.267l-11.733 -16z"></path><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"></path></svg>',
            youtube: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>',
            tiktok: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"></path></svg>',
            twitch: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
            discord: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="2"></circle></svg>',
            website: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>'
          };
          const urls = {
            instagram: links.instagram ? `https://instagram.com/${links.instagram.replace('@','')}` : '',
            twitter: links.twitter ? `https://x.com/${links.twitter.replace('@','')}` : '',
            youtube: links.youtube,
            tiktok: links.tiktok ? `https://tiktok.com/@${links.tiktok.replace('@','')}` : '',
            twitch: links.twitch ? `https://twitch.tv/${links.twitch}` : '',
            discord: links.discord,
            website: links.website
          };
          const hasLinks = Object.values(links).some(v => v);
          if (!hasLinks) return '';
          return '<div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;">' +
            (links.instagram ? `<a href="${urls.instagram}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.instagram}</a>` : '') +
            (links.twitter ? `<a href="${urls.twitter}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.twitter}</a>` : '') +
            (links.youtube ? `<a href="${urls.youtube}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.youtube}</a>` : '') +
            (links.tiktok ? `<a href="${urls.tiktok}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.tiktok}</a>` : '') +
            (links.twitch ? `<a href="${urls.twitch}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.twitch}</a>` : '') +
            (links.discord ? `<span style="color:var(--text2);cursor:pointer;" title="Discord: ${links.discord}" onclick="navigator.clipboard.writeText('${links.discord}');toast('Discord copied!','success')">${icons.discord}</span>` : '') +
            (links.website ? `<a href="${urls.website.startsWith('http') ? urls.website : 'https://' + urls.website}" target="_blank" style="color:var(--text2);transition:color 0.2s;" onmouseover="this.style.color='var(--purple)'" onmouseout="this.style.color='var(--text2)'">${icons.website}</a>` : '') +
          '</div>';
        })()}
        <div class="profile-stats">
          <div class="profile-stat"><div class="profile-stat-num">${posts.length}</div><div class="profile-stat-label">Posts</div></div>
          <div class="profile-stat"><div class="profile-stat-num">${getVibeLikeCount(username)}</div><div class="profile-stat-label">Vibes</div></div>
          <div class="profile-stat"><div class="profile-stat-num">${getTop8VibesCount(username)}</div><div class="profile-stat-label">Top 8 Vibes</div></div>
        </div>
        <div class="profile-actions">
          ${isMe
            ? `<button class="btn btn-primary" onclick="navigate('edit-profile')">🎨 Customize Page</button>`
            : `<button class="btn btn-primary" onclick="openDM_goto('${username}')">💬 Message</button>
               <button class="btn btn-outline" onclick="waveUser('${username}')">👋 Wave</button>
               <button class="vibe-like-btn" id="vibe-like-btn-${username}" onclick="likeUserVibe('${username}')">💜 I Like Your Vibe</button>
               <button class="btn btn-outline btn-sm" onclick="openReportModal('${username}')">🚩 Report</button>`
          }
        </div>
      </div>

      <div class="profile-grid">
        <div>
          <!-- Mood widget -->
          ${user.mood ? `
            <div class="mood-widget">
              <div class="mood-emoji">${user.mood.emoji}</div>
              <div class="mood-text"><strong>${user.mood.text}</strong>How ${user.name.split(' ')[0]} is feeling</div>
            </div>
          ` : ''}

          <!-- Featured Posts -->
          ${(function() {
            const featured = (user.featuredPosts || []).map(id => posts.find(p => p.id === id)).filter(Boolean);
            if (!featured.length) return '';
            return '<div class="section-title">⭐ Featured</div><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">' + 
              featured.map(p => renderPostCard(p, true)).join('') + '</div>';
          })()}

          <!-- Posts -->
          <div class="section-title">Posts</div>
          ${(function() {
            const featured = user.featuredPosts || [];
            const regularPosts = posts.filter(p => !featured.includes(p.id));
            return regularPosts.length
              ? regularPosts.map(p => renderPostCard(p)).join('')
              : '<div class="empty-state" style="padding:32px;"><div class="empty-icon">✨</div><div class="empty-title">No posts yet</div></div>';
          })()}
        </div>

        <div>
          <!-- Music Player -->
          <div class="music-player">
            <div class="music-player-title">🎵 Now Playing</div>
            <div class="music-track">
              <div class="music-thumb" id="profile-music-thumb-${username}">🎵</div>
              <div class="music-info">
                <div class="music-track-name">${user.song?.name || 'No song set'}</div>
                <div class="music-artist">${user.song?.artist || 'Unknown artist'}</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:4px;margin-top:10px;">
              <button class="music-btn">⏮</button>
              <button class="music-btn play" onclick="toggleProfileMusic('${username}')">▶</button>
              <button class="music-btn">⏭</button>
              <div class="music-progress"><div class="music-progress-fill" id="music-prog-${username}"></div></div>
            </div>
          </div>

          <!-- Top 8 -->
          <div class="top8-widget">
            <div class="top8-title">⭐ Top 8 Vibes</div>
            <div class="top8-grid">
              ${(user.top8 || []).slice(0, 8).map(friendUsername => {
                const friend = users.find(u => u.username === friendUsername);
                return friend ? `
                  <div class="top8-friend" onclick="navigate('profile','${friend.username}')">
                    <div class="avatar avatar-sm" style="font-size:14px;">${friend.avatar || friend.name[0]}</div>
                    <div class="top8-name">${friend.name.split(' ')[0]}</div>
                  </div>
                ` : '';
              }).join('')}
              ${(user.top8 || []).length < 8
                ? Array(Math.max(0, 8 - (user.top8||[]).length)).fill(0).map(() =>
                    `<div class="top8-friend"><div class="avatar avatar-sm" style="background:var(--bg3);color:var(--text3);font-size:16px;">+</div><div class="top8-name">Open</div></div>`
                  ).join('')
                : ''}
            </div>
          </div>

          <!-- Channels -->
          ${channels.length ? `
            <div class="top8-widget">
              <div class="top8-title">📺 Channels</div>
              ${channels.map(ch => `
                <div onclick="navigate('channel-detail','${ch.id}')" style="display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;border-bottom:1px solid var(--border);">
                  <span style="font-size:20px;">${ch.emoji}</span>
                  <div>
                    <div style="font-weight:600;font-size:13px;">${ch.name}</div>
                    <div style="font-size:12px;color:var(--text3);">${ch.subs.length} subs</div>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  // Start music progress animation if playing
  if (user.song?.playing) {
    const thumb = document.getElementById('profile-music-thumb-' + username);
    if (thumb) thumb.classList.add('playing');
  }
}

let musicIntervals = {};

function toggleProfileMusic(username) {
  const thumb = document.getElementById('profile-music-thumb-' + username);
  const prog = document.getElementById('music-prog-' + username);
  if (!thumb) return;

  const isPlaying = thumb.classList.contains('playing');
  if (isPlaying) {
    thumb.classList.remove('playing');
    clearInterval(musicIntervals[username]);
  } else {
    thumb.classList.add('playing');
    let pct = 35;
    musicIntervals[username] = setInterval(() => {
      pct = (pct + 0.3) % 100;
      if (prog) prog.style.width = pct + '%';
    }, 100);
  }
}

function openDM_goto(username) {
  navigate('messages');
  setTimeout(() => openDM(username), 100);
}

// ══════════════════════════════════════
// EDIT PROFILE / CUSTOMIZER
// ══════════════════════════════════════
const THEME_COLORS = ['purple','pink','cyan','gold','green','red'];
const COLOR_HEX = { purple:'#8b5cf6', pink:'#ec4899', cyan:'#06b6d4', gold:'#f59e0b', green:'#10b981', red:'#ef4444' };

function renderEditProfile() {
  const me = getCurrentUser();

  // Theme color picker
  document.getElementById('theme-color-picker').innerHTML = THEME_COLORS.map(c =>
    `<div class="color-swatch ${me.theme === c ? 'active' : ''}" style="background:${COLOR_HEX[c]};" onclick="selectTheme('${c}',this)" title="${c}"></div>`
  ).join('');

  // Banner picker
  document.getElementById('banner-picker').innerHTML = THEME_COLORS.map(c =>
    `<div class="gradient-option ${me.banner === c ? 'active' : ''}" style="background:linear-gradient(135deg,${COLOR_HEX[c]},${COLOR_HEX[c]}88);" onclick="selectBanner('${c}',this)" title="${c}"></div>`
  ).join('');

  // Song
  document.getElementById('edit-song-url').value = me.song?.url || '';
  document.getElementById('edit-song-name').value = me.song?.name || '';
  document.getElementById('edit-song-artist').value = me.song?.artist || '';

  // Bio + name
  document.getElementById('edit-display-name').value = me.name;
  document.getElementById('edit-bio').value = me.bio || '';

  // Social Links
  document.getElementById('edit-social-instagram').value = me.socialLinks?.instagram || '';
  document.getElementById('edit-social-twitter').value = me.socialLinks?.twitter || '';
  document.getElementById('edit-social-youtube').value = me.socialLinks?.youtube || '';
  document.getElementById('edit-social-tiktok').value = me.socialLinks?.tiktok || '';
  document.getElementById('edit-social-twitch').value = me.socialLinks?.twitch || '';
  document.getElementById('edit-social-discord').value = me.socialLinks?.discord || '';
  document.getElementById('edit-social-website').value = me.socialLinks?.website || '';

  // Profile Background
  document.getElementById('edit-profile-background').value = me.profileBackground || '';

  // Profile Image Preview
  if (me.avatarImage) {
    document.getElementById('profile-image-preview').innerHTML = `<img src="${me.avatarImage}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">`;
  } else {
    document.getElementById('profile-image-preview').innerHTML = '';
  }

  // Top 8 editor
  renderTop8Editor();
}

let editTheme = null;
let editBanner = null;
let editMood = null;
let editTop8 = null;
let editAvatarImage = null;
let editAvatarFile = null;

function handleProfileImageUpload(input) {
  const file = input.files[0];
  if (!file) return;
  
  // Store file for upload
  editAvatarFile = file;
  
  // Show preview
  const reader = new FileReader();
  reader.onload = e => {
    editAvatarImage = e.target.result;
    document.getElementById('profile-image-preview').innerHTML = 
      `<img src="${e.target.result}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">`;
  };
  reader.readAsDataURL(file);
}

function selectBanner(color, el) {
  editBanner = color;
  document.querySelectorAll('#banner-picker .gradient-option').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
}

function setMood(emoji, text) {
  editMood = { emoji, text };
  toast('Mood set to ' + emoji + ' ' + text, 'success');
}

function renderTop8Editor() {
  const me = getCurrentUser();
  const users = getUsers();
  const top8 = me.top8 || [];
  const el = document.getElementById('top8-editor');

  el.innerHTML = Array(8).fill(0).map((_, i) => {
    const friendUsername = top8[i];
    const friend = friendUsername ? users.find(u => u.username === friendUsername) : null;
    return `
      <div style="text-align:center;cursor:pointer;" onclick="openTop8Picker(${i})">
        <div class="avatar avatar-sm" style="margin:0 auto 4px;font-size:14px;${friend ? '' : 'background:var(--bg3);'}">${friend ? (friend.avatar || friend.name[0]) : '+'}</div>
        <div style="font-size:10px;color:var(--text2);">${friend ? friend.name.split(' ')[0] : 'Add'}</div>
      </div>
    `;
  }).join('');
}

let top8SlotIndex = null;

function openTop8Picker(slotIndex) {
  const me = getCurrentUser();
  editTop8 = editTop8 || [...(me.top8 || [])];
  top8SlotIndex = slotIndex;
  const users = getUsers().filter(u => u.username !== me.username);

  document.getElementById('top8-user-picker').innerHTML = users.map(u => `
    <div class="dm-item" onclick="pickTop8User('${u.username}')">
      <div class="avatar avatar-sm">${u.avatar || u.name[0]}</div>
      <div>
        <div style="font-weight:600;font-size:14px;">${u.name}</div>
        <div style="font-size:12px;color:var(--text3);">@${u.username}</div>
      </div>
    </div>
  `).join('');
  document.getElementById('modal-top8').classList.remove('hidden');
}

function pickTop8User(username) {
  if (!editTop8) editTop8 = [...(getCurrentUser().top8 || [])];
  if (editTop8.length <= top8SlotIndex) {
    while (editTop8.length <= top8SlotIndex) editTop8.push('');
  }
  editTop8[top8SlotIndex] = username;
  closeModal('modal-top8');
  renderTop8Editor_preview();
}

function renderTop8Editor_preview() {
  const users = getUsers();
  const el = document.getElementById('top8-editor');
  const t8 = editTop8 || [];

  el.innerHTML = Array(8).fill(0).map((_, i) => {
    const friendUsername = t8[i];
    const friend = friendUsername ? users.find(u => u.username === friendUsername) : null;
    return `
      <div style="text-align:center;cursor:pointer;" onclick="openTop8Picker(${i})">
        <div class="avatar avatar-sm" style="margin:0 auto 4px;font-size:14px;${friend ? '' : 'background:var(--bg3);'}">${friend ? (friend.avatar || friend.name[0]) : '+'}</div>
        <div style="font-size:10px;color:var(--text2);">${friend ? friend.name.split(' ')[0] : 'Add'}</div>
      </div>
    `;
  }).join('');
}

async function saveProfile() {
  const me = getCurrentUser();
  const users = getUsers();
  const idx = users.findIndex(u => u.username === me.username);
  if (idx === -1) return;

  // Validation - Essential for solid code
  const newName = document.getElementById('edit-display-name').value.trim();
  if (newName && newName.length < 2) {
    toast('Name is too short (min 2 characters)', 'error');
    return;
  }
  
  if (newName && newName.length > 50) {
    toast('Name is too long (max 50 characters)', 'error');
    return;
  }

  // Optimistic UI - Show saving state
  const saveBtn = document.querySelector('#view-edit-profile .btn-primary');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
  }

  users[idx].name = newName || me.name;
  users[idx].bio = document.getElementById('edit-bio').value.trim();
  users[idx].song = {
    url: document.getElementById('edit-song-url').value.trim(),
    name: document.getElementById('edit-song-name').value.trim(),
    artist: document.getElementById('edit-song-artist').value.trim(),
  };
  
  // Social Links
  users[idx].socialLinks = {
    instagram: document.getElementById('edit-social-instagram').value.trim(),
    twitter: document.getElementById('edit-social-twitter').value.trim(),
    youtube: document.getElementById('edit-social-youtube').value.trim(),
    tiktok: document.getElementById('edit-social-tiktok').value.trim(),
    twitch: document.getElementById('edit-social-twitch').value.trim(),
    discord: document.getElementById('edit-social-discord').value.trim(),
    website: document.getElementById('edit-social-website').value.trim(),
  };
  
  // Profile Background
  users[idx].profileBackground = document.getElementById('edit-profile-background').value.trim();
  
  // Profile Image - upload to Supabase Storage if file provided
  if (editAvatarFile) {
    toast('Uploading profile picture...', 'info');
    const avatarUrl = await uploadMedia(editAvatarFile, 'avatars');
    if (avatarUrl) {
      users[idx].avatarImage = avatarUrl;
      users[idx].avatar = avatarUrl;
      users[idx].avatar_url = avatarUrl;
    } else {
      // Fallback to base64 if upload fails
      if (editAvatarImage) {
        users[idx].avatarImage = editAvatarImage;
        users[idx].avatar = editAvatarImage;
      }
    }
  }
  
  if (editTheme) users[idx].theme = editTheme;
  if (editBanner) users[idx].banner = editBanner;
  if (editMood) users[idx].mood = editMood;
  if (editTop8) users[idx].top8 = editTop8.filter(Boolean);

  try {
    await setUsers(users);
    
    // Clear form state
    editTheme = null; editBanner = null; editMood = null; editTop8 = null; editAvatarImage = null; editAvatarFile = null;
    
    updateSidebarUser();
    toast('Profile saved! Looking fresh ✨', 'success');
    navigate('profile', me.username);
  } catch (err) {
    console.error('Failed to save profile:', err);
    toast('Failed to save profile. Please try again.', 'error');
  }
  
  // Reset button state
  if (saveBtn) {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Changes';
  }
}

// ══════════════════════════════════════
// IMAGE COMPRESSION
// ══════════════════════════════════════
function compressImage(file, maxSizeKB = 200, maxWidth = 400) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        let quality = 0.9;
        let dataUrl = canvas.toDataURL('image/jpeg', quality);
        
        while (dataUrl.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) {
          quality -= 0.1;
          dataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        
        resolve(dataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function handleProfileImageUpload(input) {
  const file = input.files[0];
  if (!file) return;
  
  compressImage(file).then(dataUrl => {
    editAvatarImage = dataUrl;
    document.getElementById('profile-image-preview').innerHTML = 
      `<img src="${dataUrl}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">`;
    toast('Image compressed and ready!', 'success');
  });
}

// ══════════════════════════════════════
// SETTINGS
// ══════════════════════════════════════
function renderSettings() {
  const me = getCurrentUser();
  if (!me) { navigate('home'); return; }
  
  document.getElementById('settings-display-name').value = me.name || '';
  document.getElementById('settings-bio').value = me.bio || '';
  document.getElementById('settings-email').value = me.email || '';
}

function updateSettingsFromForm() {
  const me = getCurrentUser();
  if (!me) return;
  
  me.name = document.getElementById('settings-display-name').value;
  me.bio = document.getElementById('settings-bio').value;
  me.email = document.getElementById('settings-email').value;
  
  const users = getUsers();
  const idx = users.findIndex(u => u.username === me.username);
  if (idx !== -1) {
    users[idx] = me;
    setUsers(users);
    setSession(me.username);
  }
  
  toast('Settings saved!', 'success');
}

function confirmDeleteAccount() {
  if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
  if (!confirm('This will permanently delete all your data. Continue?')) return;
  
  const me = getCurrentUser();
  let users = getUsers();
  users = users.filter(u => u.username !== me.username);
  setUsers(users);
  clearSession();
  toast('Account deleted. Sorry to see you go!', 'success');
  setTimeout(() => window.location.reload(), 1500);
}

// ══════════════════════════════════════
// ADMIN PANEL
// ══════════════════════════════════════
function renderAdmin() {
  const me = getCurrentUser();
  if (me?.role !== 'owner') { navigate('home'); toast('Access denied', 'error'); return; }

  const users = getUsers();
  const posts = getPosts();
  const channels = getChannels();

  // Stats
  document.getElementById('admin-stats').innerHTML = [
    { val: users.length, label:'Total Users', color:'purple' },
    { val: posts.length, label:'Total Posts', color:'pink' },
    { val: channels.length, label:'Channels', color:'cyan' },
    { val: '$' + users.length, label:'Revenue', color:'gold' },
  ].map(s => `
    <div class="admin-stat" style="border-color:var(--${s.color},var(--border));">
      <div class="admin-stat-val" style="color:var(--${s.color})">${s.val}</div>
      <div class="admin-stat-label">${s.label}</div>
    </div>
  `).join('');

  // Activity
  document.getElementById('admin-activity').innerHTML = posts.slice(0,5).map(p => {
    const u = users.find(u => u.username === p.userId);
    return `
      <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
        <span style="font-size:18px;">📝</span>
        <div style="flex:1;">
          <strong>${u?.name}</strong> posted: "${p.text?.substring(0,60)}..."
          <div style="font-size:12px;color:var(--text3);">${getTimeAgo(p.time)}</div>
        </div>
      </div>
    `;
  }).join('');

  // Users tab
  document.getElementById('admin-users-list').innerHTML = users.map(u => `
    <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
      <div class="avatar avatar-sm">${u.avatar || u.name[0]}</div>
      <div style="flex:1;">
        <div style="font-weight:600;">${u.name} <span class="badge ${u.role === 'owner' ? 'badge-gold' : 'badge-purple'}">${u.role}</span></div>
        <div style="font-size:12px;color:var(--text3);">@${u.username} · ${u.email} · Joined ${getTimeAgo(u.joined)}</div>
      </div>
      ${u.role !== 'owner' ? `<button class="btn btn-danger btn-sm" onclick="adminDeleteUser('${u.username}')">Remove</button>` : ''}
    </div>
  `).join('');

  // Posts tab
  document.getElementById('admin-posts-list').innerHTML = posts.map(p => {
    const u = users.find(u => u.username === p.userId);
    return `
      <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
        <div class="avatar avatar-sm" style="font-size:12px;">${u?.avatar || u?.name[0]}</div>
        <div style="flex:1;">
          <div style="font-size:14px;">${p.text?.substring(0,80) || '(media post)'}...</div>
          <div style="font-size:12px;color:var(--text3);">by @${p.userId} · 👍${p.likes.length} 👎${p.dislikes.length} · ${getTimeAgo(p.time)}</div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="adminDeletePost('${p.id}')">Delete</button>
      </div>
    `;
  }).join('');

  // Channels tab
  document.getElementById('admin-channels-list').innerHTML = channels.map(ch => `
    <div class="card" style="margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;">
      <span style="font-size:24px;">${ch.emoji}</span>
      <div style="flex:1;">
        <div style="font-weight:600;">${ch.name}</div>
        <div style="font-size:12px;color:var(--text3);">by @${ch.ownerId} · ${ch.subs.length} subs · ${ch.videos?.length || 0} videos</div>
      </div>
    </div>
  `).join('');
}

function adminTab(tab, btn) {
  document.querySelectorAll('.admin-nav-item').forEach(n => n.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('[id^="admin-tab-"]').forEach(el => el.style.display = 'none');
  document.getElementById('admin-tab-' + tab).style.display = '';
}

function adminDeleteUser(username) {
  if (!confirm('Remove user @' + username + '?')) return;
  setUsers(getUsers().filter(u => u.username !== username));
  setPosts(getPosts().filter(p => p.userId !== username));
  renderAdmin();
  toast('User removed', 'success');
}

function adminDeletePost(postId) {
  if (!confirm('Delete this post?')) return;
  setPosts(getPosts().filter(p => p.id !== postId));
  renderAdmin();
  toast('Post deleted', 'success');
}

// ══════════════════════════════════════
// SEARCH
// ══════════════════════════════════════
function renderSearch(query) {
  document.getElementById('topbar-title').textContent = 'Search: "' + query + '"';
  const q = query.toLowerCase();
  const users = getUsers().filter(u => u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q));
  const posts = getPosts().filter(p => p.text?.toLowerCase().includes(q) || p.tags?.some(t => t.includes(q)));

  document.getElementById('search-results').innerHTML = `
    ${users.length ? `
      <div class="section-title">People</div>
      <div class="creator-grid" style="margin-bottom:24px;">
        ${users.map(u => `
          <div class="creator-card" onclick="navigate('profile','${u.username}')">
            <div class="avatar avatar-md" style="margin:0 auto;">${u.avatar || u.name[0]}</div>
            <div class="creator-name">${u.name}</div>
            <div class="creator-handle">@${u.username}</div>
          </div>
        `).join('')}
      </div>
    ` : ''}
    ${posts.length ? `
      <div class="section-title">Posts</div>
      ${posts.map(p => renderPostCard(p)).join('')}
    ` : ''}
    ${!users.length && !posts.length ? `
      <div class="empty-state">
        <div class="empty-icon">🔍</div>
        <div class="empty-title">No results for "${query}"</div>
        <div class="empty-desc">Try a different search term</div>
      </div>
    ` : ''}
  `;
}

// ══════════════════════════════════════
// MODALS
// ══════════════════════════════════════
function closeModal(id) {
  document.getElementById(id)?.classList.add('hidden');
  // Reset payment button
  if (id === 'modal-payment') {
    const btn = document.querySelector('#modal-payment .btn-primary');
    if (btn) { btn.textContent = 'Pay $1 & Join VibeHub 🚀'; btn.disabled = false; }
  }
}

// ══════════════════════════════════════
// TOAST
// ══════════════════════════════════════
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  const icons = { success:'✅', error:'❌', info:'ℹ️' };
  el.className = 'toast ' + type;
  el.innerHTML = `<span>${icons[type] || '✨'}</span> ${msg}`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ══════════════════════════════════════
// UTILS
// ══════════════════════════════════════
function getTimeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatCard(input) {
  let val = input.value.replace(/\D/g,'').substring(0,16);
  input.value = val.replace(/(.{4})/g,'$1 ').trim();
}

// ══════════════════════════════════════
// MARKETPLACE
// ══════════════════════════════════════
function getProducts() { return getDB('products', []); }
function setProducts(v) { setDB('products', v); }

function showCreateProductModal() {
  if (!currentSession) { toast('Log in to list items', 'error'); return; }
  document.getElementById('modal-create-product').classList.remove('hidden');
}

function createProduct() {
  const title = document.getElementById('product-title-input').value.trim();
  const desc = document.getElementById('product-desc-input').value.trim();
  const price = parseFloat(document.getElementById('product-price-input').value) || 0;
  const category = document.getElementById('product-category-input').value;
  const image = document.getElementById('product-image-input').value.trim();
  
  if (!title || !price) { toast('Title and price required', 'error'); return; }
  
  const me = getCurrentUser();
  const products = getProducts();
  products.unshift({
    id: 'prod_' + Date.now(),
    seller: me.username,
    sellerName: me.name,
    title, desc, price, category, image,
    createdAt: Date.now()
  });
  setProducts(products);
  closeModal('modal-create-product');
  navigate('marketplace');
  toast('Item listed!', 'success');
  
  document.getElementById('product-title-input').value = '';
  document.getElementById('product-desc-input').value = '';
  document.getElementById('product-price-input').value = '';
  document.getElementById('product-image-input').value = '';
}

function renderMarketplace(tab = 'all') {
  // Verify authentication - check session from cookie as authoritative source
  const session = getSession();
  const me = getCurrentUser();
  
  if (!session || !me) {
    const grid = document.getElementById('marketplace-grid');
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">🔐</div><div class="empty-title">Please sign in</div><div class="empty-desc"><button class="btn btn-primary" onclick="showPage(\'login\')">Sign In</button></div></div>';
    return;
  }
  
  let products = getProducts();
  if (tab !== 'all') {
    products = products.filter(p => p.category === tab);
  }
  
  const grid = document.getElementById('marketplace-grid');
  if (!products.length) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">🛍️</div><div class="empty-title">No items yet</div><div class="empty-desc">Be the first to list something!</div></div>';
    return;
  }
  
  grid.innerHTML = products.map(p => `
    <div class="card" style="overflow:hidden;cursor:pointer;" onclick="viewProduct('${p.id}')">
      <div style="height:160px;background:${p.image ? 'url('+p.image+') center/cover' : 'linear-gradient(135deg,var(--purple2),var(--pink))'};display:flex;align-items:center;justify-content:center;">
        ${!p.image ? '<span style="font-size:48px;">📦</span>' : ''}
      </div>
      <div style="padding:16px;">
        <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${escHtml(p.title)}</div>
        <div style="color:var(--purple);font-weight:700;font-size:18px;margin-bottom:8px;">$${p.price}</div>
        <div style="font-size:12px;color:var(--text3);">by @${p.seller}</div>
      </div>
    </div>
  `).join('');
}

function switchMarketplaceTab(tab, btn) {
  document.querySelectorAll('#view-marketplace .feed-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderMarketplace(tab);
}

function renderStatusChannels() {
  const channels = getStatusChannels().filter(c => c.expiresAt > Date.now());
  const container = document.getElementById('status-channels-list');
  if (!container) return;
  
  if (!channels.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">⏰</div><div class="empty-title">No active status channels</div><div class="empty-desc">Create one to start vibing!</div></div>';
    return;
  }
  
  container.innerHTML = channels.map(c => `
    <div class="channel-card" onclick="joinStatusChannel('${c.id}')">
      <div class="channel-banner">${c.name[0]}</div>
      <div class="channel-info">
        <div class="channel-name">${escHtml(c.name)}</div>
        <div class="channel-meta">
          <span class="channel-subs">by @${c.creator}</span>
          <span style="color:var(--cyan);font-size:11px;">⏰ ${Math.round((c.expiresAt - Date.now()) / 3600000)}h left</span>
        </div>
      </div>
    </div>
  `).join('');
}

function viewProduct(productId) {
  const products = getProducts();
  const p = products.find(prod => prod.id === productId);
  if (!p) return;
  
  const me = getCurrentUser();
  if (p.seller === me?.username) {
    toast('This is your listing', 'info');
    return;
  }
  
  const msg = prompt('Message to @' + p.seller + ':');
  if (msg) {
    const messages = getMessages();
    const key = [me.username, p.seller].sort().join('_');
    if (!messages[key]) messages[key] = [];
    messages[key].unshift({ from: me.username, to: p.seller, text: msg, time: Date.now() });
    setMessages(messages);
    toast('Message sent!', 'success');
  }
}

// ══════════════════════════════════════
// REPUTATION & BADGES
// ══════════════════════════════════════
function getEngagementScore(username) {
  const users = getUsers();
  const posts = getPosts();
  const user = users.find(u => u.username === username);
  if (!user) return 0;
  
  const userPosts = posts.filter(p => p.userId === username);
  let score = 0;
  
  score += userPosts.length * 10;
  
  userPosts.forEach(p => {
    score += (p.likes?.length || 0) * 2;
    score += (p.dislikes?.length || 0) * 1;
    score += (p.comments?.length || 0) * 3;
    score += (p.waves?.length || 0) * 2;
    if (p.reactions) {
      Object.values(p.reactions).forEach(arr => {
        score += (arr?.length || 0) * 2;
      });
    }
  });
  
  const friends = getFriends()[username] || [];
  score += friends.length * 5;
  
  return score;
}

function getUserBadge(username) {
  const score = getEngagementScore(username);
  if (score >= 1000) return { icon: '👑', label: 'Legend', color: 'gold' };
  if (score >= 500) return { icon: '⭐', label: 'Superstar', color: 'purple' };
  if (score >= 200) return { icon: '🔥', label: 'Rising', color: 'pink' };
  if (score >= 50) return { icon: '🌱', label: 'Newbie', color: 'green' };
  return null;
}

function renderBadge(username) {
  const badge = getUserBadge(username);
  if (!badge) return '';
  return `<span class="badge badge-${badge.color}" style="margin-left:6px;">${badge.icon} ${badge.label}</span>`;
}

// ══════════════════════════════════════
// "I LIKE YOUR VIBE" BUTTON
// ══════════════════════════════════════
function getVibeLikes() { return getDB('vibeLikes', {}); }
function setVibeLikes(v) { setDB('vibeLikes', v); }

async function likeUserVibe(username) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const me = getCurrentUser();
  if (me.username === username) { toast("Can't vibe yourself 😅", 'error'); return; }
  
  const sb = getSupabase();
  if (sb) {
    try {
      await likeUserVibeSupabase(username);
      return;
    } catch (err) { console.error('Supabase vibe like failed, falling back:', err); }
  }
  
  const likes = getVibeLikes();
  if (!likes[username]) likes[username] = [];
  
  if (likes[username].includes(me.username)) {
    toast('You already liked their vibe!', 'info');
    return;
  }
  
  likes[username].push(me.username);
  setVibeLikes(likes);
  toast('You like their vibe! ✨', 'success');
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'vibeLike', from: me.username, to: username, time: Date.now() });
  setNotifs(notifs);
}

async function getVibeLikeCount(username) {
  const sb = getSupabase();
  if (sb) {
    try {
      const count = await getVibeLikeCountSupabase(username);
      if (count > 0) return count;
    } catch (err) { console.error('Supabase getVibeLikeCount failed:', err); }
  }
  const likes = getVibeLikes();
  return likes[username]?.length || 0;
}

// ══════════════════════════════════════
// REPORT SYSTEM
// ══════════════════════════════════════
let reportTargetUser = '';

function openReportModal(username) {
  reportTargetUser = username;
  document.getElementById('report-reason').value = '';
  document.getElementById('report-details').value = '';
  document.getElementById('modal-report').classList.remove('hidden');
}

function submitReport() {
  const reason = document.getElementById('report-reason').value;
  const details = document.getElementById('report-details').value;
  
  if (!reason) {
    toast('Please select a reason', 'error');
    return;
  }
  
  const me = getCurrentUser();
  const reports = getDB('reports', []);
  reports.unshift({
    id: 'r_' + Date.now(),
    reporter: me?.username || 'anonymous',
    reportedUser: reportTargetUser,
    reason: reason,
    details: details,
    time: Date.now(),
    status: 'pending'
  });
  setDB('reports', reports);
  
  closeModal('modal-report');
  toast('Report submitted. We\'ll review it soon. 🚩', 'success');
  reportTargetUser = '';
}

function getTop8VibesCount(username) {
  const users = getUsers();
  let count = 0;
  users.forEach(u => {
    if ((u.top8 || []).includes(username)) count++;
  });
  return count;
}

function calculateUserBadges(username) {
  const posts = getPosts().filter(p => p.userId === username);
  const users = getUsers();
  const user = users.find(u => u.username === username);
  if (!user) return [];
  
  const badges = [];
  const allReactions = { likes: 0, cap: 0, relate: 0, wild: 0, facts: 0 };
  
  posts.forEach(p => {
    allReactions.likes += p.likes.length;
    if (p.reactions) {
      allReactions.cap += p.reactions.cap?.length || 0;
      allReactions.relate += p.reactions.relate?.length || 0;
      allReactions.wild += p.reactions.wild?.length || 0;
      allReactions.facts += p.reactions.facts?.length || 0;
    }
    p.comments?.forEach(c => {
      allReactions.likes += c.reactions?.like?.length || 0;
      allReactions.relate += c.reactions?.relate?.length || 0;
    });
  });
  
  const total = allReactions.likes + allReactions.cap + allReactions.relate + allReactions.wild + allReactions.facts;
  
  if (total > 0) {
    if (allReactions.likes / total >= 0.6) badges.push({ icon: '❤️', label: 'Loved', color: '#ec4899' });
    if (allReactions.relate / total >= 0.4) badges.push({ icon: '🙌', label: 'Relatable', color: '#8b5cf6' });
    if (allReactions.wild / total >= 0.3) badges.push({ icon: '🦄', label: 'Wild Card', color: '#a855f7' });
    if (allReactions.facts / total >= 0.3) badges.push({ icon: '📢', label: 'Facts Only', color: '#eab308' });
    if (allReactions.cap / total >= 0.2) badges.push({ icon: '🤥', label: 'Cap Detector', color: '#f97316' });
  }
  
  const commentCount = posts.reduce((sum, p) => sum + (p.comments?.length || 0), 0);
  if (commentCount >= 10) badges.push({ icon: '💬', label: 'Conversationalist', color: '#06b6d4' });
  
  const totalReactions = total + (getVibeLikeCount(username));
  if (totalReactions >= 20) badges.push({ icon: '🔥', label: 'On Fire', color: '#ef4444' });
  if (getVibeLikeCount(username) >= 10) badges.push({ icon: '❤️', label: 'Vibe King', color: '#ec4899' });
  if (getTop8VibesCount(username) >= 5) badges.push({ icon: '⭐', label: 'Popular', color: '#f59e0b' });
  
  return badges;
}

function getUserRank(username) {
  const users = getUsers();
  const posts = getPosts();
  
  const userScores = users.map(u => {
    const userPosts = posts.filter(p => p.userId === u.username);
    let score = 0;
    
    score += getTop8VibesCount(u.username) * 10;
    score += getVibeLikeCount(u.username) * 5;
    
    userPosts.forEach(p => {
      score += p.likes.length * 2;
      score += p.dislikes.length * 1;
      score += p.comments.length * 3;
      score += (p.reactions?.cap?.length || 0) * 3;
      score += (p.reactions?.relate?.length || 0) * 4;
      score += (p.reactions?.wild?.length || 0) * 3;
      score += (p.reactions?.facts?.length || 0) * 3;
    });
    
    return { username: u.username, score };
  });
  
  userScores.sort((a, b) => b.score - a.score);
  
  const rank = userScores.findIndex(u => u.username === username) + 1;
  const total = users.length;
  
  return { rank, total };
}

function waveUser(username) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const me = getCurrentUser();
  if (me.username === username) { toast("Can't wave at yourself 😅", 'error'); return; }
  
  const waves = getWaves();
  if (!waves[username]) waves[username] = [];
  
  if (waves[username].includes(me.username)) {
    toast('You already waved at them! 👋', 'info');
    return;
  }
  
  waves[username].push(me.username);
  setWaves(waves);
  toast('You waved at @' + username + '! 👋', 'success');
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'wave', from: me.username, to: username, time: Date.now() });
  setNotifs(notifs);
  renderProfile(username);
}

function getWaves() { return getDB('userWaves', {}); }
function setWaves(v) { setDB('userWaves', v); }

// ══════════════════════════════════════
// FRIENDS SYSTEM
// ══════════════════════════════════════
function getFriends() { return getDB('friends', {}); }
function setFriends(v) { setDB('friends', v); }
function getFriendRequests() { return getDB('friendRequests', []); }
function setFriendRequests(v) { setDB('friendRequests', v); }

function sendFriendRequest(toUsername) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const me = getCurrentUser();
  if (me.username === toUsername) { toast("Can't friend yourself", 'error'); return; }
  
  const requests = getFriendRequests();
  if (requests.find(r => r.from === me.username && r.to === toUsername && r.status === 'pending')) {
    toast('Request already sent', 'info');
    return;
  }
  
  const friends = getFriends();
  if (friends[me.username]?.includes(toUsername)) {
    toast('Already friends!', 'info');
    return;
  }
  
  requests.push({ from: me.username, to: toUsername, time: Date.now(), status: 'pending' });
  setFriendRequests(requests);
  toast('Friend request sent!', 'success');
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'friendRequest', from: me.username, to: toUsername, time: Date.now() });
  setNotifs(notifs);
}

function acceptFriendRequest(fromUsername) {
  if (!currentSession) return;
  const me = getCurrentUser();
  const requests = getFriendRequests();
  const idx = requests.findIndex(r => r.from === fromUsername && r.to === me.username && r.status === 'pending');
  if (idx === -1) return;
  
  requests[idx].status = 'accepted';
  setFriendRequests(requests);
  
  const friends = getFriends();
  if (!friends[me.username]) friends[me.username] = [];
  if (!friends[fromUsername]) friends[fromUsername] = [];
  friends[me.username].push(fromUsername);
  friends[fromUsername].push(me.username);
  setFriends(friends);
  
  toast('You are now friends! 🎉', 'success');
  renderNotifications();
}

function rejectFriendRequest(fromUsername) {
  if (!currentSession) return;
  const me = getCurrentUser();
  const requests = getFriendRequests();
  const idx = requests.findIndex(r => r.from === fromUsername && r.to === me.username && r.status === 'pending');
  if (idx === -1) return;
  
  requests[idx].status = 'rejected';
  setFriendRequests(requests);
  renderNotifications();
}

function isFriends(user1, user2) {
  const friends = getFriends();
  return friends[user1]?.includes(user2) || false;
}

// ══════════════════════════════════════
// WAVES (SUPER LIKE)
// ══════════════════════════════════════
function wavePost(postId) {
  if (!currentSession) { toast('Log in to wave', 'error'); return; }
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post) return;
  
  if (!post.waves) post.waves = [];
  if (post.waves.includes(me.username)) {
    toast('Already waved at this!', 'info');
    return;
  }
  
  post.waves.push(me.username);
  setPosts(posts);
  
  const notifs = getNotifs();
  notifs.unshift({ type: 'wave', from: me.username, to: post.userId, postId, time: Date.now() });
  setNotifs(notifs);
  
  renderFeed(document.querySelector('#view-home .feed-tab.active')?.textContent?.toLowerCase().includes('friends') ? 'friends' : 'all');
  toast('You waved at this! 🌊', 'success');
}

// ══════════════════════════════════════
// COMMENT REACTIONS
// ══════════════════════════════════════
function toggleCommentReaction(postId, commentIndex, type) {
  if (!currentSession) { toast('Log in to react', 'error'); return; }
  const me = getCurrentUser();
  const posts = getPosts();
  const post = posts.find(p => p.id === postId);
  if (!post || !post.comments || !post.comments[commentIndex]) return;
  
  const comment = post.comments[commentIndex];
  if (!comment.reactions) comment.reactions = {};
  if (!comment.reactions[type]) comment.reactions[type] = [];
  
  const arr = comment.reactions[type];
  const idx = arr.indexOf(me.username);
  
  if (idx > -1) {
    arr.splice(idx, 1);
  } else {
    arr.push(me.username);
  }
  
  setPosts(posts);
  renderFeed('all');
}

function getCommentReactionCount(comment, type) {
  return comment.reactions?.[type]?.length || 0;
}

function hasCommentReacted(comment, type) {
  if (!currentSession) return false;
  const me = getCurrentUser();
  return comment.reactions?.[type]?.includes(me.username) || false;
}

// ══════════════════════════════════════
// AUDIO COMMENTS (60 second limit)
// ══════════════════════════════════════
function showAudioCommentModal(postId) {
  if (!currentSession) { toast('Log in to record', 'error'); return; }
  document.getElementById('modal-audio-comment').classList.remove('hidden');
  window.currentAudioCommentPost = postId;
  window.currentAudioReplyTo = null;
  initAudioRecorder();
}

function initAudioRecorder() {
  const recorderEl = document.getElementById('audio-recorder-status');
  const btn = document.getElementById('record-audio-btn');
  const timer = document.getElementById('audio-timer');
  if (recorderEl) recorderEl.textContent = '🎤 Click to start recording (60s max)';
  if (btn) btn.textContent = '🎤 Record';
  if (timer) timer.textContent = '0:00';
  window.audioRecording = false;
  window.audioBlob = null;
  if (window.audioTimerInterval) clearInterval(window.audioTimerInterval);
}

async function toggleAudioRecording() {
  const btn = document.getElementById('record-audio-btn');
  const status = document.getElementById('audio-recorder-status');
  const timer = document.getElementById('audio-timer');
  
  if (!window.audioRecording) {
    try {
      window.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      window.audioMediaRecorder = new MediaRecorder(window.audioStream);
      const chunks = [];
      
      window.audioMediaRecorder.ondataavailable = e => chunks.push(e.data);
      window.audioMediaRecorder.onstop = () => {
        window.audioBlob = new Blob(chunks, { type: 'audio/webm' });
        if (status) status.textContent = '✅ Recording done! Click to re-record';
        if (window.audioTimerInterval) clearInterval(window.audioTimerInterval);
      };
      
      window.audioMediaRecorder.start();
      window.audioRecording = true;
      window.audioStartTime = Date.now();
      if (btn) btn.textContent = '⏹️ Stop';
      if (status) status.textContent = '🔴 Recording...';
      
      window.audioTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - window.audioStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        if (timer) timer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        if (elapsed >= 60) {
          stopAudioRecording();
        }
      }, 1000);
      
    } catch (e) {
      toast('Mic access denied', 'error');
    }
  } else {
    stopAudioRecording();
  }
}

function stopAudioRecording() {
  if (window.audioMediaRecorder && window.audioRecording) {
    window.audioMediaRecorder.stop();
    if (window.audioStream) {
      window.audioStream.getTracks().forEach(t => t.stop());
    }
    window.audioRecording = false;
    const btn = document.getElementById('record-audio-btn');
    if (btn) btn.textContent = '🎤 Re-record';
    if (window.audioTimerInterval) clearInterval(window.audioTimerInterval);
  }
}

function submitAudioComment() {
  if (!window.audioBlob) { toast('Record audio first', 'error'); return; }
  
  const reader = new FileReader();
  reader.onload = () => {
    const posts = getPosts();
    const post = posts.find(p => p.id === window.currentAudioCommentPost);
    if (!post) return;
    
    if (!post.comments) post.comments = [];
    const me = getCurrentUser();
    
    post.comments.unshift({
      userId: me.username,
      authorName: me.name,
      audio: reader.result,
      time: Date.now(),
      replies: [],
      reactions: {}
    });
    
    setPosts(posts);
    closeModal('modal-audio-comment');
    openComments(window.currentAudioCommentPost);
    toast('Audio comment added! 🎤', 'success');
  };
  reader.readAsDataURL(window.audioBlob);
}

// ══════════════════════════════════════
// POST EXPIRATION (2 DAYS FOR TIMELINE)
// ══════════════════════════════════════
function isPostExpired(post) {
  if (post.pinned) return false;
  const TWO_DAYS = 2 * 24 * 60 * 60 * 1000;
  return Date.now() - post.time > TWO_DAYS;
}

function cleanupExpiredPosts() {
  const posts = getPosts();
  const initialCount = posts.length;
  const validPosts = posts.filter(p => !isPostExpired(p) || p.userId === getCurrentUser()?.username);
  
  if (validPosts.length !== initialCount) {
    setPosts(validPosts);
  }
}

// ══════════════════════════════════════
// ENHANCED REACTIONS WITH POPUPS
// ══════════════════════════════════════
function showReactionPopup(postId, btn) {
  const popup = document.getElementById('reaction-popup-' + postId);
  if (popup) {
    popup.classList.toggle('hidden');
  }
}

function toggleReactionWithPopup(postId, type) {
  toggleReaction(postId, type);
  const popup = document.getElementById('reaction-popup-' + postId);
  if (popup) popup.classList.add('hidden');
}

// ══════════════════════════════════════
// NAVIGATION - ADD MARKETPLACE & DISCLAIMER
// ══════════════════════════════════════
const originalNavigate = navigate;
navigate = function(view, param) {
  const views = ['home','explore','channels','channel-detail','messages','notifications','profile','edit-profile','my-channel','admin','search','marketplace','disclaimer','status-channels'];
  views.forEach(v => {
    const el = document.getElementById('view-' + v);
    if (el) el.classList.add('hidden');
  });
  
  const titles = { home:'🏠 Home Feed', explore:'🔍 Explore', channels:'📺 Channels', messages:'💬 Messages', notifications:'🔔 Notifications', profile:'👤 Profile', 'edit-profile':'🎨 Customize My Page', 'my-channel':'📡 My Channel', admin:'🛡️ Admin Panel', search:'🔍 Search', marketplace:'🛍️ Marketplace', disclaimer:'📜 Disclaimer', 'status-channels':'⏰ Status Channels' };
  document.getElementById('topbar-title').textContent = titles[view] || 'VibeHub';
  
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById('nav-' + view);
  if (navEl) navEl.classList.add('active');
  
  const el = document.getElementById('view-' + view);
  if (el) el.classList.remove('hidden');
  
  if (view === 'home') { cleanupExpiredPosts(); renderFeed('all'); }
  else if (view === 'explore') renderExplore();
  else if (view === 'channels') renderChannels();
  else if (view === 'channel-detail') renderChannelDetail(param);
  else if (view === 'messages') renderMessages();
  else if (view === 'notifications') renderNotifications();
  else if (view === 'profile') renderProfile(param || getCurrentUser()?.username);
  else if (view === 'edit-profile') renderEditProfile();
  else if (view === 'my-channel') renderMyChannel();
  else if (view === 'admin') renderAdmin();
  else if (view === 'marketplace') renderMarketplace();
  else if (view === 'status-channels') renderStatusChannels();
  else if (view === 'search') {} // handled by handleSearch
};

// Add nav items for marketplace and disclaimer
function addNavItems() {
  const sidebar = document.getElementById('sidebar');
  if (sidebar && !document.getElementById('nav-marketplace')) {
    const marketplaceNav = document.createElement('button');
    marketplaceNav.className = 'nav-item';
    marketplaceNav.id = 'nav-marketplace';
    marketplaceNav.onclick = () => navigate('marketplace');
    marketplaceNav.innerHTML = '<span class="nav-icon">🛍️</span> Marketplace';
    
    const disclaimerNav = document.createElement('button');
    disclaimerNav.className = 'nav-item';
    disclaimerNav.id = 'nav-disclaimer';
    disclaimerNav.onclick = () => navigate('disclaimer');
    disclaimerNav.innerHTML = '<span class="nav-icon">📜</span> Disclaimer';
    
    const editProfileNav = document.getElementById('nav-edit-profile');
    if (editProfileNav && editProfileNav.nextSibling) {
      sidebar.insertBefore(marketplaceNav, editProfileNav.nextSibling);
      sidebar.insertBefore(disclaimerNav, marketplaceNav.nextSibling);
    }
  }
}

// ══════════════════════════════════════
// REPUTATION ENGINE
// ══════════════════════════════════════
const ReputationEngine = {
  TIERS: {
    RISING_VOICE: { id: 'rising_voice', name: 'Rising Voice', emoji: '🌱', minScore: 0, color: '#10B981' },
    VIBE_CATALYST: { id: 'vibe_catalyst', name: 'Vibe Catalyst', emoji: '⚡', minScore: 100, color: '#F59E0B' },
    TREND_STARTER: { id: 'trend_starter', name: 'Trend Starter', emoji: '🔥', minScore: 500, color: '#EF4444' },
    DEBATE_MASTER: { id: 'debate_master', name: 'Debate Master', emoji: '🎯', minScore: 1000, color: '#8B5CF6' },
    COMMUNITY_BUILDER: { id: 'community_builder', name: 'Community Builder', emoji: '🏛️', minScore: 2500, color: '#06B6D4' },
    TRUSTED_SELLER: { id: 'trusted_seller', name: 'Trusted Seller', emoji: '💎', minScore: 5000, color: '#F97316' }
  },
  calculateReputation(username) {
    const posts = getPosts().filter(p => p.userId === username);
    let score = posts.length * 10;
    posts.forEach(p => {
      score += (p.likes?.length || 0) * 2;
      score += (p.dislikes?.length || 0) * 1;
      score += (p.comments?.length || 0) * 3;
      score += (p.waves?.length || 0) * 2;
    });
    const friends = getFriends()[username] || [];
    score += friends.length * 5;
    
    const tier = Object.values(this.TIERS).reverse().find(t => score >= t.minScore) || this.TIERS.RISING_VOICE;
    return { score, tier };
  },
  getScore(username) {
    return this.calculateReputation(username).score;
  },
  getTier(username) {
    return this.calculateReputation(username).tier;
  }
};
window.ReputationEngine = ReputationEngine;

// ══════════════════════════════════════
// MOMENTUM ENGINE
// ══════════════════════════════════════
const MomentumEngine = {
  DECAY_RATE: 0.985,
  LEVELS: {
    LOW: { min: 0, max: 100, name: 'Building', class: 'low' },
    MEDIUM: { min: 100, max: 300, name: 'Rising', class: 'medium' },
    HIGH: { min: 300, max: 600, name: 'Hot', class: 'high' },
    ELITE: { min: 600, max: Infinity, name: 'Legendary', class: 'elite' }
  },
  calculateMomentum(username) {
    const posts = getPosts().filter(p => p.userId === username);
    const now = Date.now();
    const dayMs = 24 * 60 * 60 * 1000;
    
    let momentum = 0;
    let streak = 0;
    
    posts.forEach(p => {
      const age = (now - p.time) / dayMs;
      const decay = Math.pow(this.DECAY_RATE, age);
      const engagement = (p.likes?.length || 0) + (p.dislikes?.length || 0) + (p.comments?.length || 0) * 2;
      momentum += engagement * decay;
    });
    
    const sorted = [...posts].sort((a, b) => b.time - a.time);
    if (sorted.length > 0) {
      let currentDate = new Date(sorted[0].time);
      currentDate.setHours(0, 0, 0, 0);
      streak = 1;
      for (let i = 1; i < Math.min(sorted.length, 30); i++) {
        const postDate = new Date(sorted[i].time);
        postDate.setHours(0, 0, 0, 0);
        const dayDiff = Math.floor((currentDate - postDate) / dayMs);
        if (dayDiff === 1) { streak++; currentDate = postDate; }
        else if (dayDiff > 1) break;
      }
    }
    
    momentum += streak * 20;
    momentum = Math.min(momentum, 1000);
    
    let level = this.LEVELS.LOW;
    if (momentum >= this.LEVELS.ELITE.min) level = this.LEVELS.ELITE;
    else if (momentum >= this.LEVELS.HIGH.min) level = this.LEVELS.HIGH;
    else if (momentum >= this.LEVELS.MEDIUM.min) level = this.LEVELS.MEDIUM;
    
    return { score: Math.floor(momentum), streak, level };
  },
  getScore(username) {
    return this.calculateMomentum(username).score;
  }
};
window.MomentumEngine = MomentumEngine;

// ══════════════════════════════════════
// STATUS CHANNELS (24-HOUR TEMPORARY)
// ══════════════════════════════════════
function getStatusChannels() { return getDB('statusChannels', []); }
function setStatusChannels(v) { setDB('statusChannels', v); }

function createStatusChannel() {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  const name = prompt('Status channel name:');
  if (!name) return;
  
  const me = getCurrentUser();
  const channels = getStatusChannels();
  channels.unshift({
    id: 'status_' + Date.now(),
    name: name,
    creator: me.username,
    createdAt: Date.now(),
    expiresAt: Date.now() + (24 * 60 * 60 * 1000)
  });
  setStatusChannels(channels);
  toast('Status channel created! Expires in 24h ⏰', 'success');
  renderStatusChannels();
}

function renderStatusChannels() {
  const channels = getStatusChannels().filter(c => c.expiresAt > Date.now());
  const container = document.getElementById('status-channels-list');
  if (!container) return;
  
  if (!channels.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">⏰</div><div class="empty-title">No active status channels</div><div class="empty-desc">Create one to start vibing!</div></div>';
    return;
  }
  
  container.innerHTML = channels.map(c => `
    <div class="channel-card" onclick="joinStatusChannel('${c.id}')">
      <div class="channel-banner">${c.name[0]}</div>
      <div class="channel-info">
        <div class="channel-name">${escHtml(c.name)}</div>
        <div class="channel-meta">
          <span class="channel-subs">by @${c.creator}</span>
          <span style="color:var(--cyan);font-size:11px;">⏰ ${Math.round((c.expiresAt - Date.now()) / 3600000)}h left</span>
        </div>
      </div>
    </div>
  `).join('');
}

function joinStatusChannel(channelId) {
  const channel = getStatusChannels().find(c => c.id === channelId);
  if (!channel) { toast('Channel expired', 'error'); return; }
  toast(`Joined #${channel.name}! 🎉`, 'success');
}

// ══════════════════════════════════════
// COLLABORATIVE POSTS
// ══════════════════════════════════════
function getCollabPosts() { return getDB('collabPosts', []); }
function setCollabPosts(v) { setDB('collabPosts', v); }

function showCollabModal(postId) {
  if (!currentSession) { toast('Log in first', 'error'); return; }
  document.getElementById('modal-collab-post').classList.remove('hidden');
  window.currentCollabPost = postId;
}

function sendCollabRequest() {
  const username = document.getElementById('collab-user-input').value.trim();
  if (!username) { toast('Enter username', 'error'); return; }
  
  const collabs = getCollabPosts();
  collabs.unshift({
    id: 'collab_' + Date.now(),
    postId: window.currentCollabPost,
    from: getCurrentUser().username,
    to: username,
    status: 'pending',
    createdAt: Date.now()
  });
  setCollabPosts(collabs);
  closeModal('modal-collab-post');
  toast('Collab request sent! 🤝', 'success');
}

function acceptCollab(collabId) {
  const collabs = getCollabPosts();
  const collab = collabs.find(c => c.id === collabId);
  if (!collab) return;
  
  collab.status = 'accepted';
  setCollabPosts(collabs);
  
  const posts = getPosts();
  const post = posts.find(p => p.id === collab.postId);
  if (post) {
    if (!post.collabs) post.collabs = [];
    post.collabs.push(collab.from);
    setPosts(posts);
  }
  
  toast('Collab accepted! 🤝', 'success');
  renderNotifications();
}

// ══════════════════════════════════════
// VIBE SYNC (ROOM ENERGY DETECTION)
// ══════════════════════════════════════
const VibeSyncEngine = {
  detectRoomEnergy(posts) {
    if (!posts || posts.length === 0) return { energy: 'calm', emoji: '😌', color: '#06B6D4' };
    
    const now = Date.now();
    const recentPosts = posts.filter(p => now - p.time < 3600000);
    
    let totalEngagement = 0;
    let waveCount = 0;
    let reactionCount = 0;
    
    recentPosts.forEach(p => {
      totalEngagement += (p.likes?.length || 0) + (p.dislikes?.length || 0);
      waveCount += p.waves?.length || 0;
      if (p.reactions) {
        Object.values(p.reactions).forEach(arr => {
          reactionCount += arr?.length || 0;
        });
      }
    });
    
    const score = totalEngagement + (waveCount * 2) + (reactionCount * 1.5);
    
    if (score > 100) return { energy: 'lit', emoji: '🔥', color: '#EF4444' };
    if (score > 50) return { energy: 'vibing', emoji: '🎵', color: '#8B5CF6' };
    if (score > 20) return { energy: 'chill', emoji: '☕', color: '#10B981' };
    return { energy: 'calm', emoji: '😌', color: '#06B6D4' };
  },
  
  getRoomPulse() {
    const posts = getPosts();
    return this.detectRoomEnergy(posts);
  }
};
window.VibeSyncEngine = VibeSyncEngine;

// ══════════════════════════════════════
// INIT
// ══════════════════════════════════════

// Clear conflicting local cache on boot - Supabase is source of truth
function clearConflictingCache() {
  const keysToClear = [
    'vibeLikes', 'friends', 'friendRequests', 
    'userWaves', 'reports', 'statusChannels', 'collabPosts', 'products'
  ];
  
  keysToClear.forEach(key => {
    try {
      localStorage.removeItem('vibehub_' + key);
      localStorage.removeItem(key);
    } catch(e) {}
  });
  
  console.log('Local cache cleared - Supabase is now source of truth');
}

async function init() {
  // Show splash screen on every boot
  const splash = document.getElementById('splash-screen');
  if (splash) {
    splash.style.display = 'flex';
  }
  
  // Clear conflicting cache on every boot
  clearConflictingCache();
  
  // Check for admin URL - only show admin elements on admin URL
  const isAdminURL = window.location.search.includes('vibe-control-7x9kq2m');
  
  // Show admin elements on admin URL (regardless of login state)
  if (isAdminURL) {
    // Bottom admin button
    const adminBtn = document.getElementById('bottom-admin-btn');
    if (adminBtn) {
      adminBtn.classList.add('admin-visible');
    }
    
    // Sidebar admin section
    const adminSection = document.getElementById('admin-section');
    if (adminSection) {
      adminSection.style.display = 'block';
    }
    
    // Sidebar admin nav
    const navAdmin = document.getElementById('nav-admin');
    if (navAdmin) {
      navAdmin.classList.remove('hidden');
    }
    
    // Mobile admin option
    const mobileAdminOption = document.getElementById('mobile-admin-option');
    if (mobileAdminOption) {
      mobileAdminOption.style.display = 'block';
    }
  }
  
  // Update mobile admin option visibility
  updateMobileAdminOption();
  
  // Attach button listeners
  addNavItems();
  
  // Initialize Supabase client first
  initSupabaseClient();
  
  // Wait a moment for Supabase to initialize, then load data
  setTimeout(async () => {
    await initDataStore();
    
    // Hide splash screen when data is ready
    const splash = document.getElementById('splash-screen');
    if (splash) {
      splash.style.display = 'none';
    }
    
    // Only check for admin features on admin URL
    const isAdminURL = window.location.search.includes('vibe-control-7x9kq2m');
    
    if (isAdminURL) {
      // Admin URL - check Supabase for owner
      const ownerExists = await checkOwnerExists();
      if (ownerExists) {
        // Owner exists in Supabase - show login
        showPage('login');
        toast('Log in with your owner account 👑', 'info');
      } else {
        // No owner - show setup
        showPage('admin-setup');
        document.getElementById('modal-admin-setup').classList.remove('hidden');
      }
      return;
    }
    
    // Check for existing session
    const session = getSession();
    if (session) {
      const user = _usersCache.find(u => u.username === session);
      if (user) {
        launchApp();
        return;
      }
    }
    
    // Show landing page
    showPage('landing');
    if (typeof updateBetaUI === 'function') updateBetaUI();
  }, 500);
}

// Simple init - handled by init() at bottom of file

function continueInit() {
  var navLoginBtn = document.getElementById('nav-login-btn');
  var landingJoinBtn = document.getElementById('landing-join-btn');
  var heroJoinBtn = document.getElementById('hero-join-btn');
  var heroLoginBtn = document.getElementById('hero-login-btn');
  
  if (landingJoinBtn) landingJoinBtn.onclick = function() { showPage('register'); };
  if (navLoginBtn) navLoginBtn.onclick = function() { showPage('login'); };
  if (heroJoinBtn) heroJoinBtn.onclick = function() { showPage('register'); };
  if (heroLoginBtn) heroLoginBtn.onclick = function() { showPage('login'); };
}



// Simple init - handled by init() at bottom of file

function continueInit() {
  // Just show landing if no session
  const session = getDB('session', null);
  if (session && getCurrentUser()) {
    launchApp();
  } else {
    showPage('landing');
  }
}

// Click outside modal to close
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-overlay')) {
    e.target.classList.add('hidden');
    const payBtn = document.querySelector('#modal-payment .btn-primary');
    if (payBtn) { payBtn.textContent = 'Pay $1 & Join VibeHub 🚀'; payBtn.disabled = false; }
  }
});

// Attach button listeners immediately - before anything else
(function attachButtonsNow() {
  var btnIds = ['nav-login-btn', 'landing-join-btn', 'hero-join-btn', 'hero-login-btn'];
  btnIds.forEach(function(id) {
    var btn = document.getElementById(id);
    if (btn && !btn._hasListener) {
      btn._hasListener = true;
      if (id === 'nav-login-btn' || id === 'hero-login-btn') {
        btn.onclick = function() { showPage('login'); };
      } else {
        btn.onclick = function() { showPage('register'); };
      }
    }
  });
})();

try {
  initSupabaseClient();
  init();
} catch(e) {
  console.error('Init error:', e);
  // Fallback: show landing page anyway
  document.getElementById('page-landing').classList.remove('hidden');
}
</script>
<script>
// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW registration failed:', err));
  });
}

// Global Error Handler
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.error('Error:', msg, 'at line', lineNo);
  return false;
};

window.onunhandledrejection = function(event) {
  console.error('Unhandled promise rejection:', event.reason);
};

// Offline Detection
window.addEventListener('online', () => {
  if (typeof toast === 'function') toast('Back online!', 'success');
});

window.addEventListener('offline', () => {
  if (typeof toast === 'function') toast('You are offline. Changes will sync when back online.', 'error');
});
</script>
</body>
</html>
